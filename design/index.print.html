<!doctype html><html id=R-html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=print><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.154.5"><meta name=generator content="Relearn 9.0.3"><meta name=description content="LLM generated design documents for resources"><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Design Documents :: Choria Configuration Manager"><meta name=twitter:description content="LLM generated design documents for resources"><meta property="og:url" content="https://choria-cm.dev/design/index.html"><meta property="og:site_name" content="Choria Configuration Manager"><meta property="og:title" content="Design Documents :: Choria Configuration Manager"><meta property="og:description" content="LLM generated design documents for resources"><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><meta itemprop=name content="Design Documents :: Choria Configuration Manager"><meta itemprop=description content="LLM generated design documents for resources"><meta itemprop=wordCount content="158"><title>Design Documents :: Choria Configuration Manager</title><link href=https://choria-cm.dev/design/index.html rel=canonical type=text/html title="Design Documents :: Choria Configuration Manager"><link href=/design/index.xml rel=alternate type=application/rss+xml title="Design Documents :: Choria Configuration Manager"><link href=/design/index.md rel=alternate type=text/markdown title="Design Documents :: Choria Configuration Manager"><link href=/css/auto-complete/auto-complete.min.css?1771940928 rel=stylesheet><script src=/js/auto-complete/auto-complete.min.js?1771940928 defer></script><script src=/js/search-lunr.min.js?1771940928 defer></script><script src=/js/search.min.js?1771940928 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="/searchindex.en.js?1771940928"</script><script src=/js/lunr/lunr.min.js?1771940928 defer></script><script src=/js/lunr/lunr.stemmer.support.min.js?1771940928 defer></script><script src=/js/lunr/lunr.multi.min.js?1771940928 defer></script><script src=/js/lunr/lunr.en.min.js?1771940928 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["en"]</script><link href=/fonts/fontawesome/css/all.min.css?1771940928 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/fonts/fontawesome/css/all.min.css?1771940928 rel=stylesheet></noscript><link href=/css/perfect-scrollbar/perfect-scrollbar.min.css?1771940928 rel=stylesheet><link href=/css/theme.min.css?1771940928 rel=stylesheet><link href=/css/format-print.min.css?1771940928 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/design/index.html",window.relearn.relBasePath="..",window.relearn.relBaseUri="..",window.relearn.absBaseUri="https://choria-cm.dev",window.relearn.disableInlineCopyToClipboard=!0,window.relearn.enableBlockCodeWrap=!0,window.T_Copy_to_clipboard=`Copy text to clipboard`,window.T_Copied_to_clipboard=`Text copied to clipboard!`,window.T_Link_copied_to_clipboard=`Link copied to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`,window.T_Browser_unsupported_feature=`This browser doesn't support this feature`,window.relearn.themevariants=["zen-auto","zen-light","ccm"],window.relearn.customvariantprefix="my-custom-",window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.localStorage.getItem(window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.localStorage.getItem(window.relearn.absBaseUri+"/variant")??"";(!e||!e.startsWith(window.relearn.customvariantprefix)&&!window.relearn.themevariants.includes(e)||e.startsWith(window.relearn.customvariantprefix)&&!window.localStorage.getItem(window.relearn.absBaseUri+"/variantstylesheet-"+e))&&(e=window.relearn.themevariants[0],window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><script src=https://cdn.counter.dev/script.js data-id=a4622abe-f6fa-4cac-a337-a4437915e4b3></script></head><body class="mobile-support print" data-origin=/design/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar class=default-animation><div class="topbar-wrapper default-animation"><div class="topbar-sidebar-divider default-animation"></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar default-animation" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><span class="btn cstyle button link noborder notitle interactive"><button onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></span></div><div class="topbar-button topbar-button-toc default-animation" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><button onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-table-list"></i></button></span><div class=topbar-content><div class=topbar-content-wrapper><nav class=TableOfContents><ul><li><a href=#contents>Contents</a></li><li><a href=#available-documents>Available Documents</a></li></ul></nav></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/index.html><span itemprop=name>Introduction</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Design Documents</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-markdown default-animation" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><a href=/design/index.md title="Show Markdown"><i class="fa-fw fab fa-markdown"></i></a></span></div><div class="topbar-button topbar-button-print default-animation" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><a href=/design/index.print.html title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a></span></div><div class="topbar-button topbar-button-prev default-animation" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><a href=/monitoring/index.html title="Monitoring (ğŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></span></div><div class="topbar-button topbar-button-next default-animation" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><a href=/design/archive/index.html title="Archive Type (ğŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></span></div><div class="topbar-button topbar-button-more default-animation" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><button onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button></span><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable design" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=design-documents>Design Documents</h1><p>Design documents provide detailed implementation guidance for CCM&rsquo;s resource types, providers, and internal components. They are intended for developers contributing to CCM or those seeking to understand specific implementation details.</p><p>For end-user documentation on how to use resources, see <a href=/resources/index.html>Resources</a>.</p><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>These design documents are largely written with AI assistance and reviewed before publication.</p></div></details><h2 id=contents>Contents<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Each design document covers:</p><ul><li><strong>Purpose and scope</strong>: What the component does and its responsibilities</li><li><strong>Architecture</strong>: How the component fits into CCM&rsquo;s overall design</li><li><strong>Implementation details</strong>: Key data structures, interfaces, and algorithms</li><li><strong>Provider contracts</strong>: Requirements for implementing new providers</li><li><strong>Testing considerations</strong>: How to test the component</li></ul><h2 id=available-documents>Available Documents<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Document</th><th>Description</th></tr></thead><tbody><tr><td><a href=/design/archive/index.html>Archive</a></td><td>Archive resource for downloading and extracting archives</td></tr><tr><td><a href=/design/exec/index.html>Exec</a></td><td>Exec resource for command execution</td></tr><tr><td><a href=/design/file/index.html>File</a></td><td>File resource for managing files and directories</td></tr><tr><td><a href=/design/package/index.html>Package</a></td><td>Package resource for system package management</td></tr><tr><td><a href=/design/scaffold/index.html>Scaffold</a></td><td>Scaffold resource for template directory rendering</td></tr><tr><td><a href=/design/service/index.html>Service</a></td><td>Service resource for system service management</td></tr><tr><td><a href=/design/new/index.html>New Type</a></td><td>How to add a new resource type to CCM</td></tr></tbody></table><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Design Documents</h1><article class=default><header class=headline></header><h1 id=archive-type>Archive Type</h1><p>This document describes the design of the archive resource type for downloading and extracting archives.</p><h2 id=overview>Overview<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The archive resource manages remote archives with three phases:</p><ul><li><strong>Download</strong>: Fetch archive from a URL to local filesystem</li><li><strong>Extract</strong>: Unpack archive contents to a target directory</li><li><strong>Cleanup</strong>: Optionally remove the archive file after extraction</li></ul><p>These phases are conditional based on current state and configuration.</p><h2 id=provider-interface>Provider Interface<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Archive providers must implement the <code>ArchiveProvider</code> interface:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ArchiveProvider</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Provider</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Download</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>properties</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ArchiveResourceProperties</span>, <span style=color:#a6e22e>log</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Logger</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Extract</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>properties</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ArchiveResourceProperties</span>, <span style=color:#a6e22e>log</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Logger</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Status</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>properties</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ArchiveResourceProperties</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ArchiveState</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=method-responsibilities>Method Responsibilities<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Method</th><th>Responsibility</th></tr></thead><tbody><tr><td><code>Status</code></td><td>Query archive file existence, checksum, attributes, and creates file</td></tr><tr><td><code>Download</code></td><td>Fetch archive from URL, verify checksum, set ownership</td></tr><tr><td><code>Extract</code></td><td>Unpack archive contents to extract parent directory</td></tr></tbody></table><h3 id=status-response>Status Response<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>Status</code> method returns an <code>ArchiveState</code> containing:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ArchiveState</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CommonResourceState</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Metadata</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ArchiveMetadata</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ArchiveMetadata</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>          <span style=color:#66d9ef>string</span>    <span style=color:#75715e>// Archive file path</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Checksum</span>      <span style=color:#66d9ef>string</span>    <span style=color:#75715e>// SHA256 hash of archive</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ArchiveExists</span> <span style=color:#66d9ef>bool</span>      <span style=color:#75715e>// Whether archive file exists</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CreatesExists</span> <span style=color:#66d9ef>bool</span>      <span style=color:#75715e>// Whether creates marker file exists</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Owner</span>         <span style=color:#66d9ef>string</span>    <span style=color:#75715e>// Archive file owner</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Group</span>         <span style=color:#66d9ef>string</span>    <span style=color:#75715e>// Archive file group</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MTime</span>         <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span> <span style=color:#75715e>// Modification time</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Size</span>          <span style=color:#66d9ef>int64</span>     <span style=color:#75715e>// File size in bytes</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Provider</span>      <span style=color:#66d9ef>string</span>    <span style=color:#75715e>// Provider name (e.g., &#34;http&#34;)</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>The <code>Ensure</code> field in <code>CommonResourceState</code> is set to:</p><ul><li><code>present</code> if the archive file exists</li><li><code>absent</code> if the archive file does not exist</li></ul><h2 id=available-providers>Available Providers<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Provider</th><th>Source</th><th>Documentation</th></tr></thead><tbody><tr><td><code>http</code></td><td>HTTP/HTTPS URLs</td><td><a href=/design/archive/http/index.html>HTTP</a></td></tr></tbody></table><h2 id=ensure-states>Ensure States<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>present</code></td><td>Archive must be downloaded (and optionally extracted)</td></tr><tr><td><code>absent</code></td><td>Archive file must not exist</td></tr></tbody></table><h2 id=supported-archive-formats>Supported Archive Formats<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Extension</th><th>Description</th></tr></thead><tbody><tr><td><code>.tar.gz</code>, <code>.tgz</code></td><td>Gzip-compressed tar archive</td></tr><tr><td><code>.tar</code></td><td>Uncompressed tar archive</td></tr><tr><td><code>.zip</code></td><td>ZIP archive</td></tr></tbody></table><p>The URL and local file name must have matching archive type extensions.</p><h2 id=apply-logic>Apply Logic<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Get current state via Status()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Is current state desired state?         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              Yes â”‚         No
                  â–¼         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
          â”‚ No change â”‚     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ What is desired ensure? â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ absent                        â”‚ present
            â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Remove archiveâ”‚             â”‚ Download needed?    â”‚
    â”‚ file          â”‚             â”‚ (checksum mismatch  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  or file missing)   â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        Yes â”‚         No
                                            â–¼         â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
                                    â”‚ Download  â”‚     â”‚
                                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â”‚
                                          â”‚           â”‚
                                          â–¼           â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ Extract needed?         â”‚
                                  â”‚ (extract_parent set AND â”‚
                                  â”‚  (download occurred OR  â”‚
                                  â”‚   creates file missing))â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        Yes â”‚         No
                                            â–¼         â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
                                    â”‚ Extract   â”‚     â”‚
                                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â”‚
                                          â”‚           â”‚
                                          â–¼           â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ Cleanup enabled?        â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        Yes â”‚         No
                                            â–¼         â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ Remove    â”‚ â”‚ Done  â”‚
                                    â”‚ archive   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The archive resource uses multiple checks for idempotency:</p><h3 id=state-checks-in-order>State Checks (in order)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><ol><li><strong>Ensure absent</strong>: Archive file must not exist</li><li><strong>Creates file</strong>: If <code>creates</code> is set, the marker file must exist</li><li><strong>Archive existence</strong>: If <code>cleanup: false</code>, archive must exist</li><li><strong>Owner/Group</strong>: Archive file attributes must match</li><li><strong>Checksum</strong>: If specified, archive checksum must match</li></ol><h3 id=decision-table>Decision Table<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Condition</th><th>Stable?</th></tr></thead><tbody><tr><td><code>ensure: absent</code> + archive missing</td><td>Yes</td></tr><tr><td><code>ensure: absent</code> + archive exists</td><td>No (remove)</td></tr><tr><td><code>creates</code> file exists</td><td>Yes (skip all)</td></tr><tr><td><code>creates</code> file missing</td><td>No (extract needed)</td></tr><tr><td><code>cleanup: false</code> + archive missing</td><td>No (download needed)</td></tr><tr><td>Archive checksum mismatch</td><td>No (re-download needed)</td></tr><tr><td>Archive owner/group mismatch</td><td>No (re-download needed)</td></tr></tbody></table><h2 id=creates-property>Creates Property<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The <code>creates</code> property provides idempotency for extraction:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>archive</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/tmp/app.tar.gz</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#ae81ff>https://example.com/app.tar.gz</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>extract_parent</span>: <span style=color:#ae81ff>/opt/app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>creates</span>: <span style=color:#ae81ff>/opt/app/bin/app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span></span></span></code></pre></div><p><strong>Behavior:</strong></p><ul><li>If <code>/opt/app/bin/app</code> exists, skip download and extraction</li><li>Useful when extracted files indicate successful prior extraction</li><li>Prevents re-extraction on every run</li></ul><h2 id=cleanup-property>Cleanup Property<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The <code>cleanup</code> property removes the archive after extraction:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>archive</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/tmp/app.tar.gz</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#ae81ff>https://example.com/app.tar.gz</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>extract_parent</span>: <span style=color:#ae81ff>/opt/app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>creates</span>: <span style=color:#ae81ff>/opt/app/bin/app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>cleanup</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span></span></span></code></pre></div><p><strong>Requirements:</strong></p><ul><li><code>extract_parent</code> must be set (cleanup only makes sense with extraction)</li><li><code>creates</code> must be set to track extraction state</li></ul><p><strong>Behavior:</strong></p><ul><li>After successful extraction, remove the archive file</li><li>On subsequent runs, <code>creates</code> file prevents re-download</li></ul><h2 id=checksum-verification>Checksum Verification<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>When <code>checksum</code> is specified:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>archive</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/tmp/app.tar.gz</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#ae81ff>https://example.com/app.tar.gz</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>checksum</span>: <span style=color:#e6db74>&#34;a1b2c3d4...&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span></span></span></code></pre></div><p><strong>Behavior:</strong></p><ul><li>Downloaded file is verified against SHA256 checksum</li><li>Existing file checksum is compared to detect changes</li><li>Checksum mismatch triggers re-download</li><li>Download fails if fetched content doesn&rsquo;t match</li></ul><h2 id=authentication>Authentication<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Archives support two authentication methods:</p><h3 id=basic-authentication>Basic Authentication<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>archive</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/tmp/app.tar.gz</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#ae81ff>https://private.example.com/app.tar.gz</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>username</span>: <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;{{ lookup(&#39;data.password&#39;) }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span></span></span></code></pre></div><h3 id=custom-headers>Custom Headers<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>archive</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/tmp/app.tar.gz</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#ae81ff>https://api.example.com/releases/app.tar.gz</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>headers</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>Authorization</span>: <span style=color:#e6db74>&#34;Bearer {{ lookup(&#39;data.token&#39;) }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span></span></span></code></pre></div><h2 id=required-properties>Required Properties<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Property</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>url</code></td><td>Yes</td><td>Source URL for download</td></tr><tr><td><code>owner</code></td><td>Yes</td><td>Username that owns the archive file</td></tr><tr><td><code>group</code></td><td>Yes</td><td>Group that owns the archive file</td></tr></tbody></table><h2 id=url-validation>URL Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>URLs are validated during resource creation:</p><ul><li>Must be valid URL format</li><li>Scheme must be <code>http</code> or <code>https</code></li><li>Path must end with supported archive extension</li><li>Extension must match the <code>name</code> property extension</li></ul><h2 id=noop-mode>Noop Mode<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>In noop mode, the archive type:</p><ol><li>Queries current state normally</li><li>Computes what actions would be taken</li><li>Sets appropriate <code>NoopMessage</code>:<ul><li>&ldquo;Would have downloaded&rdquo;</li><li>&ldquo;Would have extracted&rdquo;</li><li>&ldquo;Would have cleaned up&rdquo;</li><li>&ldquo;Would have removed&rdquo;</li></ul></li><li>Reports <code>Changed: true</code> if changes would occur</li><li>Does not call provider Download/Extract methods</li><li>Does not remove files</li></ol><p>Multiple actions are joined with &ldquo;. " (e.g., &ldquo;Would have downloaded. Would have extracted&rdquo;).</p><h2 id=desired-state-validation>Desired State Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>After applying changes (in non-noop mode), the type verifies the archive reached the desired state by calling <code>Status()</code> again and checking all conditions. If validation fails, <code>ErrDesiredStateFailed</code> is returned.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Archive Type</h1><article class=default><header class=headline></header><h1 id=http-provider>HTTP Provider</h1><p>This document describes the implementation details of the HTTP archive provider for downloading and extracting archives from HTTP/HTTPS URLs.</p><h2 id=provider-selection>Provider Selection<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The HTTP provider is selected when:</p><ol><li>The URL scheme is <code>http</code> or <code>https</code></li><li>The archive file extension is supported (<code>.tar.gz</code>, <code>.tgz</code>, <code>.tar</code>, <code>.zip</code>)</li><li>The required extraction tool (<code>tar</code> or <code>unzip</code>) is available in PATH</li></ol><p>The <code>IsManageable()</code> function checks these conditions and returns a priority of 1 if all are met.</p><h2 id=operations>Operations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=download>Download<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Parse the URL and add Basic Auth credentials if username/password provided</li><li>Create HTTP request with custom headers (if specified)</li><li>Execute GET request via <code>util.HttpGetResponse()</code></li><li>Verify HTTP 200 status code</li><li>Create temporary file in the same directory as the target</li><li>Set ownership on temp file before writing content</li><li>Copy response body to temp file</li><li>Verify checksum if provided</li><li>Atomic rename temp file to target path</li></ol><p><strong>Atomic Write Pattern:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>[parent dir]/archive-name-* (temp file)
    â†“ write content
    â†“ set owner/group
    â†“ verify checksum
    â†“ rename
[parent dir]/archive-name (final file)</code></pre></div><p>The temp file is created in the same directory as the target to ensure <code>os.Rename()</code> is atomic (same filesystem).</p><p><strong>Error Handling:</strong></p><table><thead><tr><th>Condition</th><th>Behavior</th></tr></thead><tbody><tr><td>HTTP non-200</td><td>Return error with status code</td></tr><tr><td>Write failure</td><td>Clean up temp file, return error</td></tr><tr><td>Checksum mismatch</td><td>Clean up temp file, return error with expected vs actual</td></tr><tr><td>Rename failure</td><td>Temp file cleaned up by defer</td></tr></tbody></table><p><strong>Authentication:</strong></p><table><thead><tr><th>Method</th><th>Implementation</th></tr></thead><tbody><tr><td>Basic Auth</td><td>URL userinfo is passed to <code>HttpGetResponse()</code> which sets <code>Authorization</code> header</td></tr><tr><td>Username/Password properties</td><td>Embedded in URL before request: <code>url.UserPassword(username, password)</code></td></tr><tr><td>Custom Headers</td><td>Added to request via <code>http.Header.Add()</code></td></tr></tbody></table><h3 id=extract>Extract<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Validate <code>ExtractParent</code> is set</li><li>Create <code>ExtractParent</code> directory if it doesn&rsquo;t exist (mode 0755)</li><li>Determine archive type from file extension</li><li>Execute appropriate extraction command</li></ol><p><strong>Extraction Commands:</strong></p><table><thead><tr><th>Extension</th><th>Command</th></tr></thead><tbody><tr><td><code>.tar.gz</code>, <code>.tgz</code></td><td><code>tar -xzf &lt;archive> -C &lt;extract_parent></code></td></tr><tr><td><code>.tar</code></td><td><code>tar -xf &lt;archive> -C &lt;extract_parent></code></td></tr><tr><td><code>.zip</code></td><td><code>unzip -d &lt;extract_parent> &lt;archive></code></td></tr></tbody></table><p><strong>Command Execution:</strong></p><p>Commands are executed via <code>model.CommandRunner.ExecuteWithOptions()</code> with:</p><table><thead><tr><th>Option</th><th>Value</th></tr></thead><tbody><tr><td><code>Command</code></td><td><code>tar</code> or <code>unzip</code></td></tr><tr><td><code>Args</code></td><td>Extraction flags and paths</td></tr><tr><td><code>Cwd</code></td><td><code>ExtractParent</code> directory</td></tr><tr><td><code>Timeout</code></td><td>1 minute</td></tr></tbody></table><p><strong>Error Handling:</strong></p><table><thead><tr><th>Condition</th><th>Behavior</th></tr></thead><tbody><tr><td>Unsupported extension</td><td>Return &ldquo;archive type not supported&rdquo; error</td></tr><tr><td>Command not found</td><td>Runner returns error</td></tr><tr><td>Non-zero exit code</td><td>Return error with exit code and stderr</td></tr></tbody></table><h3 id=status>Status<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Initialize state with <code>EnsureAbsent</code> default</li><li>Check if archive file exists via <code>os.Stat()</code></li><li>If exists: set <code>EnsurePresent</code>, populate metadata (size, mtime, owner, group, checksum)</li><li>If <code>Creates</code> property set: check if creates file exists</li></ol><p><strong>Metadata Collected:</strong></p><table><thead><tr><th>Field</th><th>Source</th></tr></thead><tbody><tr><td><code>Name</code></td><td>From properties</td></tr><tr><td><code>Provider</code></td><td>&ldquo;http&rdquo;</td></tr><tr><td><code>ArchiveExists</code></td><td><code>os.Stat()</code> success</td></tr><tr><td><code>Size</code></td><td><code>FileInfo.Size()</code></td></tr><tr><td><code>MTime</code></td><td><code>FileInfo.ModTime()</code></td></tr><tr><td><code>Owner</code></td><td><code>util.GetFileOwner()</code> - resolves UID to username</td></tr><tr><td><code>Group</code></td><td><code>util.GetFileOwner()</code> - resolves GID to group name</td></tr><tr><td><code>Checksum</code></td><td><code>util.Sha256HashFile()</code></td></tr><tr><td><code>CreatesExists</code></td><td><code>os.Stat()</code> on <code>Creates</code> path</td></tr></tbody></table><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The provider supports idempotency through the type&rsquo;s <code>isDesiredState()</code> function:</p><h3 id=state-checks-in-order>State Checks (in order)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><ol><li><strong>Ensure Absent</strong>: If <code>ensure: absent</code>, archive must not exist</li><li><strong>Creates File</strong>: If <code>Creates</code> set and file doesn&rsquo;t exist â†’ not stable</li><li><strong>Archive Existence</strong>: If <code>cleanup: false</code>, archive must exist</li><li><strong>Owner/Group</strong>: Must match properties</li><li><strong>Checksum</strong>: If specified in properties, must match</li></ol><p>Note: When <code>cleanup: true</code>, the <code>creates</code> property is required (enforced at validation time).</p><h3 id=decision-matrix>Decision Matrix<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Archive Exists</th><th>Creates Exists</th><th>Checksum Match</th><th>Cleanup</th><th>Stable?</th></tr></thead><tbody><tr><td>No</td><td>No</td><td>N/A</td><td>false</td><td>No (download needed)</td></tr><tr><td>Yes</td><td>No</td><td>Yes</td><td>false</td><td>No (extract needed)</td></tr><tr><td>Yes</td><td>Yes</td><td>Yes</td><td>false</td><td>Yes</td></tr><tr><td>No</td><td>Yes</td><td>N/A</td><td>true</td><td>Yes</td></tr><tr><td>Yes</td><td>Yes</td><td>Yes</td><td>true</td><td>No (cleanup needed)</td></tr></tbody></table><h2 id=checksum-verification>Checksum Verification<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p><strong>Algorithm:</strong> SHA-256</p><p><strong>Implementation:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>sum</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>Sha256HashFile</span>(<span style=color:#a6e22e>tempFile</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sum</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Checksum</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;checksum mismatch, expected %q got %q&#34;</span>, <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Checksum</span>, <span style=color:#a6e22e>sum</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p><strong>Timing:</strong> Checksum is verified after download completes but before the atomic rename. This ensures:</p><ul><li>Corrupted downloads are never placed at the target path</li><li>Temp file is cleaned up on mismatch</li><li>Clear error message with both expected and actual checksums</li></ul><h2 id=security-considerations>Security Considerations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=credential-handling>Credential Handling<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><ul><li>Credentials in URL are redacted in log messages via <code>util.RedactUrlCredentials()</code></li><li>Basic Auth header is set by Go&rsquo;s <code>http.Request.SetBasicAuth()</code>, not manually constructed</li></ul><h3 id=archive-extraction>Archive Extraction<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><ul><li>Extraction uses system <code>tar</code>/<code>unzip</code> commands</li><li>No path traversal protection beyond what the tools provide</li><li><code>ExtractParent</code> must be an absolute path (validated in model)</li></ul><h3 id=temporary-files>Temporary Files<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><ul><li>Created with <code>os.CreateTemp()</code> using pattern <code>&lt;archive-name>-*</code></li><li>Deferred removal ensures cleanup on all exit paths</li><li>Ownership set before content written</li></ul><h2 id=platform-support>Platform Support<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The provider is Unix-only due to:</p><ul><li>Dependency on <code>util.GetFileOwner()</code> which uses syscall for UID/GID resolution</li><li>Dependency on <code>util.ChownFile()</code> for ownership management</li></ul><h2 id=timeouts>Timeouts<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Operation</th><th>Timeout</th><th>Configurable</th></tr></thead><tbody><tr><td>HTTP Download</td><td>1 minute (default in <code>HttpGetResponse</code>)</td><td>No</td></tr><tr><td>Archive Extraction</td><td>1 minute</td><td>No</td></tr></tbody></table><p>Large archives may require increased timeouts in future versions.</p><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=exec-type>Exec Type</h1><p>This document describes the design of the exec resource type for executing commands.</p><h2 id=overview>Overview<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The exec resource executes commands with idempotency controls:</p><ul><li><strong>Creates</strong>: Skip execution if a file exists</li><li><strong>Refresh Only</strong>: Only execute when triggered by a subscribed resource</li><li><strong>Exit Codes</strong>: Validate success via configurable return codes</li></ul><h2 id=provider-interface>Provider Interface<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Exec providers must implement the <code>ExecProvider</code> interface:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ExecProvider</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Provider</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Execute</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>properties</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ExecResourceProperties</span>, <span style=color:#a6e22e>log</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Logger</span>) (<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Status</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>properties</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ExecResourceProperties</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ExecState</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=method-responsibilities>Method Responsibilities<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Method</th><th>Responsibility</th></tr></thead><tbody><tr><td><code>Status</code></td><td>Check if <code>creates</code> file exists, return current state</td></tr><tr><td><code>Execute</code></td><td>Run the command, return exit code</td></tr></tbody></table><h3 id=status-response>Status Response<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>Status</code> method returns an <code>ExecState</code> containing:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ExecState</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CommonResourceState</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ExitCode</span>         <span style=color:#f92672>*</span><span style=color:#66d9ef>int</span> <span style=color:#75715e>// Exit code from last execution (nil if not run)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CreatesSatisfied</span> <span style=color:#66d9ef>bool</span> <span style=color:#75715e>// Whether creates file exists</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>The <code>Ensure</code> field in <code>CommonResourceState</code> is set to:</p><ul><li><code>present</code> if the <code>creates</code> file exists</li><li><code>absent</code> if the <code>creates</code> file does not exist (or not specified)</li></ul><h2 id=available-providers>Available Providers<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Provider</th><th>Execution Method</th><th>Documentation</th></tr></thead><tbody><tr><td><code>posix</code></td><td>Direct exec (no shell)</td><td><a href=/design/exec/posix/index.html>Posix</a></td></tr><tr><td><code>shell</code></td><td>Via <code>/bin/sh -c</code></td><td><a href=/design/exec/shell/index.html>Shell</a></td></tr></tbody></table><h2 id=properties>Properties<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Property</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>command</code></td><td>string</td><td>Command to run (defaults to <code>name</code> if not set)</td></tr><tr><td><code>cwd</code></td><td>string</td><td>Working directory for command execution</td></tr><tr><td><code>environment</code></td><td>[]string</td><td>Additional environment variables (<code>KEY=value</code>)</td></tr><tr><td><code>path</code></td><td>string</td><td>Search path for executables (colon-separated)</td></tr><tr><td><code>returns</code></td><td>[]int</td><td>Acceptable exit codes (default: <code>[0]</code>)</td></tr><tr><td><code>timeout</code></td><td>string</td><td>Maximum execution time (e.g., <code>30s</code>, <code>5m</code>)</td></tr><tr><td><code>creates</code></td><td>string</td><td>File path; skip execution if exists</td></tr><tr><td><code>refresh_only</code></td><td>bool</td><td>Only execute via subscribe refresh</td></tr><tr><td><code>subscribe</code></td><td>[]string</td><td>Resources to watch for changes (<code>type#name</code>)</td></tr><tr><td><code>logoutput</code></td><td>bool</td><td>Log command output</td></tr></tbody></table><h2 id=apply-logic>Apply Logic<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Get current state via Status()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check for subscribe refresh             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Subscribed resource       â”‚
    â”‚ changed?                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              Yes â”‚         No
                  â–¼         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
          â”‚ Execute   â”‚     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Is desired state met?   â”‚
              â”‚ (creates file exists OR â”‚
              â”‚  refresh_only is true)  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        Yes â”‚         No
                            â–¼         â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
                    â”‚ Skip      â”‚     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                                      â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ Is refresh_only = true? â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  Yes â”‚         No
                                      â–¼         â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
                              â”‚ Skip      â”‚     â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                                                â–¼
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚ Execute   â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The exec resource provides idempotency through two mechanisms:</p><h3 id=creates-property>Creates Property<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>creates</code> property specifies a file that indicates successful prior execution:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>extract-archive</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>tar xzf /tmp/app.tar.gz -C /opt</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>creates</span>: <span style=color:#ae81ff>/opt/app/bin/app</span></span></span></code></pre></div><p><strong>Behavior:</strong></p><ul><li>If <code>/opt/app/bin/app</code> exists, skip execution</li><li>Useful for one-time setup commands</li><li>Provider checks file existence via <code>Status()</code></li></ul><h3 id=refresh-only-property>Refresh Only Property<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>refresh_only</code> property limits execution to subscribe refreshes:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>reload-nginx</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>systemctl reload nginx</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>refresh_only</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subscribe</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>file#/etc/nginx/nginx.conf</span></span></span></code></pre></div><p><strong>Behavior:</strong></p><ul><li>Command only runs when subscribed resource changes</li><li>Without a subscribe trigger, command is skipped</li><li>Useful for reload/restart commands</li></ul><h3 id=decision-table>Decision Table<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Condition</th><th>Action</th></tr></thead><tbody><tr><td>Subscribe triggered</td><td>Execute</td></tr><tr><td><code>creates</code> file exists</td><td>Skip</td></tr><tr><td><code>refresh_only: true</code> + no trigger</td><td>Skip</td></tr><tr><td><code>refresh_only: false</code> + no <code>creates</code></td><td>Execute</td></tr></tbody></table><h2 id=subscribe-behavior>Subscribe Behavior<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Exec resources can subscribe to other resources and execute when they change:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/etc/app/config.yaml</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>content</span>: <span style=color:#e6db74>&#34;...&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>reload-app</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>systemctl reload app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>refresh_only</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subscribe</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>file#/etc/app/config.yaml</span></span></span></code></pre></div><p>Subscribe takes precedence over other idempotency checks - if a subscribed resource changed, the command executes regardless of <code>creates</code> file existence.</p><h2 id=exit-code-validation>Exit Code Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>By default, exit code <code>0</code> indicates success. The <code>returns</code> property customizes acceptable codes:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>check-status</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>/usr/local/bin/check-health</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>returns</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>2</span></span></span></code></pre></div><p><strong>Behavior:</strong></p><ul><li>Command succeeds if exit code is in <code>returns</code> list</li><li>Command fails if exit code is not in <code>returns</code> list</li><li>Used for desired state validation after execution</li></ul><h2 id=noop-mode>Noop Mode<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>In noop mode, the exec type:</p><ol><li>Queries current state normally (checks <code>creates</code> file)</li><li>Evaluates subscribe triggers</li><li>Logs what actions would be taken</li><li>Sets appropriate <code>NoopMessage</code>:<ul><li>&ldquo;Would have executed&rdquo;</li><li>&ldquo;Would have executed via subscribe&rdquo;</li></ul></li><li>Reports <code>Changed: true</code> if execution would occur</li><li>Does not call provider <code>Execute</code> method</li></ol><h2 id=desired-state-validation>Desired State Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>After execution (in non-noop mode), the type verifies success:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Type</span>) <span style=color:#a6e22e>isDesiredState</span>(<span style=color:#a6e22e>properties</span>, <span style=color:#a6e22e>status</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Creates file check takes precedence</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Creates</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>CreatesSatisfied</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Refresh-only without execution is stable</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>ExitCode</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>RefreshOnly</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check exit code against acceptable returns</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>returns</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>int</span>{<span style=color:#ae81ff>0</span>}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Returns</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>returns</span> = <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Returns</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>ExitCode</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>slices</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>returns</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>ExitCode</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>If the exit code is not in the acceptable <code>returns</code> list, an <code>ErrDesiredStateFailed</code> error is returned.</p><h2 id=command-vs-name>Command vs Name<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The <code>command</code> property is optional. If not specified, the <code>name</code> is used as the command:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># These are equivalent:</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/usr/bin/myapp --config /etc/myapp.conf</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>run-myapp</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>/usr/bin/myapp --config /etc/myapp.conf</span></span></span></code></pre></div><p>Using a descriptive <code>name</code> with explicit <code>command</code> is recommended for clarity.</p><h2 id=environment-and-path>Environment and Path<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Commands can be configured with custom environment:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>build-app</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>make build</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>cwd</span>: <span style=color:#ae81ff>/opt/app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>CC=gcc</span>
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>CFLAGS=-O2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/usr/local/bin:/usr/bin:/bin</span></span></span></code></pre></div><p><strong>Environment:</strong></p><ul><li>Added to the command&rsquo;s environment</li><li>Format: <code>KEY=value</code></li><li>Does not replace existing environment</li></ul><p><strong>Path:</strong></p><ul><li>Sets the <code>PATH</code> for executable lookup</li><li>Must be absolute directories</li><li>Colon-separated list</li></ul><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Exec Type</h1><article class=default><header class=headline></header><h1 id=posix-provider>Posix Provider</h1><p>This document describes the implementation details of the Posix exec provider for executing commands without a shell.</p><h2 id=provider-selection>Provider Selection<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The Posix provider is the default exec provider. It is always available and returns priority 1 for all exec resources unless a different provider is explicitly requested via the <code>provider</code> property.</p><p>To use the shell provider instead, specify <code>provider: shell</code> in the resource properties.</p><h2 id=comparison-with-shell-provider>Comparison with Shell Provider<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Feature</th><th>Posix</th><th>Shell</th></tr></thead><tbody><tr><td>Shell invocation</td><td>No</td><td>Yes (<code>/bin/sh -c</code>)</td></tr><tr><td>Pipes (<code>|</code>)</td><td>Not supported</td><td>Supported</td></tr><tr><td>Redirections (<code>></code>, <code>&lt;</code>)</td><td>Not supported</td><td>Supported</td></tr><tr><td>Shell builtins (<code>cd</code>, <code>export</code>)</td><td>Not supported</td><td>Supported</td></tr><tr><td>Glob expansion</td><td>Not supported</td><td>Supported</td></tr><tr><td>Command substitution (<code>$(...)</code>)</td><td>Not supported</td><td>Supported</td></tr><tr><td>Argument parsing</td><td><code>shellquote.Split()</code></td><td>Passed as single string</td></tr><tr><td>Security</td><td>Lower attack surface</td><td>Shell injection possible</td></tr></tbody></table><p><strong>When to use Posix (default):</strong></p><ul><li>Simple commands with arguments</li><li>When shell features are not needed</li><li>For better security (no shell injection risk)</li></ul><p><strong>When to use Shell:</strong></p><ul><li>Commands with pipes, redirections, or shell builtins</li><li>Complex command strings</li><li>When shell expansion is required</li></ul><h2 id=operations>Operations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=execute>Execute<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Determine command source (<code>Command</code> property or <code>Name</code> if <code>Command</code> is empty)</li><li>Parse command string into words using <code>shellquote.Split()</code></li><li>Extract command (first word) and arguments (remaining words)</li><li>Execute via <code>CommandRunner.ExecuteWithOptions()</code></li><li>Optionally log output line-by-line if <code>LogOutput</code> is enabled</li></ol><p><strong>Command Parsing:</strong></p><p>The command string is parsed using <code>github.com/kballard/go-shellquote</code>, which handles:</p><table><thead><tr><th>Syntax</th><th>Example</th><th>Result</th></tr></thead><tbody><tr><td>Simple words</td><td><code>echo hello world</code></td><td><code>["echo", "hello", "world"]</code></td></tr><tr><td>Single quotes</td><td><code>echo 'hello world'</code></td><td><code>["echo", "hello world"]</code></td></tr><tr><td>Double quotes</td><td><code>echo "hello world"</code></td><td><code>["echo", "hello world"]</code></td></tr><tr><td>Escaped spaces</td><td><code>echo hello\ world</code></td><td><code>["echo", "hello world"]</code></td></tr><tr><td>Mixed quoting</td><td><code>echo "it's a test"</code></td><td><code>["echo", "it's a test"]</code></td></tr></tbody></table><p><strong>Execution Options:</strong></p><table><thead><tr><th>Option</th><th>Source</th><th>Description</th></tr></thead><tbody><tr><td><code>Command</code></td><td>First word after parsing</td><td>Executable path or name</td></tr><tr><td><code>Args</code></td><td>Remaining words</td><td>Command arguments</td></tr><tr><td><code>Cwd</code></td><td><code>properties.Cwd</code></td><td>Working directory</td></tr><tr><td><code>Environment</code></td><td><code>properties.Environment</code></td><td>Additional env vars (<code>KEY=VALUE</code> format)</td></tr><tr><td><code>Path</code></td><td><code>properties.Path</code></td><td>Search path for executables</td></tr><tr><td><code>Timeout</code></td><td><code>properties.ParsedTimeout</code></td><td>Maximum execution time</td></tr></tbody></table><p><strong>Output Logging:</strong></p><p>When <code>LogOutput: true</code> is set and a user logger is provided:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>scanner</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>NewScanner</span>(<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>stdout</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Each line of stdout is logged as a separate <code>Info</code> message.</p><p><strong>Error Handling:</strong></p><table><thead><tr><th>Condition</th><th>Behavior</th></tr></thead><tbody><tr><td>Empty command string</td><td>Return error: &ldquo;no command specified&rdquo;</td></tr><tr><td>Invalid shell quoting</td><td>Return parsing error (e.g., &ldquo;Unterminated single quote&rdquo;)</td></tr><tr><td>Runner not configured</td><td>Return error: &ldquo;no command runner configured&rdquo;</td></tr><tr><td>Command execution fails</td><td>Return error from runner</td></tr><tr><td>Non-zero exit code</td><td>Return exit code (not an error by itself)</td></tr></tbody></table><h3 id=status>Status<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Create state with <code>EnsurePresent</code> (exec resources are always &ldquo;present&rdquo;)</li><li>Check if <code>Creates</code> file exists via <code>util.FileExists()</code></li><li>Set <code>CreatesSatisfied</code> accordingly</li></ol><p><strong>State Fields:</strong></p><table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody><tr><td><code>Protocol</code></td><td><code>io.choria.ccm.v1.resource.exec.state</code></td></tr><tr><td><code>ResourceType</code></td><td><code>exec</code></td></tr><tr><td><code>Name</code></td><td>Resource name</td></tr><tr><td><code>Ensure</code></td><td><code>present</code> (always)</td></tr><tr><td><code>CreatesSatisfied</code></td><td><code>true</code> if <code>Creates</code> file exists</td></tr></tbody></table><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The exec resource achieves idempotency through multiple mechanisms:</p><h3 id=creates-file>Creates File<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>If <code>creates</code> is specified and the file exists, the command does not run:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/usr/bin/tar -xzf app.tar.gz</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>creates</span>: <span style=color:#ae81ff>/opt/app/bin/app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>cwd</span>: <span style=color:#ae81ff>/opt</span></span></span></code></pre></div><h3 id=refreshonly-mode>RefreshOnly Mode<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>When <code>refreshonly: true</code>, the command only runs when triggered by a subscribed resource:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>systemctl reload httpd</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>refreshonly</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subscribe</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>file#/etc/httpd/conf/httpd.conf</span></span></span></code></pre></div><h3 id=exit-code-validation>Exit Code Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>returns</code> property specifies acceptable exit codes (default: <code>[0]</code>):</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/opt/app/healthcheck</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>returns</span>: [<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>]  <span style=color:#75715e># 0=healthy, 1=degraded, 2=warning</span></span></span></code></pre></div><h2 id=decision-flow>Decision Flow<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Should resource be applied?             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Subscribe triggered?                     â”‚
â”‚ (subscribed resource changed)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ Yes           â”‚ No
              â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Execute command â”‚   â”‚ Creates satisfied? â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ Yes               â”‚ No
                      â–¼                   â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Skip (stable) â”‚   â”‚ RefreshOnly mode? â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ Yes               â”‚ No
                                  â–¼                   â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ Skip (stable) â”‚   â”‚ Execute       â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><h2 id=properties-validation>Properties Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The model validates exec properties before execution:</p><table><thead><tr><th>Property</th><th>Validation</th></tr></thead><tbody><tr><td><code>name</code></td><td>Must be parseable by shellquote (balanced quotes)</td></tr><tr><td><code>timeout</code></td><td>Must be valid duration format (e.g., <code>30s</code>, <code>5m</code>)</td></tr><tr><td><code>subscribe</code></td><td>Each entry must be <code>type#name</code> format</td></tr><tr><td><code>path</code></td><td>Each directory must be absolute (start with <code>/</code>)</td></tr><tr><td><code>environment</code></td><td>Each entry must be <code>KEY=VALUE</code> format with non-empty key and value</td></tr></tbody></table><h2 id=platform-support>Platform Support<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The Posix provider works on all platforms supported by Go&rsquo;s <code>os/exec</code> package. It does not use any platform-specific system calls directly.</p><p>The command runner (<code>model.CommandRunner</code>) handles the actual process execution, which may have platform-specific implementations.</p><h2 id=security-considerations>Security Considerations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=no-shell-injection>No Shell Injection<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Unlike the shell provider, the posix provider does not invoke a shell. Arguments are passed directly to the executable, preventing shell injection attacks:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Safe with posix provider - $USER is passed literally, not expanded</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/bin/echo $USER</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>posix </span> <span style=color:#75715e># Default</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Potentially dangerous with shell provider - $USER is expanded</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/bin/echo $USER</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span></span></span></code></pre></div><h3 id=path-validation>Path Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>path</code> property only accepts absolute directory paths, preventing path traversal via relative paths.</p><h3 id=environment-validation>Environment Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Environment variables must have non-empty keys and values, preventing injection of empty or malformed entries.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=shell-provider>Shell Provider</h1><p>This document describes the implementation details of the Shell exec provider for executing commands via <code>/bin/sh</code>.</p><h2 id=provider-selection>Provider Selection<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The Shell provider is selected when <code>provider: shell</code> is explicitly specified in the resource properties. It has a lower priority (99) than the Posix provider (1), so it is never automatically selected.</p><p><strong>Availability:</strong> The provider checks for the existence of <code>/bin/sh</code> via <code>util.FileExists()</code>. If <code>/bin/sh</code> does not exist, the provider is not available.</p><h2 id=comparison-with-posix-provider>Comparison with Posix Provider<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Feature</th><th>Shell</th><th>Posix</th></tr></thead><tbody><tr><td>Shell invocation</td><td>Yes (<code>/bin/sh -c</code>)</td><td>No</td></tr><tr><td>Pipes (<code>|</code>)</td><td>Supported</td><td>Not supported</td></tr><tr><td>Redirections (<code>></code>, <code>&lt;</code>, <code>>></code>)</td><td>Supported</td><td>Not supported</td></tr><tr><td>Shell builtins (<code>cd</code>, <code>export</code>, <code>source</code>)</td><td>Supported</td><td>Not supported</td></tr><tr><td>Glob expansion (<code>*.txt</code>, <code>?</code>)</td><td>Supported</td><td>Not supported</td></tr><tr><td>Command substitution (<code>$(...)</code>, <code>`...`</code>)</td><td>Supported</td><td>Not supported</td></tr><tr><td>Variable expansion (<code>$VAR</code>, <code>${VAR}</code>)</td><td>Supported</td><td>Not supported</td></tr><tr><td>Logical operators (<code>&&</code>, <code>||</code>)</td><td>Supported</td><td>Not supported</td></tr><tr><td>Argument parsing</td><td>Passed as single string</td><td><code>shellquote.Split()</code></td></tr><tr><td>Security</td><td>Shell injection possible</td><td>Lower attack surface</td></tr></tbody></table><p><strong>When to use Shell:</strong></p><ul><li>Commands with pipes: <code>cat file.txt | grep pattern | sort</code></li><li>Commands with redirections: <code>echo "data" > /tmp/file</code></li><li>Commands with shell builtins: <code>cd /tmp && pwd</code></li><li>Commands with variable expansion: <code>echo $HOME</code></li><li>Complex one-liners with logical operators</li></ul><p><strong>When to use Posix (default):</strong></p><ul><li>Simple commands with arguments</li><li>When shell features are not needed</li><li>For better security (no shell injection risk)</li></ul><h2 id=operations>Operations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=execute>Execute<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Determine command source (<code>Command</code> property or <code>Name</code> if <code>Command</code> is empty)</li><li>Validate command is not empty</li><li>Execute via <code>CommandRunner.ExecuteWithOptions()</code> with <code>/bin/sh -c "&lt;command>"</code></li><li>Optionally log output line-by-line if <code>LogOutput</code> is enabled</li></ol><p><strong>Execution Method:</strong></p><p>The entire command string is passed to the shell as a single argument:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>/bin/sh -c &#34;&lt;entire command string&gt;&#34;</code></pre></div><p>This allows the shell to interpret all shell syntax, including:</p><ul><li>Pipes and redirections</li><li>Variable expansion</li><li>Glob patterns</li><li>Command substitution</li><li>Logical operators</li></ul><p><strong>Execution Options:</strong></p><table><thead><tr><th>Option</th><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Command</code></td><td><code>/bin/sh</code></td><td>Shell executable path</td></tr><tr><td><code>Args</code></td><td><code>["-c", "&lt;command>"]</code></td><td>Shell flag and command string</td></tr><tr><td><code>Cwd</code></td><td><code>properties.Cwd</code></td><td>Working directory</td></tr><tr><td><code>Environment</code></td><td><code>properties.Environment</code></td><td>Additional env vars (<code>KEY=VALUE</code> format)</td></tr><tr><td><code>Path</code></td><td><code>properties.Path</code></td><td>Search path for executables</td></tr><tr><td><code>Timeout</code></td><td><code>properties.ParsedTimeout</code></td><td>Maximum execution time</td></tr></tbody></table><p><strong>Output Logging:</strong></p><p>When <code>LogOutput: true</code> is set and a user logger is provided:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>scanner</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>NewScanner</span>(<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>stdout</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Each line of stdout is logged as a separate <code>Info</code> message.</p><p><strong>Error Handling:</strong></p><table><thead><tr><th>Condition</th><th>Behavior</th></tr></thead><tbody><tr><td>Empty command string</td><td>Return error: &ldquo;no command to execute&rdquo;</td></tr><tr><td>Runner not configured</td><td>Return error: &ldquo;no command runner configured&rdquo;</td></tr><tr><td>Shell not found</td><td>Provider not available (checked at selection time)</td></tr><tr><td>Command execution fails</td><td>Return error from runner</td></tr><tr><td>Non-zero exit code</td><td>Return exit code (not an error by itself)</td></tr></tbody></table><h3 id=status>Status<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Create state with <code>EnsurePresent</code> (exec resources are always &ldquo;present&rdquo;)</li><li>Check if <code>Creates</code> file exists via <code>util.FileExists()</code></li><li>Set <code>CreatesSatisfied</code> accordingly</li></ol><p><strong>State Fields:</strong></p><table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody><tr><td><code>Protocol</code></td><td><code>io.choria.ccm.v1.resource.exec.state</code></td></tr><tr><td><code>ResourceType</code></td><td><code>exec</code></td></tr><tr><td><code>Name</code></td><td>Resource name</td></tr><tr><td><code>Ensure</code></td><td><code>present</code> (always)</td></tr><tr><td><code>CreatesSatisfied</code></td><td><code>true</code> if <code>Creates</code> file exists</td></tr></tbody></table><h2 id=use-cases>Use Cases<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=pipes-and-filters>Pipes and Filters<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>filter-logs</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>cat /var/log/app.log | grep ERROR | tail -100 &gt; /tmp/errors.txt</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>creates</span>: <span style=color:#ae81ff>/tmp/errors.txt</span></span></span></code></pre></div><h3 id=conditional-execution>Conditional Execution<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>ensure-running</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>pgrep myapp || /opt/myapp/bin/start</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span></span></span></code></pre></div><h3 id=complex-scripts>Complex Scripts<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>deploy-app</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          cd /opt/app &amp;&amp;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          git pull origin main &amp;&amp;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          npm install &amp;&amp;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          npm run build &amp;&amp;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          systemctl restart app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>5m</span></span></span></code></pre></div><h3 id=variable-expansion>Variable Expansion<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>backup-home</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>tar -czf /backup/home-$(date +%Y%m%d).tar.gz $HOME</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span></span></span></code></pre></div><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The shell provider uses the same idempotency mechanisms as the posix provider:</p><h3 id=creates-file>Creates File<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>If <code>creates</code> is specified and the file exists, the command does not run:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>extract-archive</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>cd /opt &amp;&amp; tar -xzf /tmp/app.tar.gz</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>creates</span>: <span style=color:#ae81ff>/opt/app/bin/app</span></span></span></code></pre></div><h3 id=refreshonly-mode>RefreshOnly Mode<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>When <code>refreshonly: true</code>, the command only runs when triggered by a subscribed resource:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>reload-nginx</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>nginx -t &amp;&amp; systemctl reload nginx</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>refreshonly</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subscribe</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>file#/etc/nginx/nginx.conf</span></span></span></code></pre></div><h3 id=exit-code-validation>Exit Code Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>returns</code> property specifies acceptable exit codes (default: <code>[0]</code>):</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>check-service</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>systemctl is-active myapp || true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>returns</span>: [<span style=color:#ae81ff>0</span>]</span></span></code></pre></div><h2 id=security-considerations>Security Considerations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=shell-injection-risk>Shell Injection Risk<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The shell provider passes the command string directly to <code>/bin/sh</code>, making it vulnerable to shell injection if user input is incorporated:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># DANGEROUS if filename comes from untrusted input</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>process-file</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>cat {{ user_provided_filename }} | process</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span></span></span></code></pre></div><p><strong>Mitigations:</strong></p><ul><li>Validate and sanitize any templated values</li><li>Use the posix provider when shell features aren&rsquo;t needed</li><li>Prefer explicit file paths over user-provided values</li></ul><h3 id=environment-variable-exposure>Environment Variable Exposure<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Shell commands can access environment variables, including sensitive ones:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># $SECRET_KEY will be expanded by the shell</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>use-secret</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>myapp --key=$SECRET_KEY</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span></span></span></code></pre></div><p>Consider using the <code>environment</code> property to explicitly pass required variables rather than relying on inherited environment.</p><h3 id=command-logging>Command Logging<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The full command string (including any expanded variables) may appear in logs. Avoid embedding secrets directly in commands:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># BAD - password visible in logs</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>bad-example</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>mysql -p&#39;secret123&#39; -e &#39;SELECT 1&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># BETTER - use environment variable</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>better-example</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>mysql -p&#34;$MYSQL_PWD&#34; -e &#39;SELECT 1&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>MYSQL_PWD={{ lookup(&#39;data.mysql_password&#39;) }}</span></span></span></code></pre></div><h2 id=platform-support>Platform Support<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The shell provider requires <code>/bin/sh</code> to be available. This is standard on:</p><ul><li>Linux distributions</li><li>macOS</li><li>BSD variants</li><li>Most Unix-like systems</li></ul><p>On Windows, the provider will not be available unless <code>/bin/sh</code> exists (e.g., via WSL or Cygwin).</p><h2 id=shell-compatibility>Shell Compatibility<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The provider uses <code>/bin/sh</code>, which is typically:</p><ul><li><strong>Linux:</strong> Often a symlink to <code>bash</code>, <code>dash</code>, or another POSIX-compliant shell</li><li><strong>macOS:</strong> <code>/bin/sh</code> is <code>bash</code> (older) or <code>zsh</code> (newer) in POSIX mode</li><li><strong>BSD:</strong> Usually <code>ash</code> or similar</li></ul><p>For maximum portability, use POSIX shell syntax and avoid bash-specific features like:</p><ul><li>Arrays (<code>arr=(1 2 3)</code>)</li><li><code>[[</code> conditionals (use <code>[</code> instead)</li><li><code>source</code> (use <code>.</code> instead)</li><li>Process substitution (<code>&lt;(command)</code>)</li></ul><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=file-type>File Type</h1><p>This document describes the design of the file resource type for managing files and directories.</p><h2 id=overview>Overview<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The file resource manages files and directories with three aspects:</p><ul><li><strong>Existence</strong>: Whether the file/directory exists or is absent</li><li><strong>Content</strong>: The contents of a file (from inline content or source file)</li><li><strong>Attributes</strong>: Owner, group, and permissions</li></ul><h2 id=provider-interface>Provider Interface<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>File providers must implement the <code>FileProvider</code> interface:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FileProvider</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Provider</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CreateDirectory</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>dir</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>owner</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>group</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>mode</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>file</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>contents</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>source</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>owner</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>group</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>mode</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Status</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>file</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>FileState</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=method-responsibilities>Method Responsibilities<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Method</th><th>Responsibility</th></tr></thead><tbody><tr><td><code>Status</code></td><td>Query current file state (existence, type, content hash, attributes)</td></tr><tr><td><code>Store</code></td><td>Create or update a file with content and attributes</td></tr><tr><td><code>CreateDirectory</code></td><td>Create a directory with attributes</td></tr></tbody></table><h3 id=status-response>Status Response<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>Status</code> method returns a <code>FileState</code> containing:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FileState</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CommonResourceState</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Metadata</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>FileMetadata</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FileMetadata</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>     <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// File path</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Checksum</span> <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// SHA256 hash of contents (files only)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Owner</span>    <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Owner username</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Group</span>    <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Group name</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Mode</span>     <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Permissions in octal (e.g., &#34;0644&#34;)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Provider</span> <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Provider name (e.g., &#34;posix&#34;)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MTime</span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>      <span style=color:#75715e>// Modification time</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Size</span>     <span style=color:#66d9ef>int64</span>          <span style=color:#75715e>// File size in bytes</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Extended</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>any</span> <span style=color:#75715e>// Provider-specific metadata</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>The <code>Ensure</code> field in <code>CommonResourceState</code> is set to:</p><ul><li><code>present</code> if a regular file exists</li><li><code>directory</code> if a directory exists</li><li><code>absent</code> if the path does not exist</li></ul><h2 id=available-providers>Available Providers<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Provider</th><th>Platform</th><th>Documentation</th></tr></thead><tbody><tr><td><code>posix</code></td><td>Unix/Linux</td><td><a href=/design/file/posix/index.html>Posix</a></td></tr></tbody></table><h2 id=ensure-states>Ensure States<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>present</code></td><td>Path must be a regular file with specified content</td></tr><tr><td><code>absent</code></td><td>Path must not exist</td></tr><tr><td><code>directory</code></td><td>Path must be a directory</td></tr></tbody></table><h2 id=content-sources>Content Sources<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Files can receive content from two mutually exclusive sources:</p><table><thead><tr><th>Property</th><th>Description</th></tr></thead><tbody><tr><td><code>contents</code></td><td>Inline string content (template-resolved)</td></tr><tr><td><code>source</code></td><td>Path to local file to copy from</td></tr></tbody></table><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Inline content with template</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/etc/motd</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>content</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          Welcome to {{ lookup(&#39;facts.hostname&#39;) }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          Managed by CCM</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>mode</span>: <span style=color:#e6db74>&#34;0644&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Copy from source file</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/etc/app/config.yaml</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>source</span>: <span style=color:#ae81ff>files/config.yaml</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>mode</span>: <span style=color:#e6db74>&#34;0640&#34;</span></span></span></code></pre></div><p>When using <code>source</code>, the path is relative to the manifest&rsquo;s working directory if one is set.</p><h2 id=required-properties>Required Properties<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Unlike some resources, file resources require explicit attributes:</p><table><thead><tr><th>Property</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>owner</code></td><td>Yes</td><td>Username that owns the file</td></tr><tr><td><code>group</code></td><td>Yes</td><td>Group that owns the file</td></tr><tr><td><code>mode</code></td><td>Yes</td><td>Permissions in octal notation</td></tr></tbody></table><p>This prevents accidental creation of files with default or inherited permissions.</p><h2 id=apply-logic>Apply Logic<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Get current state via Status()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Is current state desired state?         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              Yes â”‚         No
                  â–¼         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
          â”‚ No change â”‚     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ What is desired ensure? â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ absent                â”‚ directory             â”‚ present
    â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Remove     â”‚      â”‚ CreateDir     â”‚      â”‚ Store         â”‚
â”‚ (os.Remove)â”‚      â”‚               â”‚      â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The file resource checks multiple attributes for idempotency:</p><h3 id=state-checks-in-order>State Checks (in order)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><ol><li><strong>Ensure match</strong>: Current type matches desired (<code>present</code>/<code>absent</code>/<code>directory</code>)</li><li><strong>Content match</strong>: SHA256 checksum of contents matches (for <code>ensure: present</code>)</li><li><strong>Owner match</strong>: Current owner matches desired</li><li><strong>Group match</strong>: Current group matches desired</li><li><strong>Mode match</strong>: Current permissions match desired</li></ol><h3 id=decision-table>Decision Table<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Desired</th><th>Current State</th><th>Action</th></tr></thead><tbody><tr><td><code>absent</code></td><td>absent</td><td>None</td></tr><tr><td><code>absent</code></td><td>present/directory</td><td>Remove</td></tr><tr><td><code>directory</code></td><td>directory + matching attrs</td><td>None</td></tr><tr><td><code>directory</code></td><td>absent/present</td><td>CreateDirectory</td></tr><tr><td><code>directory</code></td><td>directory + wrong attrs</td><td>CreateDirectory (updates attrs)</td></tr><tr><td><code>present</code></td><td>present + matching all</td><td>None</td></tr><tr><td><code>present</code></td><td>absent</td><td>Store</td></tr><tr><td><code>present</code></td><td>present + wrong content</td><td>Store</td></tr><tr><td><code>present</code></td><td>present + wrong attrs</td><td>Store</td></tr></tbody></table><h3 id=content-comparison>Content Comparison<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Content is compared using SHA256 checksums:</p><table><thead><tr><th>Source</th><th>Checksum Method</th></tr></thead><tbody><tr><td><code>contents</code> property</td><td><code>Sha256HashBytes([]byte(contents))</code></td></tr><tr><td><code>source</code> property</td><td><code>Sha256HashFile(adjustedPath)</code></td></tr><tr><td>Existing file</td><td><code>Sha256HashFile(filePath)</code></td></tr></tbody></table><h2 id=mode-validation>Mode Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>File modes are validated during resource creation:</p><p><strong>Valid Formats:</strong></p><ul><li><code>"0644"</code> - Standard octal</li><li><code>"644"</code> - Without leading zero</li><li><code>"0o755"</code> - With <code>0o</code> prefix</li><li><code>"0O700"</code> - With <code>0O</code> prefix</li></ul><p><strong>Validation Rules:</strong></p><ul><li>Must be valid octal number (digits 0-7)</li><li>Must be â‰¤ <code>0777</code> (no setuid/setgid/sticky via mode)</li></ul><h2 id=path-validation>Path Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>File paths must be:</p><ul><li>Absolute (start with <code>/</code>)</li><li>Clean (no <code>.</code> or <code>..</code> components, <code>filepath.Clean(path) == path</code>)</li></ul><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Clean</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Name</span>) <span style=color:#f92672>!=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Name</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;file path must be absolute&#34;</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h2 id=working-directory>Working Directory<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>When a manifest has a working directory (e.g., extracted from an archive), the <code>source</code> property is resolved relative to it:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Source</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>mgr</span>.<span style=color:#a6e22e>WorkingDirectory</span>() <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>source</span> = <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>mgr</span>.<span style=color:#a6e22e>WorkingDirectory</span>(), <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Source</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>This allows manifests bundled with their source files to use relative paths.</p><h2 id=noop-mode>Noop Mode<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>In noop mode, the file type:</p><ol><li>Queries current state normally</li><li>Computes content checksums</li><li>Logs what actions would be taken</li><li>Sets appropriate <code>NoopMessage</code>:<ul><li>&ldquo;Would have created the file&rdquo;</li><li>&ldquo;Would have created directory&rdquo;</li><li>&ldquo;Would have removed the file&rdquo;</li></ul></li><li>Reports <code>Changed: true</code> if changes would occur</li><li>Does not call provider Store/CreateDirectory methods</li><li>Does not remove files</li></ol><h2 id=desired-state-validation>Desired State Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>After applying changes (in non-noop mode), the type verifies the file reached the desired state by calling <code>Status()</code> again and checking all attributes match. If validation fails, <code>ErrDesiredStateFailed</code> is returned.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of File Type</h1><article class=default><header class=headline></header><h1 id=posix-provider>Posix Provider</h1><p>This document describes the implementation details of the Posix file provider for managing files and directories on Unix-like systems.</p><h2 id=provider-selection>Provider Selection<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The Posix provider is the default and only file provider. It is always available and returns priority 1 for all file resources.</p><h2 id=operations>Operations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=store-createupdate-file>Store (Create/Update File)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Verify parent directory exists</li><li>Parse file mode from octal string</li><li>Open source file if <code>source</code> property is set</li><li>Create temporary file in the same directory as target</li><li>Set file permissions on temp file</li><li>Write content (from <code>source</code> file or <code>contents</code> property)</li><li>Set ownership (chown) on temp file</li><li>Close temp file</li><li>Atomic rename temp file to target path</li></ol><p><strong>Atomic Write Pattern:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>[parent dir]/&lt;basename&gt;.* (temp file)
    â†“ chmod (set permissions)
    â†“ write content
    â†“ chown (set owner/group)
    â†“ close
    â†“ rename
[parent dir]/&lt;basename&gt; (final file)</code></pre></div><p>The temp file is created in the same directory as the target to ensure <code>os.Rename()</code> is atomic (same filesystem).</p><p><strong>Content Sources:</strong></p><table><thead><tr><th>Property</th><th>Behavior</th></tr></thead><tbody><tr><td><code>contents</code></td><td>Write string directly to file (template-resolved)</td></tr><tr><td><code>source</code></td><td>Copy from local file path (adjusted for working directory)</td></tr></tbody></table><p>If both are empty, an empty file is created.</p><p><strong>Error Handling:</strong></p><table><thead><tr><th>Condition</th><th>Behavior</th></tr></thead><tbody><tr><td>Parent directory doesn&rsquo;t exist</td><td>Return error: &ldquo;is not a directory&rdquo;</td></tr><tr><td>Invalid mode format</td><td>Return error from <code>strconv.ParseUint</code></td></tr><tr><td>Source file not found</td><td>Return error from <code>os.Open</code></td></tr><tr><td>Permission denied</td><td>Return error from underlying syscall</td></tr><tr><td>Rename failure</td><td>Return error: &ldquo;could not rename temporary file&rdquo;</td></tr></tbody></table><h3 id=createdirectory>CreateDirectory<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Parse file mode from octal string</li><li>Create directory and parents via <code>os.MkdirAll()</code></li><li>Lookup numeric UID/GID from owner/group names</li><li>Set permissions via <code>os.Chmod()</code> (ensures correct mode even if umask affected MkdirAll)</li><li>Set ownership via <code>os.Chown()</code></li></ol><p><strong>Command Sequence:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>MkdirAll</span>(<span style=color:#a6e22e>dir</span>, <span style=color:#a6e22e>parsedMode</span>)    <span style=color:#75715e>// Create directory tree</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Chmod</span>(<span style=color:#a6e22e>dir</span>, <span style=color:#a6e22e>parsedMode</span>)        <span style=color:#75715e>// Ensure correct permissions</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Chown</span>(<span style=color:#a6e22e>dir</span>, <span style=color:#a6e22e>uid</span>, <span style=color:#a6e22e>gid</span>)          <span style=color:#75715e>// Set ownership</span></span></span></code></pre></div><p>The explicit <code>Chmod</code> after <code>MkdirAll</code> is necessary because <code>MkdirAll</code> applies the process umask to the mode.</p><h3 id=status>Status<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Initialize state with default metadata</li><li>Call <code>os.Stat()</code> on file path</li><li>Based on result, populate state accordingly</li></ol><p><strong>State Detection:</strong></p><table><thead><tr><th><code>os.Stat()</code> Result</th><th>Ensure Value</th><th>Metadata</th></tr></thead><tbody><tr><td>File exists</td><td><code>present</code></td><td>Size, mtime, owner, group, mode, checksum</td></tr><tr><td>Directory exists</td><td><code>directory</code></td><td>Size, mtime, owner, group, mode</td></tr><tr><td><code>os.ErrNotExist</code></td><td><code>absent</code></td><td>None</td></tr><tr><td><code>os.ErrPermission</code></td><td><code>absent</code></td><td>None (logged as warning)</td></tr><tr><td>Other error</td><td>(unchanged)</td><td>None (logged as warning)</td></tr></tbody></table><p><strong>Metadata Collection:</strong></p><table><thead><tr><th>Field</th><th>Source</th></tr></thead><tbody><tr><td><code>Name</code></td><td>From properties</td></tr><tr><td><code>Provider</code></td><td>&ldquo;posix&rdquo;</td></tr><tr><td><code>Size</code></td><td><code>FileInfo.Size()</code></td></tr><tr><td><code>MTime</code></td><td><code>FileInfo.ModTime()</code></td></tr><tr><td><code>Owner</code></td><td><code>util.GetFileOwner()</code> - resolves UID to username</td></tr><tr><td><code>Group</code></td><td><code>util.GetFileOwner()</code> - resolves GID to group name</td></tr><tr><td><code>Mode</code></td><td><code>util.GetFileOwner()</code> - octal string (e.g., &ldquo;0644&rdquo;)</td></tr><tr><td><code>Checksum</code></td><td><code>util.Sha256HashFile()</code> - SHA256 hash (files only)</td></tr></tbody></table><p><strong>Note:</strong> Checksum is only calculated for regular files, not directories.</p><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The file resource achieves idempotency by comparing current state against desired state:</p><h3 id=state-checks>State Checks<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>isDesiredState()</code> function checks (in order):</p><ol><li><strong>Ensure value matches</strong> - <code>present</code>, <code>absent</code>, or <code>directory</code></li><li><strong>Content checksum matches</strong> - SHA256 of contents vs existing file (for files only)</li><li><strong>Owner matches</strong> - Username comparison</li><li><strong>Group matches</strong> - Group name comparison</li><li><strong>Mode matches</strong> - Octal permission string comparison</li></ol><h3 id=decision-flow>Decision Flow<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ What is the desired ensure state?       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ absent      â”‚ directory   â”‚ present     â”‚
    â–¼             â–¼             â–¼             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ File      â”‚ â”‚ Directory â”‚ â”‚ File exists?  â”‚ â”‚
â”‚ exists?   â”‚ â”‚ exists?   â”‚ â”‚ Content match?â”‚ â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚ Owner match?  â”‚ â”‚
      â”‚             â”‚       â”‚ Group match?  â”‚ â”‚
  Yes â”‚ No      Yes â”‚ No    â”‚ Mode match?   â”‚ â”‚
      â–¼             â–¼       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚         â”‚
â”‚ Remove  â”‚ â”‚ Stable    â”‚     All Yesâ”‚    No   â”‚
â”‚ file    â”‚ â”‚           â”‚           â–¼         â–¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ Stable    â”‚ â”‚ Store     â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><h3 id=content-comparison>Content Comparison<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>For files with <code>ensure: present</code>:</p><table><thead><tr><th>Content Source</th><th>Checksum Calculation</th></tr></thead><tbody><tr><td><code>contents</code> property</td><td><code>Sha256HashBytes([]byte(contents))</code></td></tr><tr><td><code>source</code> property</td><td><code>Sha256HashFile(adjustedSourcePath)</code></td></tr></tbody></table><p>The source path is adjusted based on the manager&rsquo;s working directory when set.</p><h2 id=mode-validation>Mode Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>File modes are validated during resource creation:</p><ol><li>Strip optional <code>0o</code> or <code>0O</code> prefix</li><li>Parse as octal number (base 8)</li><li>Validate range: must be â‰¤ <code>0777</code></li></ol><p><strong>Valid Mode Examples:</strong></p><table><thead><tr><th>Input</th><th>Parsed Value</th></tr></thead><tbody><tr><td><code>"0644"</code></td><td>0o644</td></tr><tr><td><code>"644"</code></td><td>0o644</td></tr><tr><td><code>"0o755"</code></td><td>0o755</td></tr><tr><td><code>"0O700"</code></td><td>0o700</td></tr></tbody></table><p><strong>Invalid Mode Examples:</strong></p><table><thead><tr><th>Input</th><th>Error</th></tr></thead><tbody><tr><td><code>"0888"</code></td><td>Invalid octal digit</td></tr><tr><td><code>"1777"</code></td><td>Exceeds maximum (setuid/setgid not supported via mode)</td></tr><tr><td><code>"rw-r--r--"</code></td><td>Not octal format</td></tr></tbody></table><h2 id=ownership-resolution>Ownership Resolution<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Owner and group names are resolved to numeric UID/GID via:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>uid</span>, <span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>LookupOwnerGroup</span>(<span style=color:#a6e22e>owner</span>, <span style=color:#a6e22e>group</span>)</span></span></code></pre></div><p>This uses the system&rsquo;s user database (<code>/etc/passwd</code>, <code>/etc/group</code>, or equivalent):</p><ul><li><code>user.Lookup(owner)</code> â†’ UID</li><li><code>user.LookupGroup(group)</code> â†’ GID</li></ul><p><strong>Error Handling:</strong></p><table><thead><tr><th>Condition</th><th>Behavior</th></tr></thead><tbody><tr><td>User not found</td><td>Return error: &ldquo;could not lookup user&rdquo;</td></tr><tr><td>Group not found</td><td>Return error: &ldquo;could not lookup group&rdquo;</td></tr><tr><td>Invalid UID/GID format</td><td>Return error from <code>strconv.Atoi</code></td></tr></tbody></table><h2 id=working-directory-support>Working Directory Support<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>When a manager has a working directory set (e.g., from extracted manifest), the <code>source</code> property path is adjusted:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Type</span>) <span style=color:#a6e22e>adjustedSource</span>(<span style=color:#a6e22e>properties</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>FileResourceProperties</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>source</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Source</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Source</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>mgr</span>.<span style=color:#a6e22e>WorkingDirectory</span>() <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>source</span> = <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>mgr</span>.<span style=color:#a6e22e>WorkingDirectory</span>(), <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Source</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>source</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>This allows manifests to use relative paths for source files bundled with the manifest.</p><h2 id=platform-support>Platform Support<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The Posix provider uses Unix-specific system calls:</p><table><thead><tr><th>Operation</th><th>System Call</th></tr></thead><tbody><tr><td>Get file owner/group</td><td><code>syscall.Stat_t</code> (UID/GID from stat)</td></tr><tr><td>Set ownership</td><td><code>os.Chown()</code> â†’ <code>chown(2)</code></td></tr><tr><td>Set permissions</td><td><code>os.Chmod()</code> â†’ <code>chmod(2)</code></td></tr></tbody></table><p>The provider has separate implementations for Unix and Windows (<code>file_unix.go</code>, <code>file_windows.go</code> in <code>internal/util</code>), with Windows returning errors for ownership operations.</p><h2 id=security-considerations>Security Considerations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=atomic-writes>Atomic Writes<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Files are written atomically via temp file + rename. This prevents:</p><ul><li>Partial file reads during write</li><li>Corruption if process is interrupted</li><li>Race conditions with concurrent readers</li></ul><h3 id=permission-ordering>Permission Ordering<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Permissions and ownership are set on the temp file before rename:</p><ol><li><code>Chmod</code> - Set permissions</li><li>Write content</li><li><code>Chown</code> - Set ownership</li><li>Rename to target</li></ol><p>This ensures the file never exists at the target path with incorrect permissions.</p><h3 id=path-validation>Path Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>File paths must be absolute and clean (no <code>.</code> or <code>..</code> components):</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Clean</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Name</span>) <span style=color:#f92672>!=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Name</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;file path must be absolute&#34;</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=required-properties>Required Properties<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Owner, group, and mode are required properties and cannot be empty, preventing accidental creation of files with default/inherited permissions.</p><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=package-type>Package Type</h1><p>This document describes the design of the package resource type for managing software packages.</p><h2 id=overview>Overview<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The package resource manages software packages with two aspects:</p><ul><li><strong>Existence</strong>: Whether the package is installed or absent</li><li><strong>Version</strong>: The specific version installed (when applicable)</li></ul><h2 id=provider-interface>Provider Interface<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Package providers must implement the <code>PackageProvider</code> interface:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PackageProvider</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Provider</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Install</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>pkg</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>version</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Upgrade</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>pkg</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>version</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Downgrade</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>pkg</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>version</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Uninstall</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>pkg</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Status</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>pkg</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>PackageState</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>VersionCmp</span>(<span style=color:#a6e22e>versionA</span>, <span style=color:#a6e22e>versionB</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>ignoreTrailingZeroes</span> <span style=color:#66d9ef>bool</span>) (<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=method-responsibilities>Method Responsibilities<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Method</th><th>Responsibility</th></tr></thead><tbody><tr><td><code>Status</code></td><td>Query current package state (installed version or absent)</td></tr><tr><td><code>Install</code></td><td>Install package at specified version (or latest if &ldquo;latest&rdquo;)</td></tr><tr><td><code>Upgrade</code></td><td>Upgrade package to specified version</td></tr><tr><td><code>Downgrade</code></td><td>Downgrade package to specified version</td></tr><tr><td><code>Uninstall</code></td><td>Remove the package</td></tr><tr><td><code>VersionCmp</code></td><td>Compare two version strings (-1, 0, 1)</td></tr></tbody></table><h3 id=status-response>Status Response<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>Status</code> method returns a <code>PackageState</code> containing:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PackageState</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CommonResourceState</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Metadata</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PackageMetadata</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PackageMetadata</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>        <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Package name</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Version</span>     <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Installed version</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Arch</span>        <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Architecture (e.g., &#34;x86_64&#34;)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>License</span>     <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Package license</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>URL</span>         <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Package URL</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Summary</span>     <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Short description</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Description</span> <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Full description</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Provider</span>    <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Provider name (e.g., &#34;dnf&#34;)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Extended</span>    <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>any</span> <span style=color:#75715e>// Provider-specific metadata</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>The <code>Ensure</code> field in <code>CommonResourceState</code> is set to:</p><ul><li>The installed version string if the package is installed</li><li><code>absent</code> if the package is not installed</li></ul><h2 id=available-providers>Available Providers<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Provider</th><th>Package Manager</th><th>Documentation</th></tr></thead><tbody><tr><td><code>dnf</code></td><td>DNF (Fedora/RHEL)</td><td><a href=/design/package/dnf/index.html>DNF</a></td></tr><tr><td><code>apt</code></td><td>APT (Debian/Ubuntu)</td><td><a href=/design/package/apt/index.html>APT</a></td></tr></tbody></table><h2 id=ensure-states>Ensure States<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>present</code></td><td>Package must be installed (any version)</td></tr><tr><td><code>absent</code></td><td>Package must not be installed</td></tr><tr><td><code>latest</code></td><td>Package must be upgraded to latest available</td></tr><tr><td><code>&lt;version></code></td><td>Package must be at specific version</td></tr></tbody></table><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Install any version</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>package</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>vim</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Install latest version</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>package</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>vim</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>latest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Install specific version</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>package</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>nginx</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#e6db74>&#34;1.24.0-1.el9&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Remove package</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>package</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>telnet</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>absent</span></span></span></code></pre></div><h2 id=apply-logic>Apply Logic<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=phase-1-handle-special-cases>Phase 1: Handle Special Cases<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Get current state via Status()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Is ensure = &#34;latest&#34;?                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              Yes â”‚         No
                  â–¼         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ Is package absent?  â”‚ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
              Yes â”‚     No  â”‚
                  â–¼     â–¼   â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚Install â”‚ â”‚Upgrade â”‚
          â”‚latest  â”‚ â”‚latest  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Is desired state met?   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        Yes â”‚         No
                            â–¼         â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
                    â”‚ No change â”‚     â–¼
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  (Phase 2)</code></pre></div><h3 id=phase-2-handle-ensure-values>Phase 2: Handle Ensure Values<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ What is desired ensure? â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ absent                â”‚ present               â”‚ &lt;version&gt;
    â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Uninstall  â”‚      â”‚ Is absent?    â”‚      â”‚ Is absent?    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                        Yes â”‚     No           Yes â”‚     No
                            â–¼     â–¼                â–¼     â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚Install â”‚ â”‚No      â”‚  â”‚Install â”‚ â”‚Compare     â”‚
                    â”‚        â”‚ â”‚change  â”‚  â”‚version â”‚ â”‚versions    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                            â”‚
                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                           â”‚ current &lt;      â”‚ current =      â”‚ current &gt;
                                           â–¼                â–¼                â–¼
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚ Upgrade   â”‚    â”‚ No change â”‚    â”‚ Downgrade â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><h2 id=version-comparison>Version Comparison<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The <code>VersionCmp</code> method compares two version strings:</p><table><thead><tr><th>Return Value</th><th>Meaning</th></tr></thead><tbody><tr><td><code>-1</code></td><td>versionA &lt; versionB (upgrade needed)</td></tr><tr><td><code>0</code></td><td>versionA == versionB (no change)</td></tr><tr><td><code>1</code></td><td>versionA > versionB (downgrade needed)</td></tr></tbody></table><p>Version comparison is delegated to the provider, allowing platform-specific version parsing (e.g., RPM epoch handling, Debian revision suffixes).</p><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The package resource is idempotent through state comparison:</p><h3 id=decision-table>Decision Table<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Desired</th><th>Current State</th><th>Action</th></tr></thead><tbody><tr><td><code>ensure: present</code></td><td>installed (any version)</td><td>None</td></tr><tr><td><code>ensure: present</code></td><td>absent</td><td>Install</td></tr><tr><td><code>ensure: absent</code></td><td>absent</td><td>None</td></tr><tr><td><code>ensure: absent</code></td><td>installed</td><td>Uninstall</td></tr><tr><td><code>ensure: latest</code></td><td>absent</td><td>Install latest</td></tr><tr><td><code>ensure: latest</code></td><td>installed</td><td>Upgrade (always runs)</td></tr><tr><td><code>ensure: &lt;version></code></td><td>same version</td><td>None</td></tr><tr><td><code>ensure: &lt;version></code></td><td>older version</td><td>Upgrade</td></tr><tr><td><code>ensure: &lt;version></code></td><td>newer version</td><td>Downgrade</td></tr><tr><td><code>ensure: &lt;version></code></td><td>absent</td><td>Install</td></tr></tbody></table><h3 id=special-case-ensure-latest>Special Case: <code>ensure: latest</code><span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>When <code>ensure: latest</code> is used:</p><ul><li>The package manager determines what &ldquo;latest&rdquo; means</li><li>Upgrade is always called when the package exists (package manager is idempotent)</li><li>The type cannot verify if &ldquo;latest&rdquo; was achieved (package managers may report stale data)</li><li>Desired state validation only checks that the package is not absent</li></ul><h2 id=package-name-validation>Package Name Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Package names are validated to prevent injection attacks:</p><p><strong>Allowed Characters:</strong></p><ul><li>Alphanumeric (<code>a-z</code>, <code>A-Z</code>, <code>0-9</code>)</li><li>Period (<code>.</code>), underscore (<code>_</code>), plus (<code>+</code>)</li><li>Colon (<code>:</code>), tilde (<code>~</code>), hyphen (<code>-</code>)</li></ul><p><strong>Rejected:</strong></p><ul><li>Shell metacharacters (<code>;</code>, <code>|</code>, <code>&</code>, <code>$</code>, etc.)</li><li>Whitespace</li><li>Quotes and backticks</li><li>Path separators</li></ul><p>Version strings (when ensure is a version) are also validated for dangerous characters.</p><h2 id=noop-mode>Noop Mode<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>In noop mode, the package type:</p><ol><li>Queries current state normally</li><li>Computes version comparison</li><li>Logs what actions would be taken</li><li>Sets appropriate <code>NoopMessage</code>:<ul><li>&ldquo;Would have installed latest&rdquo;</li><li>&ldquo;Would have upgraded to latest&rdquo;</li><li>&ldquo;Would have installed version X&rdquo;</li><li>&ldquo;Would have upgraded to X&rdquo;</li><li>&ldquo;Would have downgraded to X&rdquo;</li><li>&ldquo;Would have uninstalled&rdquo;</li></ul></li><li>Reports <code>Changed: true</code> if changes would occur</li><li>Does not call provider Install/Upgrade/Downgrade/Uninstall methods</li></ol><h2 id=desired-state-validation>Desired State Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>After applying changes (in non-noop mode), the type verifies the package reached the desired state:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Type</span>) <span style=color:#a6e22e>isDesiredState</span>(<span style=color:#a6e22e>properties</span>, <span style=color:#a6e22e>state</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Ensure</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;present&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Any installed version is acceptable</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Ensure</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;absent&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;absent&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Ensure</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;absent&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;latest&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Cannot verify &#34;latest&#34;, just check not absent</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Ensure</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;absent&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Specific version must match</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>VersionCmp</span>(<span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Ensure</span>, <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Ensure</span>, <span style=color:#66d9ef>false</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>If the desired state is not reached, an <code>ErrDesiredStateFailed</code> error is returned.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Package Type</h1><article class=default><header class=headline></header><h1 id=apt-provider>APT Provider</h1><p>This document describes the implementation details of the APT package provider for Debian-based systems.</p><h2 id=environment>Environment<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>All commands are executed with the following environment variables to ensure non-interactive operation:</p><table><thead><tr><th>Variable</th><th>Value</th><th>Purpose</th></tr></thead><tbody><tr><td><code>DEBIAN_FRONTEND</code></td><td><code>noninteractive</code></td><td>Prevents dpkg from prompting for user input</td></tr><tr><td><code>APT_LISTBUGS_FRONTEND</code></td><td><code>none</code></td><td>Suppresses apt-listbugs prompts</td></tr><tr><td><code>APT_LISTCHANGES_FRONTEND</code></td><td><code>none</code></td><td>Suppresses apt-listchanges prompts</td></tr></tbody></table><h2 id=concurrency>Concurrency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>A global package lock (<code>model.PackageGlobalLock</code>) is held during all command executions to prevent concurrent apt/dpkg operations within the same process. This prevents lock contention on <code>/var/lib/dpkg/lock</code>.</p><h2 id=operations>Operations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=status-check>Status Check<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>dpkg-query -W -f=&#39;${Package} ${Version} ${Architecture} ${db:Status-Status}&#39; &lt;package&gt;</code></pre></div><p><strong>Behavior:</strong></p><ul><li>Exit code 0 with <code>installed</code> status â†’ Package is present, returns version info</li><li>Exit code non-zero OR status not <code>installed</code> â†’ Package is absent</li></ul><p><strong>Package States:</strong>
The <code>db:Status-Status</code> field can return various values. Only <code>installed</code> is treated as present:</p><table><thead><tr><th>Status</th><th>Treated As</th><th>Description</th></tr></thead><tbody><tr><td><code>installed</code></td><td>Present</td><td>Package fully installed</td></tr><tr><td><code>config-files</code></td><td>Absent</td><td>Removed but config files remain</td></tr><tr><td><code>half-installed</code></td><td>Absent</td><td>Installation started but failed</td></tr><tr><td><code>half-configured</code></td><td>Absent</td><td>Configuration failed</td></tr><tr><td><code>unpacked</code></td><td>Absent</td><td>Unpacked but not configured</td></tr><tr><td><code>not-installed</code></td><td>Absent</td><td>Not installed</td></tr></tbody></table><p>Treating non-<code>installed</code> states as absent allows <code>apt-get install</code> to repair broken installations.</p><h3 id=install>Install<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Ensure Present:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>apt-get install -y -q -o DPkg::Options::=--force-confold &lt;package&gt;</code></pre></div><p><strong>Ensure Latest:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>apt-cache policy &lt;package&gt;                    # Get candidate version
apt-get install -y -q -o DPkg::Options::=--force-confold &lt;package&gt;=&lt;version&gt;</code></pre></div><p><strong>Specific Version:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>apt-get install -y -q -o DPkg::Options::=--force-confold --allow-downgrades &lt;package&gt;=&lt;version&gt;</code></pre></div><p><strong>Flags:</strong></p><table><thead><tr><th>Flag</th><th>Purpose</th></tr></thead><tbody><tr><td><code>-y</code></td><td>Assume yes to prompts</td></tr><tr><td><code>-q</code></td><td>Quiet output</td></tr><tr><td><code>-o DPkg::Options::=--force-confold</code></td><td>Keep existing config files on upgrade</td></tr><tr><td><code>--allow-downgrades</code></td><td>Allow installing older versions (specific version only)</td></tr></tbody></table><h3 id=upgrade>Upgrade<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Delegates to <code>Install()</code> with the target version. The <code>--allow-downgrades</code> flag is only added for specific version requests, not for <code>latest</code>.</p><h3 id=downgrade>Downgrade<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Delegates to <code>Install()</code> with the target version. The <code>--allow-downgrades</code> flag enables this operation.</p><h3 id=uninstall>Uninstall<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>apt-get -q -y remove &lt;package&gt;</code></pre></div><p><strong>Note:</strong> Uses <code>remove</code> not <code>purge</code>, so configuration files are preserved. A subsequent install will find existing config files.</p><h3 id=latest-available-version>Latest Available Version<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>apt-cache policy &lt;package&gt;</code></pre></div><p><strong>Parsing:</strong> Extracts the <code>Candidate:</code> line from output.</p><p><strong>Example output:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>zsh:
  Installed: 5.9-8+b18
  Candidate: 5.9-8+b18
  Version table:
 *** 5.9-8+b18 500
        500 http://deb.debian.org/debian trixie/main amd64 Packages
        100 /var/lib/dpkg/status</code></pre></div><h2 id=version-comparison>Version Comparison<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Version comparison follows the <a href=https://www.debian.org/doc/debian-policy/ch-controlfields.html#version rel=external>Debian Policy Manual</a> algorithm.</p><h3 id=version-format>Version Format<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>[epoch:]upstream_version[-debian_revision]</code></pre></div><table><thead><tr><th>Component</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>epoch</code></td><td>No</td><td>Integer, default 0. Higher epoch always wins.</td></tr><tr><td><code>upstream_version</code></td><td>Yes</td><td>The main version from upstream</td></tr><tr><td><code>debian_revision</code></td><td>No</td><td>Debian-specific revision</td></tr></tbody></table><p><strong>Examples:</strong></p><ul><li><code>1.0</code> â†’ epoch=0, upstream=1.0, revision=""</li><li><code>1:2.0-3</code> â†’ epoch=1, upstream=2.0, revision=3</li><li><code>2:1.0.0+git-20190109-0ubuntu2</code> â†’ epoch=2, upstream=1.0.0+git-20190109, revision=0ubuntu2</li></ul><h3 id=comparison-algorithm>Comparison Algorithm<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><ol><li><p><strong>Compare epochs numerically</strong> - Higher epoch wins regardless of other components</p></li><li><p><strong>Compare upstream_version and debian_revision</strong> using the Debian string comparison:</p><p>The string is processed left-to-right in segments:</p><p>a. <strong>Tildes (<code>~</code>)</strong> - Compared first. More tildes = earlier version. Tilde sorts before everything, even empty string.</p><ul><li><code>1.0~alpha</code> &lt; <code>1.0</code> (tilde before empty)</li><li><code>1.0~~</code> &lt; <code>1.0~</code> (more tildes = earlier)</li></ul><p>b. <strong>Letters (<code>A-Za-z</code>)</strong> - Compared lexically (ASCII order)</p><ul><li>Letters sort before non-letters</li></ul><p>c. <strong>Non-letters (<code>.</code>, <code>+</code>, <code>-</code>)</strong> - Compared lexically</p><p>d. <strong>Digits</strong> - Compared numerically (not lexically)</p><ul><li><code>9</code> &lt; <code>13</code> (numeric comparison)</li></ul><p>These steps repeat until a difference is found or both strings are exhausted.</p></li></ol><h3 id=comparison-examples>Comparison Examples<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>A</th><th>B</th><th>Result</th><th>Reason</th></tr></thead><tbody><tr><td><code>1.0</code></td><td><code>2.0</code></td><td>A &lt; B</td><td>Numeric comparison</td></tr><tr><td><code>1:1.0</code></td><td><code>2.0</code></td><td>A > B</td><td>Epoch 1 > epoch 0</td></tr><tr><td><code>1.0~alpha</code></td><td><code>1.0</code></td><td>A &lt; B</td><td>Tilde sorts before empty</td></tr><tr><td><code>1.0~alpha</code></td><td><code>1.0~beta</code></td><td>A &lt; B</td><td>Lexical: alpha &lt; beta</td></tr><tr><td><code>1.0.1</code></td><td><code>1.0.2</code></td><td>A &lt; B</td><td>Numeric: 1 &lt; 2</td></tr><tr><td><code>1.0-1</code></td><td><code>1.0-2</code></td><td>A &lt; B</td><td>Revision comparison</td></tr><tr><td><code>1.0a</code></td><td><code>1.0-</code></td><td>A &lt; B</td><td>Letters sort before non-letters</td></tr></tbody></table><h3 id=implementation>Implementation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The version comparison is implemented in <code>version.go</code>, ported from Puppet&rsquo;s <code>Puppet::Util::Package::Version::Debian</code> module. It provides:</p><ul><li><code>ParseVersion(string)</code> - Parse a version string into components</li><li><code>CompareVersionStrings(a, b)</code> - Compare two version strings directly</li><li><code>Version.Compare(other)</code> - Compare parsed versions (-1, 0, 1)</li><li>Helper methods: <code>LessThan</code>, <code>GreaterThan</code>, <code>Equal</code>, etc.</li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=dnf-provider>DNF Provider</h1><p>This document describes the implementation details of the DNF package provider for RHEL/Fedora-based systems.</p><h2 id=concurrency>Concurrency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>A global package lock (<code>model.PackageGlobalLock</code>) is held during all command executions to prevent concurrent dnf/rpm operations within the same process. This prevents lock contention on the RPM database.</p><h2 id=operations>Operations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=status-check>Status Check<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>rpm -q &lt;package&gt; --queryformat &#39;%{NAME} %|EPOCH?{%{EPOCH}}:{0}| %{VERSION} %{RELEASE} %{ARCH}&#39;</code></pre></div><p><strong>Query Format (NEVRA):</strong>
The query format extracts the full NEVRA (Name, Epoch, Version, Release, Architecture):</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>%{NAME}</code></td><td>Package name</td></tr><tr><td><code>%|EPOCH?{%{EPOCH}}:{0}|</code></td><td>Epoch (0 if not set)</td></tr><tr><td><code>%{VERSION}</code></td><td>Upstream version</td></tr><tr><td><code>%{RELEASE}</code></td><td>Release/build number</td></tr><tr><td><code>%{ARCH}</code></td><td>Architecture (x86_64, noarch, etc.)</td></tr></tbody></table><p><strong>Example output:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>zsh 0 5.8 9.el9 x86_64</code></pre></div><p><strong>Behavior:</strong></p><ul><li>Exit code 0 â†’ Package is present, parses NEVRA components</li><li>Exit code non-zero â†’ Package is absent</li></ul><p><strong>Returned Version Format:</strong>
The version returned combines VERSION and RELEASE: <code>5.8-9.el9</code></p><p>The epoch and release are stored separately in the <code>Extended</code> metadata.</p><h3 id=install>Install<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Ensure Present or Latest:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>dnf install -y &lt;package&gt;</code></pre></div><p><strong>Specific Version:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>dnf install -y &lt;package&gt;-&lt;version&gt;</code></pre></div><p><strong>Flags:</strong></p><table><thead><tr><th>Flag</th><th>Purpose</th></tr></thead><tbody><tr><td><code>-y</code></td><td>Assume yes to all prompts</td></tr></tbody></table><p><strong>Note:</strong> DNF uses <code>-</code> (hyphen) to separate package name from version, unlike APT which uses <code>=</code>.</p><h3 id=upgrade>Upgrade<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Delegates to <code>Install()</code>. DNF&rsquo;s install command handles upgrades automatically when a newer version is available or specified.</p><h3 id=downgrade>Downgrade<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>dnf downgrade -y &lt;package&gt;-&lt;version&gt;</code></pre></div><p><strong>Note:</strong> Unlike upgrade, downgrade uses a dedicated DNF command rather than delegating to install.</p><h3 id=uninstall>Uninstall<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>dnf remove -y &lt;package&gt;</code></pre></div><h2 id=version-format>Version Format<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>RPM versions follow the EVR (Epoch:Version-Release) format:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>[epoch:]version-release</code></pre></div><table><thead><tr><th>Component</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>epoch</code></td><td>No</td><td>Integer, default 0. Higher epoch always wins.</td></tr><tr><td><code>version</code></td><td>Yes</td><td>Upstream version number</td></tr><tr><td><code>release</code></td><td>Yes</td><td>Distribution-specific release/build number</td></tr></tbody></table><p><strong>Examples:</strong></p><ul><li><code>5.8-9.el9</code> â†’ epoch=0, version=5.8, release=9.el9</li><li><code>1:2.0-3.fc39</code> â†’ epoch=1, version=2.0, release=3.fc39</li><li><code>0:1.0.0-1.el9</code> â†’ epoch=0 (explicit), version=1.0.0, release=1.el9</li></ul><h2 id=version-comparison>Version Comparison<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Version comparison uses a generic algorithm ported from Puppet, implemented in <code>internal/util.VersionCmp()</code>.</p><h3 id=algorithm>Algorithm<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The version string is tokenized into segments by splitting on <code>-</code>, <code>.</code>, digits, and non-digit sequences. Segments are compared left-to-right:</p><ol><li><strong>Hyphens (<code>-</code>)</strong> - A hyphen loses to any other character</li><li><strong>Dots (<code>.</code>)</strong> - A dot loses to any non-hyphen character</li><li><strong>Digit sequences</strong> - Compared numerically, except:<ul><li>Leading zeros trigger lexical comparison (<code>01</code> vs <code>1</code> compared as strings)</li></ul></li><li><strong>Non-digit sequences</strong> - Compared lexically (case-insensitive)</li></ol><p>If all segments match, falls back to whole-string comparison.</p><h3 id=trailing-zero-normalization>Trailing Zero Normalization<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>When <code>ignoreTrailingZeroes</code> is enabled, trailing <code>.0</code> segments before the first <code>-</code> are removed:</p><ul><li><code>1.0.0-rc1</code> â†’ <code>1-rc1</code></li><li><code>2.0.0</code> â†’ <code>2</code></li></ul><p>This allows <code>1.0.0</code> to equal <code>1.0</code> when the flag is set.</p><h3 id=comparison-examples>Comparison Examples<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>A</th><th>B</th><th>Result</th><th>Reason</th></tr></thead><tbody><tr><td><code>1.0</code></td><td><code>2.0</code></td><td>A &lt; B</td><td>Numeric: 1 &lt; 2</td></tr><tr><td><code>1.10</code></td><td><code>1.9</code></td><td>A > B</td><td>Numeric: 10 > 9</td></tr><tr><td><code>1.0</code></td><td><code>1.0.1</code></td><td>A &lt; B</td><td>A exhausted first</td></tr><tr><td><code>1.0-1</code></td><td><code>1.0-2</code></td><td>A &lt; B</td><td>Release comparison</td></tr><tr><td><code>1.0a</code></td><td><code>1.0b</code></td><td>A &lt; B</td><td>Lexical: a &lt; b</td></tr><tr><td><code>01</code></td><td><code>1</code></td><td>A &lt; B</td><td>Leading zero: lexical comparison</td></tr><tr><td><code>1.0.0</code></td><td><code>1.0</code></td><td>A > B</td><td>Without normalization</td></tr><tr><td><code>1.0.0</code></td><td><code>1.0</code></td><td>A = B</td><td>With <code>ignoreTrailingZeroes=true</code></td></tr></tbody></table><h3 id=implementation>Implementation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The version comparison is implemented in <code>internal/util/util.go</code> and provides:</p><ul><li><code>VersionCmp(a, b, ignoreTrailingZeroes)</code> - Compare two version strings</li><li>Returns -1 (a &lt; b), 0 (a == b), or 1 (a > b)</li></ul><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=scaffold-type>Scaffold Type</h1><p>This document describes the design of the scaffold resource type for rendering template directories into target directories.</p><h2 id=overview>Overview<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The scaffold resource renders files from a source template directory to a target directory:</p><ul><li><strong>Rendering</strong>: Process templates using Go <code>text/template</code> or Jet engine</li><li><strong>Synchronization</strong>: Detect changed, stable, and purgeable files</li><li><strong>Cleanup</strong>: Optionally remove files in the target not present in the source</li></ul><p>Templates have access to facts and data from Hiera, enabling dynamic configuration generation from directory structures.</p><h2 id=provider-interface>Provider Interface<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Scaffold providers must implement the <code>ScaffoldProvider</code> interface:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ScaffoldProvider</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Provider</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Remove</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>prop</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ScaffoldResourceProperties</span>, <span style=color:#a6e22e>state</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ScaffoldState</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Scaffold</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>env</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>templates</span>.<span style=color:#a6e22e>Env</span>, <span style=color:#a6e22e>prop</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ScaffoldResourceProperties</span>, <span style=color:#a6e22e>noop</span> <span style=color:#66d9ef>bool</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ScaffoldState</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Status</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>env</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>templates</span>.<span style=color:#a6e22e>Env</span>, <span style=color:#a6e22e>prop</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ScaffoldResourceProperties</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ScaffoldState</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=method-responsibilities>Method Responsibilities<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Method</th><th>Responsibility</th></tr></thead><tbody><tr><td><code>Status</code></td><td>Render in noop mode to determine current state of managed files</td></tr><tr><td><code>Scaffold</code></td><td>Render templates to target directory (or noop to preview changes)</td></tr><tr><td><code>Remove</code></td><td>Delete managed files (changed and stable) and clean up directories</td></tr></tbody></table><h3 id=status-response>Status Response<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>Status</code> method returns a <code>ScaffoldState</code> containing:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ScaffoldState</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CommonResourceState</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Metadata</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ScaffoldMetadata</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ScaffoldMetadata</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>         <span style=color:#66d9ef>string</span>                 <span style=color:#75715e>// Target directory</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Provider</span>     <span style=color:#66d9ef>string</span>                 <span style=color:#75715e>// Provider name (e.g., &#34;choria&#34;)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>TargetExists</span> <span style=color:#66d9ef>bool</span>                   <span style=color:#75715e>// Whether target directory exists</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Changed</span>      []<span style=color:#66d9ef>string</span>               <span style=color:#75715e>// Files created or modified</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Purged</span>       []<span style=color:#66d9ef>string</span>               <span style=color:#75715e>// Files removed (not in source)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Stable</span>       []<span style=color:#66d9ef>string</span>               <span style=color:#75715e>// Files unchanged</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Engine</span>       <span style=color:#a6e22e>ScaffoldResourceEngine</span> <span style=color:#75715e>// Template engine used</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>The <code>Ensure</code> field in <code>CommonResourceState</code> is set to:</p><ul><li><code>present</code> if the target directory exists</li><li><code>absent</code> if the target directory does not exist</li></ul><h2 id=available-providers>Available Providers<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Provider</th><th>Engine Support</th><th>Documentation</th></tr></thead><tbody><tr><td><code>choria</code></td><td>Go, Jet</td><td><a href=/design/scaffold/choria/index.html>Choria</a></td></tr></tbody></table><h2 id=ensure-states>Ensure States<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>present</code></td><td>Target directory must exist with rendered template files</td></tr><tr><td><code>absent</code></td><td>Managed files must be removed from the target</td></tr></tbody></table><h2 id=template-engines>Template Engines<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Two template engines are supported:</p><table><thead><tr><th>Engine</th><th>Library</th><th>Default Delimiters</th><th>Description</th></tr></thead><tbody><tr><td><code>go</code></td><td>Go <code>text/template</code></td><td><code>{{</code> / <code>}}</code></td><td>Standard Go templates</td></tr><tr><td><code>jet</code></td><td>Jet templating</td><td><code>[[</code> / <code>]]</code></td><td>Jet template language</td></tr></tbody></table><p>The engine defaults to <code>jet</code> if not specified. Delimiters can be customized via <code>left_delimiter</code> and <code>right_delimiter</code> properties.</p><h2 id=properties>Properties<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Property</th><th>Type</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>source</code></td><td>string</td><td>Yes</td><td>Source template directory path or URL</td></tr><tr><td><code>engine</code></td><td>string</td><td>No</td><td>Template engine: <code>go</code> or <code>jet</code> (default: <code>jet</code>)</td></tr><tr><td><code>skip_empty</code></td><td>bool</td><td>No</td><td>Skip empty files in rendered output</td></tr><tr><td><code>left_delimiter</code></td><td>string</td><td>No</td><td>Custom left template delimiter</td></tr><tr><td><code>right_delimiter</code></td><td>string</td><td>No</td><td>Custom right template delimiter</td></tr><tr><td><code>purge</code></td><td>bool</td><td>No</td><td>Remove files in target not present in source</td></tr><tr><td><code>post</code></td><td>[]map[string]string</td><td>No</td><td>Post-processing: glob pattern to command mapping</td></tr></tbody></table><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Render configuration templates using Jet engine</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>scaffold</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/etc/app</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>source</span>: <span style=color:#ae81ff>templates/app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>engine</span>: <span style=color:#ae81ff>jet</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>purge</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Render with Go templates and custom delimiters</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>scaffold</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/etc/myservice</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>source</span>: <span style=color:#ae81ff>templates/myservice</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>engine</span>: <span style=color:#ae81ff>go</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>left_delimiter</span>: <span style=color:#e6db74>&#34;&lt;&lt;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>right_delimiter</span>: <span style=color:#e6db74>&#34;&gt;&gt;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># With post-processing commands</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>scaffold</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/opt/app</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>source</span>: <span style=color:#ae81ff>templates/app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>post</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>&#34;*.go&#34;: </span><span style=color:#e6db74>&#34;go fmt {}&#34;</span></span></span></code></pre></div><h2 id=apply-logic>Apply Logic<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Get current state via Status()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Is current state desired state?         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              Yes â”‚         No
                  â–¼         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
          â”‚ No change â”‚     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ What is desired ensure? â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ absent                        â”‚ present
            â–¼                               â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Noop?     â”‚                   â”‚ Noop?     â”‚
      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        Yes â”‚     No                    Yes â”‚     No
            â–¼     â”‚                         â–¼     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
    â”‚ Set noop   â”‚â”‚                 â”‚ Set noop   â”‚â”‚
    â”‚ message    â”‚â”‚                 â”‚ message    â”‚â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                  â–¼                               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Remove all    â”‚             â”‚ Scaffold            â”‚
        â”‚ managed files â”‚             â”‚ (render templates)  â”‚
        â”‚ and empty dirsâ”‚             â”‚                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The scaffold resource determines idempotency by rendering templates in noop mode and comparing results against the target directory.</p><h3 id=state-checks>State Checks<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><ol><li><strong>Ensure absent</strong>: Target must not exist, or no managed files remain on disk (<code>Changed</code> and <code>Stable</code> lists empty). Purged files (files not belonging to the scaffold) do not affect this check.</li><li><strong>Ensure present</strong>: The <code>Changed</code> list must be empty, and the <code>Purged</code> list must be empty when <code>purge</code> is enabled (all files are stable). When <code>purge</code> is disabled, purged files do not affect stability.</li></ol><h3 id=decision-table>Decision Table<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>For <code>ensure: absent</code>, purged files never affect stability since they don&rsquo;t belong to the scaffold. For <code>ensure: present</code>, purged files only affect stability when <code>purge</code> is enabled.</p><p>When <code>ensure: absent</code>, the <code>Status</code> method filters <code>Changed</code> and <code>Stable</code> lists to only include files that actually exist on disk, so the state reflects reality after removal rather than what the scaffold would create.</p><table><thead><tr><th>Desired</th><th>Target Exists</th><th>Changed Files</th><th>Purged Files</th><th>Purge Enabled</th><th>Stable?</th></tr></thead><tbody><tr><td><code>absent</code></td><td>No</td><td>N/A</td><td>N/A</td><td>N/A</td><td>Yes</td></tr><tr><td><code>absent</code></td><td>Yes</td><td>None</td><td>Any</td><td>N/A</td><td>Yes (no managed files on disk)</td></tr><tr><td><code>absent</code></td><td>Yes</td><td>Some</td><td>Any</td><td>N/A</td><td>No (managed files remain)</td></tr><tr><td><code>present</code></td><td>Yes</td><td>None</td><td>None</td><td>Any</td><td>Yes</td></tr><tr><td><code>present</code></td><td>Yes</td><td>None</td><td>Some</td><td>No</td><td>Yes (purged files ignored)</td></tr><tr><td><code>present</code></td><td>Yes</td><td>None</td><td>Some</td><td>Yes</td><td>No (purge needed)</td></tr><tr><td><code>present</code></td><td>Yes</td><td>Some</td><td>Any</td><td>Any</td><td>No (render needed)</td></tr><tr><td><code>present</code></td><td>No</td><td>N/A</td><td>N/A</td><td>Any</td><td>No (target missing)</td></tr></tbody></table><h2 id=source-resolution>Source Resolution<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The <code>source</code> property is resolved relative to the manager&rsquo;s working directory when it is a relative path:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>parsed</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>Parse</span>(<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Source</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>parsed</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>parsed</span>.<span style=color:#a6e22e>Scheme</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>IsAbs</span>(<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Source</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>prop</span>.<span style=color:#a6e22e>Source</span> = <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>mgr</span>.<span style=color:#a6e22e>WorkingDirectory</span>(), <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Source</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>This allows manifests bundled with template directories to use relative paths. URL sources (with a scheme) are passed through unchanged.</p><h2 id=path-validation>Path Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Target paths (the resource name) must be:</p><ul><li>Absolute (start with <code>/</code>)</li><li>Canonical (no <code>.</code> or <code>..</code> components, <code>filepath.Clean(path) == path</code>)</li></ul><h2 id=post-processing>Post-Processing<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The <code>post</code> property defines commands to run on rendered files. Each entry is a map where the key is a glob pattern matched against the file&rsquo;s basename and the value is a command to execute. Use <code>{}</code> as a placeholder for the file&rsquo;s full path; if omitted, the path is appended as the last argument.</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>post</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>&#34;*.go&#34;: </span><span style=color:#e6db74>&#34;go fmt {}&#34;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>&#34;*.sh&#34;: </span><span style=color:#e6db74>&#34;chmod +x {}&#34;</span></span></span></code></pre></div><p>Post-processing runs immediately after each file is rendered. Validation ensures neither keys nor values are empty.</p><h2 id=noop-mode>Noop Mode<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>In noop mode, the scaffold type queries the current state via <code>Status()</code> and reports what would change without modifying the filesystem. Neither <code>Scaffold()</code> nor <code>Remove()</code> are called.</p><p>For <code>ensure: present</code>, the affected count is the number of changed files plus purged files (when <code>purge</code> is enabled). For <code>ensure: absent</code>, the affected count is the number of changed and stable files plus purged files (when <code>purge</code> is enabled).</p><table><thead><tr><th>Desired</th><th>Affected Count</th><th>Message</th></tr></thead><tbody><tr><td><code>present</code></td><td><code>Changed</code> + <code>Purged</code> (if purge enabled)</td><td><code>Would have changed N scaffold files</code></td></tr><tr><td><code>absent</code></td><td><code>Changed</code> + <code>Stable</code> + <code>Purged</code> (if purge enabled)</td><td><code>Would have removed N scaffold files</code></td></tr></tbody></table><p><code>Changed</code> is set to <code>true</code> only when the affected count is greater than zero. When the resource is already in the desired state, <code>Changed</code> is <code>false</code> and <code>NoopMessage</code> is empty.</p><h2 id=desired-state-validation>Desired State Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>After applying changes (in non-noop mode), the type verifies the scaffold reached the desired state by checking the changed and purged file lists. If validation fails, <code>ErrDesiredStateFailed</code> is returned.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Scaffold Type</h1><article class=default><header class=headline></header><h1 id=choria-provider>Choria Provider</h1><p>This document describes the implementation details of the Choria scaffold provider for rendering template directories using the <code>choria-io/scaffold</code> library.</p><h2 id=provider-selection>Provider Selection<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The Choria provider is the default and only scaffold provider. It is always available and returns priority 1 for all scaffold resources.</p><h2 id=operations>Operations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=scaffold-render-templates>Scaffold (Render Templates)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Check if target directory exists</li><li>Configure scaffold with source, target, engine, delimiters, post-processing, and skip_empty settings</li><li>Create scaffold instance using the appropriate engine (<code>scaffold.New()</code> for Go, <code>scaffold.NewJet()</code> for Jet)</li><li>Call <code>Render()</code> (real mode) or <code>RenderNoop()</code> (noop mode)</li><li>Categorize results into changed, stable, and purged file lists</li></ol><p><strong>Scaffold Configuration:</strong></p><table><thead><tr><th>Config Field</th><th>Source Property</th><th>Description</th></tr></thead><tbody><tr><td><code>TargetDirectory</code></td><td><code>Name</code></td><td>Target directory for rendered files</td></tr><tr><td><code>SourceDirectory</code></td><td><code>Source</code></td><td>Source template directory</td></tr><tr><td><code>MergeTargetDirectory</code></td><td>(always <code>true</code>)</td><td>Merge into existing target directory</td></tr><tr><td><code>Post</code></td><td><code>Post</code></td><td>Post-processing commands</td></tr><tr><td><code>SkipEmpty</code></td><td><code>SkipEmpty</code></td><td>Skip empty rendered files</td></tr><tr><td><code>CustomLeftDelimiter</code></td><td><code>LeftDelimiter</code></td><td>Custom template left delimiter</td></tr><tr><td><code>CustomRightDelimiter</code></td><td><code>RightDelimiter</code></td><td>Custom template right delimiter</td></tr></tbody></table><p><strong>Engine Selection:</strong></p><table><thead><tr><th>Engine</th><th>Constructor</th><th>Default Delimiters</th></tr></thead><tbody><tr><td><code>go</code></td><td><code>scaffold.New()</code></td><td><code>{{</code> / <code>}}</code></td></tr><tr><td><code>jet</code></td><td><code>scaffold.NewJet()</code></td><td><code>[[</code> / <code>]]</code></td></tr></tbody></table><p><strong>Result Categorization:</strong></p><table><thead><tr><th>Scaffold Action</th><th>Metadata List</th><th>Description</th></tr></thead><tbody><tr><td><code>FileActionEqual</code></td><td><code>Stable</code></td><td>File content unchanged</td></tr><tr><td><code>FileActionAdd</code></td><td><code>Changed</code></td><td>New file created</td></tr><tr><td><code>FileActionUpdate</code></td><td><code>Changed</code></td><td>Existing file modified</td></tr><tr><td><code>FileActionRemove</code></td><td><code>Purged</code></td><td>File removed from target</td></tr></tbody></table><p>File paths in the metadata lists are absolute paths, constructed by joining the target directory with the relative path from the scaffold result.</p><p><strong>Purge Behavior:</strong></p><p>When <code>purge</code> is enabled and a file has <code>FileActionRemove</code>, the provider deletes the file from disk during <code>Scaffold()</code>. In noop mode, the removal is logged but not performed. When <code>purge</code> is disabled, purged files are only tracked in metadata and not removed.</p><h3 id=status>Status<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Perform a dry-run render (noop mode) to determine what the scaffold would do</li><li>When <code>ensure</code> is <code>absent</code>, filter <code>Changed</code> and <code>Stable</code> lists to only include files that actually exist on disk</li></ol><p>The noop render reports what <em>would happen</em> if the scaffold were applied. For <code>ensure: present</code>, this is the desired output â€” it shows what needs to change. For <code>ensure: absent</code>, the raw render output is misleading after removal (it would show files to be <em>added</em>), so the lists are filtered to reflect what managed files actually remain on disk.</p><p><strong>State Detection:</strong></p><table><thead><tr><th>Target Directory</th><th>Ensure Value</th><th>Metadata</th></tr></thead><tbody><tr><td>Exists</td><td><code>present</code></td><td>Changed, stable, and purged file lists from render</td></tr><tr><td>Exists</td><td><code>absent</code></td><td>Changed and stable filtered to files on disk, purged from render</td></tr><tr><td>Does not exist</td><td>Any</td><td>Empty metadata, <code>TargetExists: false</code></td></tr></tbody></table><h3 id=remove>Remove<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Collect managed files from the state&rsquo;s <code>Changed</code> and <code>Stable</code> lists (purged files are not removed as they don&rsquo;t belong to the scaffold)</li><li>Remove each file individually</li><li>Track parent directories of removed files</li><li>Iteratively remove empty directories deepest-first</li><li>Stop when no more empty directories can be removed</li><li>Best-effort removal of the target directory (only succeeds if empty)</li></ol><p><strong>File Removal Order:</strong></p><p>Files are collected from two metadata lists:</p><ol><li><code>Changed</code> - Files that were added or modified</li><li><code>Stable</code> - Files that were unchanged</li></ol><p>Purged files are not removed because they are unrelated to the scaffold and may belong to other processes.</p><p><strong>Directory Cleanup:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>For each removed file:
    Track its parent directory

Repeat:
    For each tracked directory:
        Skip if it is the target directory itself
        Skip if not empty
        Remove the directory
        Track its parent directory
Until no more directories removed

Best-effort: remove the target directory (fails silently if not empty)</code></pre></div><p>The target directory is removed if empty after all managed files and subdirectories are cleaned up. If unrelated files remain (purged files), the directory is preserved.</p><p><strong>Error Handling:</strong></p><table><thead><tr><th>Condition</th><th>Behavior</th></tr></thead><tbody><tr><td>Non-absolute file path</td><td>Return error immediately</td></tr><tr><td>File removal fails</td><td>Log error, continue with remaining files</td></tr><tr><td>Directory removal fails</td><td>Log error, continue with remaining directories</td></tr><tr><td>File does not exist</td><td>Silently skip (<code>os.IsNotExist</code> check)</td></tr><tr><td>Target directory removal fails</td><td>Log at debug level, no error returned</td></tr></tbody></table><h2 id=template-environment>Template Environment<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Templates receive the full <code>templates.Env</code> environment, which provides access to:</p><ul><li><code>facts</code> - System facts for the managed node</li><li><code>data</code> - Hiera-resolved configuration data</li><li>Template helper functions</li></ul><p>This allows templates to generate host-specific configurations based on facts and hierarchical data.</p><h2 id=logging>Logging<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The provider wraps the CCM logger in a scaffold-compatible interface:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>logger</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Logger</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>logger</span>) <span style=color:#a6e22e>Debugf</span>(<span style=color:#a6e22e>format</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>any</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>logger</span>) <span style=color:#a6e22e>Infof</span>(<span style=color:#a6e22e>format</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>any</span>)</span></span></code></pre></div><p>This adapter translates the scaffold library&rsquo;s <code>Debugf</code>/<code>Infof</code> calls to CCM&rsquo;s structured logging.</p><h2 id=platform-support>Platform Support<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The Choria provider is platform-independent. It uses the <code>choria-io/scaffold</code> library for template rendering, which operates on standard filesystem operations. No platform-specific system calls are used.</p><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=service-type>Service Type</h1><p>This document describes the design of the service resource type for managing system services.</p><h2 id=overview>Overview<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The service resource manages system services with two independent dimensions:</p><ul><li><strong>Running state</strong>: Whether the service is currently running or stopped</li><li><strong>Enabled state</strong>: Whether the service starts automatically at boot</li></ul><p>These are managed independently, allowing combinations like &ldquo;running but disabled&rdquo; or &ldquo;stopped but enabled&rdquo;.</p><h2 id=provider-interface>Provider Interface<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Service providers must implement the <code>ServiceProvider</code> interface:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ServiceProvider</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Provider</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Enable</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Disable</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Stop</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Restart</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Status</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ServiceState</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=method-responsibilities>Method Responsibilities<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Method</th><th>Responsibility</th></tr></thead><tbody><tr><td><code>Status</code></td><td>Query current running and enabled state</td></tr><tr><td><code>Start</code></td><td>Start the service if not running</td></tr><tr><td><code>Stop</code></td><td>Stop the service if running</td></tr><tr><td><code>Restart</code></td><td>Stop and start the service (for refresh)</td></tr><tr><td><code>Enable</code></td><td>Configure service to start at boot</td></tr><tr><td><code>Disable</code></td><td>Configure service to not start at boot</td></tr></tbody></table><h3 id=status-response>Status Response<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>Status</code> method returns a <code>ServiceState</code> containing:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ServiceState</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CommonResourceState</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Metadata</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceMetadata</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ServiceMetadata</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>     <span style=color:#66d9ef>string</span>  <span style=color:#75715e>// Service name</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Provider</span> <span style=color:#66d9ef>string</span>  <span style=color:#75715e>// Provider name (e.g., &#34;systemd&#34;)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Enabled</span>  <span style=color:#66d9ef>bool</span>    <span style=color:#75715e>// Whether service starts at boot</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Running</span>  <span style=color:#66d9ef>bool</span>    <span style=color:#75715e>// Whether service is currently running</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>The <code>Ensure</code> field in <code>CommonResourceState</code> is set to:</p><ul><li><code>running</code> if the service is active</li><li><code>stopped</code> if the service is inactive</li></ul><h2 id=available-providers>Available Providers<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Provider</th><th>Init System</th><th>Documentation</th></tr></thead><tbody><tr><td><code>systemd</code></td><td>systemd</td><td><a href=/design/service/systemd/index.html>Systemd</a></td></tr></tbody></table><h2 id=ensure-states>Ensure States<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>running</code></td><td>Service must be running (default)</td></tr><tr><td><code>stopped</code></td><td>Service must be stopped</td></tr></tbody></table><p>If <code>ensure</code> is not specified, it defaults to <code>running</code>.</p><h2 id=enable-property>Enable Property<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The <code>enable</code> property is a boolean pointer (<code>*bool</code>) with three possible states:</p><table><thead><tr><th>Value</th><th>Behavior</th></tr></thead><tbody><tr><td><code>true</code></td><td>Enable service to start at boot</td></tr><tr><td><code>false</code></td><td>Disable service from starting at boot</td></tr><tr><td><code>nil</code> (not set)</td><td>Leave boot configuration unchanged</td></tr></tbody></table><p>This allows managing running state without affecting boot configuration:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Start service but don&#39;t change boot config</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>myapp</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>running</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Start and enable at boot</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>myapp</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>running</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>enable</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Stop and disable at boot</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>myapp</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>stopped</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>enable</span>: <span style=color:#66d9ef>false</span></span></span></code></pre></div><h2 id=apply-logic>Apply Logic<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The service type applies changes in two phases:</p><h3 id=phase-1-running-state>Phase 1: Running State<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check for subscribe refresh             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Subscribed resource       â”‚
    â”‚ changed?                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              Yes â”‚         â”‚ No
                  â–¼         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ ensure=running?     â”‚ â”‚
    â”‚ already running?    â”‚ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
          Yes+Yes â”‚         â”‚
                  â–¼         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
          â”‚ Restart   â”‚     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Compare ensure vs state â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ensure=stopped        â”‚ ensure=running        â”‚
    â”‚ state=running         â”‚ state=stopped         â”‚
    â–¼                       â–¼                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚ Stop   â”‚            â”‚ Start  â”‚                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
                                                    â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚ No change     â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><h3 id=phase-2-enabled-state>Phase 2: Enabled State<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>After running state is handled, enabled state is processed:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ enable property set?                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
          nil     â”‚     true/false
          â–¼       â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚ No change â”‚   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Compare enable vs enabled   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ enable=true â”‚ enable=falseâ”‚
    â”‚ !enabled    â”‚ enabled     â”‚
    â–¼             â–¼             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ Enable â”‚  â”‚ Disable â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                                â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ No change     â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><h2 id=subscribe-behavior>Subscribe Behavior<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Services can subscribe to other resources and restart when they change:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>httpd</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>running</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subscribe</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>file#/etc/httpd/conf/httpd.conf</span>
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>package#httpd</span></span></span></code></pre></div><p><strong>Special Cases:</strong></p><table><thead><tr><th>Condition</th><th>Behavior</th></tr></thead><tbody><tr><td><code>ensure: stopped</code></td><td>Subscribe ignored (no restart)</td></tr><tr><td>Service not running + <code>ensure: running</code></td><td>Start (not restart)</td></tr><tr><td>Service running + <code>ensure: running</code></td><td>Restart</td></tr></tbody></table><p>This prevents restarting stopped services and ensures a clean start when the service should be running but isn&rsquo;t.</p><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The service resource is idempotent through state comparison:</p><table><thead><tr><th>Desired</th><th>Current</th><th>Action</th></tr></thead><tbody><tr><td><code>ensure: running</code></td><td>running</td><td>None</td></tr><tr><td><code>ensure: running</code></td><td>stopped</td><td>Start</td></tr><tr><td><code>ensure: stopped</code></td><td>stopped</td><td>None</td></tr><tr><td><code>ensure: stopped</code></td><td>running</td><td>Stop</td></tr><tr><td><code>enable: true</code></td><td>enabled</td><td>None</td></tr><tr><td><code>enable: true</code></td><td>disabled</td><td>Enable</td></tr><tr><td><code>enable: false</code></td><td>enabled</td><td>Disable</td></tr><tr><td><code>enable: false</code></td><td>disabled</td><td>None</td></tr><tr><td><code>enable: nil</code></td><td>any</td><td>None</td></tr></tbody></table><h2 id=desired-state-validation>Desired State Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>After applying changes, the type verifies the service reached the desired state:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Type</span>) <span style=color:#a6e22e>isDesiredState</span>(<span style=color:#a6e22e>properties</span>, <span style=color:#a6e22e>state</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check running state</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Ensure</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Ensure</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check enabled state (only if explicitly set)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Enable</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Enable</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Metadata</span>.<span style=color:#a6e22e>Enabled</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>If the desired state is not reached, an <code>ErrDesiredStateFailed</code> error is returned.</p><h2 id=service-name-validation>Service Name Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Service names are validated to prevent injection attacks:</p><p><strong>Allowed Characters:</strong></p><ul><li>Alphanumeric (<code>a-z</code>, <code>A-Z</code>, <code>0-9</code>)</li><li>Period (<code>.</code>), underscore (<code>_</code>), plus (<code>+</code>)</li><li>Colon (<code>:</code>), tilde (<code>~</code>), hyphen (<code>-</code>)</li></ul><p><strong>Rejected:</strong></p><ul><li>Shell metacharacters (<code>;</code>, <code>|</code>, <code>&</code>, etc.)</li><li>Whitespace</li><li>Path separators</li></ul><h2 id=noop-mode>Noop Mode<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>In noop mode, the service type:</p><ol><li>Queries current state normally</li><li>Logs what actions would be taken</li><li>Sets appropriate <code>NoopMessage</code> (e.g., &ldquo;Would have started&rdquo;, &ldquo;Would have enabled&rdquo;)</li><li>Reports <code>Changed: true</code> if changes would occur</li><li>Does not call provider Start/Stop/Restart/Enable/Disable methods</li></ol><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Service Type</h1><article class=default><header class=headline></header><h1 id=systemd-provider>Systemd Provider</h1><p>This document describes the implementation details of the Systemd service provider for managing system services via <code>systemctl</code>.</p><h2 id=provider-selection>Provider Selection<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The Systemd provider is selected when <code>systemctl</code> is found in the system PATH. The provider checks for the executable using <code>util.ExecutableInPath("systemctl")</code>.</p><p><strong>Availability Check:</strong></p><ul><li>Searches PATH for <code>systemctl</code></li><li>Returns priority 1 if found</li><li>Returns unavailable if not found</li></ul><h2 id=concurrency>Concurrency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>A global service lock (<code>model.ServiceGlobalLock</code>) is held during all <code>systemctl</code> command executions to prevent concurrent systemd operations within the same process. This prevents race conditions when multiple service resources are managed simultaneously.</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Provider</span>) <span style=color:#a6e22e>execute</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>cmd</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>args</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>string</span>) (<span style=color:#f92672>...</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ServiceGlobalLock</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ServiceGlobalLock</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>runner</span>.<span style=color:#a6e22e>Execute</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cmd</span>, <span style=color:#a6e22e>args</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h2 id=daemon-reload>Daemon Reload<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The provider performs a <code>systemctl daemon-reload</code> once per provider instance before any service operations. This ensures systemd picks up any unit file changes made by other resources (e.g., file resources managing unit files).</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Provider</span>) <span style=color:#a6e22e>maybeReload</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>didReload</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>execute</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;systemctl&#34;</span>, <span style=color:#e6db74>&#34;daemon-reload&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>The reload is performed only once, tracked by the <code>didReload</code> flag.</p><h2 id=operations>Operations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=status>Status<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Commands:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>systemctl is-active --system &lt;service&gt;
systemctl is-enabled --system &lt;service&gt;</code></pre></div><p><strong>Active State Detection:</strong></p><table><thead><tr><th><code>is-active</code> Output</th><th>Interpreted As</th></tr></thead><tbody><tr><td><code>active</code></td><td>Running</td></tr><tr><td><code>inactive</code></td><td>Stopped</td></tr><tr><td><code>failed</code></td><td>Stopped</td></tr><tr><td><code>activating</code></td><td>Stopped</td></tr><tr><td>Other</td><td>Error</td></tr></tbody></table><p><strong>Enabled State Detection:</strong></p><table><thead><tr><th><code>is-enabled</code> Output</th><th>Interpreted As</th></tr></thead><tbody><tr><td><code>enabled</code></td><td>Enabled</td></tr><tr><td><code>enabled-runtime</code></td><td>Enabled</td></tr><tr><td><code>alias</code></td><td>Enabled</td></tr><tr><td><code>static</code></td><td>Enabled</td></tr><tr><td><code>indirect</code></td><td>Enabled</td></tr><tr><td><code>generated</code></td><td>Enabled</td></tr><tr><td><code>transient</code></td><td>Enabled</td></tr><tr><td><code>linked</code></td><td>Disabled</td></tr><tr><td><code>linked-runtime</code></td><td>Disabled</td></tr><tr><td><code>masked</code></td><td>Disabled</td></tr><tr><td><code>masked-runtime</code></td><td>Disabled</td></tr><tr><td><code>disabled</code></td><td>Disabled</td></tr><tr><td><code>not-found</code></td><td>Error: service not found</td></tr></tbody></table><p><strong>Returned State:</strong></p><table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody><tr><td><code>Ensure</code></td><td><code>running</code> or <code>stopped</code> based on is-active</td></tr><tr><td><code>Metadata.Enabled</code></td><td>Boolean from is-enabled</td></tr><tr><td><code>Metadata.Running</code></td><td>Boolean from is-active</td></tr><tr><td><code>Metadata.Provider</code></td><td>&ldquo;systemd&rdquo;</td></tr></tbody></table><h3 id=start>Start<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>systemctl start --system &lt;service&gt;</code></pre></div><p>Called when <code>ensure: running</code> and service is currently stopped.</p><h3 id=stop>Stop<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>systemctl stop --system &lt;service&gt;</code></pre></div><p>Called when <code>ensure: stopped</code> and service is currently running.</p><h3 id=restart>Restart<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>systemctl restart --system &lt;service&gt;</code></pre></div><p>Called when a subscribed resource has changed and the service should be refreshed.</p><h3 id=enable>Enable<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>systemctl enable --system &lt;service&gt;</code></pre></div><p>Called when <code>enable: true</code> and service is currently disabled.</p><h3 id=disable>Disable<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>systemctl disable --system &lt;service&gt;</code></pre></div><p>Called when <code>enable: false</code> and service is currently enabled.</p><h2 id=command-flags>Command Flags<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>All commands use the <code>--system</code> flag to explicitly target system-level units (as opposed to user-level units managed with <code>--user</code>).</p><h2 id=decision-flow>Decision Flow<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=ensure-state-runningstopped>Ensure State (Running/Stopped)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Subscribe triggered?                     â”‚
â”‚ (subscribed resource changed)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ Yes           â”‚ No
              â”‚               â”‚
              â”‚               â–¼
              â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚       â”‚ Ensure = stopped? â”‚
              â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚           Yes   â”‚   No
              â”‚           â–¼     â–¼
              â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   â”‚ Running?â”‚ â”‚ Ensure = running? â”‚
              â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚    Yes â”‚ No         Yes â”‚   No
              â”‚        â–¼               â–¼
              â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   â”‚ Stop   â”‚    â”‚ Running?â”‚
              â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
              â”‚                  No  â”‚ Yes
              â”‚                      â–¼
              â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                 â”‚ Start  â”‚
              â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Ensure = running?             â”‚
      â”‚ (only restart running services)â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  Yes â”‚   No
                      â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Restart     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><p><strong>Subscribe Behavior Notes:</strong></p><ul><li>Restart only occurs if <code>ensure: running</code></li><li>If service is stopped and <code>ensure: running</code>, it starts instead of restarting</li><li>Subscribe is ignored if <code>ensure: stopped</code></li></ul><h3 id=enable-state>Enable State<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Enable/disable is processed independently after ensure state:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Enable property set?                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ Yes           â”‚ No (nil)
              â”‚               â”‚
              â”‚               â–¼
              â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚       â”‚ No change     â”‚
              â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Enable = true?                 â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  Yes â”‚   No
                      â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Currently enabled?             â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  No  â”‚ Yes
                      â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Enable      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

      (Similar flow for disable when enable=false)</code></pre></div><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The service resource checks current state before making changes:</p><table><thead><tr><th>Desired State</th><th>Current State</th><th>Action</th></tr></thead><tbody><tr><td><code>running</code></td><td><code>running</code></td><td>None</td></tr><tr><td><code>running</code></td><td><code>stopped</code></td><td>Start</td></tr><tr><td><code>stopped</code></td><td><code>stopped</code></td><td>None</td></tr><tr><td><code>stopped</code></td><td><code>running</code></td><td>Stop</td></tr><tr><td><code>enable: true</code></td><td>enabled</td><td>None</td></tr><tr><td><code>enable: true</code></td><td>disabled</td><td>Enable</td></tr><tr><td><code>enable: false</code></td><td>enabled</td><td>Disable</td></tr><tr><td><code>enable: false</code></td><td>disabled</td><td>None</td></tr><tr><td><code>enable: nil</code></td><td>any</td><td>None</td></tr></tbody></table><h2 id=service-name-validation>Service Name Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Service names are validated to prevent shell injection:</p><p><strong>Dangerous Characters Check:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>dangerousCharsRegex</span>.<span style=color:#a6e22e>MatchString</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Name</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;service name contains dangerous characters: %q&#34;</span>, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p><strong>Allowed Characters:</strong></p><ul><li>Alphanumeric (<code>a-z</code>, <code>A-Z</code>, <code>0-9</code>)</li><li>Period (<code>.</code>)</li><li>Underscore (<code>_</code>)</li><li>Plus (<code>+</code>)</li><li>Colon (<code>:</code>)</li><li>Tilde (<code>~</code>)</li><li>Hyphen (<code>-</code>)</li></ul><p><strong>Examples:</strong></p><table><thead><tr><th>Name</th><th>Valid</th></tr></thead><tbody><tr><td><code>httpd</code></td><td>Yes</td></tr><tr><td><code>nginx.service</code></td><td>Yes</td></tr><tr><td><code>my-app_v2</code></td><td>Yes</td></tr><tr><td><code>app@instance</code></td><td>No (@ not allowed)</td></tr><tr><td><code>app; rm -rf /</code></td><td>No (shell metacharacters)</td></tr></tbody></table><h2 id=subscribe-and-refresh>Subscribe and Refresh<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Services can subscribe to other resources and restart when they change:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/etc/myapp/config.yaml</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>content</span>: <span style=color:#e6db74>&#34;...&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>mode</span>: <span style=color:#e6db74>&#34;0644&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>myapp</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>running</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>enable</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subscribe</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>file#/etc/myapp/config.yaml</span></span></span></code></pre></div><p><strong>Behavior:</strong></p><ul><li>When the file resource changes, the service is restarted</li><li>Restart only occurs if <code>ensure: running</code></li><li>If service was stopped and should be running, it starts (not restarts)</li></ul><h2 id=error-handling>Error Handling<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Condition</th><th>Behavior</th></tr></thead><tbody><tr><td><code>systemctl</code> not in PATH</td><td>Provider unavailable</td></tr><tr><td>Service not found</td><td>Error from <code>is-enabled</code>: &ldquo;service not found&rdquo;</td></tr><tr><td>Unknown <code>is-active</code> output</td><td>Error: &ldquo;invalid systemctl is-active output&rdquo;</td></tr><tr><td>Unknown <code>is-enabled</code> output</td><td>Error: &ldquo;invalid systemctl is-enabled output&rdquo;</td></tr><tr><td>Command execution failure</td><td>Error propagated from runner</td></tr></tbody></table><h2 id=platform-support>Platform Support<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The Systemd provider requires:</p><ul><li>Linux with systemd as init system</li><li><code>systemctl</code> command available in PATH</li></ul><p>It does not support:</p><ul><li>Non-systemd init systems (SysVinit, Upstart, OpenRC)</li><li>User-level units (uses <code>--system</code> flag)</li><li>Windows, macOS, or BSD systems</li></ul><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=adding-a-type>Adding a Type</h1><p>This guide documents the process for adding a new resource type to CCM. It uses the <code>archive</code> type as a reference implementation.</p><h2 id=overview>Overview<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Adding a new resource type requires changes across several packages:</p><ol><li><strong>Model definitions</strong> - Properties, state, and metadata structs</li><li><strong>Resource type implementation</strong> - Core logic and provider interface</li><li><strong>Provider implementation</strong> - Platform-specific operations</li><li><strong>Integration points</strong> - Factory functions and registry</li><li><strong>CLI commands</strong> - User-facing command line interface</li><li><strong>JSON schemas</strong> - Validation for manifests and API requests</li><li><strong>Documentation</strong> - User and design documentation</li><li><strong>CCM Studio</strong> - Web-based manifest designer</li></ol><h2 id=file-checklist>File Checklist<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>File</th><th>Action</th><th>Purpose</th></tr></thead><tbody><tr><td><code>model/resource_&lt;type>.go</code></td><td>Create</td><td>Properties, state, metadata structs</td></tr><tr><td><code>model/resource_&lt;type>_test.go</code></td><td>Create</td><td>Property validation tests</td></tr><tr><td><code>model/resource.go</code></td><td>Modify</td><td>Add case to factory function</td></tr><tr><td><code>resources/&lt;type>/&lt;type>.go</code></td><td>Create</td><td>Provider interface definition</td></tr><tr><td><code>resources/&lt;type>/type.go</code></td><td>Create</td><td>Resource type implementation</td></tr><tr><td><code>resources/&lt;type>/type_test.go</code></td><td>Create</td><td>Resource type tests</td></tr><tr><td><code>resources/&lt;type>/provider_mock_test.go</code></td><td>Generate</td><td>Mock provider for tests</td></tr><tr><td><code>resources/&lt;type>/&lt;provider>/factory.go</code></td><td>Create</td><td>Provider factory</td></tr><tr><td><code>resources/&lt;type>/&lt;provider>/&lt;provider>.go</code></td><td>Create</td><td>Provider implementation</td></tr><tr><td><code>resources/&lt;type>/&lt;provider>/&lt;provider>_test.go</code></td><td>Create</td><td>Provider tests</td></tr><tr><td><code>resources/resources.go</code></td><td>Modify</td><td>Add case to <code>NewResourceFromProperties</code></td></tr><tr><td><code>cmd/ensure_&lt;type>.go</code></td><td>Create</td><td>CLI command handler</td></tr><tr><td><code>cmd/ensure.go</code></td><td>Modify</td><td>Register CLI command</td></tr><tr><td><code>internal/fs/schemas/manifest.json</code></td><td>Modify</td><td>Add resource schema definitions</td></tr><tr><td><code>internal/fs/schemas/resource_ensure_request.json</code></td><td>Modify</td><td>Add API request schema</td></tr><tr><td><code>docs/content/resources/&lt;type>.md</code></td><td>Create</td><td>User documentation</td></tr><tr><td><code>docs/content/design/&lt;type>/_index.md</code></td><td>Create</td><td>Design documentation</td></tr><tr><td><code>docs/content/design/&lt;type>/&lt;provider>.md</code></td><td>Create</td><td>Provider documentation</td></tr></tbody></table><h2 id=step-1-model-definitions>Step 1: Model Definitions<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Create <code>model/resource_&lt;type>.go</code> with the following components.</p><h3 id=constants>Constants<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ResourceStatus&lt;Type&gt;Protocol is the protocol identifier for &lt;type&gt; resource state</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ResourceStatus</span>&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>Protocol</span> = <span style=color:#e6db74>&#34;io.choria.ccm.v1.resource.&lt;type&gt;.state&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// &lt;Type&gt;TypeName is the type name for &lt;type&gt; resources</span>
</span></span><span style=display:flex><span>    &lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>TypeName</span> = <span style=color:#e6db74>&#34;&lt;type&gt;&#34;</span>
</span></span><span style=display:flex><span>)</span></span></code></pre></div><h3 id=properties-struct>Properties Struct<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The properties struct must satisfy <code>model.ResourceProperties</code>:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ResourceProperties</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CommonProperties</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>CommonResourceProperties</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Validate</span>() <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ResolveTemplates</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>templates</span>.<span style=color:#a6e22e>Env</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ToYamlManifest</span>() (<span style=color:#a6e22e>yaml</span>.<span style=color:#a6e22e>RawMessage</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Structure:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> &lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>ResourceProperties</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CommonResourceProperties</span> <span style=color:#e6db74>`yaml:&#34;,inline&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Add type-specific fields here</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Url</span>      <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;url&#34; yaml:&#34;url&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Checksum</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;checksum,omitempty&#34; yaml:&#34;checksum,omitempty&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Key points:</p><ul><li>Embed <code>CommonResourceProperties</code> with <code>yaml:",inline"</code> tag</li><li>Use JSON and YAML struct tags for serialization</li><li>In <code>Validate()</code>, call <code>p.CommonResourceProperties.Validate()</code> first, then add type-specific validation</li><li>In <code>ResolveTemplates()</code>, call <code>p.CommonResourceProperties.ResolveTemplates(env)</code> first, then resolve type-specific fields</li></ul><h3 id=state-struct>State Struct<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The state struct must satisfy <code>model.ResourceState</code>:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ResourceState</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CommonState</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>CommonResourceState</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Structure:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> &lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>Metadata</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>     <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;name&#34; yaml:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Provider</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;provider,omitempty&#34; yaml:&#34;provider,omitempty&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Add fields describing current system state</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> &lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>State</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CommonResourceState</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Metadata</span> <span style=color:#f92672>*</span>&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>Metadata</span> <span style=color:#e6db74>`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=factory-function>Factory Function<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Provide a factory function for YAML parsing:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>ResourcePropertiesFromYaml</span>(<span style=color:#a6e22e>raw</span> <span style=color:#a6e22e>yaml</span>.<span style=color:#a6e22e>RawMessage</span>) ([]<span style=color:#a6e22e>ResourceProperties</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>parseProperties</span>(<span style=color:#a6e22e>raw</span>, &lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>TypeName</span>, <span style=color:#66d9ef>func</span>() <span style=color:#a6e22e>ResourceProperties</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span>&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>ResourceProperties</span>{}
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h2 id=step-2-resource-type-implementation>Step 2: Resource Type Implementation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=provider-interface-resourcestypetypego>Provider Interface (<code>resources/&lt;type>/&lt;type>.go</code>)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Define a type-specific provider interface that embeds <code>model.Provider</code> and adds type-specific methods:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> &lt;<span style=color:#66d9ef>type</span>&gt;<span style=color:#a6e22e>resource</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/choria-io/ccm/model&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/choria-io/ccm/resources/&lt;type&gt;/&lt;provider&gt;&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> &lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>Factory</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ProviderFactory</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>    &lt;<span style=color:#a6e22e>provider</span>&gt;.<span style=color:#a6e22e>Register</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> &lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>Provider</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Provider</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Status</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>properties</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>ResourceProperties</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>State</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Add provider-specific methods (e.g., Download, Extract for archive)</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=type-implementation-resourcestypetypego>Type Implementation (<code>resources/&lt;type>/type.go</code>)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The Type struct must satisfy both <code>model.Resource</code> and <code>base.EmbeddedResource</code>:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// model.Resource interface</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Resource</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Type</span>() <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>() <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Provider</span>() <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Properties</span>() <span style=color:#a6e22e>ResourceProperties</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Apply</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>TransactionEvent</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Info</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#66d9ef>any</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Healthcheck</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>TransactionEvent</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// base.EmbeddedResource interface</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>EmbeddedResource</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>NewTransactionEvent</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>TransactionEvent</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ApplyResource</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ResourceState</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>SelectProvider</span>() (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Type</span>() <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Embedding <code>*base.Base</code> provides implementations for <code>Apply()</code>, <code>Healthcheck()</code>, <code>Type()</code>, <code>Name()</code>, <code>Properties()</code>, and <code>NewTransactionEvent()</code>. The type must implement:</p><ul><li><code>ApplyResource()</code> - core resource application logic</li><li><code>SelectProvider()</code> - provider selection</li><li><code>Provider()</code> - return current provider name</li><li><code>Info()</code> - return resource information</li></ul><p>Structure:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Type</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>base</span>.<span style=color:#a6e22e>Base</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>prop</span>     <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>ResourceProperties</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mgr</span>      <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Manager</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>      <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Logger</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>provider</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Provider</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>facts</span>    <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>any</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span>     <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>any</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>_</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Resource</span> = (<span style=color:#f92672>*</span><span style=color:#a6e22e>Type</span>)(<span style=color:#66d9ef>nil</span>)</span></span></code></pre></div><p>See <code>resources/archive/type.go</code> for a complete constructor example.</p><h3 id=applyresource-method>ApplyResource Method<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>ApplyResource</code> method (part of <code>base.EmbeddedResource</code>) contains the core logic. It should follow this pattern:</p><ol><li>Get initial state via <code>provider.Status()</code></li><li>Check if already in desired state (implement <code>isDesiredState()</code> helper)</li><li>If stable, call <code>t.FinalizeState()</code> and return early</li><li>Apply changes, respecting <code>t.mgr.NoopMode()</code></li><li>Get final state and verify desired state was achieved</li><li>Call <code>t.FinalizeState()</code> with appropriate flags</li></ol><p>See <code>resources/archive/type.go:ApplyResource()</code> for a complete example.</p><h3 id=provider-selection-methods>Provider Selection Methods<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>SelectProvider()</code> method should use <code>registry.FindSuitableProvider()</code> to select an appropriate provider. See <code>resources/archive/type.go</code> for the standard implementation pattern.</p><h2 id=step-3-provider-implementation>Step 3: Provider Implementation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=factory-resourcestypeproviderfactorygo>Factory (<code>resources/&lt;type>/&lt;provider>/factory.go</code>)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The factory must satisfy <code>model.ProviderFactory</code>:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ProviderFactory</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>TypeName</span>() <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>() <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>log</span> <span style=color:#a6e22e>Logger</span>, <span style=color:#a6e22e>runner</span> <span style=color:#a6e22e>CommandRunner</span>) (<span style=color:#a6e22e>Provider</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>IsManageable</span>(<span style=color:#a6e22e>facts</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>any</span>, <span style=color:#a6e22e>properties</span> <span style=color:#a6e22e>ResourceProperties</span>) (<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>The <code>IsManageable</code> method returns:</p><ul><li><code>bool</code> - whether this provider can manage the resource</li><li><code>int</code> - priority (higher wins when multiple providers match)</li><li><code>error</code> - any error encountered</li></ul><p>Structure:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> &lt;<span style=color:#a6e22e>provider</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/choria-io/ccm/internal/registry&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/choria-io/ccm/model&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ProviderName</span> = <span style=color:#e6db74>&#34;&lt;provider&gt;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Register</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>MustRegister</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>factory</span>{})
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>factory</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>factory</span>) <span style=color:#a6e22e>TypeName</span>() <span style=color:#66d9ef>string</span> { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>model</span>.&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>TypeName</span> }
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>factory</span>) <span style=color:#a6e22e>Name</span>() <span style=color:#66d9ef>string</span>     { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ProviderName</span> }
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>factory</span>) <span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>log</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Logger</span>, <span style=color:#a6e22e>runner</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>CommandRunner</span>) (<span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Provider</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>New</span>&lt;<span style=color:#a6e22e>Provider</span>&gt;<span style=color:#a6e22e>Provider</span>(<span style=color:#a6e22e>log</span>, <span style=color:#a6e22e>runner</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>factory</span>) <span style=color:#a6e22e>IsManageable</span>(<span style=color:#a6e22e>facts</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>any</span>, <span style=color:#a6e22e>prop</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ResourceProperties</span>) (<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Type assert and check if this provider can handle the resource</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>See <code>resources/archive/http/factory.go</code> for a complete example.</p><h3 id=provider-implementation-resourcestypeproviderprovidergo>Provider Implementation (<code>resources/&lt;type>/&lt;provider>/&lt;provider>.go</code>)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The provider must satisfy the type-specific provider interface defined in Step 2 (which embeds <code>model.Provider</code>):</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Provider</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>() <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Structure:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> &lt;<span style=color:#a6e22e>provider</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/choria-io/ccm/model&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> &lt;<span style=color:#a6e22e>Provider</span>&gt;<span style=color:#a6e22e>Provider</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>    <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Logger</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>runner</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>CommandRunner</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>&lt;<span style=color:#a6e22e>Provider</span>&gt;<span style=color:#a6e22e>Provider</span>(<span style=color:#a6e22e>log</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Logger</span>, <span style=color:#a6e22e>runner</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>CommandRunner</span>) (<span style=color:#f92672>*</span>&lt;<span style=color:#a6e22e>Provider</span>&gt;<span style=color:#a6e22e>Provider</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span>&lt;<span style=color:#a6e22e>Provider</span>&gt;<span style=color:#a6e22e>Provider</span>{<span style=color:#a6e22e>log</span>: <span style=color:#a6e22e>log</span>, <span style=color:#a6e22e>runner</span>: <span style=color:#a6e22e>runner</span>}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span>&lt;<span style=color:#a6e22e>Provider</span>&gt;<span style=color:#a6e22e>Provider</span>) <span style=color:#a6e22e>Name</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ProviderName</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span>&lt;<span style=color:#a6e22e>Provider</span>&gt;<span style=color:#a6e22e>Provider</span>) <span style=color:#a6e22e>Status</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>properties</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>ResourceProperties</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>State</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>model</span>.&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>State</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>CommonResourceState</span>: <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>NewCommonResourceState</span>(
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ResourceStatus</span>&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>Protocol</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>model</span>.&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>TypeName</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Name</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>EnsureAbsent</span>,
</span></span><span style=display:flex><span>        ),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Metadata</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>model</span>.&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>Metadata</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Name</span>:     <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Name</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Provider</span>: <span style=color:#a6e22e>ProviderName</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Query system state and populate metadata</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>state</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Implement other type-specific provider methods...</span></span></span></code></pre></div><p>See <code>resources/archive/http/http.go</code> for a complete example.</p><h2 id=step-4-integration-points>Step 4: Integration Points<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=update-resourcesresourcesgo>Update <code>resources/resources.go</code><span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Add the import and case statement:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>    &lt;<span style=color:#66d9ef>type</span>&gt;<span style=color:#a6e22e>resource</span> <span style=color:#e6db74>&#34;github.com/choria-io/ccm/resources/&lt;type&gt;&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewResourceFromProperties</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>mgr</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Manager</span>, <span style=color:#a6e22e>props</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ResourceProperties</span>) (<span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Resource</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>rprop</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>props</span>.(<span style=color:#66d9ef>type</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ... existing cases ...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>ResourceProperties</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> &lt;<span style=color:#66d9ef>type</span>&gt;<span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>mgr</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>rprop</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;unsupported resource property type %T&#34;</span>, <span style=color:#a6e22e>rprop</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=update-modelresourcego>Update <code>model/resource.go</code><span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Add the case to <code>NewResourcePropertiesFromYaml</code>:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewResourcePropertiesFromYaml</span>(<span style=color:#a6e22e>typeName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>rawProperties</span> <span style=color:#a6e22e>yaml</span>.<span style=color:#a6e22e>RawMessage</span>, <span style=color:#a6e22e>env</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>templates</span>.<span style=color:#a6e22e>Env</span>) ([]<span style=color:#a6e22e>ResourceProperties</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>typeName</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ... existing cases ...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> &lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>TypeName</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>props</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>New</span>&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>ResourcePropertiesFromYaml</span>(<span style=color:#a6e22e>rawProperties</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;%w: %s %s&#34;</span>, <span style=color:#a6e22e>ErrResourceInvalid</span>, <span style=color:#a6e22e>ErrUnknownType</span>, <span style=color:#a6e22e>typeName</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h2 id=step-5-cli-command>Step 5: CLI Command<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Create <code>cmd/ensure_&lt;type>.go</code>:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/choria-io/ccm/model&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/choria-io/fisk&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ensure</span>&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>Command</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Add command-specific fields for flags</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>parent</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ensureCommand</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>registerEnsure</span>&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>Command</span>(<span style=color:#a6e22e>ccm</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>fisk</span>.<span style=color:#a6e22e>CmdClause</span>, <span style=color:#a6e22e>parent</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ensureCommand</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cmd</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ensure</span>&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>Command</span>{<span style=color:#a6e22e>parent</span>: <span style=color:#a6e22e>parent</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    &lt;<span style=color:#66d9ef>type</span>&gt; <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ccm</span>.<span style=color:#a6e22e>Command</span>(<span style=color:#e6db74>&#34;&lt;type&gt;&#34;</span>, <span style=color:#e6db74>&#34;&lt;Type&gt; management&#34;</span>).<span style=color:#a6e22e>Action</span>(<span style=color:#a6e22e>cmd</span>.&lt;<span style=color:#66d9ef>type</span>&gt;<span style=color:#a6e22e>Action</span>)
</span></span><span style=display:flex><span>    &lt;<span style=color:#66d9ef>type</span>&gt;.<span style=color:#a6e22e>Arg</span>(<span style=color:#e6db74>&#34;name&#34;</span>, <span style=color:#e6db74>&#34;Resource name&#34;</span>).<span style=color:#a6e22e>Required</span>().<span style=color:#a6e22e>StringVar</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Add type-specific flags</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>addCommonFlags</span>(&lt;<span style=color:#66d9ef>type</span>&gt;)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ensure</span>&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>Command</span>) &lt;<span style=color:#66d9ef>type</span>&gt;<span style=color:#a6e22e>Action</span>(<span style=color:#a6e22e>_</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>fisk</span>.<span style=color:#a6e22e>ParseContext</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>properties</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>model</span>.&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>ResourceProperties</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>CommonResourceProperties</span>: <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>CommonResourceProperties</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Name</span>:     <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>name</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Ensure</span>:   <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>EnsurePresent</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Provider</span>: <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>provider</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Set type-specific properties from flags</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>parent</span>.<span style=color:#a6e22e>commonEnsureResource</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>properties</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Update <code>cmd/ensure.go</code>:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>registerEnsureCommand</span>(<span style=color:#a6e22e>ccm</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>fisk</span>.<span style=color:#a6e22e>Application</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ... existing code ...</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>registerEnsure</span>&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>Command</span>(<span style=color:#a6e22e>ens</span>, <span style=color:#a6e22e>cmd</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h2 id=step-6-json-schemas>Step 6: JSON Schemas<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=update-internalfsschemasmanifestjson>Update <code>internal/fs/schemas/manifest.json</code><span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Add to the <code>$defs/resource</code> properties:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#e6db74>&#34;&lt;type&gt;&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;oneOf&#34;</span>: [
</span></span><span style=display:flex><span>    { <span style=color:#f92672>&#34;$ref&#34;</span>: <span style=color:#e6db74>&#34;#/$defs/&lt;type&gt;ResourceList&#34;</span> },
</span></span><span style=display:flex><span>    { <span style=color:#f92672>&#34;$ref&#34;</span>: <span style=color:#e6db74>&#34;#/$defs/&lt;type&gt;ResourcePropertiesWithName&#34;</span> }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Add resource list definition:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#e6db74>&#34;&lt;type&gt;ResourceList&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;array&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;List of &lt;type&gt; resources to manage (named format)&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;items&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;object&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;additionalProperties&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;$ref&#34;</span>: <span style=color:#e6db74>&#34;#/$defs/&lt;type&gt;ResourceProperties&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;minProperties&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;maxProperties&#34;</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Add properties definitions:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#e6db74>&#34;&lt;type&gt;ResourcePropertiesWithName&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;allOf&#34;</span>: [
</span></span><span style=display:flex><span>    { <span style=color:#f92672>&#34;$ref&#34;</span>: <span style=color:#e6db74>&#34;#/$defs/&lt;type&gt;ResourceProperties&#34;</span> },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;object&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;name&#34;</span>: {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;string&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;Resource name&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;required&#34;</span>: [<span style=color:#e6db74>&#34;name&#34;</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}<span style=color:#960050;background-color:#1e0010>,</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&lt;type&gt;ResourceProperties&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;object&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;ensure&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;string&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;enum&#34;</span>: [<span style=color:#e6db74>&#34;present&#34;</span>, <span style=color:#e6db74>&#34;absent&#34;</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Add type-specific properties
</span></span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=update-internalfsschemasresource_ensure_requestjson>Update <code>internal/fs/schemas/resource_ensure_request.json</code><span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Add to the <code>type</code> enum:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#e6db74>&#34;enum&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> [<span style=color:#e6db74>&#34;package&#34;</span>, <span style=color:#e6db74>&#34;service&#34;</span>, <span style=color:#e6db74>&#34;file&#34;</span>, <span style=color:#e6db74>&#34;exec&#34;</span>, <span style=color:#e6db74>&#34;archive&#34;</span>, <span style=color:#e6db74>&#34;&lt;type&gt;&#34;</span>]</span></span></code></pre></div><p>Add to <code>properties.oneOf</code>:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{ <span style=color:#f92672>&#34;$ref&#34;</span>: <span style=color:#e6db74>&#34;#/$defs/&lt;type&gt;Properties&#34;</span> }</span></span></code></pre></div><p>Add properties definition under <code>$defs</code>:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#e6db74>&#34;&lt;type&gt;Properties&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;allOf&#34;</span>: [
</span></span><span style=display:flex><span>    { <span style=color:#f92672>&#34;$ref&#34;</span>: <span style=color:#e6db74>&#34;#/$defs/commonProperties&#34;</span> },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;object&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;name&#34;</span>: {
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;string&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;Resource name&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Add type-specific properties
</span></span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;required&#34;</span>: [<span style=color:#e6db74>&#34;name&#34;</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=copy-schemas-to-documentation-site>Copy Schemas to Documentation Site<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>After updating the schema files in <code>internal/fs/schemas/</code>, copy them to <code>docs/static/schemas/v1/</code> so they are available on the documentation website:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp internal/fs/schemas/manifest.json docs/static/schemas/v1/manifest.json
</span></span><span style=display:flex><span>cp internal/fs/schemas/resource_ensure_request.json docs/static/schemas/v1/resource_ensure_request.json</span></span></code></pre></div><h2 id=step-7-generate-mocks>Step 7: Generate Mocks<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Generate the provider mock for tests:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mockgen -write_generate_directive <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  -source resources/&lt;type&gt;/&lt;type&gt;.go <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  -destination resources/&lt;type&gt;/provider_mock_test.go <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  -package &lt;type&gt;resource</span></span></code></pre></div><p>Or use the project command:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>abt gen mocks</span></span></code></pre></div><h2 id=step-8-testing>Step 8: Testing<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=model-tests-modelresource_type_testgo>Model Tests (<code>model/resource_&lt;type>_test.go</code>)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Test property validation:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>Describe</span>(<span style=color:#e6db74>&#34;&lt;Type&gt;ResourceProperties&#34;</span>, <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Describe</span>(<span style=color:#e6db74>&#34;Validate&#34;</span>, <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>It</span>(<span style=color:#e6db74>&#34;should require name&#34;</span>, <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>model</span>.&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>ResourceProperties</span>{}
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Ensure</span> = <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>EnsurePresent</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Expect</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Validate</span>()).<span style=color:#a6e22e>To</span>(<span style=color:#a6e22e>MatchError</span>(<span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ErrResourceNameRequired</span>))
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>It</span>(<span style=color:#e6db74>&#34;should validate ensure values&#34;</span>, <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>model</span>.&lt;<span style=color:#a6e22e>Type</span>&gt;<span style=color:#a6e22e>ResourceProperties</span>{}
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Name</span> = <span style=color:#e6db74>&#34;test&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Ensure</span> = <span style=color:#e6db74>&#34;invalid&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Expect</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Validate</span>()).<span style=color:#a6e22e>To</span>(<span style=color:#a6e22e>HaveOccurred</span>())
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>})</span></span></code></pre></div><h3 id=type-tests-resourcestypetype_testgo>Type Tests (<code>resources/&lt;type>/type_test.go</code>)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Use the mock manager helper:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>Describe</span>(<span style=color:#e6db74>&#34;&lt;Type&gt; Type&#34;</span>, <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>mockctl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gomock</span>.<span style=color:#a6e22e>Controller</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>BeforeEach</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>mockctl</span> = <span style=color:#a6e22e>gomock</span>.<span style=color:#a6e22e>NewController</span>(<span style=color:#a6e22e>GinkgoT</span>())
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Clear</span>()
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Register mock factory</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>AfterEach</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>mockctl</span>.<span style=color:#a6e22e>Finish</span>()
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Describe</span>(<span style=color:#e6db74>&#34;Apply&#34;</span>, <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>It</span>(<span style=color:#e6db74>&#34;should handle present ensure state&#34;</span>, <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>mgr</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>modelmocks</span>.<span style=color:#a6e22e>NewManager</span>(<span style=color:#a6e22e>facts</span>, <span style=color:#a6e22e>data</span>, <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>mockctl</span>)
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Test implementation</span>
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>})</span></span></code></pre></div><h2 id=key-patterns>Key Patterns<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=state-checking>State Checking<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Always check current state before making changes:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>initialStatus</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Status</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>prop</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>isStable</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>isDesiredState</span>(<span style=color:#a6e22e>properties</span>, <span style=color:#a6e22e>initialStatus</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isStable</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// No changes needed</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>FinalizeState</span>(<span style=color:#a6e22e>initialStatus</span>, <span style=color:#a6e22e>noop</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>initialStatus</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=noop-mode>Noop Mode<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>All resources must respect noop mode:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>noop</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Make actual changes</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;Applying changes&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>SomeAction</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>properties</span>)
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;Skipping changes as noop&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>noopMessage</span> = <span style=color:#e6db74>&#34;Would have applied changes&#34;</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=error-handling>Error Handling<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Use sentinel errors from <code>model/errors.go</code>:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrResourceInvalid</span>    = <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;resource invalid&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrProviderNotFound</span>   = <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;provider not found&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrNoSuitableProvider</span> = <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;no suitable provider&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrDesiredStateFailed</span> = <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;desired state not achieved&#34;</span>)
</span></span><span style=display:flex><span>)</span></span></code></pre></div><p>Wrap errors with context:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Remove</span>(<span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;could not remove file: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=template-resolution>Template Resolution<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>ResolveTemplates</code> method (part of <code>model.ResourceProperties</code>) should resolve all user-facing string fields using <code>templates.ResolveTemplateString()</code>. Always call the embedded <code>CommonResourceProperties.ResolveTemplates(env)</code> first.</p><h3 id=provider-selection>Provider Selection<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Providers declare manageability via <code>IsManageable</code> on the factory (see <code>model.ProviderFactory</code> in Step 3). Multiple providers can match; the one with highest priority is selected.</p><h2 id=documentation>Documentation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Create user documentation in <code>docs/content/resources/&lt;type>.md</code> covering:</p><ul><li>Overview and use cases</li><li>Ensure states table</li><li>Properties table with descriptions</li><li>Usage examples (manifest, CLI, API)</li></ul><p>Create design documentation in <code>docs/content/design/&lt;type>/_index.md</code> covering:</p><ul><li>Provider interface specification</li><li>State checking logic</li><li>Apply logic flowchart</li></ul><p>Create provider documentation in <code>docs/content/design/&lt;type>/&lt;provider>.md</code> covering:</p><ul><li>Provider selection criteria</li><li>Platform requirements</li><li>Implementation details</li></ul><h2 id=ccm-studio>CCM Studio<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>CCM Studio is a web-based manifest designer. After adding a new resource type, update CCM Studio to support it:</p><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>CCM Studio is a closed-source project. The maintainers will complete this step.</p></div></details><ul><li>Add the new resource type to the resource palette</li><li>Create property editors for type-specific fields</li><li>Add validation matching the JSON schema definitions</li><li>Update any resource type documentation or help text</li></ul><footer class=footline></footer></article></section></div></main></div><script src=/js/perfect-scrollbar/perfect-scrollbar.min.js?1771940928 defer></script><script src=/js/theme.min.js?1771940928 defer></script><div id=toast-container role=status aria-live=polite aria-atomic=false></div></body></html>