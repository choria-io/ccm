<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=html><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.152.2"><meta name=generator content="Relearn 8.3.0"><meta name=description content="For certain use cases it would be useful to run YAML Manifests in an continuous nature, you might not want to manage your dotfiles automatically, allowing for local modifications, but do want to keep your Docker up to date and current.
The CCM Agent allows you to run manifests, loaded from Object Storage, in a continuous fashion with Key-Value data overlayed.
In time the Agent will become a key part in a service registry system, allowing for continous monitoring of managed resources and sharing that state into a registry: enabling other nodes to use file resources to create configurations that combine knowledge of all nodes."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Agent :: Choria Configuration Manager"><meta name=twitter:description content="For certain use cases it would be useful to run YAML Manifests in an continuous nature, you might not want to manage your dotfiles automatically, allowing for local modifications, but do want to keep your Docker up to date and current.
The CCM Agent allows you to run manifests, loaded from Object Storage, in a continuous fashion with Key-Value data overlayed.
In time the Agent will become a key part in a service registry system, allowing for continous monitoring of managed resources and sharing that state into a registry: enabling other nodes to use file resources to create configurations that combine knowledge of all nodes."><meta property="og:url" content="https://choria-io.github.io/ccm/agent/index.html"><meta property="og:site_name" content="Choria Configuration Manager"><meta property="og:title" content="Agent :: Choria Configuration Manager"><meta property="og:description" content="For certain use cases it would be useful to run YAML Manifests in an continuous nature, you might not want to manage your dotfiles automatically, allowing for local modifications, but do want to keep your Docker up to date and current.
The CCM Agent allows you to run manifests, loaded from Object Storage, in a continuous fashion with Key-Value data overlayed.
In time the Agent will become a key part in a service registry system, allowing for continous monitoring of managed resources and sharing that state into a registry: enabling other nodes to use file resources to create configurations that combine knowledge of all nodes."><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><meta itemprop=name content="Agent :: Choria Configuration Manager"><meta itemprop=description content="For certain use cases it would be useful to run YAML Manifests in an continuous nature, you might not want to manage your dotfiles automatically, allowing for local modifications, but do want to keep your Docker up to date and current.
The CCM Agent allows you to run manifests, loaded from Object Storage, in a continuous fashion with Key-Value data overlayed.
In time the Agent will become a key part in a service registry system, allowing for continous monitoring of managed resources and sharing that state into a registry: enabling other nodes to use file resources to create configurations that combine knowledge of all nodes."><meta itemprop=wordCount content="706"><title>Agent :: Choria Configuration Manager</title><link href=https://choria-io.github.io/ccm/agent/index.xml rel=alternate type=application/rss+xml title="Agent :: Choria Configuration Manager"><link href=https://choria-io.github.io/ccm/css/auto-complete/auto-complete.min.css?1768603123 rel=stylesheet><script src=https://choria-io.github.io/ccm/js/auto-complete/auto-complete.min.js?1768603123 defer></script><script src=https://choria-io.github.io/ccm/js/search-lunr.min.js?1768603123 defer></script><script src=https://choria-io.github.io/ccm/js/search.min.js?1768603123 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="https://choria-io.github.io/ccm/searchindex.en.js?1768603123"</script><script src=https://choria-io.github.io/ccm/js/lunr/lunr.min.js?1768603123 defer></script><script src=https://choria-io.github.io/ccm/js/lunr/lunr.stemmer.support.min.js?1768603123 defer></script><script src=https://choria-io.github.io/ccm/js/lunr/lunr.multi.min.js?1768603123 defer></script><script src=https://choria-io.github.io/ccm/js/lunr/lunr.en.min.js?1768603123 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["en"]</script><link href=https://choria-io.github.io/ccm/fonts/fontawesome/css/fontawesome-all.min.css?1768603123 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://choria-io.github.io/ccm/fonts/fontawesome/css/fontawesome-all.min.css?1768603123 rel=stylesheet></noscript><link href=https://choria-io.github.io/ccm/css/perfect-scrollbar/perfect-scrollbar.min.css?1768603123 rel=stylesheet><link href=https://choria-io.github.io/ccm/css/theme.min.css?1768603123 rel=stylesheet><link href=https://choria-io.github.io/ccm/css/format-html.min.css?1768603123 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/agent/index.html",window.relearn.relBasePath="..",window.relearn.relBaseUri="..",window.relearn.absBaseUri="https://choria-io.github.io/ccm",window.relearn.disableInlineCopyToClipboard=!0,window.relearn.enableBlockCodeWrap=!0,window.relearn.getItem=(e,t)=>e.getItem(t),window.relearn.setItem=(e,t,n)=>e.setItem(t,n),window.relearn.removeItem=(e,t)=>e.removeItem(t),window.T_Copy_to_clipboard=`Copy text to clipboard`,window.T_Copied_to_clipboard=`Text copied to clipboard!`,window.T_Link_copied_to_clipboard=`Link copied to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`,window.T_Browser_unsupported_feature=`This browser doesn't support this feature`,window.relearn.themevariants=["zen-auto","zen-light","ccm"],window.relearn.customvariantname="my-custom-variant",window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><script src=https://cdn.counter.dev/script.js data-id=a4622abe-f6fa-4cac-a337-a4437915e4b3></script></head><body class="mobile-support html" data-url=https://choria-io.github.io/ccm/agent/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><span class="btn cstyle button link noborder notitle interactive"><button onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></span></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><button onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button></span><div class=topbar-content><div class=topbar-content-wrapper><nav class=TableOfContents><ul><li><a href=#run-modes>Run Modes</a></li><li><a href=#supported-manifest-snd-data-sources>Supported Manifest snd Data Sources</a></li><li><a href=#logical-flow>Logical Flow</a></li><li><a href=#prometheus-metrics>Prometheus Metrics</a></li><li><a href=#configuration>Configuration</a></li></ul></nav></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=https://choria-io.github.io/ccm/index.html><span itemprop=name>Choria Configuration Manager</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Agent</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><a href=https://choria-io.github.io/ccm/yamlmanifests/index.html title="YAML Manifests (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></span></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><a href=https://choria-io.github.io/ccm/monitoring/index.html title="Monitoring (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></span></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><button onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button></span><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable agent" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=agent>Agent</h1><p>For certain use cases it would be useful to run <a href=https://choria-io.github.io/ccm/yamlmanifests/index.html>YAML Manifests</a> in an continuous nature, you might not want to manage your <code>dotfiles</code> automatically, allowing for local modifications, but do want to keep your Docker up to date and current.</p><p>The <code>CCM Agent</code> allows you to run manifests, loaded from Object Storage, in a continuous fashion with Key-Value data overlayed.</p><p>In time the Agent will become a key part in a service registry system, allowing for continous monitoring of managed resources and sharing that state into a registry: enabling other nodes to use <code>file</code> resources to create configurations that combine knowledge of all nodes.</p><h2 id=run-modes>Run Modes<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The agent supports two major modes of operation that combine into being very efficient and fast reacting:</p><ul><li>Full manifest apply managing the complete state of every resource</li><li>Health check mode, where only <a href=https://choria-io.github.io/ccm/monitoring/index.html>Monitoring</a> checks are run which would trigger full manifest apply as remediation</li></ul><p>By enabling both modes at the same time you can run monitoring very frequently - even 10 or 20 seconds intervals - and keep your full CM as something to run every few hours.</p><p>While enabling the combination is optional, it is recommended, and so we also recommend using health checks in your key resources.</p><h2 id=supported-manifest-snd-data-sources>Supported Manifest snd Data Sources<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>For Hiera data we support Key-Value stores as a local file, Key-Value values and HTTP(s) URLs.</p><p>For the manifest bundles you can point to a local file, a Object Storage URL or a HTTP(s) URL.</p><h2 id=logical-flow>Logical Flow<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The agent continuously run and manage manifests in the following way:</p><ol><li>At start the Agent fetches data and gathers facts</li><li>Starts workers for each manifest bundle<ol><li>Each worker starts watchers to download and manage the manifest tarball</li></ol></li><li>Triggers the workers at the configured interval to do a full apply<ol><li>Each run updates facts and data</li><li>Triggers each manifest in a serial manner</li></ol></li><li>Triggers the workers at the configured health check interval to do health checks<ol><li>Each run of the health checks do not update facts or data</li><li>Triggers each manifest in a serial manner</li><li>Should any health checks be critical (not warning) the agent will trigger a full apply of the specific worker</li></ol></li></ol><p>In the background object stores and KV as watched and updates to these will trigger apply runs.</p><h2 id=prometheus-metrics>Prometheus Metrics<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>When the HTTP port is configured the agent will expose Prometheus metrics on <code>/metrics</code> that can be used to monitor the health of the agent, get metrics of resource states and event, health check statusses and later we will expose health check metrics.</p><h2 id=configuration>Configuration<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The agent is included in the same <code>ccm</code> binary so nothing new is needed but you should configure it enable the <code>systemd</code> service to use it:</p><p>The configuration file is located at <code>/etc/choria/ccm/config.yaml</code> and looks like:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># CCM Agent Configuration Example</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># This file configures the CCM agent that manages manifest apply cycles.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Time between scheduled manifest apply runs.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Must be at least 30s. Defaults to 5m.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Supports duration strings like &#34;30s&#34;, &#34;5m&#34;, &#34;1h&#34;.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>interval</span>: <span style=color:#ae81ff>5m</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Time between health check runs.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># When set, health checks run independently of apply runs and can trigger</span>
</span></span><span style=display:flex><span><span style=color:#75715e># remediation applies when critical issues are detected.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Leave empty or omit to disable periodic health checks.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>health_check_interval</span>: <span style=color:#ae81ff>1m</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># List of manifest sources to apply. Each source creates a separate worker</span>
</span></span><span style=display:flex><span><span style=color:#75715e># that manages its own apply cycle.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Supported formats:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#   - File paths: /path/to/manifest.yaml</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#   - Object store URLs: obj://bucket/key.tar.gz</span>
</span></span><span style=display:flex><span><span style=color:#f92672>manifests</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>/etc/choria/ccm/manifests/base.yaml</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>obj://ccm-manifests/app.tar.gz</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Configures the logging level to use, one of debug, info, warn, error</span>
</span></span><span style=display:flex><span><span style=color:#f92672>log_level</span>: <span style=color:#ae81ff>info</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Sets the NATS context to use for authentication, defaults to &#39;CCM&#39; when not set</span>
</span></span><span style=display:flex><span><span style=color:#f92672>nats_context</span>: <span style=color:#ae81ff>CCM</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Optional URL to fetch external data from using hiera resolution.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># The resolved data is merged into the manifest data context.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Supports file:// and obj:// URLs.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Leave empty or omit if not using external data.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>external_data_url</span>: <span style=color:#ae81ff>obj://ccm-data/common</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Directory used to cache manifest sources fetched from remote locations.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Defaults to /etc/choria/ccm/source.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>cache_dir</span>: <span style=color:#ae81ff>/etc/choria/ccm/source</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># If set, a HTTP listener will be started that expose Prometheus metrics on /metrics</span>
</span></span><span style=display:flex><span><span style=color:#f92672>monitor_port</span>: <span style=color:#ae81ff>0</span></span></span></code></pre></div><p>Follow the comments in the file and then start your service using <code>ccm ensure service ccm-agent running --enable</code></p><footer class=footline></footer></article></div></main></div><aside id=R-sidebar class=default-animation><div id=R-header-topbar class=default-animation></div><div id=R-header-wrapper class=default-animation><div id=R-header class=default-animation><img src=https://choria-io.github.io/ccm/logo.png></div><search><form action=https://choria-io.github.io/ccm/search/index.html method=get><div class="searchbox default-animation"><button class=search-detail type=submit title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
<label class=a11y-only for=R-search-by>Search</label>
<input data-search-input id=R-search-by name=search-by class=search-by type=search placeholder=Search...>
<button class=search-clear type=button data-search-clear title="Clear search"><i class="fas fa-times" title="Clear search"></i></button></div></form></search></div><div id=R-homelinks class="default-animation homelinks"><div class="R-menu-divider default-animation"><hr class=padding></div><div class="R-sidebarmenu R-shortcutmenu-homelinks"><ul class="space collapsible-menu"><li data-nav-url=https://choria-io.github.io/ccm/index.html><a class=padding href=https://choria-io.github.io/ccm/index.html><i class="fa-fw fas fa-home"></i> Home</a></li></ul></div><div class="R-menu-divider default-animation"><hr class=padding></div><div class="R-sidebarmenu R-shortcutmenu-headercontrols"><ul></ul></div><div class="R-menu-divider default-animation"><hr class=padding></div></div><div id=R-content-wrapper class=highlightable><div class="R-sidebarmenu R-shortcutmenu-main"><ul class="enlarge morespace collapsible-menu"><li data-nav-url=https://choria-io.github.io/ccm/resources/index.html><a class=padding href=https://choria-io.github.io/ccm/resources/index.html><b>1. </b>Resources</a></li><li data-nav-url=https://choria-io.github.io/ccm/hiera/index.html><a class=padding href=https://choria-io.github.io/ccm/hiera/index.html><b>2. </b>Hierarchical Data</a></li><li data-nav-url=https://choria-io.github.io/ccm/data/index.html><a class=padding href=https://choria-io.github.io/ccm/data/index.html><b>3. </b>Data</a></li><li data-nav-url=https://choria-io.github.io/ccm/cli/index.html><a class=padding href=https://choria-io.github.io/ccm/cli/index.html><b>4. </b>Shell Usage</a></li><li data-nav-url=https://choria-io.github.io/ccm/yamlmanifests/index.html><a class=padding href=https://choria-io.github.io/ccm/yamlmanifests/index.html><b>5. </b>YAML Manifests</a></li><li class=active data-nav-url=https://choria-io.github.io/ccm/agent/index.html><a class=padding href=https://choria-io.github.io/ccm/agent/index.html><b>6. </b>Agent</a></li><li data-nav-url=https://choria-io.github.io/ccm/monitoring/index.html><a class=padding href=https://choria-io.github.io/ccm/monitoring/index.html><b>7. </b>Monitoring</a></li></ul></div><div class="R-sidebarmenu R-shortcutmenu-shortcuts"><div class="nav-title padding">More</div><ul class="space collapsible-menu"><li data-nav-url=https://github.com/choria-io/ccm><a class=padding href=https://github.com/choria-io/ccm rel=external><i class='fab fa-fw fa-github'></i> GitHub</a></li><li data-nav-url=https://github.com/choria-io/ccm/releases><a class=padding href=https://github.com/choria-io/ccm/releases rel=external><i class='far fa-save'></i> Download</a></li><li data-nav-url=https://github.com/choria-io/ccm/discussions><a class=padding href=https://github.com/choria-io/ccm/discussions rel=external><i class='far fa-comments'></i> Discussions</a></li><li data-nav-url=https://github.com/choria-io/ccm/issues><a class=padding href=https://github.com/choria-io/ccm/issues rel=external><i class='far fa-life-ring'></i> Issues</a></li><li data-nav-url=https://short.voxpupu.li/puppetcommunity_slack_signup><a class=padding href=https://short.voxpupu.li/puppetcommunity_slack_signup rel=external><i class='fab fa-slack'></i> #choria</a></li></ul></div><div id=R-footer-margin></div><div class="R-menu-divider default-animation"><hr class=padding></div><div class="R-sidebarmenu R-shortcutmenu-footercontrols"><ul><li class=R-variantswitcher><div class="padding menu-control"><i class="fa-fw fas fa-paint-brush"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=R-select-variant>Theme</label>
<select id=R-select-variant><option id=R-select-variant-zen-auto value=zen-auto selected>Auto Theme</option><option id=R-select-variant-zen-light value=zen-light>Light</option><option id=R-select-variant-ccm value=ccm>Dark</option></select></div><div class=clear></div></div><script>window.relearn.markVariant()</script></li></ul></div><div id=R-footer><p>Built with <a href=https://github.com/McShelby/hugo-theme-relearn title=love><i class="fas fa-heart"></i></a> by <a href=https://gohugo.io/>Hugo</a></p></div></div></aside><script src=https://choria-io.github.io/ccm/js/perfect-scrollbar/perfect-scrollbar.min.js?1768603123 defer></script><script src=https://choria-io.github.io/ccm/js/theme.min.js?1768603123 defer></script><div id=toast-container role=status aria-live=polite aria-atomic=false></div></body></html>