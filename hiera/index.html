<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=html><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.152.2"><meta name=generator content="Relearn 8.3.0"><meta name=description content="Choria Hierarchical Data Resolver is a small data resolver inspired by Hiera. It evaluates a YAML or JSON document alongside a set of facts to produce a final data map. The resolver supports first and deep merge strategies and relwies on simple string interpolation for hierarchy entries.
It is optimized for single files that hold the hierarchy and data rather than the multi-file approach common in Hiera.
Major features:
Lookup expressions based on a full language Types are supported, and lookups can return typed data Command line tool that includes built-in system facts Go library Usage Hereâ€™s an annotated example:"><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Hierarchical Data :: Choria Configuration Manager"><meta name=twitter:description content="Choria Hierarchical Data Resolver is a small data resolver inspired by Hiera. It evaluates a YAML or JSON document alongside a set of facts to produce a final data map. The resolver supports first and deep merge strategies and relwies on simple string interpolation for hierarchy entries.
It is optimized for single files that hold the hierarchy and data rather than the multi-file approach common in Hiera.
Major features:
Lookup expressions based on a full language Types are supported, and lookups can return typed data Command line tool that includes built-in system facts Go library Usage Hereâ€™s an annotated example:"><meta property="og:url" content="https://choria-io.github.io/ccm/hiera/index.html"><meta property="og:site_name" content="Choria Configuration Manager"><meta property="og:title" content="Hierarchical Data :: Choria Configuration Manager"><meta property="og:description" content="Choria Hierarchical Data Resolver is a small data resolver inspired by Hiera. It evaluates a YAML or JSON document alongside a set of facts to produce a final data map. The resolver supports first and deep merge strategies and relwies on simple string interpolation for hierarchy entries.
It is optimized for single files that hold the hierarchy and data rather than the multi-file approach common in Hiera.
Major features:
Lookup expressions based on a full language Types are supported, and lookups can return typed data Command line tool that includes built-in system facts Go library Usage Hereâ€™s an annotated example:"><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><meta itemprop=name content="Hierarchical Data :: Choria Configuration Manager"><meta itemprop=description content="Choria Hierarchical Data Resolver is a small data resolver inspired by Hiera. It evaluates a YAML or JSON document alongside a set of facts to produce a final data map. The resolver supports first and deep merge strategies and relwies on simple string interpolation for hierarchy entries.
It is optimized for single files that hold the hierarchy and data rather than the multi-file approach common in Hiera.
Major features:
Lookup expressions based on a full language Types are supported, and lookups can return typed data Command line tool that includes built-in system facts Go library Usage Hereâ€™s an annotated example:"><meta itemprop=wordCount content="843"><title>Hierarchical Data :: Choria Configuration Manager</title><link href=https://choria-io.github.io/ccm/hiera/index.xml rel=alternate type=application/rss+xml title="Hierarchical Data :: Choria Configuration Manager"><link href=https://choria-io.github.io/ccm/css/auto-complete/auto-complete.min.css?1766605277 rel=stylesheet><script src=https://choria-io.github.io/ccm/js/auto-complete/auto-complete.min.js?1766605277 defer></script><script src=https://choria-io.github.io/ccm/js/search-lunr.min.js?1766605277 defer></script><script src=https://choria-io.github.io/ccm/js/search.min.js?1766605277 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="https://choria-io.github.io/ccm/searchindex.en.js?1766605277"</script><script src=https://choria-io.github.io/ccm/js/lunr/lunr.min.js?1766605277 defer></script><script src=https://choria-io.github.io/ccm/js/lunr/lunr.stemmer.support.min.js?1766605277 defer></script><script src=https://choria-io.github.io/ccm/js/lunr/lunr.multi.min.js?1766605277 defer></script><script src=https://choria-io.github.io/ccm/js/lunr/lunr.en.min.js?1766605277 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["en"]</script><link href=https://choria-io.github.io/ccm/fonts/fontawesome/css/fontawesome-all.min.css?1766605277 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=https://choria-io.github.io/ccm/fonts/fontawesome/css/fontawesome-all.min.css?1766605277 rel=stylesheet></noscript><link href=https://choria-io.github.io/ccm/css/perfect-scrollbar/perfect-scrollbar.min.css?1766605277 rel=stylesheet><link href=https://choria-io.github.io/ccm/css/theme.min.css?1766605277 rel=stylesheet><link href=https://choria-io.github.io/ccm/css/format-html.min.css?1766605277 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/hiera/index.html",window.relearn.relBasePath="..",window.relearn.relBaseUri="..",window.relearn.absBaseUri="https://choria-io.github.io/ccm",window.relearn.disableInlineCopyToClipboard=!0,window.relearn.enableBlockCodeWrap=!0,window.relearn.getItem=(e,t)=>e.getItem(t),window.relearn.setItem=(e,t,n)=>e.setItem(t,n),window.relearn.removeItem=(e,t)=>e.removeItem(t),window.T_Copy_to_clipboard=`Copy text to clipboard`,window.T_Copied_to_clipboard=`Text copied to clipboard!`,window.T_Link_copied_to_clipboard=`Link copied to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`,window.T_Browser_unsupported_feature=`This browser doesn't support this feature`,window.relearn.themevariants=["zen-auto","zen-light","ccm"],window.relearn.customvariantname="my-custom-variant",window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><script src=https://cdn.counter.dev/script.js data-id=a4622abe-f6fa-4cac-a337-a4437915e4b3></script></head><body class="mobile-support html" data-url=https://choria-io.github.io/ccm/hiera/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><span class="btn cstyle button link noborder notitle interactive"><button onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></span></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><button onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button></span><div class=topbar-content><div class=topbar-content-wrapper><nav class=TableOfContents><ul><li><ul><li><a href=#usage>Usage</a></li><li><a href=#cli-example>CLI Example</a></li><li><a href=#data-in-nats>Data in NATS</a></li><li><a href=#go-example>Go example</a></li></ul></li></ul></nav></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=https://choria-io.github.io/ccm/index.html><span itemprop=name>Choria Configuration Manager</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Hierarchical Data</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><a href=https://choria-io.github.io/ccm/resources/index.html title="Resources (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></span></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><a href=https://choria-io.github.io/ccm/data/index.html title="Data (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></span></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><button onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button></span><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable hiera" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=hierarchical-data>Hierarchical Data</h1><p>Choria Hierarchical Data Resolver is a small data resolver inspired by Hiera. It evaluates a YAML or JSON document alongside a set of facts to produce a final data map. The resolver supports first and deep merge strategies and relwies on simple string interpolation for hierarchy entries.</p><p>It is optimized for single files that hold the hierarchy and data rather than the multi-file approach common in Hiera.</p><p>Major features:</p><ul><li>Lookup expressions based on a full language</li><li>Types are supported, and lookups can return typed data</li><li>Command line tool that includes built-in system facts</li><li>Go library</li></ul><h3 id=usage>Usage<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Here&rsquo;s an annotated example:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>hierarchy</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># this is the lookup and override order, facts will be resolved here</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># if your fact is nested, you can use gjson format queries like via the lookup function {{ lookup(&#39;networking.fqdn&#39;) }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>order</span>:
</span></span><span style=display:flex><span>     - <span style=color:#ae81ff>env:{{ lookup(&#39;facts.env&#39;) }}</span>
</span></span><span style=display:flex><span>     - <span style=color:#ae81ff>role:{{ lookup(&#39;facts.role&#39;) }}</span>
</span></span><span style=display:flex><span>     - <span style=color:#ae81ff>host:{{ lookup(&#39;facts.hostname&#39;) }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>merge</span>: <span style=color:#ae81ff>deep</span> <span style=color:#75715e># or first</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># This is the resulting output and must be present, the hierarchy results will be merged in</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>   <span style=color:#f92672>log_level</span>: <span style=color:#ae81ff>INFO</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>packages</span>:
</span></span><span style=display:flex><span>     - <span style=color:#ae81ff>ca-certificates</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>web</span>:
</span></span><span style=display:flex><span>     <span style=color:#75715e># we look up the number and convert its type to a int if the facts was not already an int</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>listen_port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>tls</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>overrides</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>env:prod</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>log_level</span>: <span style=color:#ae81ff>WARN</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>role:web</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>packages</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>web</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>listen_port</span>: <span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>tls</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>host:web01</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>log_level</span>: <span style=color:#ae81ff>TRACE</span></span></span></code></pre></div><p>The templating used here is identical to that used in the <a href=https://choria-io.github.io/ccm/data/index.html>Data documentation section</a> except that only the <code>lookup()</code> function was added not ones for accessing files etc.</p><h3 id=cli-example>CLI Example<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>A small utility is provided to resolve a hierarchy file and a set of facts. This utility has some different rules and behaviors for loading facts than the <code>ccm</code> suite in general since we want it to be a genericly usable tool even without system facts etc, so we make it easy to pass flags on the CLI etc.</p><p>Given the input file data.json:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;hierarchy&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;order&#34;</span>: [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;fqdn:{{ lookup(&#39;facts.fqdn&#39;}} }}&#34;</span>
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;data&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;test&#34;</span>: <span style=color:#e6db74>&#34;value&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;overrides&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;fqdn:my.fqdn.com&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;test&#34;</span>: <span style=color:#e6db74>&#34;override&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>We can run the utility like this:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ccm hiera parse data.json fqdn<span style=color:#f92672>=</span>my.fqdn.com
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;test&#34;</span>: <span style=color:#e6db74>&#34;override&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>$ ccm hiera parse data.json fqdn<span style=color:#f92672>=</span>other.fqdn.com
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;test&#34;</span>: <span style=color:#e6db74>&#34;value&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span></span></span></code></pre></div><p>It can also produce YAML output:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ccm hiera parse test.json fqdn<span style=color:#f92672>=</span>other.fqdn.com --yaml
</span></span><span style=display:flex><span>test: value</span></span></code></pre></div><p>It can also produce Environment Variable output:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ccm hiera parse test.json fqdn<span style=color:#f92672>=</span>other.fqdn.com --env
</span></span><span style=display:flex><span>HIERA_TEST<span style=color:#f92672>=</span>value</span></span></code></pre></div><p>In these examples we provided facts from a file or on the CLI, we can also populate the facts from an internal fact provider, first we view the internal facts:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ccm hiera facts --system-facts
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  ....
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;host&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;info&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;hostname&#34;</span>: <span style=color:#e6db74>&#34;example.net&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;uptime&#34;</span>: 3725832,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;bootTime&#34;</span>: 1760351572,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;procs&#34;</span>: 625,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;os&#34;</span>: <span style=color:#e6db74>&#34;darwin&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;platform&#34;</span>: <span style=color:#e6db74>&#34;darwin&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;platformFamily&#34;</span>: <span style=color:#e6db74>&#34;Standalone Workstation&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;platformVersion&#34;</span>: <span style=color:#e6db74>&#34;15.7.1&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;kernelVersion&#34;</span>: <span style=color:#e6db74>&#34;24.6.0&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;kernelArch&#34;</span>: <span style=color:#e6db74>&#34;arm64&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;virtualizationSystem&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;virtualizationRole&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>....</span></span></code></pre></div><p>Now we resolve the data using those facts:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ccm hiera parse test.json --system-facts</span></span></code></pre></div><p>We can also populate the environment variables as facts, variables will be split on the = and the variable name becomes a fact name.</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ccm hiera parse test.json --env-facts</span></span></code></pre></div><p>These facts will be merged with ones from the command line and external files and all can be combined</p><h3 id=data-in-nats>Data in NATS<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><a href=https://nats.io rel=external>NATS</a> is a lightweight messaging system that is straightforward to run and host; it supports being used as a Key-Value store.</p><p>We can&rsquo;t cover NATS here in detail here, but hierarchy data can be stored in NATS Key-Value stores and used in the <code>ccm ensure</code> and <code>ccm hiera</code> commands.</p><p>To use NATS as a hierarchy store, you need to configure a NATS <code>context</code> - a way to configure authentication or URLs for NATS.</p><p>Let&rsquo;s add a context called <code>ccm</code> for our needs:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>$ nats context add ccm --user nats.example.org --user ccm --password sÂ£cret --description &#34;Choria CM Configuration Store&#34; </code></pre></div><p>We create a KV store that is stored replicated in a cluster and store the hierarchy from <code>hiera.yaml</code> in a Key called <code>data</code>:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>$ nats kv add CCM --replicas 3 --context ccm
$ nats kv put CCM data &#34;$(cat hiera.yaml)&#34;</code></pre></div><p>We can now parse the hierarchy using system facts, this is identical to using the file locally:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>$ ccm hiera parse kv://CCM/data --context ccm -S</code></pre></div><h3 id=go-example>Go example<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Supply a YAML document and a map of facts. The resolver will parse the hierarchy, replace <code>{{ lookup('facts.fact') }}</code> placeholders, and merge the matching sections.</p><p>Here the hierarchy key defines the lookup strategies and the data key defines what will be returned.</p><p>The rest is the hierarchy data.</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;github.com/choria-io/ccm/hiera&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>yamlDoc</span> <span style=color:#f92672>:=</span> []byte(<span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74> hierarchy:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   order:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     - env:</span><span style=color:#75715e>{{</span> <span style=color:#a6e22e>lookup</span><span style=color:#f92672>(</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#a6e22e>facts</span><span style=color:#a6e22e>.env</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>)</span> <span style=color:#75715e>}}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     - role:</span><span style=color:#75715e>{{</span> <span style=color:#a6e22e>lookup</span><span style=color:#f92672>(</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#a6e22e>facts</span><span style=color:#a6e22e>.role</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>)</span> <span style=color:#75715e>}}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     - host:</span><span style=color:#75715e>{{</span> <span style=color:#a6e22e>lookup</span><span style=color:#f92672>(</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#a6e22e>facts</span><span style=color:#a6e22e>.hostname</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>)</span> <span style=color:#75715e>}}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   merge: deep
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74> data:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   log_level: INFO
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   packages:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     - ca-certificates
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   web:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     listen_port: 80
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     tls: false
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74> overrides:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     env:prod:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>       log_level: WARN
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     role:web:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>       packages:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>         - nginx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>       web:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>         tls: true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     host:web01:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>       log_level: TRACE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>`</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>facts</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>any</span>{
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;env&#34;</span>:      <span style=color:#e6db74>&#34;prod&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;role&#34;</span>:     <span style=color:#e6db74>&#34;web&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;hostname&#34;</span>: <span style=color:#e6db74>&#34;web01&#34;</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>logger</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>manager</span>.<span style=color:#a6e22e>NewSlogLogger</span>(
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>New</span>(
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>NewTextHandler</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stderr</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>HandlerOptions</span>{<span style=color:#a6e22e>Level</span>: <span style=color:#a6e22e>slog</span>.<span style=color:#a6e22e>LevelInfo</span>})))
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resolved</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>hiera</span>.<span style=color:#a6e22e>ResolveYaml</span>(<span style=color:#a6e22e>yamlDoc</span>, <span style=color:#a6e22e>facts</span>, <span style=color:#a6e22e>hiera</span>.<span style=color:#a6e22e>DefaultOptions</span>, <span style=color:#a6e22e>logger</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    	<span style=color:#a6e22e>jout</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>MarshalIndent</span>(<span style=color:#a6e22e>res</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;  &#34;</span>)
</span></span><span style=display:flex><span>    	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    		    panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>jout</span>))
</span></span><span style=display:flex><span>}</span></span></code></pre></div><footer class=footline></footer></article></div></main></div><aside id=R-sidebar class=default-animation><div id=R-header-topbar class=default-animation></div><div id=R-header-wrapper class=default-animation><div id=R-header class=default-animation><img src=https://choria-io.github.io/ccm/logo.png></div><search><form action=https://choria-io.github.io/ccm/search/index.html method=get><div class="searchbox default-animation"><button class=search-detail type=submit title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
<label class=a11y-only for=R-search-by>Search</label>
<input data-search-input id=R-search-by name=search-by class=search-by type=search placeholder=Search...>
<button class=search-clear type=button data-search-clear title="Clear search"><i class="fas fa-times" title="Clear search"></i></button></div></form></search></div><div id=R-homelinks class="default-animation homelinks"><div class="R-menu-divider default-animation"><hr class=padding></div><div class="R-sidebarmenu R-shortcutmenu-homelinks"><ul class="space collapsible-menu"><li data-nav-url=https://choria-io.github.io/ccm/index.html><a class=padding href=https://choria-io.github.io/ccm/index.html><i class="fa-fw fas fa-home"></i> Home</a></li></ul></div><div class="R-menu-divider default-animation"><hr class=padding></div><div class="R-sidebarmenu R-shortcutmenu-headercontrols"><ul></ul></div><div class="R-menu-divider default-animation"><hr class=padding></div></div><div id=R-content-wrapper class=highlightable><div class="R-sidebarmenu R-shortcutmenu-main"><ul class="enlarge morespace collapsible-menu"><li data-nav-url=https://choria-io.github.io/ccm/resources/index.html><a class=padding href=https://choria-io.github.io/ccm/resources/index.html><b>1. </b>Resources</a></li><li class=active data-nav-url=https://choria-io.github.io/ccm/hiera/index.html><a class=padding href=https://choria-io.github.io/ccm/hiera/index.html><b>2. </b>Hierarchical Data</a></li><li data-nav-url=https://choria-io.github.io/ccm/data/index.html><a class=padding href=https://choria-io.github.io/ccm/data/index.html><b>3. </b>Data</a></li><li data-nav-url=https://choria-io.github.io/ccm/cli/index.html><a class=padding href=https://choria-io.github.io/ccm/cli/index.html><b>4. </b>CLI Usage</a></li><li data-nav-url=https://choria-io.github.io/ccm/yamlmanifests/index.html><a class=padding href=https://choria-io.github.io/ccm/yamlmanifests/index.html><b>5. </b>YAML Manifests</a></li><li data-nav-url=https://choria-io.github.io/ccm/monitoring/index.html><a class=padding href=https://choria-io.github.io/ccm/monitoring/index.html><b>6. </b>Monitoring</a></li></ul></div><div class="R-sidebarmenu R-shortcutmenu-shortcuts"><div class="nav-title padding">More</div><ul class="space collapsible-menu"><li data-nav-url=https://github.com/choria-io/ccm><a class=padding href=https://github.com/choria-io/ccm rel=external><i class='fab fa-fw fa-github'></i> GitHub</a></li><li data-nav-url=https://github.com/choria-io/ccm/releases><a class=padding href=https://github.com/choria-io/ccm/releases rel=external><i class='far fa-save'></i> Download</a></li><li data-nav-url=https://github.com/choria-io/ccm/discussions><a class=padding href=https://github.com/choria-io/ccm/discussions rel=external><i class='far fa-comments'></i> Discussions</a></li><li data-nav-url=https://github.com/choria-io/ccm/issues><a class=padding href=https://github.com/choria-io/ccm/issues rel=external><i class='far fa-life-ring'></i> Issues</a></li><li data-nav-url=https://short.voxpupu.li/puppetcommunity_slack_signup><a class=padding href=https://short.voxpupu.li/puppetcommunity_slack_signup rel=external><i class='fab fa-slack'></i> #choria</a></li></ul></div><div id=R-footer-margin></div><div class="R-menu-divider default-animation"><hr class=padding></div><div class="R-sidebarmenu R-shortcutmenu-footercontrols"><ul><li class=R-variantswitcher><div class="padding menu-control"><i class="fa-fw fas fa-paint-brush"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=R-select-variant>Theme</label>
<select id=R-select-variant><option id=R-select-variant-zen-auto value=zen-auto selected>Auto Theme</option><option id=R-select-variant-zen-light value=zen-light>Light</option><option id=R-select-variant-ccm value=ccm>Dark</option></select></div><div class=clear></div></div><script>window.relearn.markVariant()</script></li></ul></div><div id=R-footer><p>Built with <a href=https://github.com/McShelby/hugo-theme-relearn title=love><i class="fas fa-heart"></i></a> by <a href=https://gohugo.io/>Hugo</a></p></div></div></aside><script src=https://choria-io.github.io/ccm/js/perfect-scrollbar/perfect-scrollbar.min.js?1766605277 defer></script><script src=https://choria-io.github.io/ccm/js/theme.min.js?1766605277 defer></script><div id=toast-container role=status aria-live=polite aria-atomic=false></div></body></html>