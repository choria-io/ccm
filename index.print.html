<!doctype html><html id=R-html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=print><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.154.5"><meta name=generator content="Relearn 9.0.3"><meta name=description content="CCM is a small-scale Configuration Management system designed to meet users where they are - enabling experimentation, R&amp;D, and exploration without the overhead of full-system management while still following sound Configuration Management principles.
We focus on great UX, immediate feedback, and interactive use with minimal friction.
Small and FocusedEmbraces the popular package-config-service style of Configuration Management.
Focused on the needs of a single application or unit of software."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Introduction :: Choria Configuration Manager"><meta name=twitter:description content="CCM is a small-scale Configuration Management system designed to meet users where they are - enabling experimentation, R&amp;D, and exploration without the overhead of full-system management while still following sound Configuration Management principles.
We focus on great UX, immediate feedback, and interactive use with minimal friction.
Small and FocusedEmbraces the popular package-config-service style of Configuration Management.
Focused on the needs of a single application or unit of software."><meta property="og:url" content="https://choria-cm.dev/index.html"><meta property="og:site_name" content="Choria Configuration Manager"><meta property="og:title" content="Introduction :: Choria Configuration Manager"><meta property="og:description" content="CCM is a small-scale Configuration Management system designed to meet users where they are - enabling experimentation, R&amp;D, and exploration without the overhead of full-system management while still following sound Configuration Management principles.
We focus on great UX, immediate feedback, and interactive use with minimal friction.
Small and FocusedEmbraces the popular package-config-service style of Configuration Management.
Focused on the needs of a single application or unit of software."><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><meta itemprop=name content="Introduction :: Choria Configuration Manager"><meta itemprop=description content="CCM is a small-scale Configuration Management system designed to meet users where they are - enabling experimentation, R&amp;D, and exploration without the overhead of full-system management while still following sound Configuration Management principles.
We focus on great UX, immediate feedback, and interactive use with minimal friction.
Small and FocusedEmbraces the popular package-config-service style of Configuration Management.
Focused on the needs of a single application or unit of software."><meta itemprop=wordCount content="521"><title>Introduction :: Choria Configuration Manager</title><link href=https://choria-cm.dev/index.html rel=canonical type=text/html title="Introduction :: Choria Configuration Manager"><link href=/index.xml rel=alternate type=application/rss+xml title="Introduction :: Choria Configuration Manager"><link href=/index.md rel=alternate type=text/markdown title="Introduction :: Choria Configuration Manager"><link href=/llms.txt rel=alternate type=text/plain title="Introduction :: Choria Configuration Manager"><link href=/css/auto-complete/auto-complete.min.css?1770911710 rel=stylesheet><script src=/js/auto-complete/auto-complete.min.js?1770911710 defer></script><script src=/js/search-lunr.min.js?1770911710 defer></script><script src=/js/search.min.js?1770911710 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="/searchindex.en.js?1770911710"</script><script src=/js/lunr/lunr.min.js?1770911710 defer></script><script src=/js/lunr/lunr.stemmer.support.min.js?1770911710 defer></script><script src=/js/lunr/lunr.multi.min.js?1770911710 defer></script><script src=/js/lunr/lunr.en.min.js?1770911710 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["en"]</script><link href=/fonts/fontawesome/css/all.min.css?1770911710 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/fonts/fontawesome/css/all.min.css?1770911710 rel=stylesheet></noscript><link href=/css/perfect-scrollbar/perfect-scrollbar.min.css?1770911710 rel=stylesheet><link href=/css/theme.min.css?1770911710 rel=stylesheet><link href=/css/format-print.min.css?1770911710 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/index.html",window.relearn.relBasePath=".",window.relearn.relBaseUri=".",window.relearn.absBaseUri="https://choria-cm.dev",window.relearn.disableInlineCopyToClipboard=!0,window.relearn.enableBlockCodeWrap=!0,window.T_Copy_to_clipboard=`Copy text to clipboard`,window.T_Copied_to_clipboard=`Text copied to clipboard!`,window.T_Link_copied_to_clipboard=`Link copied to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`,window.T_Browser_unsupported_feature=`This browser doesn't support this feature`,window.relearn.themevariants=["zen-auto","zen-light","ccm"],window.relearn.customvariantprefix="my-custom-",window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.localStorage.getItem(window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.localStorage.getItem(window.relearn.absBaseUri+"/variant")??"";(!e||!e.startsWith(window.relearn.customvariantprefix)&&!window.relearn.themevariants.includes(e)||e.startsWith(window.relearn.customvariantprefix)&&!window.localStorage.getItem(window.relearn.absBaseUri+"/variantstylesheet-"+e))&&(e=window.relearn.themevariants[0],window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><script src=https://cdn.counter.dev/script.js data-id=a4622abe-f6fa-4cac-a337-a4437915e4b3></script></head><body class="mobile-support print" data-origin=/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar class=default-animation><div class="topbar-wrapper default-animation"><div class="topbar-sidebar-divider default-animation"></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar default-animation" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><span class="btn cstyle button link noborder notitle interactive"><button onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></span></div><div class="topbar-button topbar-button-toc default-animation" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><button onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-table-list"></i></button></span><div class=topbar-content><div class=topbar-content-wrapper><nav class=TableOfContents><ul><li><a href=#shell-example>Shell Example</a></li><li><a href=#manifest-example>Manifest Example</a></li><li><a href=#status>Status</a></li></ul></nav></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Introduction</span><meta itemprop=position content="1"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-markdown default-animation" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><a href=/index.md title="Show Markdown"><i class="fa-fw fab fa-markdown"></i></a></span></div><div class="topbar-button topbar-button-print default-animation" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><a href=/index.print.html title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a></span></div><div class="topbar-button topbar-button-prev default-animation" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle"><span><i class="fa-fw fas fa-chevron-left"></i></span></span></div><div class="topbar-button topbar-button-next default-animation" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><a href=/resources/index.html title="Resources (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></span></div><div class="topbar-button topbar-button-more default-animation" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><span class="btn cstyle button link noborder notitle interactive"><button onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button></span><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable page" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><p>CCM is a small-scale Configuration Management system designed to meet users where they are - enabling experimentation, R&amp;D, and exploration without the overhead of full-system management while still following sound Configuration Management principles.</p><p>We focus on great UX, immediate feedback, and interactive use with minimal friction.</p><ul class=card-container><li><article class=card aria-labelledby=R-card-99060f617a8a1c8f1e0831a15a818f11><div class=card-content><div class=card-title id=R-card-99060f617a8a1c8f1e0831a15a818f11>Small and Focused</div><div class=card-content-text><p>Embraces the popular <em>package-config-service</em> style of Configuration Management.</p><p>Focused on the needs of a single application or unit of software.</p><p>Minimal design for easy adoption, experimentation, and integration with tools like LLMs.</p></div></div></article></li><li><article class=card aria-labelledby=R-card-ee99ab69584cc69c7ba51c2a6c4c399c><div class=card-content><div class=card-title id=R-card-ee99ab69584cc69c7ba51c2a6c4c399c>Loves Snowflakes</div><div class=card-content-text><p>Brings true Configuration Management principles to ad-hoc systems, enabling use cases where traditional CM fails.</p><p>Use management bundles in an <em>Ã  la carte</em> fashion to quickly bring experimental infrastructure to a known state.</p></div></div></article></li><li><article class=card aria-labelledby=R-card-7e1e7531b99bad575248966fb6ce2a52><div class=card-content><div class=card-title id=R-card-7e1e7531b99bad575248966fb6ce2a52>External Data</div><div class=card-content-text><p>Rich, Hierarchical Data and Facts accessible in the command line, scripts, and manifests.</p><p>Democratizes and opens the data that drives systems management to the rest of your stack.</p></div></div></article></li><li><article class=card aria-labelledby=R-card-8b7cde1ebee4ce120fb51319dcaa7804><div class=card-content><div class=card-title id=R-card-8b7cde1ebee4ce120fb51319dcaa7804>No Dependencies</div><div class=card-content-text><p>Zero-dependency binaries, statically linked and fast.</p><p>Easy deployment in any environment without the overhead-cost of traditional CM.</p><p>Embraces a <em>Just Works</em> philosophy with no, or minimal, configuration.</p></div></div></article></li><li><article class=card aria-labelledby=R-card-2afb5b865ec4caa28c3849b4131e3ff9><div class=card-content><div class=card-title id=R-card-2afb5b865ec4caa28c3849b4131e3ff9>Optional Networking</div><div class=card-content-text><p>Optional Network infrastructure needed only when your needs expand.</p><p>Choose from simple webservers to clustered, reliable, Object and Key-Value stores using technology you already know.</p></div></div></article></li><li><article class=card aria-labelledby=R-card-5f0ff429428209098e041df75a79d8cb><div class=card-content><div class=card-title id=R-card-5f0ff429428209098e041df75a79d8cb>Everywhere</div><div class=card-content-text><p>Great at the CLI, shell scripts, YAML manifests, Choria Agents, and Go applications.</p><p>Scales from a single IoT Raspberry Pi 3 to millions of nodes.</p><p>Integrates easily with other software via SDK or Unix-like APIs.</p></div></div></article></li></ul><h2 id=shell-example>Shell Example<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Here we do a package-config-service style deployment using a shell script. The script is safe to run multiple times as the CCM commands are all idempotent.</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>eval <span style=color:#66d9ef>$(</span>ccm session new<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>ccm ensure package httpd
</span></span><span style=display:flex><span>ccm ensure file /etc/httpd/conf.d/listen.conf content<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Listen 8080&#34;</span>
</span></span><span style=display:flex><span>ccm ensure service httpd --subscribe file#/etc/httpd/conf.d/listen.conf
</span></span><span style=display:flex><span>ccm session report --remove</span></span></code></pre></div><p>When run, this will create a session in a temporary directory and manage the resources. If the file resource changes after initial deployment, the service will restart.</p><p>We support dynamic data on the CLI, <code>ccm</code> will read <code>.env</code> files and <code>.hiera</code> files and feed that into the runtime data. Using this even shell scripts can easily gain access to rich data.</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat .env
</span></span><span style=display:flex><span>package_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;httpd&#34;</span>
</span></span><span style=display:flex><span>$ ccm ensure package <span style=color:#e6db74>&#39;{{ Data.package_name }}&#39;</span>
</span></span><span style=display:flex><span> INFO  package#httpd stable ensure<span style=color:#f92672>=</span>present runtime<span style=color:#f92672>=</span>8ms provider<span style=color:#f92672>=</span>dnf</span></span></code></pre></div><h2 id=manifest-example>Manifest Example<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Taking the example above, here is what it looks like in a manifest, complete with multi-OS support using Hierarchical Data and System Facts:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>package_name</span>: <span style=color:#ae81ff>httpd</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>service_name</span>: <span style=color:#ae81ff>httpd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>ccm</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>package</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;{{ Data.package_name }}&#34;</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>file</span>: 
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;/etc/httpd/conf.d/listen.conf&#34;</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>content</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                Listen 8080</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;{{ Data.service_name }}&#34;</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>running</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>enable</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>subscribe</span>: 
</span></span><span style=display:flex><span>              - <span style=color:#ae81ff>file#/etc/httpd/conf.d/listen.conf</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>hierarchy</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>order</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>os:{{ lookup(&#39;facts.host.info.platformFamily&#39;) }}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>overrides</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>os:debian</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>package_name</span>: <span style=color:#ae81ff>apache2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>service_name</span>: <span style=color:#ae81ff>apache2</span></span></span></code></pre></div><p>Here we define the inputs in <code>data</code> and the Hiera hierarchy along with OS-specific overrides. The data is referenced in the manifest using the <code>{{ Data.package_name }}</code> syntax.</p><h2 id=status>Status<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>This is a new project seeking contributors and early adopters.</p><p>Currently, only <code>archive</code>, <code>exec</code>, <code>file</code>, <code>service</code>, and <code>package</code> resources are implemented, with support limited to <code>dnf</code>, <code>apt</code> and <code>systemd</code>.</p><p>The CLI and shell interaction have reached a mature state. Next, we&rsquo;re exploring network-related features and deeper monitoring integration.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Introduction</h1><article class=default><header class=headline></header><h1 id=resources>Resources</h1><p>Resources describe the desired state of your infrastructure. Each resource represents something to manage and is backed by a provider that implements platform-specific management logic.</p><p>Every resource has a type, a unique name, and resource-specific properties.</p><h2 id=resource-types>Resource Types<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><ul><li><a href=/resources/archive/>Archive</a> - Download, extract and copy files from tar.gz and zip archives</li><li><a href=/resources/exec/>Exec</a> - Idempotent command execution</li><li><a href=/resources/file/>File</a> - Manage files content, ownership and more</li><li><a href=/resources/package/>Package</a> - Install, upgrade, downgrade and remove packages using OS Native packagers</li><li><a href=/resources/service/>Service</a> - Enable, disable, start, stop and restart services using OS Native service managers</li></ul><h2 id=common-properties>Common Properties<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>All resources support the following common properties:</p><table><thead><tr><th>Property</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></td><td>Unique identifier for the resource</td></tr><tr><td><code>ensure</code></td><td>Desired state (values vary by resource type)</td></tr><tr><td><code>alias</code></td><td>Alternative name for use in <code>subscribe</code>, <code>require</code>, and logging</td></tr><tr><td><code>provider</code></td><td>Force a specific provider</td></tr><tr><td><code>require</code></td><td>List of resources (<code>type#name</code> or <code>type#alias</code>) that must succeed first</td></tr><tr><td><code>health_checks</code></td><td>Health checks to run after applying (see <a href=/monitoring/index.html>Monitoring</a>)</td></tr><tr><td><code>control</code></td><td>Conditional execution rules (see below)</td></tr></tbody></table><h2 id=conditional-resource-execution>Conditional Resource Execution<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Resources can be conditionally executed using a <code>control</code> section and expressions that should resolve to boolean values.</p><div class=tab-panel data-tab-group=R-tabs-18534b2b943ed3058d3b8fa5ddbc2d30><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-23f67f6670069ecdd7b4762ba0f0bd92 aria-expanded=true data-tab-item=R-tab-76c3e002d3c052bd6a909366a8dc3845 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-18534b2b943ed3058d3b8fa5ddbc2d30","R-tab-76c3e002d3c052bd6a909366a8dc3845")'>
<span class=tab-nav-text>Manifest</span>
</button>
<button aria-controls=R-tab-id-98ee2a1628be4d8fa06bfc8456c38271 aria-expanded=false data-tab-item=R-tab-91af5705f16502125e8b2187e64202c0 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-18534b2b943ed3058d3b8fa5ddbc2d30","R-tab-91af5705f16502125e8b2187e64202c0")'>
<span class=tab-nav-text>CLI</span>
</button>
<button aria-controls=R-tab-id-093379b004512037296265e68ba75756 aria-expanded=false data-tab-item=R-tab-7d9faab09c1d85e60360dfca30ab77cc class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-18534b2b943ed3058d3b8fa5ddbc2d30","R-tab-7d9faab09c1d85e60360dfca30ab77cc")'>
<span class=tab-nav-text>API Request</span></button></div><div class=tab-content-container><div id=R-tab-id-23f67f6670069ecdd7b4762ba0f0bd92 data-tab-item=R-tab-76c3e002d3c052bd6a909366a8dc3845 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>package</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zsh</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>5.9</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>control</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>if</span>: <span style=color:#ae81ff>lookup(&#34;facts.host.info.os&#34;) == &#34;linux&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>unless</span>: <span style=color:#ae81ff>lookup(&#34;facts.host.info.virtualizationSystem&#34;) == &#34;docker&#34;</span></span></span></code></pre></div></div></div><div id=R-tab-id-98ee2a1628be4d8fa06bfc8456c38271 data-tab-item=R-tab-91af5705f16502125e8b2187e64202c0 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm ensure package zsh 5.9 \
    --if &#34;lookup(&#39;facts.host.info.os&#39;) == &#39;linux&#39;&#34;
    --unless &#34;lookup(&#39;facts.host.info.virtualizationSystem&#39;) == &#39;docker&#39;&#34;</code></pre></div></div></div><div id=R-tab-id-093379b004512037296265e68ba75756 data-tab-item=R-tab-7d9faab09c1d85e60360dfca30ab77cc class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;io.choria.ccm.v1.resource.ensure.request&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;package&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;zsh&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;ensure&#34;</span>: <span style=color:#e6db74>&#34;5.9&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;control&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;if&#34;</span>: <span style=color:#e6db74>&#34;lookup(\&#34;facts.host.info.os\&#34;) == \&#34;linux\&#34;&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;unless&#34;</span>: <span style=color:#e6db74>&#34;lookup(\&#34;facts.host.info.virtualizationSystem\&#34;) == \&#34;docker\&#34;&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div></div></div><p>Here we install <code>zsh</code> on all <code>linux</code> machines unless they are running inside a <code>docker</code> container.</p><p>The following table shows how the two conditions interact:</p><table><thead><tr><th><code>if</code></th><th><code>unless</code></th><th>Resource Managed?</th></tr></thead><tbody><tr><td>(not set)</td><td>(not set)</td><td>Yes</td></tr><tr><td><code>true</code></td><td>(not set)</td><td>Yes</td></tr><tr><td><code>false</code></td><td>(not set)</td><td>No</td></tr><tr><td>(not set)</td><td><code>true</code></td><td>No</td></tr><tr><td>(not set)</td><td><code>false</code></td><td>Yes</td></tr><tr><td><code>true</code></td><td><code>true</code></td><td>No</td></tr><tr><td><code>true</code></td><td><code>false</code></td><td>Yes</td></tr><tr><td><code>false</code></td><td><code>true</code></td><td>No</td></tr><tr><td><code>false</code></td><td><code>false</code></td><td>No</td></tr></tbody></table><h2 id=about-names>About Names<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Resources can be specified like:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>/etc/motd</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span></span></span></code></pre></div><p>This sets <code>name</code> to <code>/etc/motd</code>, in the following paragraphs we will refer to this as <code>name</code>.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Resources</h1><article class=default><header class=headline></header><h1 id=archive>Archive</h1><p>The archive resource downloads and extracts archives from HTTP/HTTPS URLs. It supports tar.gz, tgz, tar, and zip formats.</p><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>The archive file path (<code>name</code>) must have the same archive type extension as the URL. For example, if the URL ends in <code>.tar.gz</code>, the name must also end in <code>.tar.gz</code>.</p></div></details><div class=tab-panel data-tab-group=R-tabs-d3c39bebf01ae8db400f9bca9b05fec9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-c20ba77841797b52f2e6a503ffa33a68 aria-expanded=true data-tab-item=R-tab-76c3e002d3c052bd6a909366a8dc3845 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-d3c39bebf01ae8db400f9bca9b05fec9","R-tab-76c3e002d3c052bd6a909366a8dc3845")'>
<span class=tab-nav-text>Manifest</span>
</button>
<button aria-controls=R-tab-id-64e9233c40f8557b8b8c2c3cda705650 aria-expanded=false data-tab-item=R-tab-91af5705f16502125e8b2187e64202c0 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-d3c39bebf01ae8db400f9bca9b05fec9","R-tab-91af5705f16502125e8b2187e64202c0")'>
<span class=tab-nav-text>CLI</span>
</button>
<button aria-controls=R-tab-id-4f7a9002219405017601dd38d2d4f5ef aria-expanded=false data-tab-item=R-tab-7d9faab09c1d85e60360dfca30ab77cc class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-d3c39bebf01ae8db400f9bca9b05fec9","R-tab-7d9faab09c1d85e60360dfca30ab77cc")'>
<span class=tab-nav-text>API Request</span></button></div><div class=tab-content-container><div id=R-tab-id-c20ba77841797b52f2e6a503ffa33a68 data-tab-item=R-tab-76c3e002d3c052bd6a909366a8dc3845 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>archive</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/opt/downloads/app-v1.2.3.tar.gz</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#ae81ff>https://releases.example.com/app/v1.2.3/app-v1.2.3.tar.gz</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>checksum</span>: <span style=color:#e6db74>&#34;a1b2c3d4e5f6...&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>extract_parent</span>: <span style=color:#ae81ff>/opt/app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>creates</span>: <span style=color:#ae81ff>/opt/app/bin/app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>cleanup</span>: <span style=color:#66d9ef>true</span></span></span></code></pre></div></div></div><div id=R-tab-id-64e9233c40f8557b8b8c2c3cda705650 data-tab-item=R-tab-91af5705f16502125e8b2187e64202c0 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm ensure archive /opt/downloads/app.tar.gz \
    --url https://releases.example.com/app.tar.gz \
    --extract-parent /opt/app \
    --creates /opt/app/bin/app \
    --owner root --group root</code></pre></div></div></div><div id=R-tab-id-4f7a9002219405017601dd38d2d4f5ef data-tab-item=R-tab-7d9faab09c1d85e60360dfca30ab77cc class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;io.choria.ccm.v1.resource.ensure.request&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;archive&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;/opt/downloads/app-v1.2.3.tar.gz&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;https://releases.example.com/app/v1.2.3/app-v1.2.3.tar.gz&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;checksum&#34;</span>: <span style=color:#e6db74>&#34;a1b2c3d4e5f6...&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;extract_parent&#34;</span>: <span style=color:#e6db74>&#34;/opt/app&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;creates&#34;</span>: <span style=color:#e6db74>&#34;/opt/app/bin/app&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;owner&#34;</span>: <span style=color:#e6db74>&#34;app&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;group&#34;</span>: <span style=color:#e6db74>&#34;app&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;cleanup&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div></div></div><p>This downloads the archive, extracts it to <code>/opt/app</code>, and removes the archive file after extraction. Future runs skip the download if <code>/opt/app/bin/app</code> exists.</p><h2 id=ensure-values>Ensure Values<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>present</code></td><td>The archive must be downloaded</td></tr><tr><td><code>absent</code></td><td>The archive file must not exist</td></tr></tbody></table><h2 id=properties>Properties<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Property</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></td><td>Absolute path where the archive will be saved</td></tr><tr><td><code>url</code></td><td>HTTP/HTTPS URL to download the archive from</td></tr><tr><td><code>checksum</code></td><td>Expected SHA256 checksum of the downloaded file</td></tr><tr><td><code>extract_parent</code></td><td>Directory to extract the archive contents into</td></tr><tr><td><code>creates</code></td><td>File path; if this file exists, the archive is not downloaded or extracted</td></tr><tr><td><code>cleanup</code></td><td>Remove the archive file after successful extraction (requires <code>extract_parent</code> and <code>creates</code>)</td></tr><tr><td><code>owner</code></td><td>Owner of the downloaded archive file (username)</td></tr><tr><td><code>group</code></td><td>Group of the downloaded archive file (group name)</td></tr><tr><td><code>username</code></td><td>Username for HTTP Basic Authentication</td></tr><tr><td><code>password</code></td><td>Password for HTTP Basic Authentication</td></tr><tr><td><code>headers</code></td><td>Additional HTTP headers to send with the request (map of header name to value)</td></tr><tr><td><code>provider</code></td><td>Force a specific provider (<code>http</code> only)</td></tr></tbody></table><h2 id=authentication>Authentication<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The archive resource supports two authentication methods:</p><p><strong>Basic Authentication:</strong></p><div class=tab-panel data-tab-group=R-tabs-ca8afe352f58950356b570728c25e639><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-c103be54db132530cfc2e07433eb9a84 aria-expanded=true data-tab-item=R-tab-76c3e002d3c052bd6a909366a8dc3845 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-ca8afe352f58950356b570728c25e639","R-tab-76c3e002d3c052bd6a909366a8dc3845")'>
<span class=tab-nav-text>Manifest</span>
</button>
<button aria-controls=R-tab-id-aeb2f8d5d13b279f3416652781150a14 aria-expanded=false data-tab-item=R-tab-91af5705f16502125e8b2187e64202c0 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-ca8afe352f58950356b570728c25e639","R-tab-91af5705f16502125e8b2187e64202c0")'>
<span class=tab-nav-text>CLI</span>
</button>
<button aria-controls=R-tab-id-d8c9aa8882804ed136a8b01e592033e2 aria-expanded=false data-tab-item=R-tab-7d9faab09c1d85e60360dfca30ab77cc class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-ca8afe352f58950356b570728c25e639","R-tab-7d9faab09c1d85e60360dfca30ab77cc")'>
<span class=tab-nav-text>API Request</span></button></div><div class=tab-content-container><div id=R-tab-id-c103be54db132530cfc2e07433eb9a84 data-tab-item=R-tab-76c3e002d3c052bd6a909366a8dc3845 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>archive</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/opt/downloads/private-app.tar.gz</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#ae81ff>https://private.example.com/app.tar.gz</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>username</span>: <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;{{ lookup(&#39;data.deploy_password&#39;) }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>extract_parent</span>: <span style=color:#ae81ff>/opt/app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span></span></span></code></pre></div></div></div><div id=R-tab-id-aeb2f8d5d13b279f3416652781150a14 data-tab-item=R-tab-91af5705f16502125e8b2187e64202c0 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm ensure archive /opt/downloads/private-app.tar.gz \
    --url https://private.example.com/app.tar.gz \
    --username deploy \
    --password &#34;{{ lookup(&#39;data.deploy_password&#39;) }}&#34;</code></pre></div></div></div><div id=R-tab-id-d8c9aa8882804ed136a8b01e592033e2 data-tab-item=R-tab-7d9faab09c1d85e60360dfca30ab77cc class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;io.choria.ccm.v1.resource.ensure.request&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;archive&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;/opt/downloads/private-app.tar.gz&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;https://private.example.com/app.tar.gz&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;username&#34;</span>: <span style=color:#e6db74>&#34;deploy&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;password&#34;</span>: <span style=color:#e6db74>&#34;secret&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;extract_parent&#34;</span>: <span style=color:#e6db74>&#34;/opt/app&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;owner&#34;</span>: <span style=color:#e6db74>&#34;root&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;group&#34;</span>: <span style=color:#e6db74>&#34;root&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div></div></div><p><strong>Custom Headers:</strong></p><div class=tab-panel data-tab-group=R-tabs-58c4e3fc98fb2129669e1d7f0741d0e8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-f1bc8ce1c9aa79e97298a954366e42cb aria-expanded=true data-tab-item=R-tab-76c3e002d3c052bd6a909366a8dc3845 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-58c4e3fc98fb2129669e1d7f0741d0e8","R-tab-76c3e002d3c052bd6a909366a8dc3845")'>
<span class=tab-nav-text>Manifest</span>
</button>
<button aria-controls=R-tab-id-1cc7d1562b0f2c4382f686de3c3459f2 aria-expanded=false data-tab-item=R-tab-91af5705f16502125e8b2187e64202c0 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-58c4e3fc98fb2129669e1d7f0741d0e8","R-tab-91af5705f16502125e8b2187e64202c0")'>
<span class=tab-nav-text>CLI</span>
</button>
<button aria-controls=R-tab-id-52937e4cb7fe7e79b2b068884efb223d aria-expanded=false data-tab-item=R-tab-7d9faab09c1d85e60360dfca30ab77cc class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-58c4e3fc98fb2129669e1d7f0741d0e8","R-tab-7d9faab09c1d85e60360dfca30ab77cc")'>
<span class=tab-nav-text>API Request</span></button></div><div class=tab-content-container><div id=R-tab-id-f1bc8ce1c9aa79e97298a954366e42cb data-tab-item=R-tab-76c3e002d3c052bd6a909366a8dc3845 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>archive</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/opt/downloads/app.tar.gz</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#ae81ff>https://api.example.com/releases/app.tar.gz</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>headers</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>Authorization</span>: <span style=color:#e6db74>&#34;Bearer {{ lookup(&#39;data.api_token&#39;) }}&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>X-Custom-Header</span>: <span style=color:#ae81ff>custom-value</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>extract_parent</span>: <span style=color:#ae81ff>/opt/app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span></span></span></code></pre></div></div></div><div id=R-tab-id-1cc7d1562b0f2c4382f686de3c3459f2 data-tab-item=R-tab-91af5705f16502125e8b2187e64202c0 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm ensure archive /opt/downloads/app.tar.gz \
    --url https://api.example.com/releases/app.tar.gz \
    --headers &#34;Authorization:{{ lookup(&#39;data.api_token&#39;) }}&#34;</code></pre></div></div></div><div id=R-tab-id-52937e4cb7fe7e79b2b068884efb223d data-tab-item=R-tab-7d9faab09c1d85e60360dfca30ab77cc class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;io.choria.ccm.v1.resource.ensure.request&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;archive&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;/opt/downloads/app.tar.gz&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;https://api.example.com/releases/app.tar.gz&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;headers&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;Authorization&#34;</span>: <span style=color:#e6db74>&#34;Bearer mytoken&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;X-Custom-Header&#34;</span>: <span style=color:#e6db74>&#34;custom-value&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;extract_parent&#34;</span>: <span style=color:#e6db74>&#34;/opt/app&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;owner&#34;</span>: <span style=color:#e6db74>&#34;root&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;group&#34;</span>: <span style=color:#e6db74>&#34;root&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div></div></div><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The archive resource is idempotent through multiple mechanisms:</p><ol><li><strong>Checksum verification</strong>: If a <code>checksum</code> is provided and the existing file matches, no download occurs.</li><li><strong>Creates file</strong>: If <code>creates</code> is specified and that file exists, neither download nor extraction occurs.</li><li><strong>File existence</strong>: If the archive file exists with matching checksum and owner/group, no changes are made.</li></ol><p>For best idempotency, always specify either <code>checksum</code> or <code>creates</code> (or both).</p><h2 id=cleanup-behavior>Cleanup Behavior<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>When <code>cleanup: true</code> is set:</p><ul><li>The archive file is deleted after successful extraction</li><li>The <code>extract_parent</code> property is required</li><li>The <code>creates</code> property is required to track extraction state across runs</li></ul><h2 id=supported-archive-formats>Supported Archive Formats<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Extension</th><th>Extraction Tool</th></tr></thead><tbody><tr><td><code>.tar.gz</code>, <code>.tgz</code></td><td><code>tar -xzf</code></td></tr><tr><td><code>.tar</code></td><td><code>tar -xf</code></td></tr><tr><td><code>.zip</code></td><td><code>unzip</code></td></tr></tbody></table><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>The extraction tools (<code>tar</code>, <code>unzip</code>) must be available in the system PATH.</p></div></details><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=exec>Exec</h1><p>The exec resource executes commands to bring the system into the desired state. It is idempotent when used with the <code>creates</code> property or <code>refreshonly</code> mode.</p><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Warning</summary><div class=box-content><p>Specify commands with their full path, or use the <code>path</code> property to set the search path.</p></div></details><div class=tab-panel data-tab-group=R-tabs-1b3b3a25373bd3feb0aa89b5afd85ac7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-bce7a5c917eb6eb2b3587c4d76909eb1 aria-expanded=true data-tab-item=R-tab-76c3e002d3c052bd6a909366a8dc3845 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-1b3b3a25373bd3feb0aa89b5afd85ac7","R-tab-76c3e002d3c052bd6a909366a8dc3845")'>
<span class=tab-nav-text>Manifest</span>
</button>
<button aria-controls=R-tab-id-6c88a55665032385e8c3de53a8ac48ec aria-expanded=false data-tab-item=R-tab-91af5705f16502125e8b2187e64202c0 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-1b3b3a25373bd3feb0aa89b5afd85ac7","R-tab-91af5705f16502125e8b2187e64202c0")'>
<span class=tab-nav-text>CLI</span>
</button>
<button aria-controls=R-tab-id-88c8acbb35643be56d6a2e68d41862ab aria-expanded=false data-tab-item=R-tab-7d9faab09c1d85e60360dfca30ab77cc class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-1b3b3a25373bd3feb0aa89b5afd85ac7","R-tab-7d9faab09c1d85e60360dfca30ab77cc")'>
<span class=tab-nav-text>API Request</span></button></div><div class=tab-content-container><div id=R-tab-id-bce7a5c917eb6eb2b3587c4d76909eb1 data-tab-item=R-tab-76c3e002d3c052bd6a909366a8dc3845 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/usr/bin/touch /tmp/hello</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>creates</span>: <span style=color:#ae81ff>/tmp/hello</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>30s</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>cwd</span>: <span style=color:#ae81ff>/tmp</span></span></span></code></pre></div><p>Alternatively for long commands or to improve UX for referencing execs in <code>require</code> or <code>subscribe</code>:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>touch_hello</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>/usr/bin/touch /tmp/hello</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>creates</span>: <span style=color:#ae81ff>/tmp/hello</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>30s</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>cwd</span>: <span style=color:#ae81ff>/tmp</span></span></span></code></pre></div></div></div><div id=R-tab-id-6c88a55665032385e8c3de53a8ac48ec data-tab-item=R-tab-91af5705f16502125e8b2187e64202c0 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm ensure exec &#34;/usr/bin/touch /tmp/hello&#34; --creates /tmp/hello --timeout 30s</code></pre></div></div></div><div id=R-tab-id-88c8acbb35643be56d6a2e68d41862ab data-tab-item=R-tab-7d9faab09c1d85e60360dfca30ab77cc class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;io.choria.ccm.v1.resource.ensure.request&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;exec&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;/usr/bin/touch /tmp/hello&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;creates&#34;</span>: <span style=color:#e6db74>&#34;/tmp/hello&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;timeout&#34;</span>: <span style=color:#e6db74>&#34;30s&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;cwd&#34;</span>: <span style=color:#e6db74>&#34;/tmp&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div></div></div><p>The command runs only if <code>/tmp/hello</code> does not exist.</p><h2 id=providers>Providers<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The exec resource supports two providers:</p><table><thead><tr><th>Provider</th><th>Description</th></tr></thead><tbody><tr><td><code>posix</code></td><td>Default. Executes commands directly without a shell. Arguments are parsed and passed to the executable.</td></tr><tr><td><code>shell</code></td><td>Executes commands via <code>/bin/sh -c "..."</code>. Use this for shell features like pipes, redirections, and builtins.</td></tr></tbody></table><p>The <code>posix</code> provider is the default and is suitable for most commands. Use the <code>shell</code> provider when you need shell features:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>cleanup-logs</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>find /var/log -name &#39;*.log&#39; -mtime +30 -delete &amp;&amp; echo &#34;Done&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>check-service</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>systemctl is-active httpd || systemctl start httpd</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>process-data</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>cat /tmp/input.txt | grep -v &#39;^#&#39; | sort | uniq &gt; /tmp/output.txt</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span></span></span></code></pre></div><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>The <code>shell</code> provider passes the entire command string to <code>/bin/sh -c</code>, so shell quoting rules apply. The <code>posix</code> provider parses arguments using shell-like quoting but does not invoke a shell.</p></div></details><h2 id=properties>Properties<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Property</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></td><td>The command to execute (used as the resource identifier)</td></tr><tr><td><code>command</code></td><td>Alternative command to run instead of <code>name</code></td></tr><tr><td><code>cwd</code></td><td>Working directory for command execution</td></tr><tr><td><code>environment</code> (array)</td><td>Environment variables in <code>KEY=VALUE</code> format</td></tr><tr><td><code>path</code></td><td>Search path for executables as a colon-separated list (e.g., <code>/usr/bin:/bin</code>)</td></tr><tr><td><code>returns</code> (array)</td><td>Exit codes indicating success (default: <code>[0]</code>)</td></tr><tr><td><code>timeout</code></td><td>Maximum execution time (e.g., <code>30s</code>, <code>5m</code>); command is killed if exceeded</td></tr><tr><td><code>creates</code></td><td>File path; if this file exists, the command does not run</td></tr><tr><td><code>refreshonly</code> (boolean)</td><td>Only run when notified by a subscribed resource</td></tr><tr><td><code>subscribe</code> (array)</td><td>Resources to subscribe to for refresh notifications (<code>type#name</code> or <code>type#alias</code>)</td></tr><tr><td><code>logoutput</code> (boolean)</td><td>Log the command output</td></tr><tr><td><code>provider</code></td><td>Force a specific provider (<code>posix</code> or <code>shell</code>)</td></tr></tbody></table><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=file>File</h1><p>The file resource manages files and directories, including their content, ownership, and permissions.</p><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Warning</summary><div class=box-content><p>Use absolute file paths and primary group names.</p></div></details><div class=tab-panel data-tab-group=R-tabs-52aa6c29bdd914c866f34483b6cba736><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-eef3e2522766155fa1525306bdcbad83 aria-expanded=true data-tab-item=R-tab-76c3e002d3c052bd6a909366a8dc3845 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-52aa6c29bdd914c866f34483b6cba736","R-tab-76c3e002d3c052bd6a909366a8dc3845")'>
<span class=tab-nav-text>Manifest</span>
</button>
<button aria-controls=R-tab-id-ddf7d4f0e66fb70a5df470be21e6c6d3 aria-expanded=false data-tab-item=R-tab-91af5705f16502125e8b2187e64202c0 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-52aa6c29bdd914c866f34483b6cba736","R-tab-91af5705f16502125e8b2187e64202c0")'>
<span class=tab-nav-text>CLI</span>
</button>
<button aria-controls=R-tab-id-522c1c7d0570036346c2b0e703d1c938 aria-expanded=false data-tab-item=R-tab-7d9faab09c1d85e60360dfca30ab77cc class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-52aa6c29bdd914c866f34483b6cba736","R-tab-7d9faab09c1d85e60360dfca30ab77cc")'>
<span class=tab-nav-text>API Request</span></button></div><div class=tab-content-container><div id=R-tab-id-eef3e2522766155fa1525306bdcbad83 data-tab-item=R-tab-76c3e002d3c052bd6a909366a8dc3845 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/etc/motd</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>content</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          Managed by CCM {{ now() }}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>mode</span>: <span style=color:#e6db74>&#34;0644&#34;</span></span></span></code></pre></div></div></div><div id=R-tab-id-ddf7d4f0e66fb70a5df470be21e6c6d3 data-tab-item=R-tab-91af5705f16502125e8b2187e64202c0 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm ensure file /etc/motd --source /tmp/ccm/motd --owner root --group root --mode 0644</code></pre></div></div></div><div id=R-tab-id-522c1c7d0570036346c2b0e703d1c938 data-tab-item=R-tab-7d9faab09c1d85e60360dfca30ab77cc class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;io.choria.ccm.v1.resource.ensure.request&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;file&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;/etc/motd&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;ensure&#34;</span>: <span style=color:#e6db74>&#34;present&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;content&#34;</span>: <span style=color:#e6db74>&#34;Managed by CCM\n&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;owner&#34;</span>: <span style=color:#e6db74>&#34;root&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;group&#34;</span>: <span style=color:#e6db74>&#34;root&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;mode&#34;</span>: <span style=color:#e6db74>&#34;0644&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div></div></div><p>This copies the contents of <code>/tmp/ccm/motd</code> to <code>/etc/motd</code> verbatim and sets ownership.</p><p>Use <code>--content</code> or <code>--content-file</code> to parse content through the template engine before writing.</p><h2 id=ensure-values>Ensure Values<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>present</code></td><td>The file must exist</td></tr><tr><td><code>absent</code></td><td>The file must not exist</td></tr><tr><td><code>directory</code></td><td>The path must be a directory</td></tr></tbody></table><h2 id=properties>Properties<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Property</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></td><td>Absolute path to the file</td></tr><tr><td><code>ensure</code></td><td>Desired state (<code>present</code>, <code>absent</code>, <code>directory</code>)</td></tr><tr><td><code>content</code></td><td>File contents, parsed through the template engine</td></tr><tr><td><code>source</code></td><td>Copy contents from another local file</td></tr><tr><td><code>owner</code></td><td>File owner (username)</td></tr><tr><td><code>group</code></td><td>File group (group name)</td></tr><tr><td><code>mode</code></td><td>File permissions in octal notation (e.g., <code>"0644"</code>)</td></tr><tr><td><code>provider</code></td><td>Force a specific provider (<code>posix</code> only)</td></tr></tbody></table><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=package>Package</h1><p>The package resource manages system packages. Specify whether the package should be present, absent, at the latest version, or at a specific version.</p><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Warning</summary><div class=box-content><p>Use real package names, not virtual names, aliases, or group names.</p></div></details><div class=tab-panel data-tab-group=R-tabs-1b8627e782ddf2b5f85dcc1766e46366><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-bb68b9f3927ca6bcb34f2bdbd5f1991d aria-expanded=true data-tab-item=R-tab-76c3e002d3c052bd6a909366a8dc3845 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-1b8627e782ddf2b5f85dcc1766e46366","R-tab-76c3e002d3c052bd6a909366a8dc3845")'>
<span class=tab-nav-text>Manifest</span>
</button>
<button aria-controls=R-tab-id-1fa3bceece1a783bb2b5d8bf91d8b1a7 aria-expanded=false data-tab-item=R-tab-91af5705f16502125e8b2187e64202c0 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-1b8627e782ddf2b5f85dcc1766e46366","R-tab-91af5705f16502125e8b2187e64202c0")'>
<span class=tab-nav-text>CLI</span>
</button>
<button aria-controls=R-tab-id-f47a5480ae213d9e33e643d018ec1ba0 aria-expanded=false data-tab-item=R-tab-7d9faab09c1d85e60360dfca30ab77cc class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-1b8627e782ddf2b5f85dcc1766e46366","R-tab-7d9faab09c1d85e60360dfca30ab77cc")'>
<span class=tab-nav-text>API Request</span></button></div><div class=tab-content-container><div id=R-tab-id-bb68b9f3927ca6bcb34f2bdbd5f1991d data-tab-item=R-tab-76c3e002d3c052bd6a909366a8dc3845 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>package</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>zsh</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#e6db74>&#34;5.9&#34;</span></span></span></code></pre></div></div></div><div id=R-tab-id-1fa3bceece1a783bb2b5d8bf91d8b1a7 data-tab-item=R-tab-91af5705f16502125e8b2187e64202c0 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm ensure package zsh 5.9</code></pre></div></div></div><div id=R-tab-id-f47a5480ae213d9e33e643d018ec1ba0 data-tab-item=R-tab-7d9faab09c1d85e60360dfca30ab77cc class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;io.choria.ccm.v1.resource.ensure.request&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;package&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;zsh&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;ensure&#34;</span>: <span style=color:#e6db74>&#34;5.9&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div></div></div><h2 id=ensure-values>Ensure Values<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>present</code></td><td>The package must be installed</td></tr><tr><td><code>latest</code></td><td>The package must be installed at latest version</td></tr><tr><td><code>absent</code></td><td>The package must not be installed</td></tr><tr><td><code>&lt;version></code></td><td>The package must be installed at this version</td></tr></tbody></table><h2 id=properties>Properties<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Property</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></td><td>Package name</td></tr><tr><td><code>ensure</code></td><td>Desired state or version</td></tr><tr><td><code>provider</code></td><td>Force a specific provider (<code>dnf</code>, <code>apt</code>)</td></tr></tbody></table><h2 id=provider-notes>Provider Notes<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=apt-debianubuntu>APT (Debian/Ubuntu)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The APT provider preserves existing configuration files during package installation and upgrades. When a package is upgraded and the maintainer has provided a new version of a configuration file, the existing file is kept (<code>--force-confold</code> behavior).</p><p>Packages in a partially installed or <code>config-files</code> state (removed but configuration remains) are treated as absent. Reinstalling such packages will preserve the existing configuration files.</p><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>The provider will not run <code>apt update</code> before installing a package. Use an <code>exec</code> resource to update the package index if necessary.</p></div></details><p>The provider runs non-interactively and suppresses prompts from <code>apt-listbugs</code> and <code>apt-listchanges</code>.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=service>Service</h1><p>The service resource manages system services. Services have two independent properties: whether they are running and whether they are enabled to start at boot.</p><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Warning</summary><div class=box-content><p>Use real service names, not virtual names or aliases.</p></div></details><p>Services can subscribe to other resources and restart when those resources change.</p><div class=tab-panel data-tab-group=R-tabs-67b2b7e5c4858d9863424bfc2fe1ce73><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-709064304b65d97f06ba950658ab364d aria-expanded=true data-tab-item=R-tab-76c3e002d3c052bd6a909366a8dc3845 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-67b2b7e5c4858d9863424bfc2fe1ce73","R-tab-76c3e002d3c052bd6a909366a8dc3845")'>
<span class=tab-nav-text>Manifest</span>
</button>
<button aria-controls=R-tab-id-524c6e04bb17b172e01c750d9106b3ff aria-expanded=false data-tab-item=R-tab-91af5705f16502125e8b2187e64202c0 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-67b2b7e5c4858d9863424bfc2fe1ce73","R-tab-91af5705f16502125e8b2187e64202c0")'>
<span class=tab-nav-text>CLI</span>
</button>
<button aria-controls=R-tab-id-818f7dd7bbf11deadbd7378ec524b554 aria-expanded=false data-tab-item=R-tab-7d9faab09c1d85e60360dfca30ab77cc class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-67b2b7e5c4858d9863424bfc2fe1ce73","R-tab-7d9faab09c1d85e60360dfca30ab77cc")'>
<span class=tab-nav-text>API Request</span></button></div><div class=tab-content-container><div id=R-tab-id-709064304b65d97f06ba950658ab364d data-tab-item=R-tab-76c3e002d3c052bd6a909366a8dc3845 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>httpd</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>running</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>enable</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subscribe</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>package#httpd</span></span></span></code></pre></div></div></div><div id=R-tab-id-524c6e04bb17b172e01c750d9106b3ff data-tab-item=R-tab-91af5705f16502125e8b2187e64202c0 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm ensure service httpd running --enable --subscribe package#httpd</code></pre></div></div></div><div id=R-tab-id-818f7dd7bbf11deadbd7378ec524b554 data-tab-item=R-tab-7d9faab09c1d85e60360dfca30ab77cc class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;io.choria.ccm.v1.resource.ensure.request&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;service&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;httpd&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;ensure&#34;</span>: <span style=color:#e6db74>&#34;running&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;enable&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;subscribe&#34;</span>: [<span style=color:#e6db74>&#34;package#httpd&#34;</span>]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div></div></div><h2 id=ensure-values>Ensure Values<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>running</code></td><td>The service must be running</td></tr><tr><td><code>stopped</code></td><td>The service must be stopped</td></tr></tbody></table><p>If <code>ensure</code> is not specified, it defaults to <code>running</code>.</p><h2 id=properties>Properties<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Property</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code></td><td>Service name</td></tr><tr><td><code>ensure</code></td><td>Desired state (<code>running</code> or <code>stopped</code>; default: <code>running</code>)</td></tr><tr><td><code>enable</code> (boolean)</td><td>Enable the service to start at boot</td></tr><tr><td><code>subscribe</code> (array)</td><td>Resources to watch; restart the service when they change (<code>type#name</code> or <code>type#alias</code>)</td></tr><tr><td><code>provider</code></td><td>Force a specific provider (<code>systemd</code> only)</td></tr></tbody></table><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=hierarchical-data>Hierarchical Data</h1><p>The Choria Hierarchical Data Resolver is a small data resolver inspired by Hiera. It evaluates a YAML or JSON document alongside a set of facts to produce a final data map.</p><p>The resolver supports <code>first</code> and <code>deep</code> merge strategies and relies on expression-based string interpolation for hierarchy entries. It is optimized for single files that hold both hierarchy and data, rather than the multi-file approach common in Hiera.</p><p>Key features:</p><ul><li>Lookup expressions based on the <a href=https://expr-lang.org/docs/language-definition rel=external>Expr Language</a></li><li>Type-preserving lookups (returns typed data, not just strings)</li><li>Command-line tool with built-in system facts</li><li>Go library for embedding</li></ul><h3 id=usage>Usage<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Here&rsquo;s an annotated example:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>hierarchy</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># Lookup and override order - facts are resolved in expressions</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Use GJSON path syntax for nested facts: {{ lookup(&#39;facts.host.info.hostname&#39;) }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>order</span>:
</span></span><span style=display:flex><span>     - <span style=color:#ae81ff>env:{{ lookup(&#39;facts.env&#39;) }}</span>
</span></span><span style=display:flex><span>     - <span style=color:#ae81ff>role:{{ lookup(&#39;facts.role&#39;) }}</span>
</span></span><span style=display:flex><span>     - <span style=color:#ae81ff>host:{{ lookup(&#39;facts.hostname&#39;) }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>merge</span>: <span style=color:#ae81ff>deep </span> <span style=color:#75715e># &#34;deep&#34; merges all matches; &#34;first&#34; stops at first match</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Base data - hierarchy results are merged into this</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>   <span style=color:#f92672>log_level</span>: <span style=color:#ae81ff>INFO</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>packages</span>:
</span></span><span style=display:flex><span>     - <span style=color:#ae81ff>ca-certificates</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>web</span>:
</span></span><span style=display:flex><span>     <span style=color:#f92672>listen_port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>tls</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Override sections keyed by hierarchy order entries</span>
</span></span><span style=display:flex><span><span style=color:#f92672>overrides</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>env:prod</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>log_level</span>: <span style=color:#ae81ff>WARN</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>role:web</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>packages</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>web</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>listen_port</span>: <span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>tls</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>host:web01</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>log_level</span>: <span style=color:#ae81ff>TRACE</span></span></span></code></pre></div><p>The templating here is identical to that in the <a href=/templates/index.html>Template documentation</a>, except only the <code>lookup()</code> function is available (no file access functions).</p><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Default Hierarchy</summary><div class=box-content><p>If no <code>hierarchy</code> section is provided, the resolver uses a default hierarchy of <code>["default"]</code>.</p></div></details><h3 id=cli-example>CLI Example<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>ccm hiera</code> command resolves hierarchy files with facts. It is designed to be a generally usable tool, with flexible options for providing facts.</p><p>Given the input file <code>data.json</code>:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;hierarchy&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;order&#34;</span>: [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;fqdn:{{ lookup(&#39;facts.fqdn&#39;) }}&#34;</span>
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;data&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;test&#34;</span>: <span style=color:#e6db74>&#34;value&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;overrides&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;fqdn:my.fqdn.com&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;test&#34;</span>: <span style=color:#e6db74>&#34;override&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Resolve with facts provided on the command line:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ ccm hiera parse data.json fqdn=my.fqdn.com
{
  &#34;test&#34;: &#34;override&#34;
}

$ ccm hiera parse data.json fqdn=other.fqdn.com
{
  &#34;test&#34;: &#34;value&#34;
}</code></pre></div><p>Output formats:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight># YAML output
$ ccm hiera parse data.json fqdn=other.fqdn.com --yaml
test: value

# Environment variable output
$ ccm hiera parse data.json fqdn=other.fqdn.com --env
HIERA_TEST=value</code></pre></div><h3 id=fact-sources>Fact Sources<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Facts can come from multiple sources, which are merged together:</p><p><strong>System facts</strong> (<code>-S</code> or <code>--system-facts</code>):</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight># View system facts
$ ccm hiera facts -S

# Resolve using system facts
$ ccm hiera parse data.json -S</code></pre></div><p><strong>Environment variables as facts</strong> (<code>-E</code> or <code>--env-facts</code>):</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-banohighlightsh data-lang=banohighlightsh>ccm hiera parse data.json -E</code></pre></div><p><strong>Facts file</strong> (<code>--facts FILE</code>):</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm hiera parse data.json --facts facts.yaml</code></pre></div><p><strong>Command-line facts</strong> (key=value pairs):</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm hiera parse data.json env=prod role=web</code></pre></div><p>All fact sources can be combined. Command-line facts take highest precedence.</p><h3 id=data-in-nats>Data in NATS<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><a href=https://nats.io rel=external>NATS</a> is a lightweight messaging system that supports Key-Value stores. Hierarchy data can be stored in NATS and used with <code>ccm ensure</code> and <code>ccm hiera</code> commands.</p><p>To use NATS as a hierarchy store, configure a NATS context for authentication:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>nats context add ccm --server nats.example.org --user ccm --password s3cret \
  --description &#34;CCM Configuration Store&#34;</code></pre></div><p>Create a KV store and add your hierarchy data:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ nats kv add CCM --replicas 3 --context ccm
$ nats kv put CCM data &#34;$(cat hiera.yaml)&#34;</code></pre></div><p>Resolve the hierarchy using the KV store:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm hiera parse kv://CCM/data --context ccm -S</code></pre></div><h3 id=data-on-web-servers>Data on Web Servers<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Hierarchy data can also be stored on a web server and fetched via HTTP or HTTPS.</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm hiera parse https://example.net/site.yaml -S</code></pre></div><p>HTTP Basic Auth is supported via URL credentials:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm hiera parse https://user:pass@example.net/site.yaml -S</code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=data>Data</h1><p>Just like applications need data to vary their behavior and configure their environments, so do Configuration Management tools.</p><p>For this reason, I wrote <code>extlookup</code> and <code>hiera</code> years ago for the Puppet community. Despite CCM&rsquo;s minimal focus, we still need data to vary behavior.</p><p>Data can be used for:</p><ul><li>Configuring resource names that differ between operating systems (e.g., <code>httpd</code> vs <code>apache2</code>)</li><li>Setting different configuration values depending on environment, role, or other dimensions</li><li>Deciding whether environments should have something installed (e.g., development vs production)</li></ul><p>CCM supports various data sources:</p><ul><li><strong>System Facts</strong> - Operating system, networking, and disk configuration</li><li><strong>Custom Facts</strong> - From <code>/etc/choria/ccm/facts.{yaml,json}</code> and <code>~/.config/choria/ccm/facts.{yaml,json}</code></li><li><strong>Environment</strong> - Variables from the shell environment and <code>./.env</code> files</li><li><strong>Hiera Data</strong> - Hierarchical data with overrides based on facts</li></ul><h2 id=accessing-data>Accessing Data<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Expressions like <code>{{ lookup('facts.host.info.platformFamily') }}</code> use the <a href=https://expr-lang.org/docs/language-definition rel=external>Expr Language</a>.</p><h3 id=available-variables>Available Variables<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>In templates, you have direct access to:</p><table><thead><tr><th>Variable</th><th>Description</th></tr></thead><tbody><tr><td><code>Facts</code></td><td>System facts (e.g., <code>Facts.host.info.platformFamily</code>)</td></tr><tr><td><code>Data</code></td><td>Resolved Hiera data (e.g., <code>Data.package_name</code>)</td></tr><tr><td><code>Environ</code></td><td>Environment variables (e.g., <code>Environ.HOME</code>)</td></tr></tbody></table><h3 id=available-functions>Available Functions<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Function</th><th>Description</th></tr></thead><tbody><tr><td><code>lookup(key, default)</code></td><td>Lookup data using <a href=https://github.com/tidwall/gjson/blob/master/SYNTAX.md rel=external>GJSON Path Syntax</a>. Example: <code>lookup("facts.host.info.os", "linux")</code></td></tr><tr><td><code>readFile(path)</code>, <code>file(path)</code></td><td>Read a file into a string (files must be in the working directory)</td></tr><tr><td><code>template(f)</code></td><td>Parse <code>f</code> using templates. If <code>f</code> ends in <code>.templ</code>, reads the file first, if it ends in <code>.jet</code> calls the <code>jet()</code> function</td></tr><tr><td><code>jet(f)</code>, <code>jet(f, "[[", "]]")</code></td><td>Parse <code>f</code> using <a href=https://github.com/CloudyKit/jet/blob/master/docs/syntax.md rel=external>Jet templates</a> with optional custom delimiters. If <code>f</code> ends in <code>.jet</code>, reads the file first</td></tr></tbody></table><h3 id=gjson-path-examples>GJSON Path Examples<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>lookup()</code> function uses GJSON path syntax for nested access:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>lookup(&#34;facts.host.info.platformFamily&#34;)     # Simple nested path
lookup(&#34;facts.network.interfaces.0.name&#34;)    # Array index
lookup(&#34;data.packages.#&#34;)                    # Array length</code></pre></div><h3 id=cli-usage>CLI Usage<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>These expressions work on the CLI:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ ccm ensure package &#39;{{ lookup(&#34;data.package_name&#34;, &#34;httpd&#34;) }}&#39;</code></pre></div><p>This fetches <code>package_name</code> from the data and defaults to <code>httpd</code> if not found.</p><h2 id=facts>Facts<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>CCM includes a built-in fact resolver that gathers system information. To see available facts:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ ccm facts                              # All facts as JSON
$ ccm facts host                         # Query specific path
$ ccm facts --yaml                       # Output as YAML</code></pre></div><p>Access facts in expressions using <code>{{ Facts.host.info.platformFamily }}</code> or <code>{{ lookup('facts.host.info.platformFamily') }}</code>.</p><h2 id=hiera-data-for-cli>Hiera Data for CLI<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Hiera data is resolved using the Choria Hierarchical Data Resolver. By default, data is read from <code>./.hiera</code>, or you can specify a file with <code>--hiera</code>.</p><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>This applies to <code>ccm ensure</code> commands. The <code>ccm apply</code> command uses manifests that contain their own Hiera data.</p></div></details><h3 id=hiera-data-sources>Hiera Data Sources<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Hiera data can be loaded from:</p><ul><li><strong>Local file</strong>: <code>./.hiera</code> or path specified with <code>--hiera</code></li><li><strong>Key-Value store</strong>: <code>--hiera kv://BUCKET/key</code> (requires <code>--context</code> for NATS)</li><li><strong>HTTP(S)</strong>: <code>--hiera https://example.com/data.yaml</code> (supports Basic Auth via URL credentials)</li></ul><h3 id=merge-strategies>Merge Strategies<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>hierarchy.merge</code> setting controls how overrides are applied:</p><ul><li><strong><code>first</code></strong> (default): Stops at the first matching override</li><li><strong><code>deep</code></strong>: Deep merges all matching overrides in order</li></ul><h3 id=example>Example<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Given this file stored in <code>./.hiera</code>:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>hierarchy</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>order</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>os:{{ lookup(&#39;facts.host.info.platformFamily&#39;) }}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>merge</span>: <span style=color:#ae81ff>first</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>package_name</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>overrides</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>os:debian</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>package_name</span>: <span style=color:#ae81ff>apache2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>os:rhel</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>package_name</span>: <span style=color:#ae81ff>httpd</span></span></span></code></pre></div><p>Running <code>ccm ensure package '{{ lookup("data.package_name") }}'</code> installs <code>httpd</code> on RHEL-based systems and <code>apache2</code> on Debian-based systems.</p><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>See the <a href=/hiera/index.html>Hiera</a> section for details on configuring Hiera data in NATS.</p></div></details><h2 id=environment>Environment<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The shell environment and variables defined in <code>./.env</code> can be accessed in two ways:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Direct access</span>
</span></span><span style=display:flex><span><span style=color:#f92672>home_dir</span>: <span style=color:#e6db74>&#34;{{ Environ.HOME }}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Via lookup (with default value)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>my_var</span>: <span style=color:#e6db74>&#34;{{ lookup(&#39;environ.MY_VAR&#39;, &#39;default&#39;) }}&#34;</span></span></span></code></pre></div><p>The <code>.env</code> file uses standard <code>KEY=value</code> format, one variable per line.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=shell-usage>Shell Usage</h1><p>CCM is designed as a CLI-first tool. Each resource type has its own subcommand under <code>ccm ensure</code>, with required inputs as arguments and optional settings as flags.</p><p>The <code>ccm ensure</code> commands are idempotent, making them safe to run multiple times in shell scripts.</p><p>Use <code>ccm --help</code> and <code>ccm &lt;command> --help</code> to explore available commands and options.</p><h2 id=managing-a-single-resource>Managing a Single Resource<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Managing a single resource is straightforward.</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm ensure package zsh 5.8</code></pre></div><p>This ensures the package <code>zsh</code> is installed at version <code>5.8</code>.</p><p>To view the current state of a resource:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm status package zsh</code></pre></div><h2 id=managing-multiple-resources>Managing Multiple Resources<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>When managing multiple resources in a script, create a session first. The session records the outcome of each resource, enabling features like refreshing a service when a file changes.</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>#!/bin/bash

eval &#34;$(ccm session new)&#34;

ccm ensure package httpd
ccm ensure file /etc/httpd/conf/httpd.conf .... --require package#httpd
ccm ensure service httpd --subscribe file#/etc/httpd/conf/httpd.conf
ccm session report --remove</code></pre></div><p>This creates a temporary directory for session state. If the file resource changes, the service restarts automatically.</p><p>If you prefer not to eval command output, use: <code>export CCM_SESSION_STORE=$(mktemp -d)</code></p><h2 id=data-in-the-cli>Data in the CLI<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>As covered in the <a href=/templates/index.html>templates section</a>, commands automatically read <code>./.env</code> and <code>./.hiera</code> files, merging that data into the session.</p><p>Use the <code>--hiera</code> flag or <code>CCM_HIERA_DATA</code> environment variable to specify a different data file.</p><p>With data loaded, you can access:</p><ul><li><code>{{ lookup("data.my_data_key") }}</code> for Hiera data</li><li><code>{{ lookup("env.MY_ENV_VAR") }}</code> for environment variables</li><li><code>{{ lookup("facts.host.info.platformFamily") }}</code> for system facts</li></ul><p>Example using Hiera data:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm ensure package &#39;{{ lookup(&#34;data.package&#34;) }}&#39; &#39;{{ lookup(&#34;data.version&#34;) }}&#39;</code></pre></div><p>Expressions use the <a href=https://expr-lang.org/docs/language-definition rel=external>Expr Language</a>, enabling complex logic:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ ccm ensure package &#39;{{ lookup(&#34;facts.host.info.platformFamily&#34;) == &#34;rhel&#34; ? &#34;httpd&#34; : &#34;apache2&#34; }}&#39;
WARN  package#httpd changed ensure=present runtime=14.509s provider=dnf</code></pre></div><p>For complex conditional logic, we recommend using Hiera data with hierarchy overrides instead.</p><h2 id=applying-manifests>Applying Manifests<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>For non-shell script usage use YAML manifests with <code>ccm apply</code>:</p><p>See <a href=/yamlmanifests/index.html>YAML Manifests</a> for manifest format details.</p><h2 id=viewing-system-facts>Viewing System Facts<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>CCM gathers system facts that can be used in templates and conditions:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight># Show all facts as JSON
$ ccm facts

# Show facts as YAML
$ ccm facts --yaml

# Query specific facts using gjson syntax
$ ccm facts host.info.platformFamily</code></pre></div><h2 id=resolving-hiera-data>Resolving Hiera Data<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The <code>ccm hiera</code> command helps debug and test Hiera data resolution:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight># Resolve a Hiera file with system facts
$ ccm hiera parse data.yaml -S

# Resolve with custom facts
$ ccm hiera parse data.yaml os=linux env=production

# Query a specific key from the result
$ ccm hiera parse data.yaml --query packages</code></pre></div><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Shell Usage</h1><article class=default><header class=headline></header><h1 id=json-api>JSON API</h1><p>CCM provides a STDIN/STDOUT API for managing resources programmatically. This enables integration with external languages, allowing you to build DSLs in Ruby, Perl, Python, or any language that can execute processes and handle JSON or YAML.</p><h2 id=overview>Overview<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The API uses a simple request/response pattern:</p><ol><li>Send a request to <code>ccm ensure api pipe</code> via STDIN</li><li>Receive a response on STDOUT</li></ol><p>Both JSON and YAML formats are supported for requests. The response format is always JSON, but can be explicitly set to YAML using <code>--yaml</code>.</p><h2 id=command>Command<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm ensure api pipe [--yaml] [--noop] [--facts &lt;file&gt;] [--data &lt;file&gt;]</code></pre></div><table><thead><tr><th>Flag</th><th>Description</th></tr></thead><tbody><tr><td><code>--yaml</code></td><td>Output response in YAML format instead of JSON</td></tr><tr><td><code>--noop</code></td><td>Dry-run mode; report what would change without making changes</td></tr><tr><td><code>--facts &lt;file></code></td><td>Load additional facts from a YAML file</td></tr><tr><td><code>--data &lt;file></code></td><td>Load Hiera-style data from a YAML file</td></tr></tbody></table><h2 id=request-format>Request Format<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Requests must include a protocol identifier, resource type, and properties.</p><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>JSON Schemas for these requests and responses are available at <a href=https://choria-cm.dev/schemas/ccm/v1/resource_ensure_request.json rel=external>resource_ensure_request.json</a> and <a href=https://choria-cm.dev/schemas/ccm/v1/resource_ensure_response.json rel=external>resource_ensure_response.json</a>.</p></div></details><h3 id=json-request>JSON Request<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;io.choria.ccm.v1.resource.ensure.request&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;package&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;nginx&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;ensure&#34;</span>: <span style=color:#e6db74>&#34;present&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=yaml-request>YAML Request<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>io.choria.ccm.v1.resource.ensure.request</span>
</span></span><span style=display:flex><span><span style=color:#f92672>type</span>: <span style=color:#ae81ff>package</span>
</span></span><span style=display:flex><span><span style=color:#f92672>properties</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span></span></span></code></pre></div><h3 id=request-fields>Request Fields<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Field</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>protocol</code></td><td>Yes</td><td>Must be <code>io.choria.ccm.v1.resource.ensure.request</code></td></tr><tr><td><code>type</code></td><td>Yes</td><td>Resource type example <code>package</code></td></tr><tr><td><code>properties</code></td><td>Yes</td><td>Resource properties (varies by type)</td></tr></tbody></table><h2 id=response-format>Response Format<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Responses include a protocol identifier and either a state object (on success) or an error message.</p><p>For the full response structure, see <a href=https://pkg.go.dev/github.com/choria-io/ccm@main/model#ResourceEnsureApiResponse rel=external>ResourceEnsureApiResponse</a> in the Go documentation. The <code>state</code> field contains a <a href=https://pkg.go.dev/github.com/choria-io/ccm@main/model#TransactionEvent rel=external>TransactionEvent</a>.</p><h3 id=successful-response>Successful Response<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;io.choria.ccm.v1.resource.ensure.response&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;state&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;io.choria.ccm.v1.transaction.event&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;event_id&#34;</span>: <span style=color:#e6db74>&#34;2abc123def456&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;timestamp&#34;</span>: <span style=color:#e6db74>&#34;2026-01-28T10:30:00Z&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;package&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;provider&#34;</span>: <span style=color:#e6db74>&#34;dnf&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;nginx&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;requested_ensure&#34;</span>: <span style=color:#e6db74>&#34;present&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;final_ensure&#34;</span>: <span style=color:#e6db74>&#34;1.24.0-1.el9&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;duration&#34;</span>: <span style=color:#ae81ff>1500000000</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;changed&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;failed&#34;</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=error-response>Error Response<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;protocol&#34;</span>: <span style=color:#e6db74>&#34;io.choria.ccm.v1.resource.ensure.response&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;error&#34;</span>: <span style=color:#e6db74>&#34;invalid protocol \&#34;wrong.protocol\&#34;&#34;</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h2 id=examples>Examples<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=install-a-package>Install a Package<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>echo &#39;{
  &#34;protocol&#34;: &#34;io.choria.ccm.v1.resource.ensure.request&#34;,
  &#34;type&#34;: &#34;package&#34;,
  &#34;properties&#34;: {
    &#34;name&#34;: &#34;htop&#34;,
    &#34;ensure&#34;: &#34;present&#34;
  }
}&#39; | ccm ensure api pipe</code></pre></div><h3 id=manage-a-service>Manage a Service<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>cat &lt;&lt;EOF | ccm ensure api pipe
protocol: io.choria.ccm.v1.resource.ensure.request
type: service
properties:
  name: nginx
  ensure: running
EOF</code></pre></div><h3 id=create-a-file>Create a File<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>echo &#39;{
  &#34;protocol&#34;: &#34;io.choria.ccm.v1.resource.ensure.request&#34;,
  &#34;type&#34;: &#34;file&#34;,
  &#34;properties&#34;: {
    &#34;name&#34;: &#34;/etc/motd&#34;,
    &#34;ensure&#34;: &#34;present&#34;,
    &#34;content&#34;: &#34;Welcome to this server\n&#34;,
    &#34;owner&#34;: &#34;root&#34;,
    &#34;group&#34;: &#34;root&#34;,
    &#34;mode&#34;: &#34;0644&#34;
  }
}&#39; | ccm ensure api pipe</code></pre></div><h3 id=dry-run-mode>Dry-Run Mode<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>echo &#39;{
  &#34;protocol&#34;: &#34;io.choria.ccm.v1.resource.ensure.request&#34;,
  &#34;type&#34;: &#34;package&#34;,
  &#34;properties&#34;: {
    &#34;name&#34;: &#34;vim&#34;,
    &#34;ensure&#34;: &#34;absent&#34;
  }
}&#39; | ccm ensure api pipe --noop</code></pre></div><h2 id=resource-types>Resource Types<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>For detailed information about each resource type and its properties, see the <a href=/resources/index.html>Resource Documentation</a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=cli-plugins>CLI Plugins</h1><p>CCM supports extending the CLI with custom commands using <a href=https://choria-io.github.io/appbuilder/index.html rel=external>App Builder</a>. This allows you to create organization-specific workflows that integrate with the <code>ccm</code> command.</p><h2 id=plugin-locations>Plugin Locations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>CCM searches for plugins in two directories:</p><table><thead><tr><th>Location</th><th>Purpose</th></tr></thead><tbody><tr><td><code>/etc/choria/ccm/plugins/</code></td><td>System-wide plugins</td></tr><tr><td><code>$XDG_CONFIG_HOME/choria/ccm/plugins/</code></td><td>User plugins (typically <code>~/.config/choria/ccm/plugins/</code>)</td></tr></tbody></table><p>Plugins in the user directory override system plugins with the same name.</p><h2 id=plugin-file-format>Plugin File Format<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Plugin files must be named <code>&lt;command>-plugin.yaml</code>. The filename determines the command name:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>deploy-plugin.yaml    â†’ ccm deploy
backup-plugin.yaml    â†’ ccm backup
myapp-plugin.yaml     â†’ ccm myapp</code></pre></div><h2 id=basic-plugin-structure>Basic Plugin Structure<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Plugins use App Builder&rsquo;s YAML definition format. Here&rsquo;s a minimal example:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># deploy-plugin.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>description</span>: <span style=color:#ae81ff>Deploy application configuration</span>
</span></span><span style=display:flex><span><span style=color:#f92672>commands</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>web</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#ae81ff>Deploy web server configuration</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>exec</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      ccm apply /etc/ccm/manifests/webserver.yaml</span></span></span></code></pre></div><p>This creates <code>ccm deploy web</code> which applies a manifest.</p><h2 id=passing-data-to-manifests>Passing Data to Manifests<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Plugins can pass data to manifests through environment variables or facts. Both are accessible in manifest templates.</p><h3 id=using-environment-variables>Using Environment Variables<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Environment variables set in the plugin are available in manifests via <code>{{ lookup("env.VAR_NAME") }}</code>:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># deploy-plugin.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>description</span>: <span style=color:#ae81ff>Deploy with environment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>commands</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>production</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#ae81ff>Deploy to production</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>exec</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;DEPLOY_ENV=production&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;LOG_LEVEL=warn&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      ccm apply /etc/ccm/manifests/app.yaml</span></span></span></code></pre></div><p>In the manifest:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>file</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>/etc/app/config.yaml</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>content</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      environment: {{ lookup(&#34;env.DEPLOY_ENV&#34;) }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      log_level: {{ lookup(&#34;env.LOG_LEVEL&#34;) }}</span></span></span></code></pre></div><h3 id=using-facts>Using Facts<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Pass additional facts using the <code>--fact</code> flag. Facts are available via <code>{{ lookup("facts.KEY") }}</code>:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># deploy-plugin.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>description</span>: <span style=color:#ae81ff>Deploy with custom facts</span>
</span></span><span style=display:flex><span><span style=color:#f92672>commands</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>app</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#ae81ff>Deploy application</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>exec</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>arguments</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>version</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>description</span>: <span style=color:#ae81ff>Application version to deploy</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>required</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      ccm apply /etc/ccm/manifests/app.yaml --fact app_version={{ .Arguments.version }}</span></span></span></code></pre></div><p>In the manifest:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>package</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>myapp</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;{{ lookup(&#39;facts.app_version&#39;) }}&#34;</span></span></span></code></pre></div><h2 id=further-reading>Further Reading<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>For complete App Builder documentation including all command types, templating features, and advanced options, see the <a href=https://choria-io.github.io/appbuilder/index.html rel=external>App Builder documentation</a>.</p><p>Since version <code>0.13.0</code> of App Builder it has a transform and a command that can invoke CCM Manifests, this combines well with flags, arguments and form wizards to create custom UI&rsquo;s that manage your infrastructure.</p><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=yaml-manifests>YAML Manifests</h1><p>A manifest is a YAML file that combines data, hierarchy configuration, and resources in a single file.</p><p>Manifests support template expressions but not procedural logic. Think of them as declarative configuration similar to multi-resource shell scripts.</p><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-lightbulb"></i>
CCM Studio</summary><div class=box-content><p>An experimental visual editor for manifests is available at <a href=https://studio.choria-cm.dev/ rel=external>CCM Studio</a>.</p></div></details><h2 id=manifest-structure>Manifest Structure<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>A manifest contains these top-level sections:</p><table><thead><tr><th>Section</th><th>Description</th></tr></thead><tbody><tr><td><code>data</code></td><td>Input data (like module parameters)</td></tr><tr><td><code>hierarchy</code></td><td>Lookup order and merge strategy for overrides</td></tr><tr><td><code>overrides</code></td><td>Data overrides keyed by hierarchy entries</td></tr><tr><td><code>ccm</code></td><td>Resource definitions and execution options</td></tr></tbody></table><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>A JSON Schema for manifests is available at <a href=https://choria-cm.dev/schemas/ccm/v1/manifest.json rel=external>https://choria-cm.dev/schemas/ccm/v1/manifest.json</a>. Configure your editor to use this schema for completion and validation.</p></div></details><p>The manifest is resolved using the <a href=/hiera/index.html>Choria Hierarchical Data Resolver</a>.</p><h2 id=full-example>Full Example<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=input-data>Input Data<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Define input data like parameters for a module:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>package_name</span>: <span style=color:#e6db74>&#34;httpd&#34;</span></span></span></code></pre></div><h3 id=resources>Resources<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Define resources to manage in the <code>ccm</code> section:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>ccm</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>package</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;{{ lookup(&#39;data.package_name&#39;) }}&#34;</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>latest</span></span></span></code></pre></div><h3 id=configure-hierarchy>Configure Hierarchy<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Configure a hierarchy to vary data by dimensions like OS platform:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>hierarchy</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>order</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>os:{{ lookup(&#39;facts.host.info.platformFamily&#39;) }}</span></span></span></code></pre></div><p>This looks for overrides in <code>os:rhel</code>, <code>os:debian</code>, etc.</p><h3 id=overrides>Overrides<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Provide platform-specific data overrides:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>overrides</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>os:debian</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>package_name</span>: <span style=color:#ae81ff>apache2</span></span></span></code></pre></div><h2 id=applying-manifests>Applying Manifests<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The complete manifest:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>package_name</span>: <span style=color:#e6db74>&#34;httpd&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>ccm</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>package</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;{{ lookup(&#39;data.package_name&#39;) }}&#34;</span>:
</span></span><span style=display:flex><span>             <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>latest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>hierarchy</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>order</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>os:{{ lookup(&#39;facts.host.info.platformFamily&#39;) }}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>overrides</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>os:debian</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>package_name</span>: <span style=color:#ae81ff>apache2</span></span></span></code></pre></div><p>Apply the manifest with <code>ccm apply</code>. The first run makes changes; subsequent runs are stable:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ ccm apply manifest.yaml
INFO  Creating new session record resources=1
WARN  package#httpd changed ensure=latest runtime=3.560699287s provider=dnf

$ ccm apply manifest.yaml
INFO  Creating new session record resources=1
INFO  package#httpd stable ensure=latest runtime=293.448824ms provider=dnf</code></pre></div><p>To preview the fully resolved manifest without applying it:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ ccm apply manifest.yaml --render
data:
  package_name: apache2
resources:
- package:
    - apache2:
        ensure: latest</code></pre></div><h2 id=pre-and-post-messages>Pre and Post Messages<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Display messages before and after manifest execution:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>ccm</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>pre_message</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Starting configuration update...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>post_message</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Configuration complete.</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>...</span></span></span></code></pre></div><p>Both are optional.</p><h2 id=overriding-data>Overriding Data<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Override or augment manifest data with an external Hiera source:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm apply manifest.yaml --hiera kv://CCM/common</code></pre></div><p>Supported sources include local files, KV stores (<code>kv://</code>), and HTTP(S) URLs.</p><h2 id=setting-defaults>Setting Defaults<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Reduce repetition by setting defaults for resources of the same type:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>ccm</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>defaults</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>app</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>group</span>: <span style=color:#ae81ff>app</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>mode</span>: <span style=color:#e6db74>&#34;0644&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>/app/config/file.conf</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>source</span>: <span style=color:#ae81ff>file.conf</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>/app/bin/app</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>source</span>: <span style=color:#ae81ff>app.bin</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>mode</span>: <span style=color:#e6db74>&#34;0700&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>/etc/motd</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>source</span>: <span style=color:#ae81ff>motd.txt</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>mode</span>: <span style=color:#e6db74>&#34;0644&#34;</span></span></span></code></pre></div><p>The first two files inherit the <code>defaults</code> values. The <code>/app/bin/app</code> file overrides just the mode. The <code>/etc/motd</code> file is a separate resource block, so defaults do not apply.</p><h2 id=templating>Templating<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Manifests support template expressions like <code>{{ lookup("key") }}</code> for adjusting values. These expressions cannot generate new resources; they only modify values in valid YAML.</p><h3 id=available-variables>Available Variables<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Templates have access to:</p><table><thead><tr><th>Variable</th><th>Description</th></tr></thead><tbody><tr><td><code>Facts</code></td><td>System facts</td></tr><tr><td><code>Data</code></td><td>Resolved Hiera data</td></tr><tr><td><code>Environ</code></td><td>Environment variables</td></tr></tbody></table><h3 id=generating-resources-with-jet-templates>Generating Resources with Jet Templates<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>To dynamically generate resources from data, use <a href=https://github.com/CloudyKit/jet/blob/master/docs/syntax.md rel=external>Jet Templates</a>.</p><p>Given this data:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>common_packages</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>zsh</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>vim-enhanced</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>nagios-plugins-all</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>tar</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>nmap-ncat</span></span></span></code></pre></div><p>Reference a Jet template file instead of inline resources:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>ccm</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources_jet_file</span>: <span style=color:#ae81ff>resources.jet</span></span></span></code></pre></div><p>Create the template file:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-jet data-lang=jet>{* resources.jet *}
[[ range Data.common_packages ]]
- package:
    - [[ . ]]:
        ensure: present
[[ end ]]</code></pre></div><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>The template file must be in the same directory as the manifest.</p></div></details><p>The template receives the fully resolved Hiera data, plus <code>Facts</code> and <code>Environ</code>.</p><h2 id=failure-handling>Failure Handling<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>By default, if a resource fails, the apply continues to the next resource.</p><h3 id=fail-on-error>Fail on Error<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>To stop execution on the first failure, set <code>fail_on_error</code>:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>ccm</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>fail_on_error</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>/usr/bin/false</span>: {}
</span></span><span style=display:flex><span>        - <span style=color:#f92672>/usr/bin/true</span>: {}</span></span></code></pre></div><p>The second resource is never executed:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ ccm apply manifest.yaml
INFO  Executing manifest manifest=manifest.yaml resources=2
ERROR exec#/usr/bin/false failed ensure=present runtime=3ms provider=posix errors=failed to reach desired state exit code 1
WARN  Terminating manifest execution due to failed resource</code></pre></div><h3 id=resource-dependencies>Resource Dependencies<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Use the <code>require</code> property to ensure a resource only runs after its dependencies succeed:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>ccm</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>package</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>httpd</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>/etc/httpd/conf.d/custom.conf</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>content</span>: <span style=color:#e6db74>&#34;Listen 8080&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>mode</span>: <span style=color:#e6db74>&#34;0644&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>require</span>:
</span></span><span style=display:flex><span>              - <span style=color:#ae81ff>package#httpd</span></span></span></code></pre></div><p>If the required resource fails, the dependent resource is skipped.</p><h2 id=dry-run-noop-mode>Dry Run (Noop Mode)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Preview changes without applying them:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm apply manifest.yaml --noop</code></pre></div><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>Noop mode cannot always detect cascading effects. If one resource change would affect a later resource, that dependency may not be reflected in the dry run.</p></div></details><h2 id=health-check-only-mode>Health Check Only Mode<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Run only health checks without applying resources:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm apply manifest.yaml --monitor-only</code></pre></div><p>This is useful for verifying system state without making changes.</p><h2 id=manifests-in-nats-object-store>Manifests in NATS Object Store<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Manifests can be stored in <a href=https://nats.io rel=external>NATS</a> Object Stores, avoiding the need to distribute files locally.</p><p>Configure a NATS context for authentication:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>nats context add ccm --server nats.example.org --user ccm --password s3cret \
  --description &#34;CCM Configuration Store&#34;</code></pre></div><p>Create an Object Store:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>nats obj add CCM --replicas 3 --context ccm</code></pre></div><p>Create a manifest with supporting files:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ mkdir /tmp/manifest
$ echo &#39;CCM Managed&#39; &gt; /tmp/manifest/motd
$ cat &gt; /tmp/manifest/manifest.yaml &lt;&lt; &#39;EOF&#39;
ccm:
  resources:
    - file:
        - /etc/motd:
            ensure: present
            source: motd
            owner: root
            group: root
            mode: &#34;0644&#34;
EOF</code></pre></div><p>Package and upload to the Object Store:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ tar -C /tmp/manifest/ -cvzf /tmp/manifest.tgz .
$ nats obj put CCM manifest.tgz --context ccm</code></pre></div><p>Apply the manifest:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ ccm apply obj://CCM/manifest.tgz --context ccm
INFO  Using manifest from Object Store in temporary directory bucket=CCM file=manifest.tgz
INFO  file#/etc/motd stable ensure=present runtime=0s provider=posix</code></pre></div><h2 id=manifests-on-web-servers>Manifests on Web Servers<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Store gzipped tar archives on a web server and apply them directly:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>$ ccm apply https://example.net/manifest.tar.gz
INFO  Executing manifest manifest=https://example.net/manifest.tar.gz resources=1
INFO  file#/etc/motd stable ensure=present runtime=0s provider=posix</code></pre></div><p>HTTP Basic Auth is supported via URL credentials:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm apply https://user:pass@example.net/manifest.tar.gz</code></pre></div><h2 id=additional-facts>Additional Facts<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Provide additional facts from the command line or a file:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight># Individual facts
$ ccm apply manifest.yaml --fact env=production --fact region=us-east

# Facts from a file
$ ccm apply manifest.yaml --facts custom-facts.yaml</code></pre></div><p>Facts from these sources are merged with system facts, with command-line facts taking precedence.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=agent>Agent</h1><p>For certain use cases, it is useful to run <a href=/yamlmanifests/index.html>YAML Manifests</a> continuously. For example, you might not want to manage your <code>dotfiles</code> automatically (allowing for local modifications), but you do want to keep Docker up to date.</p><p>The CCM Agent runs manifests continuously, loading them from local files, Object Storage, or HTTP(S) URLs, with Key-Value data overlaid.</p><p>In time, the Agent will become a key part of a service registry system, allowing for continuous monitoring of managed resources and sharing that state into a registryâ€”enabling other nodes to use <code>file</code> resources to create configurations that combine knowledge of all nodes.</p><h2 id=run-modes>Run Modes<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The agent supports two modes of operation that combine to be efficient and fast-reacting:</p><ul><li><strong>Full manifest apply</strong>: Manages the complete state of every resource</li><li><strong>Health check mode</strong>: Runs only <a href=/monitoring/index.html>Monitoring</a> checks, which can trigger a full manifest apply as remediation</li></ul><p>By enabling both modes, you can run health checks very frequently (even at 10- or 20-second intervals) while keeping full Configuration Management runs less frequent (every few hours).</p><p>Enabling both modes is optional but recommended. We also recommend adding health checks to your key resources.</p><h2 id=supported-manifest-and-data-sources>Supported Manifest and Data Sources<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=manifest-sources>Manifest Sources<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Manifests can be loaded from:</p><ul><li><strong>Local file</strong>: <code>/path/to/manifest.yaml</code></li><li><strong>Object Storage</strong>: <code>obj://bucket/key.tar.gz</code></li><li><strong>HTTP(S)</strong>: <code>https://example.com/manifest.tar.gz</code> (supports Basic Auth via URL credentials)</li></ul><p>Remote sources (Object Storage and HTTP) must be <code>.tar.gz</code> archives containing a <code>manifest.yaml</code> file, templates and file sources.</p><h3 id=external-data-sources>External Data Sources<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>For Hiera data resolution, the agent supports:</p><ul><li><strong>Local file</strong>: <code>file:///path/to/data.yaml</code></li><li><strong>Key-Value store</strong>: <code>kv://bucket/key</code></li><li><strong>HTTP(S)</strong>: <code>https://example.com/data.yaml</code></li></ul><h2 id=logical-flow>Logical Flow<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The agent continuously runs and manages manifests as follows:</p><ol><li>At startup, the agent fetches data and gathers facts</li><li>Starts a worker for each manifest source<ol><li>Each worker starts watchers to download and manage the manifest (polling every 30 seconds for remote sources)</li></ol></li><li>Triggers workers at the configured interval for a full apply<ol><li>Each run updates facts (minimum 2-minute interval) and data</li><li>Applies each manifest serially</li></ol></li><li>Triggers workers at the configured health check interval<ol><li>Health check runs do not update facts or data</li><li>Runs health checks for each manifest serially</li><li>If any health checks are critical (not warning), the agent triggers a full apply for that worker</li></ol></li></ol><p>In the background, object stores and HTTP sources are watched for changes. Updates trigger immediate apply runs with exponential backoff retry on failures.</p><h2 id=prometheus-metrics>Prometheus Metrics<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>When <code>monitor_port</code> is configured, the agent exposes Prometheus metrics on <code>/metrics</code>. These metrics can be used to monitor agent health, track resource states and events, and observe health check statuses.</p><h3 id=agent-metrics>Agent Metrics<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Metric</th><th>Type</th><th>Labels</th><th>Description</th></tr></thead><tbody><tr><td><code>choria_ccm_agent_apply_duration_seconds</code></td><td>Summary</td><td>manifest</td><td>Time taken to apply manifests</td></tr><tr><td><code>choria_ccm_agent_healthcheck_duration_seconds</code></td><td>Summary</td><td>manifests</td><td>Time taken for health check runs</td></tr><tr><td><code>choria_ccm_agent_healthcheck_remediations_count</code></td><td>Counter</td><td>manifest</td><td>Health checks that triggered remediation</td></tr><tr><td><code>choria_ccm_agent_data_resolve_duration_seconds</code></td><td>Summary</td><td>-</td><td>Time taken to resolve external data</td></tr><tr><td><code>choria_ccm_agent_data_resolve_error_count</code></td><td>Counter</td><td>url</td><td>Data resolution failures</td></tr><tr><td><code>choria_ccm_agent_facts_resolve_duration_seconds</code></td><td>Summary</td><td>-</td><td>Time taken to resolve facts</td></tr><tr><td><code>choria_ccm_agent_facts_resolve_error_count</code></td><td>Counter</td><td>-</td><td>Facts resolution failures</td></tr><tr><td><code>choria_ccm_agent_manifest_fetch_count</code></td><td>Counter</td><td>manifest</td><td>Remote manifest fetches</td></tr><tr><td><code>choria_ccm_agent_manifest_fetch_error_count</code></td><td>Counter</td><td>manifest</td><td>Remote manifest fetch failures</td></tr></tbody></table><h3 id=resource-metrics>Resource Metrics<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Metric</th><th>Type</th><th>Labels</th><th>Description</th></tr></thead><tbody><tr><td><code>choria_ccm_manifest_apply_duration_seconds</code></td><td>Summary</td><td>source</td><td>Time taken to apply an entire manifest</td></tr><tr><td><code>choria_ccm_resource_apply_duration_seconds</code></td><td>Summary</td><td>type, provider, name</td><td>Time taken to apply a resource</td></tr><tr><td><code>choria_ccm_resource_state_total_count</code></td><td>Counter</td><td>type, name</td><td>Total resources processed</td></tr><tr><td><code>choria_ccm_resource_state_stable_count</code></td><td>Counter</td><td>type, name</td><td>Resources in stable state</td></tr><tr><td><code>choria_ccm_resource_state_changed_count</code></td><td>Counter</td><td>type, name</td><td>Resources that changed</td></tr><tr><td><code>choria_ccm_resource_state_refreshed_count</code></td><td>Counter</td><td>type, name</td><td>Resources that were refreshed</td></tr><tr><td><code>choria_ccm_resource_state_failed_count</code></td><td>Counter</td><td>type, name</td><td>Resources that failed</td></tr><tr><td><code>choria_ccm_resource_state_error_count</code></td><td>Counter</td><td>type, name</td><td>Resources with errors</td></tr><tr><td><code>choria_ccm_resource_state_skipped_count</code></td><td>Counter</td><td>type, name</td><td>Resources that were skipped</td></tr><tr><td><code>choria_ccm_resource_state_noop_count</code></td><td>Counter</td><td>type, name</td><td>Resources in noop mode</td></tr></tbody></table><h3 id=health-check-metrics>Health Check Metrics<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Metric</th><th>Type</th><th>Labels</th><th>Description</th></tr></thead><tbody><tr><td><code>choria_ccm_healthcheck_duration_seconds</code></td><td>Summary</td><td>type, name, check</td><td>Time taken for health checks</td></tr><tr><td><code>choria_ccm_healthcheck_status_count</code></td><td>Counter</td><td>type, name, status, check</td><td>Health check results by status</td></tr></tbody></table><h3 id=facts-metrics>Facts Metrics<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Metric</th><th>Type</th><th>Labels</th><th>Description</th></tr></thead><tbody><tr><td><code>choria_ccm_facts_gather_duration_seconds</code></td><td>Summary</td><td>-</td><td>Time taken to gather system facts</td></tr></tbody></table><h2 id=configuration>Configuration<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The agent is included in the <code>ccm</code> binary. To use it, create a configuration file and enable the systemd service.</p><p>The configuration file is located at <code>/etc/choria/ccm/config.yaml</code>:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># CCM Agent Configuration Example</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Time between scheduled manifest apply runs.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Must be at least 30s. Defaults to 5m.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>interval</span>: <span style=color:#ae81ff>5m</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Time between health check runs.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># When set, health checks run independently of apply runs and can trigger</span>
</span></span><span style=display:flex><span><span style=color:#75715e># remediation applies when critical issues are detected.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Omit to disable periodic health checks.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>health_check_interval</span>: <span style=color:#ae81ff>1m</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># List of manifest sources to apply. Each source creates a separate worker.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Supported formats:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#   - Local file: /path/to/manifest.yaml</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#   - Object store: obj://bucket/key.tar.gz</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#   - HTTP(S): https://example.com/manifest.tar.gz</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#   - HTTP with Basic Auth: https://user:pass@example.com/manifest.tar.gz</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Remote sources must be .tar.gz archives containing a manifest.yaml file.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>manifests</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>/etc/choria/ccm/manifests/base.yaml</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>obj://ccm-manifests/app.tar.gz</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>https://config.example.com/manifests/web.tar.gz</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Logging level: debug, info, warn, error</span>
</span></span><span style=display:flex><span><span style=color:#f92672>log_level</span>: <span style=color:#ae81ff>info</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># NATS context for authentication. Defaults to &#39;CCM&#39;.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>nats_context</span>: <span style=color:#ae81ff>CCM</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Optional URL for external Hiera data resolution.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Supported formats: file://, kv://, http(s)://</span>
</span></span><span style=display:flex><span><span style=color:#75715e># The resolved data is merged into the manifest data context.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>external_data_url</span>: <span style=color:#ae81ff>kv://ccm-data/common</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Directory for caching remote manifest sources.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Defaults to /etc/choria/ccm/source.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>cache_dir</span>: <span style=color:#ae81ff>/etc/choria/ccm/source</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Port for Prometheus metrics endpoint (/metrics).</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Set to 0 or omit to disable.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>monitor_port</span>: <span style=color:#ae81ff>9100</span></span></span></code></pre></div><p>After configuring, start the service:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm ensure service ccm-agent running --enable</code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=monitoring>Monitoring</h1><p>By default, CCM verifies resource health using the resource&rsquo;s native state. For example, if a service should be running and <code>systemd</code> reports it as running, CCM considers it healthy.</p><p>For deeper validation, all resources support custom health checks. These checks run after a resource is managed and can verify that the resource is functioning correctly, not just present.</p><h2 id=health-check-properties>Health Check Properties<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Property</th><th>Description</th><th>Default</th></tr></thead><tbody><tr><td><code>command</code></td><td>Command to execute (Nagios-style check)</td><td>-</td></tr><tr><td><code>goss_rules</code></td><td>Inline <a href=https://goss.readthedocs.io rel=external>Goss</a> validation rules</td><td>-</td></tr><tr><td><code>name</code></td><td>Name for logging and metrics</td><td>Command base name</td></tr><tr><td><code>tries</code></td><td>Number of attempts before failing</td><td>1</td></tr><tr><td><code>try_sleep</code></td><td>Duration to wait between retry attempts</td><td>1s</td></tr><tr><td><code>timeout</code></td><td>Maximum time for command execution</td><td>No timeout</td></tr><tr><td><code>format</code></td><td>Output format interpretation</td><td>Auto-detected</td></tr></tbody></table><p>Each health check must specify either <code>command</code> or <code>goss_rules</code> &ndash; they are mutually exclusive. The <code>format</code> is auto-detected based on which field is set (<code>nagios</code> for <code>command</code>, <code>goss</code> for <code>goss_rules</code>), but can be overridden explicitly.</p><h2 id=nagios-format>Nagios Format<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Health checks using <code>command</code> follow Nagios plugin conventions for exit codes:</p><table><thead><tr><th>Exit Code</th><th>Status</th><th>Description</th></tr></thead><tbody><tr><td>0</td><td>OK</td><td>Check passed</td></tr><tr><td>1</td><td>WARNING</td><td>Check passed with warnings (non-critical)</td></tr><tr><td>2</td><td>CRITICAL</td><td>Check failed</td></tr><tr><td>3+</td><td>UNKNOWN</td><td>Check could not determine status</td></tr></tbody></table><h3 id=example>Example<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class=tab-panel data-tab-group=R-tabs-c16035f76d82ad661baa64dd99863cd3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button aria-controls=R-tab-id-a6423352cafad5d962460e1bbda1c3bc aria-expanded=true data-tab-item=R-tab-76c3e002d3c052bd6a909366a8dc3845 class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("R-tabs-c16035f76d82ad661baa64dd99863cd3","R-tab-76c3e002d3c052bd6a909366a8dc3845")'>
<span class=tab-nav-text>Manifest</span>
</button>
<button aria-controls=R-tab-id-988098d2d8c9b49b8d6abd068c2e7968 aria-expanded=false data-tab-item=R-tab-91af5705f16502125e8b2187e64202c0 class="tab-nav-button tab-panel-style cstyle initial" onclick='switchTab("R-tabs-c16035f76d82ad661baa64dd99863cd3","R-tab-91af5705f16502125e8b2187e64202c0")'>
<span class=tab-nav-text>CLI</span></button></div><div class=tab-content-container><div id=R-tab-id-a6423352cafad5d962460e1bbda1c3bc data-tab-item=R-tab-76c3e002d3c052bd6a909366a8dc3845 class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>httpd</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>running</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>enable</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>health_checks</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>check_http</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>command</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              /usr/lib64/nagios/plugins/check_http -H localhost -p 80 --expect &#34;Acme Inc&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>tries</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>try_sleep</span>: <span style=color:#ae81ff>1s</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>10s</span></span></span></code></pre></div></div></div><div id=R-tab-id-988098d2d8c9b49b8d6abd068c2e7968 data-tab-item=R-tab-91af5705f16502125e8b2187e64202c0 class="tab-content tab-panel-style cstyle initial"><div class=tab-content-text><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code class=language-nohighlight data-lang=nohighlight>ccm ensure service httpd running \
    --check &#39;/usr/lib64/nagios/plugins/check_http -H localhost -p 80&#39; \
    --check-tries 5 \
    --check-sleep 1s</code></pre></div><p>The CLI supports a single health check per resource. For multiple health checks, use a manifest.</p></div></div></div></div><p>This example verifies that the web server responds with content containing &ldquo;Acme Inc&rdquo;. If the check fails, it retries up to 5 times with 1 second between attempts.</p><h2 id=goss-format>Goss Format<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Health checks using <code>goss_rules</code> embed <a href=https://goss.readthedocs.io rel=external>Goss</a> validation rules directly in the manifest. This allows you to validate system state &ndash; running services, listening ports, file contents, HTTP responses, and more &ndash; without writing external check scripts.</p><p>The check result is OK when all Goss rules pass, or CRITICAL when any rule fails. See the <a href=https://goss.readthedocs.io rel=external>Goss documentation</a> for the full list of supported resource types and matchers.</p><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-lightbulb"></i>
Supported Version</summary><div class=box-content><p>Added in version <code>0.1.0</code></p></div></details><h3 id=example-1>Example<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>httpd</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>running</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>enable</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>health_checks</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>httpd_health</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>goss_rules</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>httpd</span>:
</span></span><span style=display:flex><span>                  <span style=color:#f92672>running</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>tcp:80</span>:
</span></span><span style=display:flex><span>                  <span style=color:#f92672>listening</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>http://localhost</span>:
</span></span><span style=display:flex><span>                  <span style=color:#f92672>status</span>: <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>body</span>:
</span></span><span style=display:flex><span>                    - <span style=color:#ae81ff>Acme Inc</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>tries</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>try_sleep</span>: <span style=color:#ae81ff>1s</span></span></span></code></pre></div><p>This validates that the httpd service is running and enabled, port 80 is listening, and the web server responds with a 200 status containing &ldquo;Acme Inc&rdquo;.</p><h3 id=templates-in-goss-rules>Templates in Goss Rules<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Goss rules are processed through CCM&rsquo;s own template engine before evaluation. This means you can use the standard <code>{{ }}</code> expression syntax with access to <code>Facts</code>, <code>Data</code>, and <code>Environ</code>, as well as the <code>lookup()</code>, <code>template()</code>, and <code>jet()</code> functions. See the <a href=/templates/index.html>Data</a> section for full details on template syntax.</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>health_checks</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>app_check</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>goss_rules</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;http://localhost:{{ Data.app_port }}/health&#34;</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>status</span>: <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>body</span>:
</span></span><span style=display:flex><span>            - <span style=color:#e6db74>&#34;{{ lookup(&#39;data.expected_response&#39;, &#39;ok&#39;) }}&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;{{ Data.config_path }}&#34;</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>exists</span>: <span style=color:#66d9ef>true</span></span></span></code></pre></div><p>For more complex rules, you can use the <code>template()</code> function with Jet templates:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>health_checks</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>app_check</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>goss_rules</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;http://localhost:{{ template(&#39;check_url.jet&#39;) }}&#34;</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>status</span>: <span style=color:#ae81ff>200</span></span></span></code></pre></div><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i>
Note</summary><div class=box-content><p>CCM resolves templates before passing rules to Goss. Goss&rsquo;s own template variables are not used.</p></div></details><h2 id=agent-integration>Agent Integration<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>When running the <a href=/agent/index.html>Agent</a> with <code>health_check_interval</code> configured, health checks run independently of full manifest applies. If any health check returns a CRITICAL status, the agent triggers a remediation apply for that manifest.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=design-documents>Design Documents</h1><p>Design documents provide detailed implementation guidance for CCM&rsquo;s resource types, providers, and internal components. They are intended for developers contributing to CCM or those seeking to understand specific implementation details.</p><p>For end-user documentation on how to use resources, see <a href=/resources/index.html>Resources</a>.</p><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Note</summary><div class=box-content><p>These design documents are largely written with AI assistance and reviewed before publication.</p></div></details><h2 id=contents>Contents<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Each design document covers:</p><ul><li><strong>Purpose and scope</strong>: What the component does and its responsibilities</li><li><strong>Architecture</strong>: How the component fits into CCM&rsquo;s overall design</li><li><strong>Implementation details</strong>: Key data structures, interfaces, and algorithms</li><li><strong>Provider contracts</strong>: Requirements for implementing new providers</li><li><strong>Testing considerations</strong>: How to test the component</li></ul><h2 id=available-documents>Available Documents<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Document</th><th>Description</th></tr></thead><tbody><tr><td><a href=/design/archive/index.html>Archive</a></td><td>Archive resource for downloading and extracting archives</td></tr><tr><td><a href=/design/exec/index.html>Exec</a></td><td>Exec resource for command execution</td></tr><tr><td><a href=/design/file/index.html>File</a></td><td>File resource for managing files and directories</td></tr><tr><td><a href=/design/package/index.html>Package</a></td><td>Package resource for system package management</td></tr><tr><td><a href=/design/service/index.html>Service</a></td><td>Service resource for system service management</td></tr></tbody></table><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Design Documents</h1><article class=default><header class=headline></header><h1 id=archive-type>Archive Type</h1><p>This document describes the design of the archive resource type for downloading and extracting archives.</p><h2 id=overview>Overview<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The archive resource manages remote archives with three phases:</p><ul><li><strong>Download</strong>: Fetch archive from a URL to local filesystem</li><li><strong>Extract</strong>: Unpack archive contents to a target directory</li><li><strong>Cleanup</strong>: Optionally remove the archive file after extraction</li></ul><p>These phases are conditional based on current state and configuration.</p><h2 id=provider-interface>Provider Interface<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Archive providers must implement the <code>ArchiveProvider</code> interface:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ArchiveProvider</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Provider</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Download</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>properties</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ArchiveResourceProperties</span>, <span style=color:#a6e22e>log</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Logger</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Extract</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>properties</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ArchiveResourceProperties</span>, <span style=color:#a6e22e>log</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Logger</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Status</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>properties</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ArchiveResourceProperties</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ArchiveState</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=method-responsibilities>Method Responsibilities<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Method</th><th>Responsibility</th></tr></thead><tbody><tr><td><code>Status</code></td><td>Query archive file existence, checksum, attributes, and creates file</td></tr><tr><td><code>Download</code></td><td>Fetch archive from URL, verify checksum, set ownership</td></tr><tr><td><code>Extract</code></td><td>Unpack archive contents to extract parent directory</td></tr></tbody></table><h3 id=status-response>Status Response<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>Status</code> method returns an <code>ArchiveState</code> containing:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ArchiveState</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CommonResourceState</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Metadata</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ArchiveMetadata</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ArchiveMetadata</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>          <span style=color:#66d9ef>string</span>    <span style=color:#75715e>// Archive file path</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Checksum</span>      <span style=color:#66d9ef>string</span>    <span style=color:#75715e>// SHA256 hash of archive</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ArchiveExists</span> <span style=color:#66d9ef>bool</span>      <span style=color:#75715e>// Whether archive file exists</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CreatesExists</span> <span style=color:#66d9ef>bool</span>      <span style=color:#75715e>// Whether creates marker file exists</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Owner</span>         <span style=color:#66d9ef>string</span>    <span style=color:#75715e>// Archive file owner</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Group</span>         <span style=color:#66d9ef>string</span>    <span style=color:#75715e>// Archive file group</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MTime</span>         <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span> <span style=color:#75715e>// Modification time</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Size</span>          <span style=color:#66d9ef>int64</span>     <span style=color:#75715e>// File size in bytes</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Provider</span>      <span style=color:#66d9ef>string</span>    <span style=color:#75715e>// Provider name (e.g., &#34;http&#34;)</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>The <code>Ensure</code> field in <code>CommonResourceState</code> is set to:</p><ul><li><code>present</code> if the archive file exists</li><li><code>absent</code> if the archive file does not exist</li></ul><h2 id=available-providers>Available Providers<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Provider</th><th>Source</th><th>Documentation</th></tr></thead><tbody><tr><td><code>http</code></td><td>HTTP/HTTPS URLs</td><td><a href=/design/archive/http/index.html>HTTP</a></td></tr></tbody></table><h2 id=ensure-states>Ensure States<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>present</code></td><td>Archive must be downloaded (and optionally extracted)</td></tr><tr><td><code>absent</code></td><td>Archive file must not exist</td></tr></tbody></table><h2 id=supported-archive-formats>Supported Archive Formats<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Extension</th><th>Description</th></tr></thead><tbody><tr><td><code>.tar.gz</code>, <code>.tgz</code></td><td>Gzip-compressed tar archive</td></tr><tr><td><code>.tar</code></td><td>Uncompressed tar archive</td></tr><tr><td><code>.zip</code></td><td>ZIP archive</td></tr></tbody></table><p>The URL and local file name must have matching archive type extensions.</p><h2 id=apply-logic>Apply Logic<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Get current state via Status()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Is current state desired state?         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              Yes â”‚         No
                  â–¼         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
          â”‚ No change â”‚     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ What is desired ensure? â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ absent                        â”‚ present
            â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Remove archiveâ”‚             â”‚ Download needed?    â”‚
    â”‚ file          â”‚             â”‚ (checksum mismatch  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  or file missing)   â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        Yes â”‚         No
                                            â–¼         â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
                                    â”‚ Download  â”‚     â”‚
                                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â”‚
                                          â”‚           â”‚
                                          â–¼           â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ Extract needed?         â”‚
                                  â”‚ (extract_parent set AND â”‚
                                  â”‚  (download occurred OR  â”‚
                                  â”‚   creates file missing))â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        Yes â”‚         No
                                            â–¼         â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
                                    â”‚ Extract   â”‚     â”‚
                                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â”‚
                                          â”‚           â”‚
                                          â–¼           â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ Cleanup enabled?        â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        Yes â”‚         No
                                            â–¼         â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ Remove    â”‚ â”‚ Done  â”‚
                                    â”‚ archive   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The archive resource uses multiple checks for idempotency:</p><h3 id=state-checks-in-order>State Checks (in order)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><ol><li><strong>Ensure absent</strong>: Archive file must not exist</li><li><strong>Creates file</strong>: If <code>creates</code> is set, the marker file must exist</li><li><strong>Archive existence</strong>: If <code>cleanup: false</code>, archive must exist</li><li><strong>Owner/Group</strong>: Archive file attributes must match</li><li><strong>Checksum</strong>: If specified, archive checksum must match</li></ol><h3 id=decision-table>Decision Table<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Condition</th><th>Stable?</th></tr></thead><tbody><tr><td><code>ensure: absent</code> + archive missing</td><td>Yes</td></tr><tr><td><code>ensure: absent</code> + archive exists</td><td>No (remove)</td></tr><tr><td><code>creates</code> file exists</td><td>Yes (skip all)</td></tr><tr><td><code>creates</code> file missing</td><td>No (extract needed)</td></tr><tr><td><code>cleanup: false</code> + archive missing</td><td>No (download needed)</td></tr><tr><td>Archive checksum mismatch</td><td>No (re-download needed)</td></tr><tr><td>Archive owner/group mismatch</td><td>No (re-download needed)</td></tr></tbody></table><h2 id=creates-property>Creates Property<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The <code>creates</code> property provides idempotency for extraction:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>archive</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/tmp/app.tar.gz</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#ae81ff>https://example.com/app.tar.gz</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>extract_parent</span>: <span style=color:#ae81ff>/opt/app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>creates</span>: <span style=color:#ae81ff>/opt/app/bin/app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span></span></span></code></pre></div><p><strong>Behavior:</strong></p><ul><li>If <code>/opt/app/bin/app</code> exists, skip download and extraction</li><li>Useful when extracted files indicate successful prior extraction</li><li>Prevents re-extraction on every run</li></ul><h2 id=cleanup-property>Cleanup Property<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The <code>cleanup</code> property removes the archive after extraction:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>archive</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/tmp/app.tar.gz</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#ae81ff>https://example.com/app.tar.gz</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>extract_parent</span>: <span style=color:#ae81ff>/opt/app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>creates</span>: <span style=color:#ae81ff>/opt/app/bin/app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>cleanup</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span></span></span></code></pre></div><p><strong>Requirements:</strong></p><ul><li><code>extract_parent</code> must be set (cleanup only makes sense with extraction)</li><li><code>creates</code> must be set to track extraction state</li></ul><p><strong>Behavior:</strong></p><ul><li>After successful extraction, remove the archive file</li><li>On subsequent runs, <code>creates</code> file prevents re-download</li></ul><h2 id=checksum-verification>Checksum Verification<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>When <code>checksum</code> is specified:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>archive</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/tmp/app.tar.gz</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#ae81ff>https://example.com/app.tar.gz</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>checksum</span>: <span style=color:#e6db74>&#34;a1b2c3d4...&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span></span></span></code></pre></div><p><strong>Behavior:</strong></p><ul><li>Downloaded file is verified against SHA256 checksum</li><li>Existing file checksum is compared to detect changes</li><li>Checksum mismatch triggers re-download</li><li>Download fails if fetched content doesn&rsquo;t match</li></ul><h2 id=authentication>Authentication<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Archives support two authentication methods:</p><h3 id=basic-authentication>Basic Authentication<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>archive</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/tmp/app.tar.gz</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#ae81ff>https://private.example.com/app.tar.gz</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>username</span>: <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;{{ lookup(&#39;data.password&#39;) }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span></span></span></code></pre></div><h3 id=custom-headers>Custom Headers<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>archive</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/tmp/app.tar.gz</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>: <span style=color:#ae81ff>https://api.example.com/releases/app.tar.gz</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>headers</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>Authorization</span>: <span style=color:#e6db74>&#34;Bearer {{ lookup(&#39;data.token&#39;) }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span></span></span></code></pre></div><h2 id=required-properties>Required Properties<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Property</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>url</code></td><td>Yes</td><td>Source URL for download</td></tr><tr><td><code>owner</code></td><td>Yes</td><td>Username that owns the archive file</td></tr><tr><td><code>group</code></td><td>Yes</td><td>Group that owns the archive file</td></tr></tbody></table><h2 id=url-validation>URL Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>URLs are validated during resource creation:</p><ul><li>Must be valid URL format</li><li>Scheme must be <code>http</code> or <code>https</code></li><li>Path must end with supported archive extension</li><li>Extension must match the <code>name</code> property extension</li></ul><h2 id=noop-mode>Noop Mode<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>In noop mode, the archive type:</p><ol><li>Queries current state normally</li><li>Computes what actions would be taken</li><li>Sets appropriate <code>NoopMessage</code>:<ul><li>&ldquo;Would have downloaded&rdquo;</li><li>&ldquo;Would have extracted&rdquo;</li><li>&ldquo;Would have cleaned up&rdquo;</li><li>&ldquo;Would have removed&rdquo;</li></ul></li><li>Reports <code>Changed: true</code> if changes would occur</li><li>Does not call provider Download/Extract methods</li><li>Does not remove files</li></ol><p>Multiple actions are joined with &ldquo;. " (e.g., &ldquo;Would have downloaded. Would have extracted&rdquo;).</p><h2 id=desired-state-validation>Desired State Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>After applying changes (in non-noop mode), the type verifies the archive reached the desired state by calling <code>Status()</code> again and checking all conditions. If validation fails, <code>ErrDesiredStateFailed</code> is returned.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Archive Type</h1><article class=default><header class=headline></header><h1 id=http-provider>HTTP Provider</h1><p>This document describes the implementation details of the HTTP archive provider for downloading and extracting archives from HTTP/HTTPS URLs.</p><h2 id=provider-selection>Provider Selection<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The HTTP provider is selected when:</p><ol><li>The URL scheme is <code>http</code> or <code>https</code></li><li>The archive file extension is supported (<code>.tar.gz</code>, <code>.tgz</code>, <code>.tar</code>, <code>.zip</code>)</li><li>The required extraction tool (<code>tar</code> or <code>unzip</code>) is available in PATH</li></ol><p>The <code>IsManageable()</code> function checks these conditions and returns a priority of 1 if all are met.</p><h2 id=operations>Operations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=download>Download<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Parse the URL and add Basic Auth credentials if username/password provided</li><li>Create HTTP request with custom headers (if specified)</li><li>Execute GET request via <code>util.HttpGetResponse()</code></li><li>Verify HTTP 200 status code</li><li>Create temporary file in the same directory as the target</li><li>Set ownership on temp file before writing content</li><li>Copy response body to temp file</li><li>Verify checksum if provided</li><li>Atomic rename temp file to target path</li></ol><p><strong>Atomic Write Pattern:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>[parent dir]/archive-name-* (temp file)
    â†“ write content
    â†“ set owner/group
    â†“ verify checksum
    â†“ rename
[parent dir]/archive-name (final file)</code></pre></div><p>The temp file is created in the same directory as the target to ensure <code>os.Rename()</code> is atomic (same filesystem).</p><p><strong>Error Handling:</strong></p><table><thead><tr><th>Condition</th><th>Behavior</th></tr></thead><tbody><tr><td>HTTP non-200</td><td>Return error with status code</td></tr><tr><td>Write failure</td><td>Clean up temp file, return error</td></tr><tr><td>Checksum mismatch</td><td>Clean up temp file, return error with expected vs actual</td></tr><tr><td>Rename failure</td><td>Temp file cleaned up by defer</td></tr></tbody></table><p><strong>Authentication:</strong></p><table><thead><tr><th>Method</th><th>Implementation</th></tr></thead><tbody><tr><td>Basic Auth</td><td>URL userinfo is passed to <code>HttpGetResponse()</code> which sets <code>Authorization</code> header</td></tr><tr><td>Username/Password properties</td><td>Embedded in URL before request: <code>url.UserPassword(username, password)</code></td></tr><tr><td>Custom Headers</td><td>Added to request via <code>http.Header.Add()</code></td></tr></tbody></table><h3 id=extract>Extract<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Validate <code>ExtractParent</code> is set</li><li>Create <code>ExtractParent</code> directory if it doesn&rsquo;t exist (mode 0755)</li><li>Determine archive type from file extension</li><li>Execute appropriate extraction command</li></ol><p><strong>Extraction Commands:</strong></p><table><thead><tr><th>Extension</th><th>Command</th></tr></thead><tbody><tr><td><code>.tar.gz</code>, <code>.tgz</code></td><td><code>tar -xzf &lt;archive> -C &lt;extract_parent></code></td></tr><tr><td><code>.tar</code></td><td><code>tar -xf &lt;archive> -C &lt;extract_parent></code></td></tr><tr><td><code>.zip</code></td><td><code>unzip -d &lt;extract_parent> &lt;archive></code></td></tr></tbody></table><p><strong>Command Execution:</strong></p><p>Commands are executed via <code>model.CommandRunner.ExecuteWithOptions()</code> with:</p><table><thead><tr><th>Option</th><th>Value</th></tr></thead><tbody><tr><td><code>Command</code></td><td><code>tar</code> or <code>unzip</code></td></tr><tr><td><code>Args</code></td><td>Extraction flags and paths</td></tr><tr><td><code>Cwd</code></td><td><code>ExtractParent</code> directory</td></tr><tr><td><code>Timeout</code></td><td>1 minute</td></tr></tbody></table><p><strong>Error Handling:</strong></p><table><thead><tr><th>Condition</th><th>Behavior</th></tr></thead><tbody><tr><td>Unsupported extension</td><td>Return &ldquo;archive type not supported&rdquo; error</td></tr><tr><td>Command not found</td><td>Runner returns error</td></tr><tr><td>Non-zero exit code</td><td>Return error with exit code and stderr</td></tr></tbody></table><h3 id=status>Status<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Initialize state with <code>EnsureAbsent</code> default</li><li>Check if archive file exists via <code>os.Stat()</code></li><li>If exists: set <code>EnsurePresent</code>, populate metadata (size, mtime, owner, group, checksum)</li><li>If <code>Creates</code> property set: check if creates file exists</li></ol><p><strong>Metadata Collected:</strong></p><table><thead><tr><th>Field</th><th>Source</th></tr></thead><tbody><tr><td><code>Name</code></td><td>From properties</td></tr><tr><td><code>Provider</code></td><td>&ldquo;http&rdquo;</td></tr><tr><td><code>ArchiveExists</code></td><td><code>os.Stat()</code> success</td></tr><tr><td><code>Size</code></td><td><code>FileInfo.Size()</code></td></tr><tr><td><code>MTime</code></td><td><code>FileInfo.ModTime()</code></td></tr><tr><td><code>Owner</code></td><td><code>util.GetFileOwner()</code> - resolves UID to username</td></tr><tr><td><code>Group</code></td><td><code>util.GetFileOwner()</code> - resolves GID to group name</td></tr><tr><td><code>Checksum</code></td><td><code>util.Sha256HashFile()</code></td></tr><tr><td><code>CreatesExists</code></td><td><code>os.Stat()</code> on <code>Creates</code> path</td></tr></tbody></table><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The provider supports idempotency through the type&rsquo;s <code>isDesiredState()</code> function:</p><h3 id=state-checks-in-order>State Checks (in order)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><ol><li><strong>Ensure Absent</strong>: If <code>ensure: absent</code>, archive must not exist</li><li><strong>Creates File</strong>: If <code>Creates</code> set and file doesn&rsquo;t exist â†’ not stable</li><li><strong>Archive Existence</strong>: If <code>cleanup: false</code>, archive must exist</li><li><strong>Owner/Group</strong>: Must match properties</li><li><strong>Checksum</strong>: If specified in properties, must match</li></ol><p>Note: When <code>cleanup: true</code>, the <code>creates</code> property is required (enforced at validation time).</p><h3 id=decision-matrix>Decision Matrix<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Archive Exists</th><th>Creates Exists</th><th>Checksum Match</th><th>Cleanup</th><th>Stable?</th></tr></thead><tbody><tr><td>No</td><td>No</td><td>N/A</td><td>false</td><td>No (download needed)</td></tr><tr><td>Yes</td><td>No</td><td>Yes</td><td>false</td><td>No (extract needed)</td></tr><tr><td>Yes</td><td>Yes</td><td>Yes</td><td>false</td><td>Yes</td></tr><tr><td>No</td><td>Yes</td><td>N/A</td><td>true</td><td>Yes</td></tr><tr><td>Yes</td><td>Yes</td><td>Yes</td><td>true</td><td>No (cleanup needed)</td></tr></tbody></table><h2 id=checksum-verification>Checksum Verification<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p><strong>Algorithm:</strong> SHA-256</p><p><strong>Implementation:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>sum</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>Sha256HashFile</span>(<span style=color:#a6e22e>tempFile</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sum</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Checksum</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;checksum mismatch, expected %q got %q&#34;</span>, <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Checksum</span>, <span style=color:#a6e22e>sum</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p><strong>Timing:</strong> Checksum is verified after download completes but before the atomic rename. This ensures:</p><ul><li>Corrupted downloads are never placed at the target path</li><li>Temp file is cleaned up on mismatch</li><li>Clear error message with both expected and actual checksums</li></ul><h2 id=security-considerations>Security Considerations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=credential-handling>Credential Handling<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><ul><li>Credentials in URL are redacted in log messages via <code>util.RedactUrlCredentials()</code></li><li>Basic Auth header is set by Go&rsquo;s <code>http.Request.SetBasicAuth()</code>, not manually constructed</li></ul><h3 id=archive-extraction>Archive Extraction<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><ul><li>Extraction uses system <code>tar</code>/<code>unzip</code> commands</li><li>No path traversal protection beyond what the tools provide</li><li><code>ExtractParent</code> must be an absolute path (validated in model)</li></ul><h3 id=temporary-files>Temporary Files<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><ul><li>Created with <code>os.CreateTemp()</code> using pattern <code>&lt;archive-name>-*</code></li><li>Deferred removal ensures cleanup on all exit paths</li><li>Ownership set before content written</li></ul><h2 id=platform-support>Platform Support<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The provider is Unix-only due to:</p><ul><li>Dependency on <code>util.GetFileOwner()</code> which uses syscall for UID/GID resolution</li><li>Dependency on <code>util.ChownFile()</code> for ownership management</li></ul><h2 id=timeouts>Timeouts<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Operation</th><th>Timeout</th><th>Configurable</th></tr></thead><tbody><tr><td>HTTP Download</td><td>1 minute (default in <code>HttpGetResponse</code>)</td><td>No</td></tr><tr><td>Archive Extraction</td><td>1 minute</td><td>No</td></tr></tbody></table><p>Large archives may require increased timeouts in future versions.</p><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=exec-type>Exec Type</h1><p>This document describes the design of the exec resource type for executing commands.</p><h2 id=overview>Overview<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The exec resource executes commands with idempotency controls:</p><ul><li><strong>Creates</strong>: Skip execution if a file exists</li><li><strong>Refresh Only</strong>: Only execute when triggered by a subscribed resource</li><li><strong>Exit Codes</strong>: Validate success via configurable return codes</li></ul><h2 id=provider-interface>Provider Interface<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Exec providers must implement the <code>ExecProvider</code> interface:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ExecProvider</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Provider</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Execute</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>properties</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ExecResourceProperties</span>, <span style=color:#a6e22e>log</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Logger</span>) (<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Status</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>properties</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ExecResourceProperties</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ExecState</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=method-responsibilities>Method Responsibilities<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Method</th><th>Responsibility</th></tr></thead><tbody><tr><td><code>Status</code></td><td>Check if <code>creates</code> file exists, return current state</td></tr><tr><td><code>Execute</code></td><td>Run the command, return exit code</td></tr></tbody></table><h3 id=status-response>Status Response<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>Status</code> method returns an <code>ExecState</code> containing:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ExecState</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CommonResourceState</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ExitCode</span>         <span style=color:#f92672>*</span><span style=color:#66d9ef>int</span> <span style=color:#75715e>// Exit code from last execution (nil if not run)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CreatesSatisfied</span> <span style=color:#66d9ef>bool</span> <span style=color:#75715e>// Whether creates file exists</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>The <code>Ensure</code> field in <code>CommonResourceState</code> is set to:</p><ul><li><code>present</code> if the <code>creates</code> file exists</li><li><code>absent</code> if the <code>creates</code> file does not exist (or not specified)</li></ul><h2 id=available-providers>Available Providers<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Provider</th><th>Execution Method</th><th>Documentation</th></tr></thead><tbody><tr><td><code>posix</code></td><td>Direct exec (no shell)</td><td><a href=/design/exec/posix/index.html>Posix</a></td></tr><tr><td><code>shell</code></td><td>Via <code>/bin/sh -c</code></td><td><a href=/design/exec/shell/index.html>Shell</a></td></tr></tbody></table><h2 id=properties>Properties<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Property</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>command</code></td><td>string</td><td>Command to run (defaults to <code>name</code> if not set)</td></tr><tr><td><code>cwd</code></td><td>string</td><td>Working directory for command execution</td></tr><tr><td><code>environment</code></td><td>[]string</td><td>Additional environment variables (<code>KEY=value</code>)</td></tr><tr><td><code>path</code></td><td>string</td><td>Search path for executables (colon-separated)</td></tr><tr><td><code>returns</code></td><td>[]int</td><td>Acceptable exit codes (default: <code>[0]</code>)</td></tr><tr><td><code>timeout</code></td><td>string</td><td>Maximum execution time (e.g., <code>30s</code>, <code>5m</code>)</td></tr><tr><td><code>creates</code></td><td>string</td><td>File path; skip execution if exists</td></tr><tr><td><code>refresh_only</code></td><td>bool</td><td>Only execute via subscribe refresh</td></tr><tr><td><code>subscribe</code></td><td>[]string</td><td>Resources to watch for changes (<code>type#name</code>)</td></tr><tr><td><code>logoutput</code></td><td>bool</td><td>Log command output</td></tr></tbody></table><h2 id=apply-logic>Apply Logic<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Get current state via Status()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check for subscribe refresh             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Subscribed resource       â”‚
    â”‚ changed?                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              Yes â”‚         No
                  â–¼         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
          â”‚ Execute   â”‚     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Is desired state met?   â”‚
              â”‚ (creates file exists OR â”‚
              â”‚  refresh_only is true)  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        Yes â”‚         No
                            â–¼         â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
                    â”‚ Skip      â”‚     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                                      â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ Is refresh_only = true? â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  Yes â”‚         No
                                      â–¼         â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
                              â”‚ Skip      â”‚     â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                                                â–¼
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚ Execute   â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The exec resource provides idempotency through two mechanisms:</p><h3 id=creates-property>Creates Property<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>creates</code> property specifies a file that indicates successful prior execution:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>extract-archive</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>tar xzf /tmp/app.tar.gz -C /opt</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>creates</span>: <span style=color:#ae81ff>/opt/app/bin/app</span></span></span></code></pre></div><p><strong>Behavior:</strong></p><ul><li>If <code>/opt/app/bin/app</code> exists, skip execution</li><li>Useful for one-time setup commands</li><li>Provider checks file existence via <code>Status()</code></li></ul><h3 id=refresh-only-property>Refresh Only Property<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>refresh_only</code> property limits execution to subscribe refreshes:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>reload-nginx</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>systemctl reload nginx</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>refresh_only</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subscribe</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>file#/etc/nginx/nginx.conf</span></span></span></code></pre></div><p><strong>Behavior:</strong></p><ul><li>Command only runs when subscribed resource changes</li><li>Without a subscribe trigger, command is skipped</li><li>Useful for reload/restart commands</li></ul><h3 id=decision-table>Decision Table<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Condition</th><th>Action</th></tr></thead><tbody><tr><td>Subscribe triggered</td><td>Execute</td></tr><tr><td><code>creates</code> file exists</td><td>Skip</td></tr><tr><td><code>refresh_only: true</code> + no trigger</td><td>Skip</td></tr><tr><td><code>refresh_only: false</code> + no <code>creates</code></td><td>Execute</td></tr></tbody></table><h2 id=subscribe-behavior>Subscribe Behavior<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Exec resources can subscribe to other resources and execute when they change:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/etc/app/config.yaml</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>content</span>: <span style=color:#e6db74>&#34;...&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>reload-app</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>systemctl reload app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>refresh_only</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subscribe</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>file#/etc/app/config.yaml</span></span></span></code></pre></div><p>Subscribe takes precedence over other idempotency checks - if a subscribed resource changed, the command executes regardless of <code>creates</code> file existence.</p><h2 id=exit-code-validation>Exit Code Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>By default, exit code <code>0</code> indicates success. The <code>returns</code> property customizes acceptable codes:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>check-status</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>/usr/local/bin/check-health</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>returns</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>2</span></span></span></code></pre></div><p><strong>Behavior:</strong></p><ul><li>Command succeeds if exit code is in <code>returns</code> list</li><li>Command fails if exit code is not in <code>returns</code> list</li><li>Used for desired state validation after execution</li></ul><h2 id=noop-mode>Noop Mode<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>In noop mode, the exec type:</p><ol><li>Queries current state normally (checks <code>creates</code> file)</li><li>Evaluates subscribe triggers</li><li>Logs what actions would be taken</li><li>Sets appropriate <code>NoopMessage</code>:<ul><li>&ldquo;Would have executed&rdquo;</li><li>&ldquo;Would have executed via subscribe&rdquo;</li></ul></li><li>Reports <code>Changed: true</code> if execution would occur</li><li>Does not call provider <code>Execute</code> method</li></ol><h2 id=desired-state-validation>Desired State Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>After execution (in non-noop mode), the type verifies success:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Type</span>) <span style=color:#a6e22e>isDesiredState</span>(<span style=color:#a6e22e>properties</span>, <span style=color:#a6e22e>status</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Creates file check takes precedence</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Creates</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>CreatesSatisfied</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Refresh-only without execution is stable</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>ExitCode</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>RefreshOnly</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check exit code against acceptable returns</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>returns</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>int</span>{<span style=color:#ae81ff>0</span>}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Returns</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>returns</span> = <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Returns</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>ExitCode</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>slices</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>returns</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>ExitCode</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>If the exit code is not in the acceptable <code>returns</code> list, an <code>ErrDesiredStateFailed</code> error is returned.</p><h2 id=command-vs-name>Command vs Name<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The <code>command</code> property is optional. If not specified, the <code>name</code> is used as the command:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># These are equivalent:</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/usr/bin/myapp --config /etc/myapp.conf</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>run-myapp</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>/usr/bin/myapp --config /etc/myapp.conf</span></span></span></code></pre></div><p>Using a descriptive <code>name</code> with explicit <code>command</code> is recommended for clarity.</p><h2 id=environment-and-path>Environment and Path<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Commands can be configured with custom environment:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>build-app</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>make build</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>cwd</span>: <span style=color:#ae81ff>/opt/app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>CC=gcc</span>
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>CFLAGS=-O2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/usr/local/bin:/usr/bin:/bin</span></span></span></code></pre></div><p><strong>Environment:</strong></p><ul><li>Added to the command&rsquo;s environment</li><li>Format: <code>KEY=value</code></li><li>Does not replace existing environment</li></ul><p><strong>Path:</strong></p><ul><li>Sets the <code>PATH</code> for executable lookup</li><li>Must be absolute directories</li><li>Colon-separated list</li></ul><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Exec Type</h1><article class=default><header class=headline></header><h1 id=posix-provider>Posix Provider</h1><p>This document describes the implementation details of the Posix exec provider for executing commands without a shell.</p><h2 id=provider-selection>Provider Selection<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The Posix provider is the default exec provider. It is always available and returns priority 1 for all exec resources unless a different provider is explicitly requested via the <code>provider</code> property.</p><p>To use the shell provider instead, specify <code>provider: shell</code> in the resource properties.</p><h2 id=comparison-with-shell-provider>Comparison with Shell Provider<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Feature</th><th>Posix</th><th>Shell</th></tr></thead><tbody><tr><td>Shell invocation</td><td>No</td><td>Yes (<code>/bin/sh -c</code>)</td></tr><tr><td>Pipes (<code>|</code>)</td><td>Not supported</td><td>Supported</td></tr><tr><td>Redirections (<code>></code>, <code>&lt;</code>)</td><td>Not supported</td><td>Supported</td></tr><tr><td>Shell builtins (<code>cd</code>, <code>export</code>)</td><td>Not supported</td><td>Supported</td></tr><tr><td>Glob expansion</td><td>Not supported</td><td>Supported</td></tr><tr><td>Command substitution (<code>$(...)</code>)</td><td>Not supported</td><td>Supported</td></tr><tr><td>Argument parsing</td><td><code>shellquote.Split()</code></td><td>Passed as single string</td></tr><tr><td>Security</td><td>Lower attack surface</td><td>Shell injection possible</td></tr></tbody></table><p><strong>When to use Posix (default):</strong></p><ul><li>Simple commands with arguments</li><li>When shell features are not needed</li><li>For better security (no shell injection risk)</li></ul><p><strong>When to use Shell:</strong></p><ul><li>Commands with pipes, redirections, or shell builtins</li><li>Complex command strings</li><li>When shell expansion is required</li></ul><h2 id=operations>Operations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=execute>Execute<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Determine command source (<code>Command</code> property or <code>Name</code> if <code>Command</code> is empty)</li><li>Parse command string into words using <code>shellquote.Split()</code></li><li>Extract command (first word) and arguments (remaining words)</li><li>Execute via <code>CommandRunner.ExecuteWithOptions()</code></li><li>Optionally log output line-by-line if <code>LogOutput</code> is enabled</li></ol><p><strong>Command Parsing:</strong></p><p>The command string is parsed using <code>github.com/kballard/go-shellquote</code>, which handles:</p><table><thead><tr><th>Syntax</th><th>Example</th><th>Result</th></tr></thead><tbody><tr><td>Simple words</td><td><code>echo hello world</code></td><td><code>["echo", "hello", "world"]</code></td></tr><tr><td>Single quotes</td><td><code>echo 'hello world'</code></td><td><code>["echo", "hello world"]</code></td></tr><tr><td>Double quotes</td><td><code>echo "hello world"</code></td><td><code>["echo", "hello world"]</code></td></tr><tr><td>Escaped spaces</td><td><code>echo hello\ world</code></td><td><code>["echo", "hello world"]</code></td></tr><tr><td>Mixed quoting</td><td><code>echo "it's a test"</code></td><td><code>["echo", "it's a test"]</code></td></tr></tbody></table><p><strong>Execution Options:</strong></p><table><thead><tr><th>Option</th><th>Source</th><th>Description</th></tr></thead><tbody><tr><td><code>Command</code></td><td>First word after parsing</td><td>Executable path or name</td></tr><tr><td><code>Args</code></td><td>Remaining words</td><td>Command arguments</td></tr><tr><td><code>Cwd</code></td><td><code>properties.Cwd</code></td><td>Working directory</td></tr><tr><td><code>Environment</code></td><td><code>properties.Environment</code></td><td>Additional env vars (<code>KEY=VALUE</code> format)</td></tr><tr><td><code>Path</code></td><td><code>properties.Path</code></td><td>Search path for executables</td></tr><tr><td><code>Timeout</code></td><td><code>properties.ParsedTimeout</code></td><td>Maximum execution time</td></tr></tbody></table><p><strong>Output Logging:</strong></p><p>When <code>LogOutput: true</code> is set and a user logger is provided:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>scanner</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>NewScanner</span>(<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>stdout</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Each line of stdout is logged as a separate <code>Info</code> message.</p><p><strong>Error Handling:</strong></p><table><thead><tr><th>Condition</th><th>Behavior</th></tr></thead><tbody><tr><td>Empty command string</td><td>Return error: &ldquo;no command specified&rdquo;</td></tr><tr><td>Invalid shell quoting</td><td>Return parsing error (e.g., &ldquo;Unterminated single quote&rdquo;)</td></tr><tr><td>Runner not configured</td><td>Return error: &ldquo;no command runner configured&rdquo;</td></tr><tr><td>Command execution fails</td><td>Return error from runner</td></tr><tr><td>Non-zero exit code</td><td>Return exit code (not an error by itself)</td></tr></tbody></table><h3 id=status>Status<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Create state with <code>EnsurePresent</code> (exec resources are always &ldquo;present&rdquo;)</li><li>Check if <code>Creates</code> file exists via <code>util.FileExists()</code></li><li>Set <code>CreatesSatisfied</code> accordingly</li></ol><p><strong>State Fields:</strong></p><table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody><tr><td><code>Protocol</code></td><td><code>io.choria.ccm.v1.resource.exec.state</code></td></tr><tr><td><code>ResourceType</code></td><td><code>exec</code></td></tr><tr><td><code>Name</code></td><td>Resource name</td></tr><tr><td><code>Ensure</code></td><td><code>present</code> (always)</td></tr><tr><td><code>CreatesSatisfied</code></td><td><code>true</code> if <code>Creates</code> file exists</td></tr></tbody></table><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The exec resource achieves idempotency through multiple mechanisms:</p><h3 id=creates-file>Creates File<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>If <code>creates</code> is specified and the file exists, the command does not run:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/usr/bin/tar -xzf app.tar.gz</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>creates</span>: <span style=color:#ae81ff>/opt/app/bin/app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>cwd</span>: <span style=color:#ae81ff>/opt</span></span></span></code></pre></div><h3 id=refreshonly-mode>RefreshOnly Mode<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>When <code>refreshonly: true</code>, the command only runs when triggered by a subscribed resource:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>systemctl reload httpd</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>refreshonly</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subscribe</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>file#/etc/httpd/conf/httpd.conf</span></span></span></code></pre></div><h3 id=exit-code-validation>Exit Code Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>returns</code> property specifies acceptable exit codes (default: <code>[0]</code>):</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/opt/app/healthcheck</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>returns</span>: [<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>]  <span style=color:#75715e># 0=healthy, 1=degraded, 2=warning</span></span></span></code></pre></div><h2 id=decision-flow>Decision Flow<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Should resource be applied?             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Subscribe triggered?                     â”‚
â”‚ (subscribed resource changed)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ Yes           â”‚ No
              â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Execute command â”‚   â”‚ Creates satisfied? â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ Yes               â”‚ No
                      â–¼                   â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Skip (stable) â”‚   â”‚ RefreshOnly mode? â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ Yes               â”‚ No
                                  â–¼                   â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ Skip (stable) â”‚   â”‚ Execute       â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><h2 id=properties-validation>Properties Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The model validates exec properties before execution:</p><table><thead><tr><th>Property</th><th>Validation</th></tr></thead><tbody><tr><td><code>name</code></td><td>Must be parseable by shellquote (balanced quotes)</td></tr><tr><td><code>timeout</code></td><td>Must be valid duration format (e.g., <code>30s</code>, <code>5m</code>)</td></tr><tr><td><code>subscribe</code></td><td>Each entry must be <code>type#name</code> format</td></tr><tr><td><code>path</code></td><td>Each directory must be absolute (start with <code>/</code>)</td></tr><tr><td><code>environment</code></td><td>Each entry must be <code>KEY=VALUE</code> format with non-empty key and value</td></tr></tbody></table><h2 id=platform-support>Platform Support<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The Posix provider works on all platforms supported by Go&rsquo;s <code>os/exec</code> package. It does not use any platform-specific system calls directly.</p><p>The command runner (<code>model.CommandRunner</code>) handles the actual process execution, which may have platform-specific implementations.</p><h2 id=security-considerations>Security Considerations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=no-shell-injection>No Shell Injection<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Unlike the shell provider, the posix provider does not invoke a shell. Arguments are passed directly to the executable, preventing shell injection attacks:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Safe with posix provider - $USER is passed literally, not expanded</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/bin/echo $USER</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>posix </span> <span style=color:#75715e># Default</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Potentially dangerous with shell provider - $USER is expanded</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/bin/echo $USER</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span></span></span></code></pre></div><h3 id=path-validation>Path Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>path</code> property only accepts absolute directory paths, preventing path traversal via relative paths.</p><h3 id=environment-validation>Environment Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Environment variables must have non-empty keys and values, preventing injection of empty or malformed entries.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=shell-provider>Shell Provider</h1><p>This document describes the implementation details of the Shell exec provider for executing commands via <code>/bin/sh</code>.</p><h2 id=provider-selection>Provider Selection<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The Shell provider is selected when <code>provider: shell</code> is explicitly specified in the resource properties. It has a lower priority (99) than the Posix provider (1), so it is never automatically selected.</p><p><strong>Availability:</strong> The provider checks for the existence of <code>/bin/sh</code> via <code>util.FileExists()</code>. If <code>/bin/sh</code> does not exist, the provider is not available.</p><h2 id=comparison-with-posix-provider>Comparison with Posix Provider<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Feature</th><th>Shell</th><th>Posix</th></tr></thead><tbody><tr><td>Shell invocation</td><td>Yes (<code>/bin/sh -c</code>)</td><td>No</td></tr><tr><td>Pipes (<code>|</code>)</td><td>Supported</td><td>Not supported</td></tr><tr><td>Redirections (<code>></code>, <code>&lt;</code>, <code>>></code>)</td><td>Supported</td><td>Not supported</td></tr><tr><td>Shell builtins (<code>cd</code>, <code>export</code>, <code>source</code>)</td><td>Supported</td><td>Not supported</td></tr><tr><td>Glob expansion (<code>*.txt</code>, <code>?</code>)</td><td>Supported</td><td>Not supported</td></tr><tr><td>Command substitution (<code>$(...)</code>, <code>`...`</code>)</td><td>Supported</td><td>Not supported</td></tr><tr><td>Variable expansion (<code>$VAR</code>, <code>${VAR}</code>)</td><td>Supported</td><td>Not supported</td></tr><tr><td>Logical operators (<code>&&</code>, <code>||</code>)</td><td>Supported</td><td>Not supported</td></tr><tr><td>Argument parsing</td><td>Passed as single string</td><td><code>shellquote.Split()</code></td></tr><tr><td>Security</td><td>Shell injection possible</td><td>Lower attack surface</td></tr></tbody></table><p><strong>When to use Shell:</strong></p><ul><li>Commands with pipes: <code>cat file.txt | grep pattern | sort</code></li><li>Commands with redirections: <code>echo "data" > /tmp/file</code></li><li>Commands with shell builtins: <code>cd /tmp && pwd</code></li><li>Commands with variable expansion: <code>echo $HOME</code></li><li>Complex one-liners with logical operators</li></ul><p><strong>When to use Posix (default):</strong></p><ul><li>Simple commands with arguments</li><li>When shell features are not needed</li><li>For better security (no shell injection risk)</li></ul><h2 id=operations>Operations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=execute>Execute<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Determine command source (<code>Command</code> property or <code>Name</code> if <code>Command</code> is empty)</li><li>Validate command is not empty</li><li>Execute via <code>CommandRunner.ExecuteWithOptions()</code> with <code>/bin/sh -c "&lt;command>"</code></li><li>Optionally log output line-by-line if <code>LogOutput</code> is enabled</li></ol><p><strong>Execution Method:</strong></p><p>The entire command string is passed to the shell as a single argument:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>/bin/sh -c &#34;&lt;entire command string&gt;&#34;</code></pre></div><p>This allows the shell to interpret all shell syntax, including:</p><ul><li>Pipes and redirections</li><li>Variable expansion</li><li>Glob patterns</li><li>Command substitution</li><li>Logical operators</li></ul><p><strong>Execution Options:</strong></p><table><thead><tr><th>Option</th><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>Command</code></td><td><code>/bin/sh</code></td><td>Shell executable path</td></tr><tr><td><code>Args</code></td><td><code>["-c", "&lt;command>"]</code></td><td>Shell flag and command string</td></tr><tr><td><code>Cwd</code></td><td><code>properties.Cwd</code></td><td>Working directory</td></tr><tr><td><code>Environment</code></td><td><code>properties.Environment</code></td><td>Additional env vars (<code>KEY=VALUE</code> format)</td></tr><tr><td><code>Path</code></td><td><code>properties.Path</code></td><td>Search path for executables</td></tr><tr><td><code>Timeout</code></td><td><code>properties.ParsedTimeout</code></td><td>Maximum execution time</td></tr></tbody></table><p><strong>Output Logging:</strong></p><p>When <code>LogOutput: true</code> is set and a user logger is provided:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>scanner</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>NewScanner</span>(<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>stdout</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>Scan</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#a6e22e>scanner</span>.<span style=color:#a6e22e>Text</span>())
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Each line of stdout is logged as a separate <code>Info</code> message.</p><p><strong>Error Handling:</strong></p><table><thead><tr><th>Condition</th><th>Behavior</th></tr></thead><tbody><tr><td>Empty command string</td><td>Return error: &ldquo;no command to execute&rdquo;</td></tr><tr><td>Runner not configured</td><td>Return error: &ldquo;no command runner configured&rdquo;</td></tr><tr><td>Shell not found</td><td>Provider not available (checked at selection time)</td></tr><tr><td>Command execution fails</td><td>Return error from runner</td></tr><tr><td>Non-zero exit code</td><td>Return exit code (not an error by itself)</td></tr></tbody></table><h3 id=status>Status<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Create state with <code>EnsurePresent</code> (exec resources are always &ldquo;present&rdquo;)</li><li>Check if <code>Creates</code> file exists via <code>util.FileExists()</code></li><li>Set <code>CreatesSatisfied</code> accordingly</li></ol><p><strong>State Fields:</strong></p><table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody><tr><td><code>Protocol</code></td><td><code>io.choria.ccm.v1.resource.exec.state</code></td></tr><tr><td><code>ResourceType</code></td><td><code>exec</code></td></tr><tr><td><code>Name</code></td><td>Resource name</td></tr><tr><td><code>Ensure</code></td><td><code>present</code> (always)</td></tr><tr><td><code>CreatesSatisfied</code></td><td><code>true</code> if <code>Creates</code> file exists</td></tr></tbody></table><h2 id=use-cases>Use Cases<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=pipes-and-filters>Pipes and Filters<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>filter-logs</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>cat /var/log/app.log | grep ERROR | tail -100 &gt; /tmp/errors.txt</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>creates</span>: <span style=color:#ae81ff>/tmp/errors.txt</span></span></span></code></pre></div><h3 id=conditional-execution>Conditional Execution<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>ensure-running</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>pgrep myapp || /opt/myapp/bin/start</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span></span></span></code></pre></div><h3 id=complex-scripts>Complex Scripts<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>deploy-app</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          cd /opt/app &amp;&amp;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          git pull origin main &amp;&amp;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          npm install &amp;&amp;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          npm run build &amp;&amp;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          systemctl restart app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>5m</span></span></span></code></pre></div><h3 id=variable-expansion>Variable Expansion<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>backup-home</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>tar -czf /backup/home-$(date +%Y%m%d).tar.gz $HOME</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span></span></span></code></pre></div><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The shell provider uses the same idempotency mechanisms as the posix provider:</p><h3 id=creates-file>Creates File<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>If <code>creates</code> is specified and the file exists, the command does not run:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>extract-archive</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>cd /opt &amp;&amp; tar -xzf /tmp/app.tar.gz</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>creates</span>: <span style=color:#ae81ff>/opt/app/bin/app</span></span></span></code></pre></div><h3 id=refreshonly-mode>RefreshOnly Mode<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>When <code>refreshonly: true</code>, the command only runs when triggered by a subscribed resource:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>reload-nginx</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>nginx -t &amp;&amp; systemctl reload nginx</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>refreshonly</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subscribe</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>file#/etc/nginx/nginx.conf</span></span></span></code></pre></div><h3 id=exit-code-validation>Exit Code Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>returns</code> property specifies acceptable exit codes (default: <code>[0]</code>):</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>check-service</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>systemctl is-active myapp || true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>returns</span>: [<span style=color:#ae81ff>0</span>]</span></span></code></pre></div><h2 id=security-considerations>Security Considerations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=shell-injection-risk>Shell Injection Risk<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The shell provider passes the command string directly to <code>/bin/sh</code>, making it vulnerable to shell injection if user input is incorporated:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># DANGEROUS if filename comes from untrusted input</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>process-file</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>cat {{ user_provided_filename }} | process</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span></span></span></code></pre></div><p><strong>Mitigations:</strong></p><ul><li>Validate and sanitize any templated values</li><li>Use the posix provider when shell features aren&rsquo;t needed</li><li>Prefer explicit file paths over user-provided values</li></ul><h3 id=environment-variable-exposure>Environment Variable Exposure<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Shell commands can access environment variables, including sensitive ones:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># $SECRET_KEY will be expanded by the shell</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>use-secret</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>myapp --key=$SECRET_KEY</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span></span></span></code></pre></div><p>Consider using the <code>environment</code> property to explicitly pass required variables rather than relying on inherited environment.</p><h3 id=command-logging>Command Logging<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The full command string (including any expanded variables) may appear in logs. Avoid embedding secrets directly in commands:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># BAD - password visible in logs</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>bad-example</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>mysql -p&#39;secret123&#39; -e &#39;SELECT 1&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># BETTER - use environment variable</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>better-example</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>: <span style=color:#ae81ff>mysql -p&#34;$MYSQL_PWD&#34; -e &#39;SELECT 1&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>shell</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>MYSQL_PWD={{ lookup(&#39;data.mysql_password&#39;) }}</span></span></span></code></pre></div><h2 id=platform-support>Platform Support<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The shell provider requires <code>/bin/sh</code> to be available. This is standard on:</p><ul><li>Linux distributions</li><li>macOS</li><li>BSD variants</li><li>Most Unix-like systems</li></ul><p>On Windows, the provider will not be available unless <code>/bin/sh</code> exists (e.g., via WSL or Cygwin).</p><h2 id=shell-compatibility>Shell Compatibility<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The provider uses <code>/bin/sh</code>, which is typically:</p><ul><li><strong>Linux:</strong> Often a symlink to <code>bash</code>, <code>dash</code>, or another POSIX-compliant shell</li><li><strong>macOS:</strong> <code>/bin/sh</code> is <code>bash</code> (older) or <code>zsh</code> (newer) in POSIX mode</li><li><strong>BSD:</strong> Usually <code>ash</code> or similar</li></ul><p>For maximum portability, use POSIX shell syntax and avoid bash-specific features like:</p><ul><li>Arrays (<code>arr=(1 2 3)</code>)</li><li><code>[[</code> conditionals (use <code>[</code> instead)</li><li><code>source</code> (use <code>.</code> instead)</li><li>Process substitution (<code>&lt;(command)</code>)</li></ul><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=file-type>File Type</h1><p>This document describes the design of the file resource type for managing files and directories.</p><h2 id=overview>Overview<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The file resource manages files and directories with three aspects:</p><ul><li><strong>Existence</strong>: Whether the file/directory exists or is absent</li><li><strong>Content</strong>: The contents of a file (from inline content or source file)</li><li><strong>Attributes</strong>: Owner, group, and permissions</li></ul><h2 id=provider-interface>Provider Interface<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>File providers must implement the <code>FileProvider</code> interface:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FileProvider</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Provider</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CreateDirectory</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>dir</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>owner</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>group</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>mode</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>file</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>contents</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>source</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>owner</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>group</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>mode</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Status</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>file</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>FileState</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=method-responsibilities>Method Responsibilities<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Method</th><th>Responsibility</th></tr></thead><tbody><tr><td><code>Status</code></td><td>Query current file state (existence, type, content hash, attributes)</td></tr><tr><td><code>Store</code></td><td>Create or update a file with content and attributes</td></tr><tr><td><code>CreateDirectory</code></td><td>Create a directory with attributes</td></tr></tbody></table><h3 id=status-response>Status Response<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>Status</code> method returns a <code>FileState</code> containing:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FileState</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CommonResourceState</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Metadata</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>FileMetadata</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FileMetadata</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>     <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// File path</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Checksum</span> <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// SHA256 hash of contents (files only)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Owner</span>    <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Owner username</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Group</span>    <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Group name</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Mode</span>     <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Permissions in octal (e.g., &#34;0644&#34;)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Provider</span> <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Provider name (e.g., &#34;posix&#34;)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MTime</span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>      <span style=color:#75715e>// Modification time</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Size</span>     <span style=color:#66d9ef>int64</span>          <span style=color:#75715e>// File size in bytes</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Extended</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>any</span> <span style=color:#75715e>// Provider-specific metadata</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>The <code>Ensure</code> field in <code>CommonResourceState</code> is set to:</p><ul><li><code>present</code> if a regular file exists</li><li><code>directory</code> if a directory exists</li><li><code>absent</code> if the path does not exist</li></ul><h2 id=available-providers>Available Providers<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Provider</th><th>Platform</th><th>Documentation</th></tr></thead><tbody><tr><td><code>posix</code></td><td>Unix/Linux</td><td><a href=/design/file/posix/index.html>Posix</a></td></tr></tbody></table><h2 id=ensure-states>Ensure States<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>present</code></td><td>Path must be a regular file with specified content</td></tr><tr><td><code>absent</code></td><td>Path must not exist</td></tr><tr><td><code>directory</code></td><td>Path must be a directory</td></tr></tbody></table><h2 id=content-sources>Content Sources<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Files can receive content from two mutually exclusive sources:</p><table><thead><tr><th>Property</th><th>Description</th></tr></thead><tbody><tr><td><code>contents</code></td><td>Inline string content (template-resolved)</td></tr><tr><td><code>source</code></td><td>Path to local file to copy from</td></tr></tbody></table><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Inline content with template</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/etc/motd</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>content</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          Welcome to {{ lookup(&#39;facts.hostname&#39;) }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          Managed by CCM</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>mode</span>: <span style=color:#e6db74>&#34;0644&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Copy from source file</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/etc/app/config.yaml</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>source</span>: <span style=color:#ae81ff>files/config.yaml</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>app</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>mode</span>: <span style=color:#e6db74>&#34;0640&#34;</span></span></span></code></pre></div><p>When using <code>source</code>, the path is relative to the manifest&rsquo;s working directory if one is set.</p><h2 id=required-properties>Required Properties<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Unlike some resources, file resources require explicit attributes:</p><table><thead><tr><th>Property</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>owner</code></td><td>Yes</td><td>Username that owns the file</td></tr><tr><td><code>group</code></td><td>Yes</td><td>Group that owns the file</td></tr><tr><td><code>mode</code></td><td>Yes</td><td>Permissions in octal notation</td></tr></tbody></table><p>This prevents accidental creation of files with default or inherited permissions.</p><h2 id=apply-logic>Apply Logic<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Get current state via Status()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Is current state desired state?         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              Yes â”‚         No
                  â–¼         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
          â”‚ No change â”‚     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ What is desired ensure? â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ absent                â”‚ directory             â”‚ present
    â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Remove     â”‚      â”‚ CreateDir     â”‚      â”‚ Store         â”‚
â”‚ (os.Remove)â”‚      â”‚               â”‚      â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The file resource checks multiple attributes for idempotency:</p><h3 id=state-checks-in-order>State Checks (in order)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><ol><li><strong>Ensure match</strong>: Current type matches desired (<code>present</code>/<code>absent</code>/<code>directory</code>)</li><li><strong>Content match</strong>: SHA256 checksum of contents matches (for <code>ensure: present</code>)</li><li><strong>Owner match</strong>: Current owner matches desired</li><li><strong>Group match</strong>: Current group matches desired</li><li><strong>Mode match</strong>: Current permissions match desired</li></ol><h3 id=decision-table>Decision Table<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Desired</th><th>Current State</th><th>Action</th></tr></thead><tbody><tr><td><code>absent</code></td><td>absent</td><td>None</td></tr><tr><td><code>absent</code></td><td>present/directory</td><td>Remove</td></tr><tr><td><code>directory</code></td><td>directory + matching attrs</td><td>None</td></tr><tr><td><code>directory</code></td><td>absent/present</td><td>CreateDirectory</td></tr><tr><td><code>directory</code></td><td>directory + wrong attrs</td><td>CreateDirectory (updates attrs)</td></tr><tr><td><code>present</code></td><td>present + matching all</td><td>None</td></tr><tr><td><code>present</code></td><td>absent</td><td>Store</td></tr><tr><td><code>present</code></td><td>present + wrong content</td><td>Store</td></tr><tr><td><code>present</code></td><td>present + wrong attrs</td><td>Store</td></tr></tbody></table><h3 id=content-comparison>Content Comparison<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Content is compared using SHA256 checksums:</p><table><thead><tr><th>Source</th><th>Checksum Method</th></tr></thead><tbody><tr><td><code>contents</code> property</td><td><code>Sha256HashBytes([]byte(contents))</code></td></tr><tr><td><code>source</code> property</td><td><code>Sha256HashFile(adjustedPath)</code></td></tr><tr><td>Existing file</td><td><code>Sha256HashFile(filePath)</code></td></tr></tbody></table><h2 id=mode-validation>Mode Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>File modes are validated during resource creation:</p><p><strong>Valid Formats:</strong></p><ul><li><code>"0644"</code> - Standard octal</li><li><code>"644"</code> - Without leading zero</li><li><code>"0o755"</code> - With <code>0o</code> prefix</li><li><code>"0O700"</code> - With <code>0O</code> prefix</li></ul><p><strong>Validation Rules:</strong></p><ul><li>Must be valid octal number (digits 0-7)</li><li>Must be â‰¤ <code>0777</code> (no setuid/setgid/sticky via mode)</li></ul><h2 id=path-validation>Path Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>File paths must be:</p><ul><li>Absolute (start with <code>/</code>)</li><li>Clean (no <code>.</code> or <code>..</code> components, <code>filepath.Clean(path) == path</code>)</li></ul><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Clean</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Name</span>) <span style=color:#f92672>!=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Name</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;file path must be absolute&#34;</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h2 id=working-directory>Working Directory<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>When a manifest has a working directory (e.g., extracted from an archive), the <code>source</code> property is resolved relative to it:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Source</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>mgr</span>.<span style=color:#a6e22e>WorkingDirectory</span>() <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>source</span> = <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>mgr</span>.<span style=color:#a6e22e>WorkingDirectory</span>(), <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Source</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>This allows manifests bundled with their source files to use relative paths.</p><h2 id=noop-mode>Noop Mode<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>In noop mode, the file type:</p><ol><li>Queries current state normally</li><li>Computes content checksums</li><li>Logs what actions would be taken</li><li>Sets appropriate <code>NoopMessage</code>:<ul><li>&ldquo;Would have created the file&rdquo;</li><li>&ldquo;Would have created directory&rdquo;</li><li>&ldquo;Would have removed the file&rdquo;</li></ul></li><li>Reports <code>Changed: true</code> if changes would occur</li><li>Does not call provider Store/CreateDirectory methods</li><li>Does not remove files</li></ol><h2 id=desired-state-validation>Desired State Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>After applying changes (in non-noop mode), the type verifies the file reached the desired state by calling <code>Status()</code> again and checking all attributes match. If validation fails, <code>ErrDesiredStateFailed</code> is returned.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of File Type</h1><article class=default><header class=headline></header><h1 id=posix-provider>Posix Provider</h1><p>This document describes the implementation details of the Posix file provider for managing files and directories on Unix-like systems.</p><h2 id=provider-selection>Provider Selection<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The Posix provider is the default and only file provider. It is always available and returns priority 1 for all file resources.</p><h2 id=operations>Operations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=store-createupdate-file>Store (Create/Update File)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Verify parent directory exists</li><li>Parse file mode from octal string</li><li>Open source file if <code>source</code> property is set</li><li>Create temporary file in the same directory as target</li><li>Set file permissions on temp file</li><li>Write content (from <code>source</code> file or <code>contents</code> property)</li><li>Set ownership (chown) on temp file</li><li>Close temp file</li><li>Atomic rename temp file to target path</li></ol><p><strong>Atomic Write Pattern:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>[parent dir]/&lt;basename&gt;.* (temp file)
    â†“ chmod (set permissions)
    â†“ write content
    â†“ chown (set owner/group)
    â†“ close
    â†“ rename
[parent dir]/&lt;basename&gt; (final file)</code></pre></div><p>The temp file is created in the same directory as the target to ensure <code>os.Rename()</code> is atomic (same filesystem).</p><p><strong>Content Sources:</strong></p><table><thead><tr><th>Property</th><th>Behavior</th></tr></thead><tbody><tr><td><code>contents</code></td><td>Write string directly to file (template-resolved)</td></tr><tr><td><code>source</code></td><td>Copy from local file path (adjusted for working directory)</td></tr></tbody></table><p>If both are empty, an empty file is created.</p><p><strong>Error Handling:</strong></p><table><thead><tr><th>Condition</th><th>Behavior</th></tr></thead><tbody><tr><td>Parent directory doesn&rsquo;t exist</td><td>Return error: &ldquo;is not a directory&rdquo;</td></tr><tr><td>Invalid mode format</td><td>Return error from <code>strconv.ParseUint</code></td></tr><tr><td>Source file not found</td><td>Return error from <code>os.Open</code></td></tr><tr><td>Permission denied</td><td>Return error from underlying syscall</td></tr><tr><td>Rename failure</td><td>Return error: &ldquo;could not rename temporary file&rdquo;</td></tr></tbody></table><h3 id=createdirectory>CreateDirectory<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Parse file mode from octal string</li><li>Create directory and parents via <code>os.MkdirAll()</code></li><li>Lookup numeric UID/GID from owner/group names</li><li>Set permissions via <code>os.Chmod()</code> (ensures correct mode even if umask affected MkdirAll)</li><li>Set ownership via <code>os.Chown()</code></li></ol><p><strong>Command Sequence:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>MkdirAll</span>(<span style=color:#a6e22e>dir</span>, <span style=color:#a6e22e>parsedMode</span>)    <span style=color:#75715e>// Create directory tree</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Chmod</span>(<span style=color:#a6e22e>dir</span>, <span style=color:#a6e22e>parsedMode</span>)        <span style=color:#75715e>// Ensure correct permissions</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Chown</span>(<span style=color:#a6e22e>dir</span>, <span style=color:#a6e22e>uid</span>, <span style=color:#a6e22e>gid</span>)          <span style=color:#75715e>// Set ownership</span></span></span></code></pre></div><p>The explicit <code>Chmod</code> after <code>MkdirAll</code> is necessary because <code>MkdirAll</code> applies the process umask to the mode.</p><h3 id=status>Status<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Process:</strong></p><ol><li>Initialize state with default metadata</li><li>Call <code>os.Stat()</code> on file path</li><li>Based on result, populate state accordingly</li></ol><p><strong>State Detection:</strong></p><table><thead><tr><th><code>os.Stat()</code> Result</th><th>Ensure Value</th><th>Metadata</th></tr></thead><tbody><tr><td>File exists</td><td><code>present</code></td><td>Size, mtime, owner, group, mode, checksum</td></tr><tr><td>Directory exists</td><td><code>directory</code></td><td>Size, mtime, owner, group, mode</td></tr><tr><td><code>os.ErrNotExist</code></td><td><code>absent</code></td><td>None</td></tr><tr><td><code>os.ErrPermission</code></td><td><code>absent</code></td><td>None (logged as warning)</td></tr><tr><td>Other error</td><td>(unchanged)</td><td>None (logged as warning)</td></tr></tbody></table><p><strong>Metadata Collection:</strong></p><table><thead><tr><th>Field</th><th>Source</th></tr></thead><tbody><tr><td><code>Name</code></td><td>From properties</td></tr><tr><td><code>Provider</code></td><td>&ldquo;posix&rdquo;</td></tr><tr><td><code>Size</code></td><td><code>FileInfo.Size()</code></td></tr><tr><td><code>MTime</code></td><td><code>FileInfo.ModTime()</code></td></tr><tr><td><code>Owner</code></td><td><code>util.GetFileOwner()</code> - resolves UID to username</td></tr><tr><td><code>Group</code></td><td><code>util.GetFileOwner()</code> - resolves GID to group name</td></tr><tr><td><code>Mode</code></td><td><code>util.GetFileOwner()</code> - octal string (e.g., &ldquo;0644&rdquo;)</td></tr><tr><td><code>Checksum</code></td><td><code>util.Sha256HashFile()</code> - SHA256 hash (files only)</td></tr></tbody></table><p><strong>Note:</strong> Checksum is only calculated for regular files, not directories.</p><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The file resource achieves idempotency by comparing current state against desired state:</p><h3 id=state-checks>State Checks<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>isDesiredState()</code> function checks (in order):</p><ol><li><strong>Ensure value matches</strong> - <code>present</code>, <code>absent</code>, or <code>directory</code></li><li><strong>Content checksum matches</strong> - SHA256 of contents vs existing file (for files only)</li><li><strong>Owner matches</strong> - Username comparison</li><li><strong>Group matches</strong> - Group name comparison</li><li><strong>Mode matches</strong> - Octal permission string comparison</li></ol><h3 id=decision-flow>Decision Flow<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ What is the desired ensure state?       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ absent      â”‚ directory   â”‚ present     â”‚
    â–¼             â–¼             â–¼             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ File      â”‚ â”‚ Directory â”‚ â”‚ File exists?  â”‚ â”‚
â”‚ exists?   â”‚ â”‚ exists?   â”‚ â”‚ Content match?â”‚ â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚ Owner match?  â”‚ â”‚
      â”‚             â”‚       â”‚ Group match?  â”‚ â”‚
  Yes â”‚ No      Yes â”‚ No    â”‚ Mode match?   â”‚ â”‚
      â–¼             â–¼       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚         â”‚
â”‚ Remove  â”‚ â”‚ Stable    â”‚     All Yesâ”‚    No   â”‚
â”‚ file    â”‚ â”‚           â”‚           â–¼         â–¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ Stable    â”‚ â”‚ Store     â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><h3 id=content-comparison>Content Comparison<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>For files with <code>ensure: present</code>:</p><table><thead><tr><th>Content Source</th><th>Checksum Calculation</th></tr></thead><tbody><tr><td><code>contents</code> property</td><td><code>Sha256HashBytes([]byte(contents))</code></td></tr><tr><td><code>source</code> property</td><td><code>Sha256HashFile(adjustedSourcePath)</code></td></tr></tbody></table><p>The source path is adjusted based on the manager&rsquo;s working directory when set.</p><h2 id=mode-validation>Mode Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>File modes are validated during resource creation:</p><ol><li>Strip optional <code>0o</code> or <code>0O</code> prefix</li><li>Parse as octal number (base 8)</li><li>Validate range: must be â‰¤ <code>0777</code></li></ol><p><strong>Valid Mode Examples:</strong></p><table><thead><tr><th>Input</th><th>Parsed Value</th></tr></thead><tbody><tr><td><code>"0644"</code></td><td>0o644</td></tr><tr><td><code>"644"</code></td><td>0o644</td></tr><tr><td><code>"0o755"</code></td><td>0o755</td></tr><tr><td><code>"0O700"</code></td><td>0o700</td></tr></tbody></table><p><strong>Invalid Mode Examples:</strong></p><table><thead><tr><th>Input</th><th>Error</th></tr></thead><tbody><tr><td><code>"0888"</code></td><td>Invalid octal digit</td></tr><tr><td><code>"1777"</code></td><td>Exceeds maximum (setuid/setgid not supported via mode)</td></tr><tr><td><code>"rw-r--r--"</code></td><td>Not octal format</td></tr></tbody></table><h2 id=ownership-resolution>Ownership Resolution<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Owner and group names are resolved to numeric UID/GID via:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>uid</span>, <span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>util</span>.<span style=color:#a6e22e>LookupOwnerGroup</span>(<span style=color:#a6e22e>owner</span>, <span style=color:#a6e22e>group</span>)</span></span></code></pre></div><p>This uses the system&rsquo;s user database (<code>/etc/passwd</code>, <code>/etc/group</code>, or equivalent):</p><ul><li><code>user.Lookup(owner)</code> â†’ UID</li><li><code>user.LookupGroup(group)</code> â†’ GID</li></ul><p><strong>Error Handling:</strong></p><table><thead><tr><th>Condition</th><th>Behavior</th></tr></thead><tbody><tr><td>User not found</td><td>Return error: &ldquo;could not lookup user&rdquo;</td></tr><tr><td>Group not found</td><td>Return error: &ldquo;could not lookup group&rdquo;</td></tr><tr><td>Invalid UID/GID format</td><td>Return error from <code>strconv.Atoi</code></td></tr></tbody></table><h2 id=working-directory-support>Working Directory Support<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>When a manager has a working directory set (e.g., from extracted manifest), the <code>source</code> property path is adjusted:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Type</span>) <span style=color:#a6e22e>adjustedSource</span>(<span style=color:#a6e22e>properties</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>FileResourceProperties</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>source</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Source</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Source</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>mgr</span>.<span style=color:#a6e22e>WorkingDirectory</span>() <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>source</span> = <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>mgr</span>.<span style=color:#a6e22e>WorkingDirectory</span>(), <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Source</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>source</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>This allows manifests to use relative paths for source files bundled with the manifest.</p><h2 id=platform-support>Platform Support<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The Posix provider uses Unix-specific system calls:</p><table><thead><tr><th>Operation</th><th>System Call</th></tr></thead><tbody><tr><td>Get file owner/group</td><td><code>syscall.Stat_t</code> (UID/GID from stat)</td></tr><tr><td>Set ownership</td><td><code>os.Chown()</code> â†’ <code>chown(2)</code></td></tr><tr><td>Set permissions</td><td><code>os.Chmod()</code> â†’ <code>chmod(2)</code></td></tr></tbody></table><p>The provider has separate implementations for Unix and Windows (<code>file_unix.go</code>, <code>file_windows.go</code> in <code>internal/util</code>), with Windows returning errors for ownership operations.</p><h2 id=security-considerations>Security Considerations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=atomic-writes>Atomic Writes<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Files are written atomically via temp file + rename. This prevents:</p><ul><li>Partial file reads during write</li><li>Corruption if process is interrupted</li><li>Race conditions with concurrent readers</li></ul><h3 id=permission-ordering>Permission Ordering<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Permissions and ownership are set on the temp file before rename:</p><ol><li><code>Chmod</code> - Set permissions</li><li>Write content</li><li><code>Chown</code> - Set ownership</li><li>Rename to target</li></ol><p>This ensures the file never exists at the target path with incorrect permissions.</p><h3 id=path-validation>Path Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>File paths must be absolute and clean (no <code>.</code> or <code>..</code> components):</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Clean</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Name</span>) <span style=color:#f92672>!=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Name</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;file path must be absolute&#34;</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=required-properties>Required Properties<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Owner, group, and mode are required properties and cannot be empty, preventing accidental creation of files with default/inherited permissions.</p><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=package-type>Package Type</h1><p>This document describes the design of the package resource type for managing software packages.</p><h2 id=overview>Overview<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The package resource manages software packages with two aspects:</p><ul><li><strong>Existence</strong>: Whether the package is installed or absent</li><li><strong>Version</strong>: The specific version installed (when applicable)</li></ul><h2 id=provider-interface>Provider Interface<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Package providers must implement the <code>PackageProvider</code> interface:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PackageProvider</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Provider</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Install</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>pkg</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>version</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Upgrade</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>pkg</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>version</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Downgrade</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>pkg</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>version</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Uninstall</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>pkg</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Status</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>pkg</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>PackageState</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>VersionCmp</span>(<span style=color:#a6e22e>versionA</span>, <span style=color:#a6e22e>versionB</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>ignoreTrailingZeroes</span> <span style=color:#66d9ef>bool</span>) (<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=method-responsibilities>Method Responsibilities<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Method</th><th>Responsibility</th></tr></thead><tbody><tr><td><code>Status</code></td><td>Query current package state (installed version or absent)</td></tr><tr><td><code>Install</code></td><td>Install package at specified version (or latest if &ldquo;latest&rdquo;)</td></tr><tr><td><code>Upgrade</code></td><td>Upgrade package to specified version</td></tr><tr><td><code>Downgrade</code></td><td>Downgrade package to specified version</td></tr><tr><td><code>Uninstall</code></td><td>Remove the package</td></tr><tr><td><code>VersionCmp</code></td><td>Compare two version strings (-1, 0, 1)</td></tr></tbody></table><h3 id=status-response>Status Response<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>Status</code> method returns a <code>PackageState</code> containing:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PackageState</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CommonResourceState</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Metadata</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PackageMetadata</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PackageMetadata</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>        <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Package name</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Version</span>     <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Installed version</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Arch</span>        <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Architecture (e.g., &#34;x86_64&#34;)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>License</span>     <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Package license</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>URL</span>         <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Package URL</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Summary</span>     <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Short description</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Description</span> <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Full description</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Provider</span>    <span style=color:#66d9ef>string</span>         <span style=color:#75715e>// Provider name (e.g., &#34;dnf&#34;)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Extended</span>    <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>any</span> <span style=color:#75715e>// Provider-specific metadata</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>The <code>Ensure</code> field in <code>CommonResourceState</code> is set to:</p><ul><li>The installed version string if the package is installed</li><li><code>absent</code> if the package is not installed</li></ul><h2 id=available-providers>Available Providers<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Provider</th><th>Package Manager</th><th>Documentation</th></tr></thead><tbody><tr><td><code>dnf</code></td><td>DNF (Fedora/RHEL)</td><td><a href=/design/package/dnf/index.html>DNF</a></td></tr><tr><td><code>apt</code></td><td>APT (Debian/Ubuntu)</td><td><a href=/design/package/apt/index.html>APT</a></td></tr></tbody></table><h2 id=ensure-states>Ensure States<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>present</code></td><td>Package must be installed (any version)</td></tr><tr><td><code>absent</code></td><td>Package must not be installed</td></tr><tr><td><code>latest</code></td><td>Package must be upgraded to latest available</td></tr><tr><td><code>&lt;version></code></td><td>Package must be at specific version</td></tr></tbody></table><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Install any version</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>package</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>vim</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Install latest version</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>package</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>vim</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>latest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Install specific version</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>package</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>nginx</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#e6db74>&#34;1.24.0-1.el9&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Remove package</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>package</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>telnet</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>absent</span></span></span></code></pre></div><h2 id=apply-logic>Apply Logic<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=phase-1-handle-special-cases>Phase 1: Handle Special Cases<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Get current state via Status()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Is ensure = &#34;latest&#34;?                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              Yes â”‚         No
                  â–¼         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ Is package absent?  â”‚ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
              Yes â”‚     No  â”‚
                  â–¼     â–¼   â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚Install â”‚ â”‚Upgrade â”‚
          â”‚latest  â”‚ â”‚latest  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Is desired state met?   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        Yes â”‚         No
                            â–¼         â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
                    â”‚ No change â”‚     â–¼
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  (Phase 2)</code></pre></div><h3 id=phase-2-handle-ensure-values>Phase 2: Handle Ensure Values<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ What is desired ensure? â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ absent                â”‚ present               â”‚ &lt;version&gt;
    â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Uninstall  â”‚      â”‚ Is absent?    â”‚      â”‚ Is absent?    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                        Yes â”‚     No           Yes â”‚     No
                            â–¼     â–¼                â–¼     â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚Install â”‚ â”‚No      â”‚  â”‚Install â”‚ â”‚Compare     â”‚
                    â”‚        â”‚ â”‚change  â”‚  â”‚version â”‚ â”‚versions    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                            â”‚
                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                           â”‚ current &lt;      â”‚ current =      â”‚ current &gt;
                                           â–¼                â–¼                â–¼
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚ Upgrade   â”‚    â”‚ No change â”‚    â”‚ Downgrade â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><h2 id=version-comparison>Version Comparison<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The <code>VersionCmp</code> method compares two version strings:</p><table><thead><tr><th>Return Value</th><th>Meaning</th></tr></thead><tbody><tr><td><code>-1</code></td><td>versionA &lt; versionB (upgrade needed)</td></tr><tr><td><code>0</code></td><td>versionA == versionB (no change)</td></tr><tr><td><code>1</code></td><td>versionA > versionB (downgrade needed)</td></tr></tbody></table><p>Version comparison is delegated to the provider, allowing platform-specific version parsing (e.g., RPM epoch handling, Debian revision suffixes).</p><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The package resource is idempotent through state comparison:</p><h3 id=decision-table>Decision Table<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Desired</th><th>Current State</th><th>Action</th></tr></thead><tbody><tr><td><code>ensure: present</code></td><td>installed (any version)</td><td>None</td></tr><tr><td><code>ensure: present</code></td><td>absent</td><td>Install</td></tr><tr><td><code>ensure: absent</code></td><td>absent</td><td>None</td></tr><tr><td><code>ensure: absent</code></td><td>installed</td><td>Uninstall</td></tr><tr><td><code>ensure: latest</code></td><td>absent</td><td>Install latest</td></tr><tr><td><code>ensure: latest</code></td><td>installed</td><td>Upgrade (always runs)</td></tr><tr><td><code>ensure: &lt;version></code></td><td>same version</td><td>None</td></tr><tr><td><code>ensure: &lt;version></code></td><td>older version</td><td>Upgrade</td></tr><tr><td><code>ensure: &lt;version></code></td><td>newer version</td><td>Downgrade</td></tr><tr><td><code>ensure: &lt;version></code></td><td>absent</td><td>Install</td></tr></tbody></table><h3 id=special-case-ensure-latest>Special Case: <code>ensure: latest</code><span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>When <code>ensure: latest</code> is used:</p><ul><li>The package manager determines what &ldquo;latest&rdquo; means</li><li>Upgrade is always called when the package exists (package manager is idempotent)</li><li>The type cannot verify if &ldquo;latest&rdquo; was achieved (package managers may report stale data)</li><li>Desired state validation only checks that the package is not absent</li></ul><h2 id=package-name-validation>Package Name Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Package names are validated to prevent injection attacks:</p><p><strong>Allowed Characters:</strong></p><ul><li>Alphanumeric (<code>a-z</code>, <code>A-Z</code>, <code>0-9</code>)</li><li>Period (<code>.</code>), underscore (<code>_</code>), plus (<code>+</code>)</li><li>Colon (<code>:</code>), tilde (<code>~</code>), hyphen (<code>-</code>)</li></ul><p><strong>Rejected:</strong></p><ul><li>Shell metacharacters (<code>;</code>, <code>|</code>, <code>&</code>, <code>$</code>, etc.)</li><li>Whitespace</li><li>Quotes and backticks</li><li>Path separators</li></ul><p>Version strings (when ensure is a version) are also validated for dangerous characters.</p><h2 id=noop-mode>Noop Mode<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>In noop mode, the package type:</p><ol><li>Queries current state normally</li><li>Computes version comparison</li><li>Logs what actions would be taken</li><li>Sets appropriate <code>NoopMessage</code>:<ul><li>&ldquo;Would have installed latest&rdquo;</li><li>&ldquo;Would have upgraded to latest&rdquo;</li><li>&ldquo;Would have installed version X&rdquo;</li><li>&ldquo;Would have upgraded to X&rdquo;</li><li>&ldquo;Would have downgraded to X&rdquo;</li><li>&ldquo;Would have uninstalled&rdquo;</li></ul></li><li>Reports <code>Changed: true</code> if changes would occur</li><li>Does not call provider Install/Upgrade/Downgrade/Uninstall methods</li></ol><h2 id=desired-state-validation>Desired State Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>After applying changes (in non-noop mode), the type verifies the package reached the desired state:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Type</span>) <span style=color:#a6e22e>isDesiredState</span>(<span style=color:#a6e22e>properties</span>, <span style=color:#a6e22e>state</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Ensure</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;present&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Any installed version is acceptable</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Ensure</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;absent&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;absent&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Ensure</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;absent&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;latest&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Cannot verify &#34;latest&#34;, just check not absent</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Ensure</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;absent&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Specific version must match</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>VersionCmp</span>(<span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Ensure</span>, <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Ensure</span>, <span style=color:#66d9ef>false</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>If the desired state is not reached, an <code>ErrDesiredStateFailed</code> error is returned.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Package Type</h1><article class=default><header class=headline></header><h1 id=apt-provider>APT Provider</h1><p>This document describes the implementation details of the APT package provider for Debian-based systems.</p><h2 id=environment>Environment<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>All commands are executed with the following environment variables to ensure non-interactive operation:</p><table><thead><tr><th>Variable</th><th>Value</th><th>Purpose</th></tr></thead><tbody><tr><td><code>DEBIAN_FRONTEND</code></td><td><code>noninteractive</code></td><td>Prevents dpkg from prompting for user input</td></tr><tr><td><code>APT_LISTBUGS_FRONTEND</code></td><td><code>none</code></td><td>Suppresses apt-listbugs prompts</td></tr><tr><td><code>APT_LISTCHANGES_FRONTEND</code></td><td><code>none</code></td><td>Suppresses apt-listchanges prompts</td></tr></tbody></table><h2 id=concurrency>Concurrency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>A global package lock (<code>model.PackageGlobalLock</code>) is held during all command executions to prevent concurrent apt/dpkg operations within the same process. This prevents lock contention on <code>/var/lib/dpkg/lock</code>.</p><h2 id=operations>Operations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=status-check>Status Check<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>dpkg-query -W -f=&#39;${Package} ${Version} ${Architecture} ${db:Status-Status}&#39; &lt;package&gt;</code></pre></div><p><strong>Behavior:</strong></p><ul><li>Exit code 0 with <code>installed</code> status â†’ Package is present, returns version info</li><li>Exit code non-zero OR status not <code>installed</code> â†’ Package is absent</li></ul><p><strong>Package States:</strong>
The <code>db:Status-Status</code> field can return various values. Only <code>installed</code> is treated as present:</p><table><thead><tr><th>Status</th><th>Treated As</th><th>Description</th></tr></thead><tbody><tr><td><code>installed</code></td><td>Present</td><td>Package fully installed</td></tr><tr><td><code>config-files</code></td><td>Absent</td><td>Removed but config files remain</td></tr><tr><td><code>half-installed</code></td><td>Absent</td><td>Installation started but failed</td></tr><tr><td><code>half-configured</code></td><td>Absent</td><td>Configuration failed</td></tr><tr><td><code>unpacked</code></td><td>Absent</td><td>Unpacked but not configured</td></tr><tr><td><code>not-installed</code></td><td>Absent</td><td>Not installed</td></tr></tbody></table><p>Treating non-<code>installed</code> states as absent allows <code>apt-get install</code> to repair broken installations.</p><h3 id=install>Install<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Ensure Present:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>apt-get install -y -q -o DPkg::Options::=--force-confold &lt;package&gt;</code></pre></div><p><strong>Ensure Latest:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>apt-cache policy &lt;package&gt;                    # Get candidate version
apt-get install -y -q -o DPkg::Options::=--force-confold &lt;package&gt;=&lt;version&gt;</code></pre></div><p><strong>Specific Version:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>apt-get install -y -q -o DPkg::Options::=--force-confold --allow-downgrades &lt;package&gt;=&lt;version&gt;</code></pre></div><p><strong>Flags:</strong></p><table><thead><tr><th>Flag</th><th>Purpose</th></tr></thead><tbody><tr><td><code>-y</code></td><td>Assume yes to prompts</td></tr><tr><td><code>-q</code></td><td>Quiet output</td></tr><tr><td><code>-o DPkg::Options::=--force-confold</code></td><td>Keep existing config files on upgrade</td></tr><tr><td><code>--allow-downgrades</code></td><td>Allow installing older versions (specific version only)</td></tr></tbody></table><h3 id=upgrade>Upgrade<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Delegates to <code>Install()</code> with the target version. The <code>--allow-downgrades</code> flag is only added for specific version requests, not for <code>latest</code>.</p><h3 id=downgrade>Downgrade<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Delegates to <code>Install()</code> with the target version. The <code>--allow-downgrades</code> flag enables this operation.</p><h3 id=uninstall>Uninstall<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>apt-get -q -y remove &lt;package&gt;</code></pre></div><p><strong>Note:</strong> Uses <code>remove</code> not <code>purge</code>, so configuration files are preserved. A subsequent install will find existing config files.</p><h3 id=latest-available-version>Latest Available Version<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>apt-cache policy &lt;package&gt;</code></pre></div><p><strong>Parsing:</strong> Extracts the <code>Candidate:</code> line from output.</p><p><strong>Example output:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>zsh:
  Installed: 5.9-8+b18
  Candidate: 5.9-8+b18
  Version table:
 *** 5.9-8+b18 500
        500 http://deb.debian.org/debian trixie/main amd64 Packages
        100 /var/lib/dpkg/status</code></pre></div><h2 id=version-comparison>Version Comparison<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Version comparison follows the <a href=https://www.debian.org/doc/debian-policy/ch-controlfields.html#version rel=external>Debian Policy Manual</a> algorithm.</p><h3 id=version-format>Version Format<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>[epoch:]upstream_version[-debian_revision]</code></pre></div><table><thead><tr><th>Component</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>epoch</code></td><td>No</td><td>Integer, default 0. Higher epoch always wins.</td></tr><tr><td><code>upstream_version</code></td><td>Yes</td><td>The main version from upstream</td></tr><tr><td><code>debian_revision</code></td><td>No</td><td>Debian-specific revision</td></tr></tbody></table><p><strong>Examples:</strong></p><ul><li><code>1.0</code> â†’ epoch=0, upstream=1.0, revision=""</li><li><code>1:2.0-3</code> â†’ epoch=1, upstream=2.0, revision=3</li><li><code>2:1.0.0+git-20190109-0ubuntu2</code> â†’ epoch=2, upstream=1.0.0+git-20190109, revision=0ubuntu2</li></ul><h3 id=comparison-algorithm>Comparison Algorithm<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><ol><li><p><strong>Compare epochs numerically</strong> - Higher epoch wins regardless of other components</p></li><li><p><strong>Compare upstream_version and debian_revision</strong> using the Debian string comparison:</p><p>The string is processed left-to-right in segments:</p><p>a. <strong>Tildes (<code>~</code>)</strong> - Compared first. More tildes = earlier version. Tilde sorts before everything, even empty string.</p><ul><li><code>1.0~alpha</code> &lt; <code>1.0</code> (tilde before empty)</li><li><code>1.0~~</code> &lt; <code>1.0~</code> (more tildes = earlier)</li></ul><p>b. <strong>Letters (<code>A-Za-z</code>)</strong> - Compared lexically (ASCII order)</p><ul><li>Letters sort before non-letters</li></ul><p>c. <strong>Non-letters (<code>.</code>, <code>+</code>, <code>-</code>)</strong> - Compared lexically</p><p>d. <strong>Digits</strong> - Compared numerically (not lexically)</p><ul><li><code>9</code> &lt; <code>13</code> (numeric comparison)</li></ul><p>These steps repeat until a difference is found or both strings are exhausted.</p></li></ol><h3 id=comparison-examples>Comparison Examples<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>A</th><th>B</th><th>Result</th><th>Reason</th></tr></thead><tbody><tr><td><code>1.0</code></td><td><code>2.0</code></td><td>A &lt; B</td><td>Numeric comparison</td></tr><tr><td><code>1:1.0</code></td><td><code>2.0</code></td><td>A > B</td><td>Epoch 1 > epoch 0</td></tr><tr><td><code>1.0~alpha</code></td><td><code>1.0</code></td><td>A &lt; B</td><td>Tilde sorts before empty</td></tr><tr><td><code>1.0~alpha</code></td><td><code>1.0~beta</code></td><td>A &lt; B</td><td>Lexical: alpha &lt; beta</td></tr><tr><td><code>1.0.1</code></td><td><code>1.0.2</code></td><td>A &lt; B</td><td>Numeric: 1 &lt; 2</td></tr><tr><td><code>1.0-1</code></td><td><code>1.0-2</code></td><td>A &lt; B</td><td>Revision comparison</td></tr><tr><td><code>1.0a</code></td><td><code>1.0-</code></td><td>A &lt; B</td><td>Letters sort before non-letters</td></tr></tbody></table><h3 id=implementation>Implementation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The version comparison is implemented in <code>version.go</code>, ported from Puppet&rsquo;s <code>Puppet::Util::Package::Version::Debian</code> module. It provides:</p><ul><li><code>ParseVersion(string)</code> - Parse a version string into components</li><li><code>CompareVersionStrings(a, b)</code> - Compare two version strings directly</li><li><code>Version.Compare(other)</code> - Compare parsed versions (-1, 0, 1)</li><li>Helper methods: <code>LessThan</code>, <code>GreaterThan</code>, <code>Equal</code>, etc.</li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=dnf-provider>DNF Provider</h1><p>This document describes the implementation details of the DNF package provider for RHEL/Fedora-based systems.</p><h2 id=concurrency>Concurrency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>A global package lock (<code>model.PackageGlobalLock</code>) is held during all command executions to prevent concurrent dnf/rpm operations within the same process. This prevents lock contention on the RPM database.</p><h2 id=operations>Operations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=status-check>Status Check<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>rpm -q &lt;package&gt; --queryformat &#39;%{NAME} %|EPOCH?{%{EPOCH}}:{0}| %{VERSION} %{RELEASE} %{ARCH}&#39;</code></pre></div><p><strong>Query Format (NEVRA):</strong>
The query format extracts the full NEVRA (Name, Epoch, Version, Release, Architecture):</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>%{NAME}</code></td><td>Package name</td></tr><tr><td><code>%|EPOCH?{%{EPOCH}}:{0}|</code></td><td>Epoch (0 if not set)</td></tr><tr><td><code>%{VERSION}</code></td><td>Upstream version</td></tr><tr><td><code>%{RELEASE}</code></td><td>Release/build number</td></tr><tr><td><code>%{ARCH}</code></td><td>Architecture (x86_64, noarch, etc.)</td></tr></tbody></table><p><strong>Example output:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>zsh 0 5.8 9.el9 x86_64</code></pre></div><p><strong>Behavior:</strong></p><ul><li>Exit code 0 â†’ Package is present, parses NEVRA components</li><li>Exit code non-zero â†’ Package is absent</li></ul><p><strong>Returned Version Format:</strong>
The version returned combines VERSION and RELEASE: <code>5.8-9.el9</code></p><p>The epoch and release are stored separately in the <code>Extended</code> metadata.</p><h3 id=install>Install<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Ensure Present or Latest:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>dnf install -y &lt;package&gt;</code></pre></div><p><strong>Specific Version:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>dnf install -y &lt;package&gt;-&lt;version&gt;</code></pre></div><p><strong>Flags:</strong></p><table><thead><tr><th>Flag</th><th>Purpose</th></tr></thead><tbody><tr><td><code>-y</code></td><td>Assume yes to all prompts</td></tr></tbody></table><p><strong>Note:</strong> DNF uses <code>-</code> (hyphen) to separate package name from version, unlike APT which uses <code>=</code>.</p><h3 id=upgrade>Upgrade<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Delegates to <code>Install()</code>. DNF&rsquo;s install command handles upgrades automatically when a newer version is available or specified.</p><h3 id=downgrade>Downgrade<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>dnf downgrade -y &lt;package&gt;-&lt;version&gt;</code></pre></div><p><strong>Note:</strong> Unlike upgrade, downgrade uses a dedicated DNF command rather than delegating to install.</p><h3 id=uninstall>Uninstall<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>dnf remove -y &lt;package&gt;</code></pre></div><h2 id=version-format>Version Format<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>RPM versions follow the EVR (Epoch:Version-Release) format:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>[epoch:]version-release</code></pre></div><table><thead><tr><th>Component</th><th>Required</th><th>Description</th></tr></thead><tbody><tr><td><code>epoch</code></td><td>No</td><td>Integer, default 0. Higher epoch always wins.</td></tr><tr><td><code>version</code></td><td>Yes</td><td>Upstream version number</td></tr><tr><td><code>release</code></td><td>Yes</td><td>Distribution-specific release/build number</td></tr></tbody></table><p><strong>Examples:</strong></p><ul><li><code>5.8-9.el9</code> â†’ epoch=0, version=5.8, release=9.el9</li><li><code>1:2.0-3.fc39</code> â†’ epoch=1, version=2.0, release=3.fc39</li><li><code>0:1.0.0-1.el9</code> â†’ epoch=0 (explicit), version=1.0.0, release=1.el9</li></ul><h2 id=version-comparison>Version Comparison<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Version comparison uses a generic algorithm ported from Puppet, implemented in <code>internal/util.VersionCmp()</code>.</p><h3 id=algorithm>Algorithm<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The version string is tokenized into segments by splitting on <code>-</code>, <code>.</code>, digits, and non-digit sequences. Segments are compared left-to-right:</p><ol><li><strong>Hyphens (<code>-</code>)</strong> - A hyphen loses to any other character</li><li><strong>Dots (<code>.</code>)</strong> - A dot loses to any non-hyphen character</li><li><strong>Digit sequences</strong> - Compared numerically, except:<ul><li>Leading zeros trigger lexical comparison (<code>01</code> vs <code>1</code> compared as strings)</li></ul></li><li><strong>Non-digit sequences</strong> - Compared lexically (case-insensitive)</li></ol><p>If all segments match, falls back to whole-string comparison.</p><h3 id=trailing-zero-normalization>Trailing Zero Normalization<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>When <code>ignoreTrailingZeroes</code> is enabled, trailing <code>.0</code> segments before the first <code>-</code> are removed:</p><ul><li><code>1.0.0-rc1</code> â†’ <code>1-rc1</code></li><li><code>2.0.0</code> â†’ <code>2</code></li></ul><p>This allows <code>1.0.0</code> to equal <code>1.0</code> when the flag is set.</p><h3 id=comparison-examples>Comparison Examples<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>A</th><th>B</th><th>Result</th><th>Reason</th></tr></thead><tbody><tr><td><code>1.0</code></td><td><code>2.0</code></td><td>A &lt; B</td><td>Numeric: 1 &lt; 2</td></tr><tr><td><code>1.10</code></td><td><code>1.9</code></td><td>A > B</td><td>Numeric: 10 > 9</td></tr><tr><td><code>1.0</code></td><td><code>1.0.1</code></td><td>A &lt; B</td><td>A exhausted first</td></tr><tr><td><code>1.0-1</code></td><td><code>1.0-2</code></td><td>A &lt; B</td><td>Release comparison</td></tr><tr><td><code>1.0a</code></td><td><code>1.0b</code></td><td>A &lt; B</td><td>Lexical: a &lt; b</td></tr><tr><td><code>01</code></td><td><code>1</code></td><td>A &lt; B</td><td>Leading zero: lexical comparison</td></tr><tr><td><code>1.0.0</code></td><td><code>1.0</code></td><td>A > B</td><td>Without normalization</td></tr><tr><td><code>1.0.0</code></td><td><code>1.0</code></td><td>A = B</td><td>With <code>ignoreTrailingZeroes=true</code></td></tr></tbody></table><h3 id=implementation>Implementation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The version comparison is implemented in <code>internal/util/util.go</code> and provides:</p><ul><li><code>VersionCmp(a, b, ignoreTrailingZeroes)</code> - Compare two version strings</li><li>Returns -1 (a &lt; b), 0 (a == b), or 1 (a > b)</li></ul><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=service-type>Service Type</h1><p>This document describes the design of the service resource type for managing system services.</p><h2 id=overview>Overview<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The service resource manages system services with two independent dimensions:</p><ul><li><strong>Running state</strong>: Whether the service is currently running or stopped</li><li><strong>Enabled state</strong>: Whether the service starts automatically at boot</li></ul><p>These are managed independently, allowing combinations like &ldquo;running but disabled&rdquo; or &ldquo;stopped but enabled&rdquo;.</p><h2 id=provider-interface>Provider Interface<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Service providers must implement the <code>ServiceProvider</code> interface:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ServiceProvider</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Provider</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Enable</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Disable</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Stop</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Restart</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Status</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ServiceState</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h3 id=method-responsibilities>Method Responsibilities<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><table><thead><tr><th>Method</th><th>Responsibility</th></tr></thead><tbody><tr><td><code>Status</code></td><td>Query current running and enabled state</td></tr><tr><td><code>Start</code></td><td>Start the service if not running</td></tr><tr><td><code>Stop</code></td><td>Stop the service if running</td></tr><tr><td><code>Restart</code></td><td>Stop and start the service (for refresh)</td></tr><tr><td><code>Enable</code></td><td>Configure service to start at boot</td></tr><tr><td><code>Disable</code></td><td>Configure service to not start at boot</td></tr></tbody></table><h3 id=status-response>Status Response<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>The <code>Status</code> method returns a <code>ServiceState</code> containing:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ServiceState</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CommonResourceState</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Metadata</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceMetadata</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ServiceMetadata</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>     <span style=color:#66d9ef>string</span>  <span style=color:#75715e>// Service name</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Provider</span> <span style=color:#66d9ef>string</span>  <span style=color:#75715e>// Provider name (e.g., &#34;systemd&#34;)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Enabled</span>  <span style=color:#66d9ef>bool</span>    <span style=color:#75715e>// Whether service starts at boot</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Running</span>  <span style=color:#66d9ef>bool</span>    <span style=color:#75715e>// Whether service is currently running</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>The <code>Ensure</code> field in <code>CommonResourceState</code> is set to:</p><ul><li><code>running</code> if the service is active</li><li><code>stopped</code> if the service is inactive</li></ul><h2 id=available-providers>Available Providers<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Provider</th><th>Init System</th><th>Documentation</th></tr></thead><tbody><tr><td><code>systemd</code></td><td>systemd</td><td><a href=/design/service/systemd/index.html>Systemd</a></td></tr></tbody></table><h2 id=ensure-states>Ensure States<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody><tr><td><code>running</code></td><td>Service must be running (default)</td></tr><tr><td><code>stopped</code></td><td>Service must be stopped</td></tr></tbody></table><p>If <code>ensure</code> is not specified, it defaults to <code>running</code>.</p><h2 id=enable-property>Enable Property<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The <code>enable</code> property is a boolean pointer (<code>*bool</code>) with three possible states:</p><table><thead><tr><th>Value</th><th>Behavior</th></tr></thead><tbody><tr><td><code>true</code></td><td>Enable service to start at boot</td></tr><tr><td><code>false</code></td><td>Disable service from starting at boot</td></tr><tr><td><code>nil</code> (not set)</td><td>Leave boot configuration unchanged</td></tr></tbody></table><p>This allows managing running state without affecting boot configuration:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Start service but don&#39;t change boot config</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>myapp</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>running</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Start and enable at boot</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>myapp</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>running</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>enable</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Stop and disable at boot</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>myapp</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>stopped</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>enable</span>: <span style=color:#66d9ef>false</span></span></span></code></pre></div><h2 id=apply-logic>Apply Logic<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The service type applies changes in two phases:</p><h3 id=phase-1-running-state>Phase 1: Running State<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check for subscribe refresh             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Subscribed resource       â”‚
    â”‚ changed?                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              Yes â”‚         â”‚ No
                  â–¼         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ ensure=running?     â”‚ â”‚
    â”‚ already running?    â”‚ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
          Yes+Yes â”‚         â”‚
                  â–¼         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
          â”‚ Restart   â”‚     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Compare ensure vs state â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ensure=stopped        â”‚ ensure=running        â”‚
    â”‚ state=running         â”‚ state=stopped         â”‚
    â–¼                       â–¼                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚ Stop   â”‚            â”‚ Start  â”‚                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
                                                    â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚ No change     â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><h3 id=phase-2-enabled-state>Phase 2: Enabled State<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>After running state is handled, enabled state is processed:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ enable property set?                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
          nil     â”‚     true/false
          â–¼       â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚ No change â”‚   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Compare enable vs enabled   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ enable=true â”‚ enable=falseâ”‚
    â”‚ !enabled    â”‚ enabled     â”‚
    â–¼             â–¼             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ Enable â”‚  â”‚ Disable â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                                â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ No change     â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><h2 id=subscribe-behavior>Subscribe Behavior<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Services can subscribe to other resources and restart when they change:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>httpd</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>running</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subscribe</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>file#/etc/httpd/conf/httpd.conf</span>
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>package#httpd</span></span></span></code></pre></div><p><strong>Special Cases:</strong></p><table><thead><tr><th>Condition</th><th>Behavior</th></tr></thead><tbody><tr><td><code>ensure: stopped</code></td><td>Subscribe ignored (no restart)</td></tr><tr><td>Service not running + <code>ensure: running</code></td><td>Start (not restart)</td></tr><tr><td>Service running + <code>ensure: running</code></td><td>Restart</td></tr></tbody></table><p>This prevents restarting stopped services and ensures a clean start when the service should be running but isn&rsquo;t.</p><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The service resource is idempotent through state comparison:</p><table><thead><tr><th>Desired</th><th>Current</th><th>Action</th></tr></thead><tbody><tr><td><code>ensure: running</code></td><td>running</td><td>None</td></tr><tr><td><code>ensure: running</code></td><td>stopped</td><td>Start</td></tr><tr><td><code>ensure: stopped</code></td><td>stopped</td><td>None</td></tr><tr><td><code>ensure: stopped</code></td><td>running</td><td>Stop</td></tr><tr><td><code>enable: true</code></td><td>enabled</td><td>None</td></tr><tr><td><code>enable: true</code></td><td>disabled</td><td>Enable</td></tr><tr><td><code>enable: false</code></td><td>enabled</td><td>Disable</td></tr><tr><td><code>enable: false</code></td><td>disabled</td><td>None</td></tr><tr><td><code>enable: nil</code></td><td>any</td><td>None</td></tr></tbody></table><h2 id=desired-state-validation>Desired State Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>After applying changes, the type verifies the service reached the desired state:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Type</span>) <span style=color:#a6e22e>isDesiredState</span>(<span style=color:#a6e22e>properties</span>, <span style=color:#a6e22e>state</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check running state</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Ensure</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Ensure</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check enabled state (only if explicitly set)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Enable</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>properties</span>.<span style=color:#a6e22e>Enable</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Metadata</span>.<span style=color:#a6e22e>Enabled</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>If the desired state is not reached, an <code>ErrDesiredStateFailed</code> error is returned.</p><h2 id=service-name-validation>Service Name Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Service names are validated to prevent injection attacks:</p><p><strong>Allowed Characters:</strong></p><ul><li>Alphanumeric (<code>a-z</code>, <code>A-Z</code>, <code>0-9</code>)</li><li>Period (<code>.</code>), underscore (<code>_</code>), plus (<code>+</code>)</li><li>Colon (<code>:</code>), tilde (<code>~</code>), hyphen (<code>-</code>)</li></ul><p><strong>Rejected:</strong></p><ul><li>Shell metacharacters (<code>;</code>, <code>|</code>, <code>&</code>, etc.)</li><li>Whitespace</li><li>Path separators</li></ul><h2 id=noop-mode>Noop Mode<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>In noop mode, the service type:</p><ol><li>Queries current state normally</li><li>Logs what actions would be taken</li><li>Sets appropriate <code>NoopMessage</code> (e.g., &ldquo;Would have started&rdquo;, &ldquo;Would have enabled&rdquo;)</li><li>Reports <code>Changed: true</code> if changes would occur</li><li>Does not call provider Start/Stop/Restart/Enable/Disable methods</li></ol><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Service Type</h1><article class=default><header class=headline></header><h1 id=systemd-provider>Systemd Provider</h1><p>This document describes the implementation details of the Systemd service provider for managing system services via <code>systemctl</code>.</p><h2 id=provider-selection>Provider Selection<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The Systemd provider is selected when <code>systemctl</code> is found in the system PATH. The provider checks for the executable using <code>util.ExecutableInPath("systemctl")</code>.</p><p><strong>Availability Check:</strong></p><ul><li>Searches PATH for <code>systemctl</code></li><li>Returns priority 1 if found</li><li>Returns unavailable if not found</li></ul><h2 id=concurrency>Concurrency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>A global service lock (<code>model.ServiceGlobalLock</code>) is held during all <code>systemctl</code> command executions to prevent concurrent systemd operations within the same process. This prevents race conditions when multiple service resources are managed simultaneously.</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Provider</span>) <span style=color:#a6e22e>execute</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>cmd</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>args</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>string</span>) (<span style=color:#f92672>...</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ServiceGlobalLock</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>ServiceGlobalLock</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>runner</span>.<span style=color:#a6e22e>Execute</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cmd</span>, <span style=color:#a6e22e>args</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h2 id=daemon-reload>Daemon Reload<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The provider performs a <code>systemctl daemon-reload</code> once per provider instance before any service operations. This ensures systemd picks up any unit file changes made by other resources (e.g., file resources managing unit files).</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Provider</span>) <span style=color:#a6e22e>maybeReload</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>didReload</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>execute</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;systemctl&#34;</span>, <span style=color:#e6db74>&#34;daemon-reload&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>The reload is performed only once, tracked by the <code>didReload</code> flag.</p><h2 id=operations>Operations<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=status>Status<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Commands:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>systemctl is-active --system &lt;service&gt;
systemctl is-enabled --system &lt;service&gt;</code></pre></div><p><strong>Active State Detection:</strong></p><table><thead><tr><th><code>is-active</code> Output</th><th>Interpreted As</th></tr></thead><tbody><tr><td><code>active</code></td><td>Running</td></tr><tr><td><code>inactive</code></td><td>Stopped</td></tr><tr><td><code>failed</code></td><td>Stopped</td></tr><tr><td><code>activating</code></td><td>Stopped</td></tr><tr><td>Other</td><td>Error</td></tr></tbody></table><p><strong>Enabled State Detection:</strong></p><table><thead><tr><th><code>is-enabled</code> Output</th><th>Interpreted As</th></tr></thead><tbody><tr><td><code>enabled</code></td><td>Enabled</td></tr><tr><td><code>enabled-runtime</code></td><td>Enabled</td></tr><tr><td><code>alias</code></td><td>Enabled</td></tr><tr><td><code>static</code></td><td>Enabled</td></tr><tr><td><code>indirect</code></td><td>Enabled</td></tr><tr><td><code>generated</code></td><td>Enabled</td></tr><tr><td><code>transient</code></td><td>Enabled</td></tr><tr><td><code>linked</code></td><td>Disabled</td></tr><tr><td><code>linked-runtime</code></td><td>Disabled</td></tr><tr><td><code>masked</code></td><td>Disabled</td></tr><tr><td><code>masked-runtime</code></td><td>Disabled</td></tr><tr><td><code>disabled</code></td><td>Disabled</td></tr><tr><td><code>not-found</code></td><td>Error: service not found</td></tr></tbody></table><p><strong>Returned State:</strong></p><table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody><tr><td><code>Ensure</code></td><td><code>running</code> or <code>stopped</code> based on is-active</td></tr><tr><td><code>Metadata.Enabled</code></td><td>Boolean from is-enabled</td></tr><tr><td><code>Metadata.Running</code></td><td>Boolean from is-active</td></tr><tr><td><code>Metadata.Provider</code></td><td>&ldquo;systemd&rdquo;</td></tr></tbody></table><h3 id=start>Start<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>systemctl start --system &lt;service&gt;</code></pre></div><p>Called when <code>ensure: running</code> and service is currently stopped.</p><h3 id=stop>Stop<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>systemctl stop --system &lt;service&gt;</code></pre></div><p>Called when <code>ensure: stopped</code> and service is currently running.</p><h3 id=restart>Restart<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>systemctl restart --system &lt;service&gt;</code></pre></div><p>Called when a subscribed resource has changed and the service should be refreshed.</p><h3 id=enable>Enable<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>systemctl enable --system &lt;service&gt;</code></pre></div><p>Called when <code>enable: true</code> and service is currently disabled.</p><h3 id=disable>Disable<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p><strong>Command:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>systemctl disable --system &lt;service&gt;</code></pre></div><p>Called when <code>enable: false</code> and service is currently enabled.</p><h2 id=command-flags>Command Flags<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>All commands use the <code>--system</code> flag to explicitly target system-level units (as opposed to user-level units managed with <code>--user</code>).</p><h2 id=decision-flow>Decision Flow<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><h3 id=ensure-state-runningstopped>Ensure State (Running/Stopped)<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Subscribe triggered?                     â”‚
â”‚ (subscribed resource changed)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ Yes           â”‚ No
              â”‚               â”‚
              â”‚               â–¼
              â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚       â”‚ Ensure = stopped? â”‚
              â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚           Yes   â”‚   No
              â”‚           â–¼     â–¼
              â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   â”‚ Running?â”‚ â”‚ Ensure = running? â”‚
              â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚    Yes â”‚ No         Yes â”‚   No
              â”‚        â–¼               â–¼
              â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   â”‚ Stop   â”‚    â”‚ Running?â”‚
              â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
              â”‚                  No  â”‚ Yes
              â”‚                      â–¼
              â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                 â”‚ Start  â”‚
              â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Ensure = running?             â”‚
      â”‚ (only restart running services)â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  Yes â”‚   No
                      â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Restart     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><p><strong>Subscribe Behavior Notes:</strong></p><ul><li>Restart only occurs if <code>ensure: running</code></li><li>If service is stopped and <code>ensure: running</code>, it starts instead of restarting</li><li>Subscribe is ignored if <code>ensure: stopped</code></li></ul><h3 id=enable-state>Enable State<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h3><p>Enable/disable is processed independently after ensure state:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Enable property set?                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ Yes           â”‚ No (nil)
              â”‚               â”‚
              â”‚               â–¼
              â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚       â”‚ No change     â”‚
              â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Enable = true?                 â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  Yes â”‚   No
                      â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Currently enabled?             â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  No  â”‚ Yes
                      â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Enable      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

      (Similar flow for disable when enable=false)</code></pre></div><h2 id=idempotency>Idempotency<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The service resource checks current state before making changes:</p><table><thead><tr><th>Desired State</th><th>Current State</th><th>Action</th></tr></thead><tbody><tr><td><code>running</code></td><td><code>running</code></td><td>None</td></tr><tr><td><code>running</code></td><td><code>stopped</code></td><td>Start</td></tr><tr><td><code>stopped</code></td><td><code>stopped</code></td><td>None</td></tr><tr><td><code>stopped</code></td><td><code>running</code></td><td>Stop</td></tr><tr><td><code>enable: true</code></td><td>enabled</td><td>None</td></tr><tr><td><code>enable: true</code></td><td>disabled</td><td>Enable</td></tr><tr><td><code>enable: false</code></td><td>enabled</td><td>Disable</td></tr><tr><td><code>enable: false</code></td><td>disabled</td><td>None</td></tr><tr><td><code>enable: nil</code></td><td>any</td><td>None</td></tr></tbody></table><h2 id=service-name-validation>Service Name Validation<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Service names are validated to prevent shell injection:</p><p><strong>Dangerous Characters Check:</strong></p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>dangerousCharsRegex</span>.<span style=color:#a6e22e>MatchString</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Name</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;service name contains dangerous characters: %q&#34;</span>, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p><strong>Allowed Characters:</strong></p><ul><li>Alphanumeric (<code>a-z</code>, <code>A-Z</code>, <code>0-9</code>)</li><li>Period (<code>.</code>)</li><li>Underscore (<code>_</code>)</li><li>Plus (<code>+</code>)</li><li>Colon (<code>:</code>)</li><li>Tilde (<code>~</code>)</li><li>Hyphen (<code>-</code>)</li></ul><p><strong>Examples:</strong></p><table><thead><tr><th>Name</th><th>Valid</th></tr></thead><tbody><tr><td><code>httpd</code></td><td>Yes</td></tr><tr><td><code>nginx.service</code></td><td>Yes</td></tr><tr><td><code>my-app_v2</code></td><td>Yes</td></tr><tr><td><code>app@instance</code></td><td>No (@ not allowed)</td></tr><tr><td><code>app; rm -rf /</code></td><td>No (shell metacharacters)</td></tr></tbody></table><h2 id=subscribe-and-refresh>Subscribe and Refresh<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>Services can subscribe to other resources and restart when they change:</p><div class="highlight actionbar-wrapper wrap-code" dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>/etc/myapp/config.yaml</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>content</span>: <span style=color:#e6db74>&#34;...&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>mode</span>: <span style=color:#e6db74>&#34;0644&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>myapp</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ensure</span>: <span style=color:#ae81ff>running</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>enable</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subscribe</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>file#/etc/myapp/config.yaml</span></span></span></code></pre></div><p><strong>Behavior:</strong></p><ul><li>When the file resource changes, the service is restarted</li><li>Restart only occurs if <code>ensure: running</code></li><li>If service was stopped and should be running, it starts (not restarts)</li></ul><h2 id=error-handling>Error Handling<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><table><thead><tr><th>Condition</th><th>Behavior</th></tr></thead><tbody><tr><td><code>systemctl</code> not in PATH</td><td>Provider unavailable</td></tr><tr><td>Service not found</td><td>Error from <code>is-enabled</code>: &ldquo;service not found&rdquo;</td></tr><tr><td>Unknown <code>is-active</code> output</td><td>Error: &ldquo;invalid systemctl is-active output&rdquo;</td></tr><tr><td>Unknown <code>is-enabled</code> output</td><td>Error: &ldquo;invalid systemctl is-enabled output&rdquo;</td></tr><tr><td>Command execution failure</td><td>Error propagated from runner</td></tr></tbody></table><h2 id=platform-support>Platform Support<span class="btn cstyle anchor copyanchor scrollanchor link noborder notitle interactive"><button type=button title="Copy link to clipboard"><i class="fa-fw fas fa-link fa-lg"></i></button></span></h2><p>The Systemd provider requires:</p><ul><li>Linux with systemd as init system</li><li><code>systemctl</code> command available in PATH</li></ul><p>It does not support:</p><ul><li>Non-systemd init systems (SysVinit, Upstart, OpenRC)</li><li>User-level units (uses <code>--system</code> flag)</li><li>Windows, macOS, or BSD systems</li></ul><footer class=footline></footer></article></section></section></section></div></main></div><script src=/js/perfect-scrollbar/perfect-scrollbar.min.js?1770911710 defer></script><script src=/js/theme.min.js?1770911710 defer></script><div id=toast-container role=status aria-live=polite aria-atomic=false></div></body></html>